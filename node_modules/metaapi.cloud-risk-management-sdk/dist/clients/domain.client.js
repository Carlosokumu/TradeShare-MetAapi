'use strict';

/**
 * Connection URL and request managing client
 */

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class DomainClient {

  /**
   * Constructs domain client instance
   * @param {HttpClient} httpClient HTTP client
   * @param {String} token authorization token
   * @param {String} apiPath api url part
   * @param {String} domain domain to connect to, default is agiliumtrade.agiliumtrade.ai
   */
  constructor(httpClient, token, apiPath, domain = 'agiliumtrade.agiliumtrade.ai') {
    this._httpClient = httpClient;
    this._apiPath = apiPath;
    this._domain = domain;
    this._token = token;
    this._urlCache = null;
    this._regionCache = [];
    this._regionIndex = 0;
  }

  /**
   * Returns domain client domain
   * @returns {String} client domain
   */
  get domain() {
    return this._domain;
  }

  /**
   * Returns domain client token
   * @returns {String} client token
   */
  get token() {
    return this._token;
  }

  /**
   * Sends an authorized json API request
   * @param {Object} opts options request options
   * @param {Boolean} [isExtendedTimeout] whether to run the request with an extended timeout
   * @returns {Promise<Object|String|any>} request result
   */
  async requestApi(opts, isExtendedTimeout = false) {
    await this._updateHost();
    try {
      return await this._httpClient.request((0, _assign2.default)({}, opts, {
        headers: opts.headers || { 'auth-token': this._token },
        url: this._urlCache.url + opts.url,
        json: true
      }), isExtendedTimeout);
    } catch (err) {
      if (!['ConflictError', 'InternalError', 'ApiError', 'TimeoutError'].includes(err.name)) {
        throw err;
      } else {
        if (this._regionCache.length === this._regionIndex + 1) {
          throw err;
        } else {
          this._regionIndex++;
          return this.requestApi(opts);
        }
      }
    }
  }

  /**
   * Sends an http request
   * @param {Object} opts options request options
   * @returns {Promise<Object|String|any>} request result
   */
  request(opts) {
    return this._httpClient.request(opts);
  }

  async _updateHost() {
    if (!this._urlCache || this._urlCache.lastUpdated < Date.now() - 1000 * 60 * 10) {
      await this._updateRegions();
      const urlSettings = await this._httpClient.request({
        url: `https://mt-provisioning-api-v1.${this._domain}/users/current/servers/mt-client-api`,
        method: 'GET',
        headers: {
          'auth-token': this._token
        },
        json: true
      });
      this._urlCache = {
        url: `https://${this._apiPath}.${this._regionCache[this._regionIndex]}.${urlSettings.domain}`,
        domain: urlSettings.domain,
        lastUpdated: Date.now()
      };
    } else {
      this._urlCache = {
        url: `https://${this._apiPath}.${this._regionCache[this._regionIndex]}.${this._urlCache.domain}`,
        domain: this._urlCache.domain,
        lastUpdated: Date.now()
      };
    }
  }

  async _updateRegions() {
    this._regionIndex = 0;
    this._regionCache = await this._httpClient.request({
      url: `https://mt-provisioning-api-v1.${this._domain}/users/current/regions`,
      method: 'GET',
      headers: {
        'auth-token': this._token
      },
      json: true
    });
  }
}
exports.default = DomainClient;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9jbGllbnRzL2RvbWFpbi5jbGllbnQuZXM2Il0sIm5hbWVzIjpbIkRvbWFpbkNsaWVudCIsImNvbnN0cnVjdG9yIiwiaHR0cENsaWVudCIsInRva2VuIiwiYXBpUGF0aCIsImRvbWFpbiIsIl9odHRwQ2xpZW50IiwiX2FwaVBhdGgiLCJfZG9tYWluIiwiX3Rva2VuIiwiX3VybENhY2hlIiwiX3JlZ2lvbkNhY2hlIiwiX3JlZ2lvbkluZGV4IiwicmVxdWVzdEFwaSIsIm9wdHMiLCJpc0V4dGVuZGVkVGltZW91dCIsIl91cGRhdGVIb3N0IiwicmVxdWVzdCIsImhlYWRlcnMiLCJ1cmwiLCJqc29uIiwiZXJyIiwiaW5jbHVkZXMiLCJuYW1lIiwibGVuZ3RoIiwibGFzdFVwZGF0ZWQiLCJEYXRlIiwibm93IiwiX3VwZGF0ZVJlZ2lvbnMiLCJ1cmxTZXR0aW5ncyIsIm1ldGhvZCJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7Ozs7Ozs7Ozs7Ozs7O0FBR2UsTUFBTUEsWUFBTixDQUFtQjs7QUFFaEM7Ozs7Ozs7QUFPQUMsY0FBWUMsVUFBWixFQUF3QkMsS0FBeEIsRUFBK0JDLE9BQS9CLEVBQXdDQyxTQUFTLDhCQUFqRCxFQUFpRjtBQUMvRSxTQUFLQyxXQUFMLEdBQW1CSixVQUFuQjtBQUNBLFNBQUtLLFFBQUwsR0FBZ0JILE9BQWhCO0FBQ0EsU0FBS0ksT0FBTCxHQUFlSCxNQUFmO0FBQ0EsU0FBS0ksTUFBTCxHQUFjTixLQUFkO0FBQ0EsU0FBS08sU0FBTCxHQUFpQixJQUFqQjtBQUNBLFNBQUtDLFlBQUwsR0FBb0IsRUFBcEI7QUFDQSxTQUFLQyxZQUFMLEdBQW9CLENBQXBCO0FBQ0Q7O0FBRUQ7Ozs7QUFJQSxNQUFJUCxNQUFKLEdBQWE7QUFDWCxXQUFPLEtBQUtHLE9BQVo7QUFDRDs7QUFFRDs7OztBQUlBLE1BQUlMLEtBQUosR0FBWTtBQUNWLFdBQU8sS0FBS00sTUFBWjtBQUNEOztBQUVEOzs7Ozs7QUFNQSxRQUFNSSxVQUFOLENBQWlC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Y3Rpb24gVVJMIGFuZCByZXF1ZXN0IG1hbmFnaW5nIGNsaWVudFxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBEb21haW5DbGllbnQge1xuXG4gIC8qKlxuICAgKiBDb25zdHJ1Y3RzIGRvbWFpbiBjbGllbnQgaW5zdGFuY2VcbiAgICogQHBhcmFtIHtIdHRwQ2xpZW50fSBodHRwQ2xpZW50IEhUVFAgY2xpZW50XG4gICAqIEBwYXJhbSB7U3RyaW5nfSB0b2tlbiBhdXRob3JpemF0aW9uIHRva2VuXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBhcGlQYXRoIGFwaSB1cmwgcGFydFxuICAgKiBAcGFyYW0ge1N0cmluZ30gZG9tYWluIGRvbWFpbiB0byBjb25uZWN0IHRvLCBkZWZhdWx0IGlzIGFnaWxpdW10cmFkZS5hZ2lsaXVtdHJhZGUuYWlcbiAgICovXG4gIGNvbnN0cnVjdG9yKGh0dHBDbGllbnQsIHRva2VuLCBhcGlQYXRoLCBkb21haW4gPSAnYWdpbGl1bXRyYWRlLmFnaWxpdW10cmFkZS5haScpIHtcbiAgICB0aGlzLl9odHRwQ2xpZW50ID0gaHR0cENsaWVudDtcbiAgICB0aGlzLl9hcGlQYXRoID0gYXBpUGF0aDtcbiAgICB0aGlzLl9kb21haW4gPSBkb21haW47XG4gICAgdGhpcy5fdG9rZW4gPSB0b2tlbjtcbiAgICB0aGlzLl91cmxDYWNoZSA9IG51bGw7XG4gICAgdGhpcy5fcmVnaW9uQ2FjaGUgPSBbXTtcbiAgICB0aGlzLl9yZWdpb25JbmRleCA9IDA7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBkb21haW4gY2xpZW50IGRvbWFpblxuICAgKiBAcmV0dXJucyB7U3RyaW5nfSBjbGllbnQgZG9tYWluXG4gICAqL1xuICBnZXQgZG9tYWluKCkge1xuICAgIHJldHVybiB0aGlzLl9kb21haW47XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBkb21haW4gY2xpZW50IHRva2VuXG4gICAqIEByZXR1cm5zIHtTdHJpbmd9IGNsaWVudCB0b2tlblxuICAgKi9cbiAgZ2V0IHRva2VuKCkge1xuICAgIHJldHVybiB0aGlzLl90b2tlbjtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZW5kcyBhbiBhdXRob3JpemVkIGpzb24gQVBJIHJlcXVlc3RcbiAgICogQHBhcmFtIHtPYmplY3R9IG9wdHMgb3B0aW9ucyByZXF1ZXN0IG9wdGlvbnNcbiAgICogQHBhcmFtIHtCb29sZWFufSBbaXNFeHRlbmRlZFRpbWVvdXRdIHdoZXRoZXIgdG8gcnVuIHRoZSByZXF1ZXN0IHdpdGggYW4gZXh0ZW5kZWQgdGltZW91dFxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxPYmplY3R8U3RyaW5nfGFueT59IHJlcXVlc3QgcmVzdWx0XG4gICAqL1xuICBhc3luYyByZXF1ZXN0QXBpKG9wdHMsIGlzRXh0ZW5kZWRUaW1lb3V0ID0gZmFsc2UpIHtcbiAgICBhd2FpdCB0aGlzLl91cGRhdGVIb3N0KCk7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9odHRwQ2xpZW50LnJlcXVlc3QoT2JqZWN0LmFzc2lnbih7fSwgb3B0cywge1xuICAgICAgICBoZWFkZXJzOiBvcHRzLmhlYWRlcnMgfHwgeydhdXRoLXRva2VuJzogdGhpcy5fdG9rZW59LFxuICAgICAgICB1cmw6IHRoaXMuX3VybENhY2hlLnVybCArIG9wdHMudXJsLFxuICAgICAgICBqc29uOiB0cnVlXG4gICAgICB9KSwgaXNFeHRlbmRlZFRpbWVvdXQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKCFbJ0NvbmZsaWN0RXJyb3InLCAnSW50ZXJuYWxFcnJvcicsICdBcGlFcnJvcicsICdUaW1lb3V0RXJyb3InXS5pbmNsdWRlcyhlcnIubmFtZSkpIHtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHRoaXMuX3JlZ2lvbkNhY2hlLmxlbmd0aCA9PT0gdGhpcy5fcmVnaW9uSW5kZXggKyAxKSB7XG4gICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuX3JlZ2lvbkluZGV4Kys7XG4gICAgICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdEFwaShvcHRzKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICB9XG5cbiAgLyoqXG4gICAqIFNlbmRzIGFuIGh0dHAgcmVxdWVzdFxuICAgKiBAcGFyYW0ge09iamVjdH0gb3B0cyBvcHRpb25zIHJlcXVlc3Qgb3B0aW9uc1xuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxPYmplY3R8U3RyaW5nfGFueT59IHJlcXVlc3QgcmVzdWx0XG4gICAqL1xuICByZXF1ZXN0KG9wdHMpIHtcbiAgICByZXR1cm4gdGhpcy5faHR0cENsaWVudC5yZXF1ZXN0KG9wdHMpO1xuICB9XG5cbiAgYXN5bmMgX3VwZGF0ZUhvc3QoKSB7XG4gICAgaWYgKCF0aGlzLl91cmxDYWNoZSB8fCB0aGlzLl91cmxDYWNoZS5sYXN0VXBkYXRlZCA8IERhdGUubm93KCkgLSAxMDAwICogNjAgKiAxMCkge1xuICAgICAgYXdhaXQgdGhpcy5fdXBkYXRlUmVnaW9ucygpO1xuICAgICAgY29uc3QgdXJsU2V0dGluZ3MgPSBhd2FpdCB0aGlzLl9odHRwQ2xpZW50LnJlcXVlc3Qoe1xuICAgICAgICB1cmw6IGBodHRwczovL210LXByb3Zpc2lvbmluZy1hcGktdjEuJHt0aGlzLl9kb21haW59L3VzZXJzL2N1cnJlbnQvc2VydmVycy9tdC1jbGllbnQtYXBpYCxcbiAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdhdXRoLXRva2VuJzogdGhpcy5fdG9rZW5cbiAgICAgICAgfSxcbiAgICAgICAganNvbjogdHJ1ZSxcbiAgICAgIH0pO1xuICAgICAgdGhpcy5fdXJsQ2FjaGUgPSB7XG4gICAgICAgIHVybDogYGh0dHBzOi8vJHt0aGlzLl9hcGlQYXRofS4ke3RoaXMuX3JlZ2lvbkNhY2hlW3RoaXMuX3JlZ2lvbkluZGV4XX0uJHt1cmxTZXR0aW5ncy5kb21haW59YCxcbiAgICAgICAgZG9tYWluOiB1cmxTZXR0aW5ncy5kb21haW4sXG4gICAgICAgIGxhc3RVcGRhdGVkOiBEYXRlLm5vdygpXG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl91cmxDYWNoZSA9IHtcbiAgICAgICAgdXJsOiBgaHR0cHM6Ly8ke3RoaXMuX2FwaVBhdGh9LiR7dGhpcy5fcmVnaW9uQ2FjaGVbdGhpcy5fcmVnaW9uSW5kZXhdfS4ke3RoaXMuX3VybENhY2hlLmRvbWFpbn1gLFxuICAgICAgICBkb21haW46IHRoaXMuX3VybENhY2hlLmRvbWFpbixcbiAgICAgICAgbGFzdFVwZGF0ZWQ6IERhdGUubm93KClcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgX3VwZGF0ZVJlZ2lvbnMoKSB7XG4gICAgdGhpcy5fcmVnaW9uSW5kZXggPSAwO1xuICAgIHRoaXMuX3JlZ2lvbkNhY2hlID0gYXdhaXQgdGhpcy5faHR0cENsaWVudC5yZXF1ZXN0KHtcbiAgICAgIHVybDogYGh0dHBzOi8vbXQtcHJvdmlzaW9uaW5nLWFwaS12MS4ke3RoaXMuX2RvbWFpbn0vdXNlcnMvY3VycmVudC9yZWdpb25zYCxcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdhdXRoLXRva2VuJzogdGhpcy5fdG9rZW5cbiAgICAgIH0sXG4gICAgICBqc29uOiB0cnVlLFxuICAgIH0pO1xuICB9XG59Il19