'use strict';

var _httpClient = require('./httpClient');

var _httpClient2 = _interopRequireDefault(_httpClient);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _domain = require('./domain.client');

var _domain2 = _interopRequireDefault(_domain);

var _errorHandler = require('./errorHandler');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @test {DomainClient}
 */
describe('DomainClient', () => {

  let domainClient;
  const token = 'header.payload.sign';
  let httpClient = new _httpClient2.default();
  let sandbox;
  let requestStub;
  let getRegionsStub;
  let getHostStub;
  let clock;
  const expected = [{ _id: 'ABCD' }];

  before(() => {
    sandbox = _sinon2.default.createSandbox();
  });

  beforeEach(() => {
    domainClient = new _domain2.default(httpClient, token, 'risk-management-api-v1');
    clock = sandbox.useFakeTimers({ shouldAdvanceTime: true });
    requestStub = sandbox.stub(httpClient, 'request');
    requestStub.withArgs({
      url: 'https://risk-management-api-v1.vint-hill.agiliumtrade.agiliumtrade.ai/some/rest/api',
      method: 'GET',
      headers: { 'auth-token': token },
      json: true
    }).resolves(expected);
    getRegionsStub = requestStub.withArgs({
      url: 'https://mt-provisioning-api-v1.agiliumtrade.agiliumtrade.ai/users/current/regions',
      method: 'GET',
      headers: { 'auth-token': token },
      json: true
    }).resolves(['vint-hill', 'us-west']);
    getHostStub = requestStub.withArgs({
      url: 'https://mt-provisioning-api-v1.agiliumtrade.agiliumtrade.ai/users/current/servers/mt-client-api',
      method: 'GET',
      headers: { 'auth-token': token },
      json: true
    }).resolves({ domain: 'agiliumtrade.agiliumtrade.ai' });
  });

  afterEach(() => {
    sandbox.restore();
    clock.restore();
  });

  /**
   * @test {DomainClient#requestApi}
   */
  describe('requestApi', () => {

    const opts = {
      url: '/some/rest/api',
      method: 'GET'
    };

    /**
     * @test {DomainClient#requestApi}
     */
    it('should execute request', async () => {
      const response = await domainClient.requestApi(opts);
      _sinon2.default.assert.match(response, expected);
      _sinon2.default.assert.calledWith(requestStub, {
        url: 'https://risk-management-api-v1.vint-hill.agiliumtrade.agiliumtrade.ai/some/rest/api',
        method: 'GET',
        headers: { 'auth-token': token },
        json: true
      });
    });

    /**
     * @test {DomainClient#requestApi}
     */
    it('should use cached url on repeated request', async () => {
      await domainClient.requestApi(opts);
      const response = await domainClient.requestApi(opts);
      _sinon2.default.assert.calledWith(requestStub, {
        url: 'https://risk-management-api-v1.vint-hill.agiliumtrade.agiliumtrade.ai/some/rest/api',
        method: 'GET',
        headers: { 'auth-token': token },
        json: true
      });
      _sinon2.default.assert.match(response, expected);
      _sinon2.default.assert.calledOnce(getHostStub);
      _sinon2.default.assert.calledOnce(getRegionsStub);
    });

    /**
     * @test {DomainClient#requestApi}
     */
    it('should request url again if expired', async () => {
      await domainClient.requestApi(opts);
      await clock.tickAsync(610000);
      const response = await domainClient.requestApi(opts);
      _sinon2.default.assert.match(response, expected);
      _sinon2.default.assert.calledWith(requestStub, {
        url: 'https://risk-management-api-v1.vint-hill.agiliumtrade.agiliumtrade.ai/some/rest/api',
        method: 'GET',
        headers: { 'auth-token': token },
        json: true
      });
      _sinon2.default.assert.calledTwice(getHostStub);
      _sinon2.default.assert.calledTwice(getRegionsStub);
    });

    /**
     * @test {DomainClient#requestApi}
     */
    it('should return request error', async () => {
      requestStub.withArgs({
        url: 'https://risk-management-api-v1.vint-hill.agiliumtrade.agiliumtrade.ai/some/rest/api',
        method: 'GET',
        headers: { 'auth-token': token },
        json: true
      }).throws(new _errorHandler.ValidationError('test'));
      try {
        await domainClient.requestApi(opts);
        throw new Error('ValidationError expected');
      } catch (error) {
        error.name.should.equal('ValidationError');
      }
    });

    /**
     * @test {DomainClient#requestApi}
     */
    it('should return error if failed to get host', async () => {
      getHostStub.throws(new _errorHandler.ValidationError('test'));
      try {
        await domainClient.requestApi(opts);
        throw new Error('ValidationError expected');
      } catch (error) {
        error.name.should.equal('ValidationError');
      }
    });

    /**
     * @test {DomainClient#requestApi}
     */
    describe('regions', () => {

      /**
       * @test {DomainClient#requestApi}
       */
      it('should return error if failed to get regions', async () => {
        getRegionsStub.throws(new _errorHandler.ValidationError('test'));
        try {
          await domainClient.requestApi(opts);
          throw new Error('ValidationError expected');
        } catch (error) {
          error.name.should.equal('ValidationError');
        }
      });

      /**
       * @test {DomainClient#requestApi}
       */
      it('should try another region if the first failed', async () => {
        requestStub.withArgs({
          url: 'https://risk-management-api-v1.vint-hill.agiliumtrade.agiliumtrade.ai/some/rest/api',
          method: 'GET',
          headers: { 'auth-token': token },
          json: true
        }).rejects(new _errorHandler.InternalError('test'));
        requestStub.withArgs({
          url: 'https://risk-management-api-v1.us-west.agiliumtrade.agiliumtrade.ai/some/rest/api',
          method: 'GET',
          headers: { 'auth-token': token },
          json: true
        }).resolves(expected);
        const response = await domainClient.requestApi(opts);
        _sinon2.default.assert.calledWith(requestStub, {
          url: 'https://risk-management-api-v1.us-west.agiliumtrade.agiliumtrade.ai/some/rest/api',
          method: 'GET',
          headers: { 'auth-token': token },
          json: true
        });
        _sinon2.default.assert.match(response, expected);

        _sinon2.default.assert.calledOnce(getHostStub);
        _sinon2.default.assert.calledOnce(getRegionsStub);
      });

      /**
       * @test {DomainClient#requestApi}
       */
      it('should return error if all regions failed', async () => {
        requestStub.withArgs({
          url: 'https://risk-management-api-v1.vint-hill.agiliumtrade.agiliumtrade.ai/some/rest/api',
          method: 'GET',
          headers: { 'auth-token': token },
          json: true
        }).throws(new _errorHandler.InternalError('test'));
        requestStub.withArgs({
          url: 'https://risk-management-api-v1.us-west.agiliumtrade.agiliumtrade.ai/some/rest/api',
          method: 'GET',
          headers: { 'auth-token': token },
          json: true
        }).throws(new _errorHandler.InternalError('test'));

        try {
          await domainClient.requestApi(opts);
          throw new Error('InternalError expected');
        } catch (error) {
          error.name.should.equal('InternalError');
        }
      });
    });
  });

  /**
   * @test {DomainClient#request}
   */
  describe('request', () => {

    it('should execute request', async () => {
      const opts = {
        url: 'https://mt-provisioning-api-v1.agiliumtrade.agiliumtrade.ai/users/current/accounts/accountId',
        method: 'GET',
        headers: {
          'auth-token': token
        },
        json: true
      };

      requestStub.withArgs(opts).resolves(expected);
      const response = await domainClient.request(opts);
      _sinon2.default.assert.match(response, expected);
      _sinon2.default.assert.calledWith(requestStub, opts);
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9jbGllbnRzL2RvbWFpbi5jbGllbnQuc3BlYy5lczYiXSwibmFtZXMiOlsiZGVzY3JpYmUiLCJkb21haW5DbGllbnQiLCJ0b2tlbiIsImh0dHBDbGllbnQiLCJIdHRwQ2xpZW50Iiwic2FuZGJveCIsInJlcXVlc3RTdHViIiwiZ2V0UmVnaW9uc1N0dWIiLCJnZXRIb3N0U3R1YiIsImNsb2NrIiwiZXhwZWN0ZWQiLCJfaWQiLCJiZWZvcmUiLCJzaW5vbiIsImNyZWF0ZVNhbmRib3giLCJiZWZvcmVFYWNoIiwiRG9tYWluQ2xpZW50IiwidXNlRmFrZVRpbWVycyIsInNob3VsZEFkdmFuY2VUaW1lIiwic3R1YiIsIndpdGhBcmdzIiwidXJsIiwibWV0aG9kIiwiaGVhZGVycyIsImpzb24iLCJyZXNvbHZlcyIsImRvbWFpbiIsImFmdGVyRWFjaCIsInJlc3RvcmUiLCJvcHRzIiwiaXQiLCJyZXNwb25zZSIsInJlcXVlc3RBcGkiLCJhc3NlcnQiLCJtYXRjaCIsImNhbGxlZFdpdGgiLCJjYWxsZWRPbmNlIiwidGlja0FzeW5jIiwiY2FsbGVkVHdpY2UiLCJ0aHJvd3MiLCJWYWxpZGF0aW9uRXJyb3IiLCJFcnJvciIsImVycm9yIiwibmFtZSIsInNob3VsZCIsImVxdWFsIiwicmVqZWN0cyIsIkludGVybmFsRXJyb3IiLCJyZXF1ZXN0Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOzs7QUFHQUEsU0FBUyxjQUFULEVBQXlCLE1BQU07O0FBRTdCLE1BQUlDLFlBQUo7QUFDQSxRQUFNQyxRQUFRLHFCQUFkO0FBQ0EsTUFBSUMsYUFBYSxJQUFJQyxvQkFBSixFQUFqQjtBQUNBLE1BQUlDLE9BQUo7QUFDQSxNQUFJQyxXQUFKO0FBQ0EsTUFBSUMsY0FBSjtBQUNBLE1BQUlDLFdBQUo7QUFDQSxNQUFJQyxLQUFKO0FBQ0EsUUFBTUMsV0FBVyxDQUFDLEVBQUNDLEtBQUssTUFBTixFQUFELENBQWpC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Q3ZDLFlBQU1ELE9BQU87QUFDWFIsYUFBTSw4RkFESztBQUVYQyxnQkFBUSxLQUZHO0FBR1hDLGlCQUFTO0FBQ1Asd0JBQWNyQjtBQURQLFNBSEU7QUFNWHNCLGNBQU07QUFOSyxPQUFiOztBQVNBbEIsa0JBQVljLFFBQVosQ0FBcUJTLElBQXJCLEVBQTJCSixRQUEzQixDQUFvQ2YsUUFBcEM7QUFDQSxZQUFNcUIsV0FBVyxNQUFNOUIsYUFBYStDLE9BQWIsQ0FBcUJuQixJQUFyQixDQUF2QjtBQUNBaEIsc0JBQU1vQixNQUFOLENBQWFDLEtBQWIsQ0FBbUJILFFBQW5CLEVBQTZCckIsUUFBN0I7QUFDQUcsc0JBQU1vQixNQUFOLENBQWFFLFVBQWIsQ0FBd0I3QixXQUF4QixFQUFxQ3VCLElBQXJDO0FBQ0QsS0FkRDtBQWdCRCxHQWxCRDtBQW9CRCxDQTFPRCIsImZpbGUiOiJkb21haW4uY2xpZW50LnNwZWMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCBIdHRwQ2xpZW50IGZyb20gJy4vaHR0cENsaWVudCc7XG5pbXBvcnQgc2lub24gZnJvbSAnc2lub24nO1xuaW1wb3J0IERvbWFpbkNsaWVudCBmcm9tICcuL2RvbWFpbi5jbGllbnQnO1xuaW1wb3J0IHsgVmFsaWRhdGlvbkVycm9yLCBJbnRlcm5hbEVycm9yIH0gZnJvbSAnLi9lcnJvckhhbmRsZXInO1xuXG4vKipcbiAqIEB0ZXN0IHtEb21haW5DbGllbnR9XG4gKi9cbmRlc2NyaWJlKCdEb21haW5DbGllbnQnLCAoKSA9PiB7XG5cbiAgbGV0IGRvbWFpbkNsaWVudDtcbiAgY29uc3QgdG9rZW4gPSAnaGVhZGVyLnBheWxvYWQuc2lnbic7XG4gIGxldCBodHRwQ2xpZW50ID0gbmV3IEh0dHBDbGllbnQoKTtcbiAgbGV0IHNhbmRib3g7XG4gIGxldCByZXF1ZXN0U3R1YjtcbiAgbGV0IGdldFJlZ2lvbnNTdHViO1xuICBsZXQgZ2V0SG9zdFN0dWI7XG4gIGxldCBjbG9jaztcbiAgY29uc3QgZXhwZWN0ZWQgPSBbe19pZDogJ0FCQ0QnfV07XG5cbiAgYmVmb3JlKCgpID0+IHtcbiAgICBzYW5kYm94ID0gc2lub24uY3JlYXRlU2FuZGJveCgpO1xuICB9KTtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBkb21haW5DbGllbnQgPSBuZXcgRG9tYWluQ2xpZW50KGh0dHBDbGllbnQsIHRva2VuLCAncmlzay1tYW5hZ2VtZW50LWFwaS12MScpO1xuICAgIGNsb2NrID0gc2FuZGJveC51c2VGYWtlVGltZXJzKHtzaG91bGRBZHZhbmNlVGltZTogdHJ1ZX0pO1xuICAgIHJlcXVlc3RTdHViID0gc2FuZGJveC5zdHViKGh0dHBDbGllbnQsICdyZXF1ZXN0Jyk7XG4gICAgcmVxdWVzdFN0dWIud2l0aEFyZ3Moe1xuICAgICAgdXJsOiAnaHR0cHM6Ly9yaXNrLW1hbmFnZW1lbnQtYXBpLXYxLnZpbnQtaGlsbC5hZ2lsaXVtdHJhZGUuYWdpbGl1bXRyYWRlLmFpL3NvbWUvcmVzdC9hcGknLFxuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIGhlYWRlcnM6IHsnYXV0aC10b2tlbic6IHRva2VufSxcbiAgICAgIGpzb246IHRydWVcbiAgICB9KS5yZXNvbHZlcyhleHBlY3RlZCk7XG4gICAgZ2V0UmVnaW9uc1N0dWIgPSByZXF1ZXN0U3R1Yi53aXRoQXJncyh7XG4gICAgICB1cmw6ICdodHRwczovL210LXByb3Zpc2lvbmluZy1hcGktdjEuYWdpbGl1bXRyYWRlLmFnaWxpdW10cmFkZS5haS91c2Vycy9jdXJyZW50L3JlZ2lvbnMnLFxuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIGhlYWRlcnM6IHsnYXV0aC10b2tlbic6IHRva2VufSxcbiAgICAgIGpzb246IHRydWUsXG4gICAgfSkucmVzb2x2ZXMoWyd2aW50LWhpbGwnLCAndXMtd2VzdCddKTtcbiAgICBnZXRIb3N0U3R1YiA9IHJlcXVlc3RTdHViLndpdGhBcmdzKHtcbiAgICAgIHVybDogJ2h0dHBzOi8vbXQtcHJvdmlzaW9uaW5nLWFwaS12MS5hZ2lsaXVtdHJhZGUuYWdpbGl1bXRyYWRlLmFpL3VzZXJzL2N1cnJlbnQvc2VydmVycy9tdC1jbGllbnQtYXBpJyxcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICBoZWFkZXJzOiB7J2F1dGgtdG9rZW4nOiB0b2tlbn0sXG4gICAgICBqc29uOiB0cnVlLFxuICAgIH0pLnJlc29sdmVzKHtkb21haW46ICdhZ2lsaXVtdHJhZGUuYWdpbGl1bXRyYWRlLmFpJ30pO1xuICB9KTtcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIHNhbmRib3gucmVzdG9yZSgpO1xuICAgIGNsb2NrLnJlc3RvcmUoKTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtEb21haW5DbGllbnQjcmVxdWVzdEFwaX1cbiAgICovXG4gIGRlc2NyaWJlKCdyZXF1ZXN0QXBpJywgKCkgPT4ge1xuXG4gICAgY29uc3Qgb3B0cyA9IHtcbiAgICAgIHVybDogJy9zb21lL3Jlc3QvYXBpJyxcbiAgICAgIG1ldGhvZDogJ0dFVCdcbiAgICB9O1xuXG4gICAgLyoqXG4gICAgICogQHRlc3Qge0RvbWFpbkNsaWVudCNyZXF1ZXN0QXBpfVxuICAgICAqL1xuICAgIGl0KCdzaG91bGQgZXhlY3V0ZSByZXF1ZXN0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBkb21haW5DbGllbnQucmVxdWVzdEFwaShvcHRzKTtcbiAgICAgIHNpbm9uLmFzc2VydC5tYXRjaChyZXNwb25zZSwgZXhwZWN0ZWQpO1xuICAgICAgc2lub24uYXNzZXJ0LmNhbGxlZFdpdGgocmVxdWVzdFN0dWIsIHtcbiAgICAgICAgdXJsOiAnaHR0cHM6Ly9yaXNrLW1hbmFnZW1lbnQtYXBpLXYxLnZpbnQtaGlsbC5hZ2lsaXVtdHJhZGUuYWdpbGl1bXRyYWRlLmFpL3NvbWUvcmVzdC9hcGknLFxuICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICBoZWFkZXJzOiB7J2F1dGgtdG9rZW4nOiB0b2tlbn0sXG4gICAgICAgIGpzb246IHRydWVcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgLyoqXG4gICAgICogQHRlc3Qge0RvbWFpbkNsaWVudCNyZXF1ZXN0QXBpfVxuICAgICAqL1xuICAgIGl0KCdzaG91bGQgdXNlIGNhY2hlZCB1cmwgb24gcmVwZWF0ZWQgcmVxdWVzdCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IGRvbWFpbkNsaWVudC5yZXF1ZXN0QXBpKG9wdHMpO1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBkb21haW5DbGllbnQucmVxdWVzdEFwaShvcHRzKTtcbiAgICAgIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKHJlcXVlc3RTdHViLCB7XG4gICAgICAgIHVybDogJ2h0dHBzOi8vcmlzay1tYW5hZ2VtZW50LWFwaS12MS52aW50LWhpbGwuYWdpbGl1bXRyYWRlLmFnaWxpdW10cmFkZS5haS9zb21lL3Jlc3QvYXBpJyxcbiAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgaGVhZGVyczogeydhdXRoLXRva2VuJzogdG9rZW59LFxuICAgICAgICBqc29uOiB0cnVlXG4gICAgICB9KTtcbiAgICAgIHNpbm9uLmFzc2VydC5tYXRjaChyZXNwb25zZSwgZXhwZWN0ZWQpO1xuICAgICAgc2lub24uYXNzZXJ0LmNhbGxlZE9uY2UoZ2V0SG9zdFN0dWIpO1xuICAgICAgc2lub24uYXNzZXJ0LmNhbGxlZE9uY2UoZ2V0UmVnaW9uc1N0dWIpO1xuICAgIH0pO1xuXG4gICAgLyoqXG4gICAgICogQHRlc3Qge0RvbWFpbkNsaWVudCNyZXF1ZXN0QXBpfVxuICAgICAqL1xuICAgIGl0KCdzaG91bGQgcmVxdWVzdCB1cmwgYWdhaW4gaWYgZXhwaXJlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IGRvbWFpbkNsaWVudC5yZXF1ZXN0QXBpKG9wdHMpO1xuICAgICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDYxMDAwMCk7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGRvbWFpbkNsaWVudC5yZXF1ZXN0QXBpKG9wdHMpO1xuICAgICAgc2lub24uYXNzZXJ0Lm1hdGNoKHJlc3BvbnNlLCBleHBlY3RlZCk7XG4gICAgICBzaW5vbi5hc3NlcnQuY2FsbGVkV2l0aChyZXF1ZXN0U3R1Yiwge1xuICAgICAgICB1cmw6ICdodHRwczovL3Jpc2stbWFuYWdlbWVudC1hcGktdjEudmludC1oaWxsLmFnaWxpdW10cmFkZS5hZ2lsaXVtdHJhZGUuYWkvc29tZS9yZXN0L2FwaScsXG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgIGhlYWRlcnM6IHsnYXV0aC10b2tlbic6IHRva2VufSxcbiAgICAgICAganNvbjogdHJ1ZVxuICAgICAgfSk7XG4gICAgICBzaW5vbi5hc3NlcnQuY2FsbGVkVHdpY2UoZ2V0SG9zdFN0dWIpO1xuICAgICAgc2lub24uYXNzZXJ0LmNhbGxlZFR3aWNlKGdldFJlZ2lvbnNTdHViKTtcbiAgICB9KTtcblxuICAgIC8qKlxuICAgICAqIEB0ZXN0IHtEb21haW5DbGllbnQjcmVxdWVzdEFwaX1cbiAgICAgKi9cbiAgICBpdCgnc2hvdWxkIHJldHVybiByZXF1ZXN0IGVycm9yJywgYXN5bmMgKCkgPT4ge1xuICAgICAgcmVxdWVzdFN0dWIud2l0aEFyZ3Moe1xuICAgICAgICB1cmw6ICdodHRwczovL3Jpc2stbWFuYWdlbWVudC1hcGktdjEudmludC1oaWxsLmFnaWxpdW10cmFkZS5hZ2lsaXVtdHJhZGUuYWkvc29tZS9yZXN0L2FwaScsXG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgIGhlYWRlcnM6IHsnYXV0aC10b2tlbic6IHRva2VufSxcbiAgICAgICAganNvbjogdHJ1ZVxuICAgICAgfSkudGhyb3dzKG5ldyBWYWxpZGF0aW9uRXJyb3IoJ3Rlc3QnKSk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBkb21haW5DbGllbnQucmVxdWVzdEFwaShvcHRzKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdWYWxpZGF0aW9uRXJyb3IgZXhwZWN0ZWQnKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGVycm9yLm5hbWUuc2hvdWxkLmVxdWFsKCdWYWxpZGF0aW9uRXJyb3InKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8qKlxuICAgICAqIEB0ZXN0IHtEb21haW5DbGllbnQjcmVxdWVzdEFwaX1cbiAgICAgKi9cbiAgICBpdCgnc2hvdWxkIHJldHVybiBlcnJvciBpZiBmYWlsZWQgdG8gZ2V0IGhvc3QnLCBhc3luYyAoKSA9PiB7XG4gICAgICBnZXRIb3N0U3R1Yi50aHJvd3MobmV3IFZhbGlkYXRpb25FcnJvcigndGVzdCcpKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGRvbWFpbkNsaWVudC5yZXF1ZXN0QXBpKG9wdHMpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1ZhbGlkYXRpb25FcnJvciBleHBlY3RlZCcpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgZXJyb3IubmFtZS5zaG91bGQuZXF1YWwoJ1ZhbGlkYXRpb25FcnJvcicpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLyoqXG4gICAgICogQHRlc3Qge0RvbWFpbkNsaWVudCNyZXF1ZXN0QXBpfVxuICAgICAqL1xuICAgIGRlc2NyaWJlKCdyZWdpb25zJywgKCkgPT4ge1xuXG4gICAgICAvKipcbiAgICAgICAqIEB0ZXN0IHtEb21haW5DbGllbnQjcmVxdWVzdEFwaX1cbiAgICAgICAqL1xuICAgICAgaXQoJ3Nob3VsZCByZXR1cm4gZXJyb3IgaWYgZmFpbGVkIHRvIGdldCByZWdpb25zJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBnZXRSZWdpb25zU3R1Yi50aHJvd3MobmV3IFZhbGlkYXRpb25FcnJvcigndGVzdCcpKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCBkb21haW5DbGllbnQucmVxdWVzdEFwaShvcHRzKTtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1ZhbGlkYXRpb25FcnJvciBleHBlY3RlZCcpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIGVycm9yLm5hbWUuc2hvdWxkLmVxdWFsKCdWYWxpZGF0aW9uRXJyb3InKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIC8qKlxuICAgICAgICogQHRlc3Qge0RvbWFpbkNsaWVudCNyZXF1ZXN0QXBpfVxuICAgICAgICovXG4gICAgICBpdCgnc2hvdWxkIHRyeSBhbm90aGVyIHJlZ2lvbiBpZiB0aGUgZmlyc3QgZmFpbGVkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICByZXF1ZXN0U3R1Yi53aXRoQXJncyh7XG4gICAgICAgICAgdXJsOiAnaHR0cHM6Ly9yaXNrLW1hbmFnZW1lbnQtYXBpLXYxLnZpbnQtaGlsbC5hZ2lsaXVtdHJhZGUuYWdpbGl1bXRyYWRlLmFpL3NvbWUvcmVzdC9hcGknLFxuICAgICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgICAgaGVhZGVyczogeydhdXRoLXRva2VuJzogdG9rZW59LFxuICAgICAgICAgIGpzb246IHRydWVcbiAgICAgICAgfSkucmVqZWN0cyhuZXcgSW50ZXJuYWxFcnJvcigndGVzdCcpKTtcbiAgICAgICAgcmVxdWVzdFN0dWIud2l0aEFyZ3Moe1xuICAgICAgICAgIHVybDogJ2h0dHBzOi8vcmlzay1tYW5hZ2VtZW50LWFwaS12MS51cy13ZXN0LmFnaWxpdW10cmFkZS5hZ2lsaXVtdHJhZGUuYWkvc29tZS9yZXN0L2FwaScsXG4gICAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgICBoZWFkZXJzOiB7J2F1dGgtdG9rZW4nOiB0b2tlbn0sXG4gICAgICAgICAganNvbjogdHJ1ZVxuICAgICAgICB9KS5yZXNvbHZlcyhleHBlY3RlZCk7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZG9tYWluQ2xpZW50LnJlcXVlc3RBcGkob3B0cyk7XG4gICAgICAgIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKHJlcXVlc3RTdHViLCB7XG4gICAgICAgICAgdXJsOiAnaHR0cHM6Ly9yaXNrLW1hbmFnZW1lbnQtYXBpLXYxLnVzLXdlc3QuYWdpbGl1bXRyYWRlLmFnaWxpdW10cmFkZS5haS9zb21lL3Jlc3QvYXBpJyxcbiAgICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICAgIGhlYWRlcnM6IHsnYXV0aC10b2tlbic6IHRva2VufSxcbiAgICAgICAgICBqc29uOiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgICBzaW5vbi5hc3NlcnQubWF0Y2gocmVzcG9uc2UsIGV4cGVjdGVkKTtcblxuICAgICAgICBzaW5vbi5hc3NlcnQuY2FsbGVkT25jZShnZXRIb3N0U3R1Yik7XG4gICAgICAgIHNpbm9uLmFzc2VydC5jYWxsZWRPbmNlKGdldFJlZ2lvbnNTdHViKTtcbiAgICAgIH0pO1xuXG4gICAgICAvKipcbiAgICAgICAqIEB0ZXN0IHtEb21haW5DbGllbnQjcmVxdWVzdEFwaX1cbiAgICAgICAqL1xuICAgICAgaXQoJ3Nob3VsZCByZXR1cm4gZXJyb3IgaWYgYWxsIHJlZ2lvbnMgZmFpbGVkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICByZXF1ZXN0U3R1Yi53aXRoQXJncyh7XG4gICAgICAgICAgdXJsOiAnaHR0cHM6Ly9yaXNrLW1hbmFnZW1lbnQtYXBpLXYxLnZpbnQtaGlsbC5hZ2lsaXVtdHJhZGUuYWdpbGl1bXRyYWRlLmFpL3NvbWUvcmVzdC9hcGknLFxuICAgICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgICAgaGVhZGVyczogeydhdXRoLXRva2VuJzogdG9rZW59LFxuICAgICAgICAgIGpzb246IHRydWVcbiAgICAgICAgfSkudGhyb3dzKG5ldyBJbnRlcm5hbEVycm9yKCd0ZXN0JykpO1xuICAgICAgICByZXF1ZXN0U3R1Yi53aXRoQXJncyh7XG4gICAgICAgICAgdXJsOiAnaHR0cHM6Ly9yaXNrLW1hbmFnZW1lbnQtYXBpLXYxLnVzLXdlc3QuYWdpbGl1bXRyYWRlLmFnaWxpdW10cmFkZS5haS9zb21lL3Jlc3QvYXBpJyxcbiAgICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICAgIGhlYWRlcnM6IHsnYXV0aC10b2tlbic6IHRva2VufSxcbiAgICAgICAgICBqc29uOiB0cnVlXG4gICAgICAgIH0pLnRocm93cyhuZXcgSW50ZXJuYWxFcnJvcigndGVzdCcpKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IGRvbWFpbkNsaWVudC5yZXF1ZXN0QXBpKG9wdHMpO1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW50ZXJuYWxFcnJvciBleHBlY3RlZCcpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIGVycm9yLm5hbWUuc2hvdWxkLmVxdWFsKCdJbnRlcm5hbEVycm9yJyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgfSk7XG5cbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtEb21haW5DbGllbnQjcmVxdWVzdH1cbiAgICovXG4gIGRlc2NyaWJlKCdyZXF1ZXN0JywgKCkgPT4ge1xuXG4gICAgaXQoJ3Nob3VsZCBleGVjdXRlIHJlcXVlc3QnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBvcHRzID0ge1xuICAgICAgICB1cmw6ICAnaHR0cHM6Ly9tdC1wcm92aXNpb25pbmctYXBpLXYxLmFnaWxpdW10cmFkZS5hZ2lsaXVtdHJhZGUuYWkvdXNlcnMvY3VycmVudC9hY2NvdW50cy9hY2NvdW50SWQnLFxuICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ2F1dGgtdG9rZW4nOiB0b2tlblxuICAgICAgICB9LFxuICAgICAgICBqc29uOiB0cnVlXG4gICAgICB9O1xuXG4gICAgICByZXF1ZXN0U3R1Yi53aXRoQXJncyhvcHRzKS5yZXNvbHZlcyhleHBlY3RlZCk7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGRvbWFpbkNsaWVudC5yZXF1ZXN0KG9wdHMpO1xuICAgICAgc2lub24uYXNzZXJ0Lm1hdGNoKHJlc3BvbnNlLCBleHBlY3RlZCk7XG4gICAgICBzaW5vbi5hc3NlcnQuY2FsbGVkV2l0aChyZXF1ZXN0U3R1Yiwgb3B0cyk7XG4gICAgfSk7XG5cbiAgfSk7XG5cbn0pO1xuIl19