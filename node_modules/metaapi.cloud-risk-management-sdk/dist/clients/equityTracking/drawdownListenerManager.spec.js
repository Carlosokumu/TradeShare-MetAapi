'use strict';

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _drawdownListener = require('./drawdownListener');

var _drawdownListener2 = _interopRequireDefault(_drawdownListener);

var _drawdownListenerManager = require('./drawdownListenerManager');

var _drawdownListenerManager2 = _interopRequireDefault(_drawdownListenerManager);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @test {DrawdownListenerManager}
 */
describe('DrawdownListenerManager', () => {

  let domainClient = {
    requestApi: () => {}
  };
  let sandbox;
  let clock;
  let drawdownListenerManager;
  let getDrawdownStub, listener, callStub;

  let expected = [{
    sequenceNumber: 2,
    accountId: 'accountId',
    trackerId: 'trackerId',
    period: 'day',
    startBrokerTime: '2022-04-08 00:00:00.000',
    endBrokerTime: '2022-04-08 23:59:59.999',
    brokerTime: '2022-04-08 09:36:00.000',
    absoluteDrawdown: 250,
    relativeDrawdown: 0.25
  }, {
    sequenceNumber: 3,
    accountId: 'accountId',
    trackerId: 'trackerId',
    period: 'day',
    startBrokerTime: '2022-04-08 00:00:00.000',
    endBrokerTime: '2022-04-08 23:59:59.999',
    brokerTime: '2022-04-08 09:36:00.000',
    absoluteDrawdown: 250,
    relativeDrawdown: 0.25
  }];

  let expected2 = [{
    sequenceNumber: 4,
    accountId: 'accountId',
    trackerId: 'trackerId',
    period: 'day',
    startBrokerTime: '2022-04-08 00:00:00.000',
    endBrokerTime: '2022-04-08 23:59:59.999',
    brokerTime: '2022-04-08 09:36:00.000',
    absoluteDrawdown: 250,
    relativeDrawdown: 0.25
  }, {
    sequenceNumber: 5,
    accountId: 'accountId',
    trackerId: 'trackerId',
    period: 'day',
    startBrokerTime: '2022-04-08 00:00:00.000',
    endBrokerTime: '2022-04-08 23:59:59.999',
    brokerTime: '2022-04-08 09:36:00.000',
    absoluteDrawdown: 250,
    relativeDrawdown: 0.25
  }];

  before(() => {
    sandbox = _sinon2.default.createSandbox();
  });

  beforeEach(() => {
    clock = sandbox.useFakeTimers({ shouldAdvanceTime: true });
    drawdownListenerManager = new _drawdownListenerManager2.default(domainClient);
    getDrawdownStub = sandbox.stub(domainClient, 'requestApi');
    getDrawdownStub.callsFake(async opts => {
      await new _promise2.default(res => setTimeout(res, 1000));
      return [];
    }).withArgs({
      url: '/users/current/drawdown-events/stream',
      method: 'GET',
      qs: {
        previousSequenceNumber: 1,
        accountId: 'accountId',
        trackerId: 'trackerId',
        limit: 1000
      }
    }).callsFake(async opts => {
      await new _promise2.default(res => setTimeout(res, 1000));
      return expected;
    }).withArgs({
      url: '/users/current/drawdown-events/stream',
      method: 'GET',
      qs: {
        previousSequenceNumber: 3,
        accountId: 'accountId',
        trackerId: 'trackerId',
        limit: 1000
      }
    }).callsFake(async opts => {
      await new _promise2.default(res => setTimeout(res, 1000));
      return expected2;
    });

    callStub = _sinon2.default.stub();

    class Listener extends _drawdownListener2.default {

      async onDrawdown(drawdownEvent) {
        callStub(drawdownEvent);
      }

    }

    listener = new Listener();
  });

  afterEach(() => {
    sandbox.restore();
    clock.restore();
  });

  /**
   * @test {DrawdownListenerManager#addDrawdownListener}
   */
  it('should add drawdown listener', async () => {
    const id = drawdownListenerManager.addDrawdownListener(listener, 'accountId', 'trackerId', 1);
    await clock.tickAsync(2200);
    _sinon2.default.assert.callCount(callStub, 4);
    callStub.args[0][0].should.equal(expected[0]);
    callStub.args[1][0].should.equal(expected[1]);
    callStub.args[2][0].should.equal(expected2[0]);
    callStub.args[3][0].should.equal(expected2[1]);
    drawdownListenerManager.removeDrawdownListener(id);
  });

  /**
   * @test {DrawdownListenerManager#addDrawdownListener}
   */
  it('should remove drawdown listener', async () => {
    const id = drawdownListenerManager.addDrawdownListener(listener, 'accountId', 'trackerId', 1);
    await clock.tickAsync(800);
    drawdownListenerManager.removeDrawdownListener(id);
    await clock.tickAsync(2200);
    _sinon2.default.assert.calledWith(callStub, expected[0]);
    _sinon2.default.assert.calledWith(callStub, expected[1]);
    _sinon2.default.assert.callCount(callStub, 2);
  });

  /**
   * @test {DrawdownListenerManager#addDrawdownListener}
   */
  it('should wait if error returned', async () => {
    getDrawdownStub.callsFake(async opts => {
      await new _promise2.default(res => setTimeout(res, 500));
      return [];
    }).withArgs({
      url: '/users/current/drawdown-events/stream',
      method: 'GET',
      qs: {
        previousSequenceNumber: 1,
        accountId: 'accountId',
        trackerId: 'trackerId',
        limit: 1000
      }
    }).callsFake(async opts => {
      await new _promise2.default(res => setTimeout(res, 500));
      return expected;
    }).onFirstCall().rejects(new Error('test')).onSecondCall().rejects(new Error('test'));
    const id = drawdownListenerManager.addDrawdownListener(listener, 'accountId', 'trackerId', 1);
    await clock.tickAsync(600);
    _sinon2.default.assert.callCount(getDrawdownStub, 1);
    _sinon2.default.assert.notCalled(callStub);
    await clock.tickAsync(600);
    _sinon2.default.assert.callCount(getDrawdownStub, 2);
    _sinon2.default.assert.notCalled(callStub);
    await clock.tickAsync(2000);
    _sinon2.default.assert.callCount(getDrawdownStub, 3);
    _sinon2.default.assert.notCalled(callStub);
    await clock.tickAsync(800);
    _sinon2.default.assert.calledWith(callStub, expected[0]);
    _sinon2.default.assert.calledWith(callStub, expected[1]);
    drawdownListenerManager.removeDrawdownListener(id);
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9jbGllbnRzL2VxdWl0eVRyYWNraW5nL2RyYXdkb3duTGlzdGVuZXJNYW5hZ2VyLnNwZWMuZXM2Il0sIm5hbWVzIjpbImRlc2NyaWJlIiwiZG9tYWluQ2xpZW50IiwicmVxdWVzdEFwaSIsInNhbmRib3giLCJjbG9jayIsImRyYXdkb3duTGlzdGVuZXJNYW5hZ2VyIiwiZ2V0RHJhd2Rvd25TdHViIiwibGlzdGVuZXIiLCJjYWxsU3R1YiIsImV4cGVjdGVkIiwic2VxdWVuY2VOdW1iZXIiLCJhY2NvdW50SWQiLCJ0cmFja2VySWQiLCJwZXJpb2QiLCJzdGFydEJyb2tlclRpbWUiLCJlbmRCcm9rZXJUaW1lIiwiYnJva2VyVGltZSIsImFic29sdXRlRHJhd2Rvd24iLCJyZWxhdGl2ZURyYXdkb3duIiwiZXhwZWN0ZWQyIiwiYmVmb3JlIiwic2lub24iLCJjcmVhdGVTYW5kYm94IiwiYmVmb3JlRWFjaCIsInVzZUZha2VUaW1lcnMiLCJzaG91bGRBZHZhbmNlVGltZSIsIkRyYXdkb3duTGlzdGVuZXJNYW5hZ2VyIiwic3R1YiIsImNhbGxzRmFrZSIsIm9wdHMiLCJyZXMiLCJzZXRUaW1lb3V0Iiwid2l0aEFyZ3MiLCJ1cmwiLCJtZXRob2QiLCJxcyIsInByZXZpb3VzU2VxdWVuY2VOdW1iZXIiLCJsaW1pdCIsIkxpc3RlbmVyIiwiRHJhd2Rvd25MaXN0ZW5lciIsIm9uRHJhd2Rvd24iLCJkcmF3ZG93bkV2ZW50IiwiYWZ0ZXJFYWNoIiwicmVzdG9yZSIsIml0IiwiaWQiLCJhZGREcmF3ZG93bkxpc3RlbmVyIiwidGlja0FzeW5jIiwiYXNzZXJ0IiwiY2FsbENvdW50IiwiYXJncyIsInNob3VsZCIsImVxdWFsIiwicmVtb3ZlRHJhd2Rvd25MaXN0ZW5lciIsImNhbGxlZFdpdGgiLCJvbkZpcnN0Q2FsbCIsInJlamVjdHMiLCJFcnJvciIsIm9uU2Vjb25kQ2FsbCIsIm5vdENhbGxlZCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztBQUVBOzs7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JztcblxuaW1wb3J0IHNpbm9uIGZyb20gJ3Npbm9uJztcbmltcG9ydCBEcmF3ZG93bkxpc3RlbmVyIGZyb20gJy4vZHJhd2Rvd25MaXN0ZW5lcic7XG5pbXBvcnQgRHJhd2Rvd25MaXN0ZW5lck1hbmFnZXIgZnJvbSAnLi9kcmF3ZG93bkxpc3RlbmVyTWFuYWdlcic7XG5cbi8qKlxuICogQHRlc3Qge0RyYXdkb3duTGlzdGVuZXJNYW5hZ2VyfVxuICovXG5kZXNjcmliZSgnRHJhd2Rvd25MaXN0ZW5lck1hbmFnZXInLCAoKSA9PiB7XG5cbiAgbGV0IGRvbWFpbkNsaWVudCA9IHtcbiAgICByZXF1ZXN0QXBpOiAoKSA9PiB7fVxuICB9O1xuICBsZXQgc2FuZGJveDtcbiAgbGV0IGNsb2NrO1xuICBsZXQgZHJhd2Rvd25MaXN0ZW5lck1hbmFnZXI7XG4gIGxldCBnZXREcmF3ZG93blN0dWIsIGxpc3RlbmVyLCBjYWxsU3R1YjtcblxuICBsZXQgZXhwZWN0ZWQgPSBbe1xuICAgIHNlcXVlbmNlTnVtYmVyOiAyLFxuICAgIGFjY291bnRJZDogJ2FjY291bnRJZCcsXG4gICAgdHJhY2tlcklkOiAndHJhY2tlcklkJyxcbiAgICBwZXJpb2Q6ICdkYXknLFxuICAgIHN0YXJ0QnJva2VyVGltZTogJzIwMjItMDQtMDggMDA6MDA6MDAuMDAwJyxcbiAgICBlbmRCcm9rZXJUaW1lOiAnMjAyMi0wNC0wOCAyMzo1OTo1OS45OTknLFxuICAgIGJyb2tlclRpbWU6ICcyMDIyLTA0LTA4IDA5OjM2OjAwLjAwMCcsXG4gICAgYWJzb2x1dGVEcmF3ZG93bjogMjUwLFxuICAgIHJlbGF0aXZlRHJhd2Rvd246IDAuMjVcbiAgfSxcbiAge1xuICAgIHNlcXVlbmNlTnVtYmVyOiAzLFxuICAgIGFjY291bnRJZDogJ2FjY291bnRJZCcsXG4gICAgdHJhY2tlcklkOiAndHJhY2tlcklkJyxcbiAgICBwZXJpb2Q6ICdkYXknLFxuICAgIHN0YXJ0QnJva2VyVGltZTogJzIwMjItMDQtMDggMDA6MDA6MDAuMDAwJyxcbiAgICBlbmRCcm9rZXJUaW1lOiAnMjAyMi0wNC0wOCAyMzo1OTo1OS45OTknLFxuICAgIGJyb2tlclRpbWU6ICcyMDIyLTA0LTA4IDA5OjM2OjAwLjAwMCcsXG4gICAgYWJzb2x1dGVEcmF3ZG93bjogMjUwLFxuICAgIHJlbGF0aXZlRHJhd2Rvd246IDAuMjVcbiAgfV07XG5cbiAgbGV0IGV4cGVjdGVkMiA9IFt7XG4gICAgc2VxdWVuY2VOdW1iZXI6IDQsXG4gICAgYWNjb3VudElkOiAnYWNjb3VudElkJyxcbiAgICB0cmFja2VySWQ6ICd0cmFja2VySWQnLFxuICAgIHBlcmlvZDogJ2RheScsXG4gICAgc3RhcnRCcm9rZXJUaW1lOiAnMjAyMi0wNC0wOCAwMDowMDowMC4wMDAnLFxuICAgIGVuZEJyb2tlclRpbWU6ICcyMDIyLTA0LTA4IDIzOjU5OjU5Ljk5OScsXG4gICAgYnJva2VyVGltZTogJzIwMjItMDQtMDggMDk6MzY6MDAuMDAwJyxcbiAgICBhYnNvbHV0ZURyYXdkb3duOiAyNTAsXG4gICAgcmVsYXRpdmVEcmF3ZG93bjogMC4yNVxuICB9LFxuICB7XG4gICAgc2VxdWVuY2VOdW1iZXI6IDUsXG4gICAgYWNjb3VudElkOiAnYWNjb3VudElkJyxcbiAgICB0cmFja2VySWQ6ICd0cmFja2VySWQnLFxuICAgIHBlcmlvZDogJ2RheScsXG4gICAgc3RhcnRCcm9rZXJUaW1lOiAnMjAyMi0wNC0wOCAwMDowMDowMC4wMDAnLFxuICAgIGVuZEJyb2tlclRpbWU6ICcyMDIyLTA0LTA4IDIzOjU5OjU5Ljk5OScsXG4gICAgYnJva2VyVGltZTogJzIwMjItMDQtMDggMDk6MzY6MDAuMDAwJyxcbiAgICBhYnNvbHV0ZURyYXdkb3duOiAyNTAsXG4gICAgcmVsYXRpdmVEcmF3ZG93bjogMC4yNVxuICB9XTtcblxuXG4gIGJlZm9yZSgoKSA9PiB7XG4gICAgc2FuZGJveCA9IHNpbm9uLmNyZWF0ZVNhbmRib3goKTtcbiAgfSk7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgY2xvY2sgPSBzYW5kYm94LnVzZUZha2VUaW1lcnMoe3Nob3VsZEFkdmFuY2VUaW1lOiB0cnVlfSk7XG4gICAgZHJhd2Rvd25MaXN0ZW5lck1hbmFnZXIgPSBuZXcgRHJhd2Rvd25MaXN0ZW5lck1hbmFnZXIoZG9tYWluQ2xpZW50KTtcbiAgICBnZXREcmF3ZG93blN0dWIgPSBzYW5kYm94LnN0dWIoZG9tYWluQ2xpZW50LCAncmVxdWVzdEFwaScpO1xuICAgIGdldERyYXdkb3duU3R1YlxuICAgICAgLmNhbGxzRmFrZShhc3luYyAob3B0cykgPT4ge1xuICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXMgPT4gc2V0VGltZW91dChyZXMsIDEwMDApKTtcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgfSlcbiAgICAgIC53aXRoQXJncyh7XG4gICAgICAgIHVybDogJy91c2Vycy9jdXJyZW50L2RyYXdkb3duLWV2ZW50cy9zdHJlYW0nLFxuICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICBxczoge1xuICAgICAgICAgIHByZXZpb3VzU2VxdWVuY2VOdW1iZXI6IDEsXG4gICAgICAgICAgYWNjb3VudElkOiAnYWNjb3VudElkJyxcbiAgICAgICAgICB0cmFja2VySWQ6ICd0cmFja2VySWQnLFxuICAgICAgICAgIGxpbWl0OiAxMDAwXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICAuY2FsbHNGYWtlKGFzeW5jIChvcHRzKSA9PiB7XG4gICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlcyA9PiBzZXRUaW1lb3V0KHJlcywgMTAwMCkpO1xuICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7XG4gICAgICB9KVxuICAgICAgLndpdGhBcmdzKHtcbiAgICAgICAgdXJsOiAnL3VzZXJzL2N1cnJlbnQvZHJhd2Rvd24tZXZlbnRzL3N0cmVhbScsXG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgIHFzOiB7XG4gICAgICAgICAgcHJldmlvdXNTZXF1ZW5jZU51bWJlcjogMyxcbiAgICAgICAgICBhY2NvdW50SWQ6ICdhY2NvdW50SWQnLFxuICAgICAgICAgIHRyYWNrZXJJZDogJ3RyYWNrZXJJZCcsXG4gICAgICAgICAgbGltaXQ6IDEwMDBcbiAgICAgICAgfVxuICAgICAgfSkuY2FsbHNGYWtlKGFzeW5jIChvcHRzKSA9PiB7XG4gICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlcyA9PiBzZXRUaW1lb3V0KHJlcywgMTAwMCkpO1xuICAgICAgICByZXR1cm4gZXhwZWN0ZWQyO1xuICAgICAgfSk7XG5cbiAgICBjYWxsU3R1YiA9IHNpbm9uLnN0dWIoKTtcblxuICAgIGNsYXNzIExpc3RlbmVyIGV4dGVuZHMgRHJhd2Rvd25MaXN0ZW5lciB7XG5cbiAgICAgIGFzeW5jIG9uRHJhd2Rvd24oZHJhd2Rvd25FdmVudCkge1xuICAgICAgICBjYWxsU3R1YihkcmF3ZG93bkV2ZW50KTtcbiAgICAgIH1cblxuICAgIH1cblxuICAgIGxpc3RlbmVyID0gbmV3IExpc3RlbmVyKCk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgc2FuZGJveC5yZXN0b3JlKCk7XG4gICAgY2xvY2sucmVzdG9yZSgpO1xuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge0RyYXdkb3duTGlzdGVuZXJNYW5hZ2VyI2FkZERyYXdkb3duTGlzdGVuZXJ9XG4gICAqL1xuICBpdCgnc2hvdWxkIGFkZCBkcmF3ZG93biBsaXN0ZW5lcicsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBpZCA9IGRyYXdkb3duTGlzdGVuZXJNYW5hZ2VyLmFkZERyYXdkb3duTGlzdGVuZXIobGlzdGVuZXIsICdhY2NvdW50SWQnLCAndHJhY2tlcklkJywgMSk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDIyMDApO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsQ291bnQoY2FsbFN0dWIsIDQpO1xuICAgIGNhbGxTdHViLmFyZ3NbMF1bMF0uc2hvdWxkLmVxdWFsKGV4cGVjdGVkWzBdKTtcbiAgICBjYWxsU3R1Yi5hcmdzWzFdWzBdLnNob3VsZC5lcXVhbChleHBlY3RlZFsxXSk7XG4gICAgY2FsbFN0dWIuYXJnc1syXVswXS5zaG91bGQuZXF1YWwoZXhwZWN0ZWQyWzBdKTtcbiAgICBjYWxsU3R1Yi5hcmdzWzNdWzBdLnNob3VsZC5lcXVhbChleHBlY3RlZDJbMV0pO1xuICAgIGRyYXdkb3duTGlzdGVuZXJNYW5hZ2VyLnJlbW92ZURyYXdkb3duTGlzdGVuZXIoaWQpO1xuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge0RyYXdkb3duTGlzdGVuZXJNYW5hZ2VyI2FkZERyYXdkb3duTGlzdGVuZXJ9XG4gICAqL1xuICBpdCgnc2hvdWxkIHJlbW92ZSBkcmF3ZG93biBsaXN0ZW5lcicsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBpZCA9IGRyYXdkb3duTGlzdGVuZXJNYW5hZ2VyLmFkZERyYXdkb3duTGlzdGVuZXIobGlzdGVuZXIsICdhY2NvdW50SWQnLCAndHJhY2tlcklkJywgMSk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDgwMCk7XG4gICAgZHJhd2Rvd25MaXN0ZW5lck1hbmFnZXIucmVtb3ZlRHJhd2Rvd25MaXN0ZW5lcihpZCk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDIyMDApO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKGNhbGxTdHViLCBleHBlY3RlZFswXSk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZFdpdGgoY2FsbFN0dWIsIGV4cGVjdGVkWzFdKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbENvdW50KGNhbGxTdHViLCAyKTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtEcmF3ZG93bkxpc3RlbmVyTWFuYWdlciNhZGREcmF3ZG93bkxpc3RlbmVyfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCB3YWl0IGlmIGVycm9yIHJldHVybmVkJywgYXN5bmMgKCkgPT4ge1xuICAgIGdldERyYXdkb3duU3R1YlxuICAgICAgLmNhbGxzRmFrZShhc3luYyAob3B0cykgPT4ge1xuICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXMgPT4gc2V0VGltZW91dChyZXMsIDUwMCkpO1xuICAgICAgICByZXR1cm4gW107XG4gICAgICB9KVxuICAgICAgLndpdGhBcmdzKHtcbiAgICAgICAgdXJsOiAnL3VzZXJzL2N1cnJlbnQvZHJhd2Rvd24tZXZlbnRzL3N0cmVhbScsXG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgIHFzOiB7XG4gICAgICAgICAgcHJldmlvdXNTZXF1ZW5jZU51bWJlcjogMSxcbiAgICAgICAgICBhY2NvdW50SWQ6ICdhY2NvdW50SWQnLFxuICAgICAgICAgIHRyYWNrZXJJZDogJ3RyYWNrZXJJZCcsXG4gICAgICAgICAgbGltaXQ6IDEwMDBcbiAgICAgICAgfVxuICAgICAgfSkuY2FsbHNGYWtlKGFzeW5jIChvcHRzKSA9PiB7XG4gICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlcyA9PiBzZXRUaW1lb3V0KHJlcywgNTAwKSk7XG4gICAgICAgIHJldHVybiBleHBlY3RlZDtcbiAgICAgIH0pXG4gICAgICAub25GaXJzdENhbGwoKS5yZWplY3RzKG5ldyBFcnJvcigndGVzdCcpKVxuICAgICAgLm9uU2Vjb25kQ2FsbCgpLnJlamVjdHMobmV3IEVycm9yKCd0ZXN0JykpO1xuICAgIGNvbnN0IGlkID0gZHJhd2Rvd25MaXN0ZW5lck1hbmFnZXIuYWRkRHJhd2Rvd25MaXN0ZW5lcihsaXN0ZW5lciwgJ2FjY291bnRJZCcsICd0cmFja2VySWQnLCAxKTtcbiAgICBhd2FpdCBjbG9jay50aWNrQXN5bmMoNjAwKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbENvdW50KGdldERyYXdkb3duU3R1YiwgMSk7XG4gICAgc2lub24uYXNzZXJ0Lm5vdENhbGxlZChjYWxsU3R1Yik7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDYwMCk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxDb3VudChnZXREcmF3ZG93blN0dWIsIDIpO1xuICAgIHNpbm9uLmFzc2VydC5ub3RDYWxsZWQoY2FsbFN0dWIpO1xuICAgIGF3YWl0IGNsb2NrLnRpY2tBc3luYygyMDAwKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbENvdW50KGdldERyYXdkb3duU3R1YiwgMyk7XG4gICAgc2lub24uYXNzZXJ0Lm5vdENhbGxlZChjYWxsU3R1Yik7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDgwMCk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZFdpdGgoY2FsbFN0dWIsIGV4cGVjdGVkWzBdKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbGVkV2l0aChjYWxsU3R1YiwgZXhwZWN0ZWRbMV0pO1xuICAgIGRyYXdkb3duTGlzdGVuZXJNYW5hZ2VyLnJlbW92ZURyYXdkb3duTGlzdGVuZXIoaWQpO1xuICB9KTtcblxufSk7XG4iXX0=