/**
 * 
 */'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _metaApi = require('../../metaApi.client');

var _metaApi2 = _interopRequireDefault(_metaApi);

var _randomstring = require('randomstring');

var _randomstring2 = _interopRequireDefault(_randomstring);

var _logger = require('../../../logger');

var _logger2 = _interopRequireDefault(_logger);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Transaction event listener manager
 */
class TransactionListenerManager extends _metaApi2.default {

  /**
   * Constructs transaction event listener manager instance
   * @param {DomainClient} domainClient domain client
   */
  constructor(domainClient) {
    super(domainClient);
    this._domainClient = domainClient;
    this._strategyTransactionListeners = {};
    this._subscriberTransactionListeners = {};
    this._errorThrottleTime = 1000;
    this._logger = _logger2.default.getLogger('TransactionListenerManager');
  }

  /**
   * Returns the dictionary of strategy transaction listeners
   * @returns {Object} dictionary of strategy transaction listeners
   */
  get strategyTransactionListeners() {
    return this._strategyTransactionListeners;
  }

  /**
   * Returns the dictionary of subscriber transaction listeners
   * @returns {Object} dictionary of subscriber transaction listeners
   */
  get subscriberTransactionListeners() {
    return this._subscriberTransactionListeners;
  }

  /**
   * Adds a strategy transaction listener
   * @param {UserTransactionListener} listener user transaction listener
   * @param {String} strategyId strategy id
   * @param {Date} [startTime] transaction search start time
   * @returns {String} strategy transaction listener id
   */
  addStrategyTransactionListener(listener, strategyId, startTime) {
    const listenerId = _randomstring2.default.generate(10);
    this._strategyTransactionListeners[listenerId] = listener;
    this._startStrategyTransactionStreamJob(listenerId, listener, strategyId, startTime);
    return listenerId;
  }

  /**
   * Adds a subscriber transaction listener
   * @param {UserTransactionListener} listener user transaction listener
   * @param {String} subscriberId subscriber id
   * @param {Date} [startTime] transaction search start time
   * @returns {String} subscriber transaction listener id
   */
  addSubscriberTransactionListener(listener, subscriberId, startTime) {
    const listenerId = _randomstring2.default.generate(10);
    this._subscriberTransactionListeners[listenerId] = listener;
    this._startSubscriberTransactionStreamJob(listenerId, listener, subscriberId, startTime);
    return listenerId;
  }

  /**
   * Removes strategy transaction listener by id
   * @param {String} listenerId listener id 
   */
  removeStrategyTransactionListener(listenerId) {
    delete this._strategyTransactionListeners[listenerId];
  }

  /**
   * Removes subscriber transaction listener by id
   * @param {String} listenerId listener id 
   */
  removeSubscriberTransactionListener(listenerId) {
    delete this._subscriberTransactionListeners[listenerId];
  }

  async _startStrategyTransactionStreamJob(listenerId, listener, strategyId, startTime) {
    let throttleTime = this._errorThrottleTime;

    while (this._strategyTransactionListeners[listenerId]) {
      const opts = {
        url: `/users/current/strategies/${strategyId}/transactions/stream`,
        method: 'GET',
        qs: {
          startTime,
          limit: 1000
        },
        headers: {
          'auth-token': this._token
        },
        json: true
      };
      try {
        const packets = await this._domainClient.requestCopyFactory(opts, true);
        await listener.onTransaction(packets);
        throttleTime = this._errorThrottleTime;
        if (this._strategyTransactionListeners[listenerId] && packets.length) {
          startTime = new Date(new Date(packets[0].time).getTime() + 1);
        }
      } catch (err) {
        if (err.name === 'NotFoundError') {
          this._logger.error(`Strategy ${strategyId} not found, removing listener ${listenerId}`);
          delete this._strategyTransactionListeners[listenerId];
        } else {
          await new _promise2.default(res => setTimeout(res, throttleTime));
          throttleTime = Math.min(throttleTime * 2, 30000);
        }
      }
    }
  }

  async _startSubscriberTransactionStreamJob(listenerId, listener, subscriberId, startTime) {
    let throttleTime = this._errorThrottleTime;

    while (this._subscriberTransactionListeners[listenerId]) {
      const opts = {
        url: `/users/current/subscribers/${subscriberId}/transactions/stream`,
        method: 'GET',
        qs: {
          startTime,
          limit: 1000
        },
        headers: {
          'auth-token': this._token
        },
        json: true
      };
      try {
        const packets = await this._domainClient.requestCopyFactory(opts, true);
        await listener.onTransaction(packets);
        throttleTime = this._errorThrottleTime;
        if (this._subscriberTransactionListeners[listenerId] && packets.length) {
          startTime = new Date(new Date(packets[0].time).getTime() + 1);
        }
      } catch (err) {
        if (err.name === 'NotFoundError') {
          this._logger.error(`Subscriber ${subscriberId} not found, removing listener ${listenerId}`);
          delete this._subscriberTransactionListeners[listenerId];
        } else {
          await new _promise2.default(res => setTimeout(res, throttleTime));
          throttleTime = Math.min(throttleTime * 2, 30000);
        }
      }
    }
  }

}
exports.default = TransactionListenerManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2xpYi9jbGllbnRzL2NvcHlGYWN0b3J5L3N0cmVhbWluZy90cmFuc2FjdGlvbkxpc3RlbmVyTWFuYWdlci5lczYiXSwibmFtZXMiOlsiVHJhbnNhY3Rpb25MaXN0ZW5lck1hbmFnZXIiLCJNZXRhQXBpQ2xpZW50IiwiY29uc3RydWN0b3IiLCJkb21haW5DbGllbnQiLCJfZG9tYWluQ2xpZW50IiwiX3N0cmF0ZWd5VHJhbnNhY3Rpb25MaXN0ZW5lcnMiLCJfc3Vic2NyaWJlclRyYW5zYWN0aW9uTGlzdGVuZXJzIiwiX2Vycm9yVGhyb3R0bGVUaW1lIiwiX2xvZ2dlciIsIkxvZ2dlck1hbmFnZXIiLCJnZXRMb2dnZXIiLCJzdHJhdGVneVRyYW5zYWN0aW9uTGlzdGVuZXJzIiwic3Vic2NyaWJlclRyYW5zYWN0aW9uTGlzdGVuZXJzIiwiYWRkU3RyYXRlZ3lUcmFuc2FjdGlvbkxpc3RlbmVyIiwibGlzdGVuZXIiLCJzdHJhdGVneUlkIiwic3RhcnRUaW1lIiwibGlzdGVuZXJJZCIsInJhbmRvbXN0cmluZyIsImdlbmVyYXRlIiwiX3N0YXJ0U3RyYXRlZ3lUcmFuc2FjdGlvblN0cmVhbUpvYiIsImFkZFN1YnNjcmliZXJUcmFuc2FjdGlvbkxpc3RlbmVyIiwic3Vic2NyaWJlcklkIiwiX3N0YXJ0U3Vic2NyaWJlclRyYW5zYWN0aW9uU3RyZWFtSm9iIiwicmVtb3ZlU3RyYXRlZ3lUcmFuc2FjdGlvbkxpc3RlbmVyIiwicmVtb3ZlU3Vic2NyaWJlclRyYW5zYWN0aW9uTGlzdGVuZXIiLCJ0aHJvdHRsZVRpbWUiLCJvcHRzIiwidXJsIiwibWV0aG9kIiwicXMiLCJsaW1pdCIsImhlYWRlcnMiLCJfdG9rZW4iLCJqc29uIiwicGFja2V0cyIsInJlcXVlc3RDb3B5RmFjdG9yeSIsIm9uVHJhbnNhY3Rpb24iLCJsZW5ndGgiLCJEYXRlIiwidGltZSIsImdldFRpbWUiLCJlcnIiLCJuYW1lIiwiZXJyb3IiLCJyZXMiLCJzZXRUaW1lb3V0IiwiTWF0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QTBCQyxPQUExQixLQUFzQyxDQUEvQyxDQUFaO0FBQ0Q7QUFDRixPQVBELENBT0UsT0FBT0MsR0FBUCxFQUFZO0FBQ1osWUFBSUEsSUFBSUMsSUFBSixLQUFhLGVBQWpCLEVBQWtDO0FBQ2hDLGVBQUtuQyxPQUFMLENBQWFvQyxLQUFiLENBQW9CLGNBQWF0QixZQUFhLGlDQUFnQ0wsVUFBVyxFQUF6RjtBQUNBLGlCQUFPLEtBQUtYLCtCQUFMLENBQXFDVyxVQUFyQyxDQUFQO0FBQ0QsU0FIRCxNQUdPO0FBQ0wsZ0JBQU0sc0JBQVk0QixPQUFPQyxXQUFXRCxHQUFYLEVBQWdCbkIsWUFBaEIsQ0FBbkIsQ0FBTjtBQUNBQSx5QkFBZXFCLEtBQUtDLEdBQUwsQ0FBU3RCLGVBQWUsQ0FBeEIsRUFBMkIsS0FBM0IsQ0FBZjtBQUNEO0FBQ0Y7QUFDRjtBQUNGOztBQS9JbUU7a0JBQWpEMUIsMEIiLCJmaWxlIjoidHJhbnNhY3Rpb25MaXN0ZW5lck1hbmFnZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFxuICovJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgTWV0YUFwaUNsaWVudCBmcm9tICcuLi8uLi9tZXRhQXBpLmNsaWVudCc7XG5pbXBvcnQgcmFuZG9tc3RyaW5nIGZyb20gJ3JhbmRvbXN0cmluZyc7XG5pbXBvcnQgTG9nZ2VyTWFuYWdlciBmcm9tICcuLi8uLi8uLi9sb2dnZXInO1xuXG4vKipcbiAqIFRyYW5zYWN0aW9uIGV2ZW50IGxpc3RlbmVyIG1hbmFnZXJcbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVHJhbnNhY3Rpb25MaXN0ZW5lck1hbmFnZXIgZXh0ZW5kcyBNZXRhQXBpQ2xpZW50IHtcblxuICAvKipcbiAgICogQ29uc3RydWN0cyB0cmFuc2FjdGlvbiBldmVudCBsaXN0ZW5lciBtYW5hZ2VyIGluc3RhbmNlXG4gICAqIEBwYXJhbSB7RG9tYWluQ2xpZW50fSBkb21haW5DbGllbnQgZG9tYWluIGNsaWVudFxuICAgKi9cbiAgY29uc3RydWN0b3IoZG9tYWluQ2xpZW50KSB7XG4gICAgc3VwZXIoZG9tYWluQ2xpZW50KTtcbiAgICB0aGlzLl9kb21haW5DbGllbnQgPSBkb21haW5DbGllbnQ7XG4gICAgdGhpcy5fc3RyYXRlZ3lUcmFuc2FjdGlvbkxpc3RlbmVycyA9IHt9O1xuICAgIHRoaXMuX3N1YnNjcmliZXJUcmFuc2FjdGlvbkxpc3RlbmVycyA9IHt9O1xuICAgIHRoaXMuX2Vycm9yVGhyb3R0bGVUaW1lID0gMTAwMDtcbiAgICB0aGlzLl9sb2dnZXIgPSBMb2dnZXJNYW5hZ2VyLmdldExvZ2dlcignVHJhbnNhY3Rpb25MaXN0ZW5lck1hbmFnZXInKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBkaWN0aW9uYXJ5IG9mIHN0cmF0ZWd5IHRyYW5zYWN0aW9uIGxpc3RlbmVyc1xuICAgKiBAcmV0dXJucyB7T2JqZWN0fSBkaWN0aW9uYXJ5IG9mIHN0cmF0ZWd5IHRyYW5zYWN0aW9uIGxpc3RlbmVyc1xuICAgKi9cbiAgZ2V0IHN0cmF0ZWd5VHJhbnNhY3Rpb25MaXN0ZW5lcnMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3N0cmF0ZWd5VHJhbnNhY3Rpb25MaXN0ZW5lcnM7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgZGljdGlvbmFyeSBvZiBzdWJzY3JpYmVyIHRyYW5zYWN0aW9uIGxpc3RlbmVyc1xuICAgKiBAcmV0dXJucyB7T2JqZWN0fSBkaWN0aW9uYXJ5IG9mIHN1YnNjcmliZXIgdHJhbnNhY3Rpb24gbGlzdGVuZXJzXG4gICAqL1xuICBnZXQgc3Vic2NyaWJlclRyYW5zYWN0aW9uTGlzdGVuZXJzKCkge1xuICAgIHJldHVybiB0aGlzLl9zdWJzY3JpYmVyVHJhbnNhY3Rpb25MaXN0ZW5lcnM7XG4gIH1cblxuICAvKipcbiAgICogQWRkcyBhIHN0cmF0ZWd5IHRyYW5zYWN0aW9uIGxpc3RlbmVyXG4gICAqIEBwYXJhbSB7VXNlclRyYW5zYWN0aW9uTGlzdGVuZXJ9IGxpc3RlbmVyIHVzZXIgdHJhbnNhY3Rpb24gbGlzdGVuZXJcbiAgICogQHBhcmFtIHtTdHJpbmd9IHN0cmF0ZWd5SWQgc3RyYXRlZ3kgaWRcbiAgICogQHBhcmFtIHtEYXRlfSBbc3RhcnRUaW1lXSB0cmFuc2FjdGlvbiBzZWFyY2ggc3RhcnQgdGltZVxuICAgKiBAcmV0dXJucyB7U3RyaW5nfSBzdHJhdGVneSB0cmFuc2FjdGlvbiBsaXN0ZW5lciBpZFxuICAgKi9cbiAgYWRkU3RyYXRlZ3lUcmFuc2FjdGlvbkxpc3RlbmVyKGxpc3RlbmVyLCBzdHJhdGVneUlkLCBzdGFydFRpbWUpIHtcbiAgICBjb25zdCBsaXN0ZW5lcklkID0gcmFuZG9tc3RyaW5nLmdlbmVyYXRlKDEwKTtcbiAgICB0aGlzLl9zdHJhdGVneVRyYW5zYWN0aW9uTGlzdGVuZXJzW2xpc3RlbmVySWRdID0gbGlzdGVuZXI7XG4gICAgdGhpcy5fc3RhcnRTdHJhdGVneVRyYW5zYWN0aW9uU3RyZWFtSm9iKGxpc3RlbmVySWQsIGxpc3RlbmVyLCBzdHJhdGVneUlkLCBzdGFydFRpbWUpO1xuICAgIHJldHVybiBsaXN0ZW5lcklkO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZHMgYSBzdWJzY3JpYmVyIHRyYW5zYWN0aW9uIGxpc3RlbmVyXG4gICAqIEBwYXJhbSB7VXNlclRyYW5zYWN0aW9uTGlzdGVuZXJ9IGxpc3RlbmVyIHVzZXIgdHJhbnNhY3Rpb24gbGlzdGVuZXJcbiAgICogQHBhcmFtIHtTdHJpbmd9IHN1YnNjcmliZXJJZCBzdWJzY3JpYmVyIGlkXG4gICAqIEBwYXJhbSB7RGF0ZX0gW3N0YXJ0VGltZV0gdHJhbnNhY3Rpb24gc2VhcmNoIHN0YXJ0IHRpbWVcbiAgICogQHJldHVybnMge1N0cmluZ30gc3Vic2NyaWJlciB0cmFuc2FjdGlvbiBsaXN0ZW5lciBpZFxuICAgKi9cbiAgYWRkU3Vic2NyaWJlclRyYW5zYWN0aW9uTGlzdGVuZXIobGlzdGVuZXIsIHN1YnNjcmliZXJJZCwgc3RhcnRUaW1lKSB7XG4gICAgY29uc3QgbGlzdGVuZXJJZCA9IHJhbmRvbXN0cmluZy5nZW5lcmF0ZSgxMCk7XG4gICAgdGhpcy5fc3Vic2NyaWJlclRyYW5zYWN0aW9uTGlzdGVuZXJzW2xpc3RlbmVySWRdID0gbGlzdGVuZXI7XG4gICAgdGhpcy5fc3RhcnRTdWJzY3JpYmVyVHJhbnNhY3Rpb25TdHJlYW1Kb2IobGlzdGVuZXJJZCwgbGlzdGVuZXIsIHN1YnNjcmliZXJJZCwgc3RhcnRUaW1lKTtcbiAgICByZXR1cm4gbGlzdGVuZXJJZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmVzIHN0cmF0ZWd5IHRyYW5zYWN0aW9uIGxpc3RlbmVyIGJ5IGlkXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBsaXN0ZW5lcklkIGxpc3RlbmVyIGlkIFxuICAgKi9cbiAgcmVtb3ZlU3RyYXRlZ3lUcmFuc2FjdGlvbkxpc3RlbmVyKGxpc3RlbmVySWQpIHtcbiAgICBkZWxldGUgdGhpcy5fc3RyYXRlZ3lUcmFuc2FjdGlvbkxpc3RlbmVyc1tsaXN0ZW5lcklkXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmVzIHN1YnNjcmliZXIgdHJhbnNhY3Rpb24gbGlzdGVuZXIgYnkgaWRcbiAgICogQHBhcmFtIHtTdHJpbmd9IGxpc3RlbmVySWQgbGlzdGVuZXIgaWQgXG4gICAqL1xuICByZW1vdmVTdWJzY3JpYmVyVHJhbnNhY3Rpb25MaXN0ZW5lcihsaXN0ZW5lcklkKSB7XG4gICAgZGVsZXRlIHRoaXMuX3N1YnNjcmliZXJUcmFuc2FjdGlvbkxpc3RlbmVyc1tsaXN0ZW5lcklkXTtcbiAgfVxuXG4gIGFzeW5jIF9zdGFydFN0cmF0ZWd5VHJhbnNhY3Rpb25TdHJlYW1Kb2IobGlzdGVuZXJJZCwgbGlzdGVuZXIsIHN0cmF0ZWd5SWQsIHN0YXJ0VGltZSkge1xuICAgIGxldCB0aHJvdHRsZVRpbWUgPSB0aGlzLl9lcnJvclRocm90dGxlVGltZTtcblxuICAgIHdoaWxlKHRoaXMuX3N0cmF0ZWd5VHJhbnNhY3Rpb25MaXN0ZW5lcnNbbGlzdGVuZXJJZF0pIHtcbiAgICAgIGNvbnN0IG9wdHMgPSB7XG4gICAgICAgIHVybDogYC91c2Vycy9jdXJyZW50L3N0cmF0ZWdpZXMvJHtzdHJhdGVneUlkfS90cmFuc2FjdGlvbnMvc3RyZWFtYCxcbiAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgcXM6IHtcbiAgICAgICAgICBzdGFydFRpbWUsXG4gICAgICAgICAgbGltaXQ6IDEwMDBcbiAgICAgICAgfSxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdhdXRoLXRva2VuJzogdGhpcy5fdG9rZW5cbiAgICAgICAgfSxcbiAgICAgICAganNvbjogdHJ1ZVxuICAgICAgfTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHBhY2tldHMgPSBhd2FpdCB0aGlzLl9kb21haW5DbGllbnQucmVxdWVzdENvcHlGYWN0b3J5KG9wdHMsIHRydWUpO1xuICAgICAgICBhd2FpdCBsaXN0ZW5lci5vblRyYW5zYWN0aW9uKHBhY2tldHMpO1xuICAgICAgICB0aHJvdHRsZVRpbWUgPSB0aGlzLl9lcnJvclRocm90dGxlVGltZTtcbiAgICAgICAgaWYodGhpcy5fc3RyYXRlZ3lUcmFuc2FjdGlvbkxpc3RlbmVyc1tsaXN0ZW5lcklkXSAmJiBwYWNrZXRzLmxlbmd0aCkge1xuICAgICAgICAgIHN0YXJ0VGltZSA9IG5ldyBEYXRlKG5ldyBEYXRlKHBhY2tldHNbMF0udGltZSkuZ2V0VGltZSgpICsgMSk7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBpZiAoZXJyLm5hbWUgPT09ICdOb3RGb3VuZEVycm9yJykge1xuICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihgU3RyYXRlZ3kgJHtzdHJhdGVneUlkfSBub3QgZm91bmQsIHJlbW92aW5nIGxpc3RlbmVyICR7bGlzdGVuZXJJZH1gKTtcbiAgICAgICAgICBkZWxldGUgdGhpcy5fc3RyYXRlZ3lUcmFuc2FjdGlvbkxpc3RlbmVyc1tsaXN0ZW5lcklkXTsgXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzID0+IHNldFRpbWVvdXQocmVzLCB0aHJvdHRsZVRpbWUpKTtcbiAgICAgICAgICB0aHJvdHRsZVRpbWUgPSBNYXRoLm1pbih0aHJvdHRsZVRpbWUgKiAyLCAzMDAwMCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBfc3RhcnRTdWJzY3JpYmVyVHJhbnNhY3Rpb25TdHJlYW1Kb2IobGlzdGVuZXJJZCwgbGlzdGVuZXIsIHN1YnNjcmliZXJJZCwgc3RhcnRUaW1lKSB7XG4gICAgbGV0IHRocm90dGxlVGltZSA9IHRoaXMuX2Vycm9yVGhyb3R0bGVUaW1lO1xuXG4gICAgd2hpbGUodGhpcy5fc3Vic2NyaWJlclRyYW5zYWN0aW9uTGlzdGVuZXJzW2xpc3RlbmVySWRdKSB7XG4gICAgICBjb25zdCBvcHRzID0ge1xuICAgICAgICB1cmw6IGAvdXNlcnMvY3VycmVudC9zdWJzY3JpYmVycy8ke3N1YnNjcmliZXJJZH0vdHJhbnNhY3Rpb25zL3N0cmVhbWAsXG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgIHFzOiB7XG4gICAgICAgICAgc3RhcnRUaW1lLFxuICAgICAgICAgIGxpbWl0OiAxMDAwXG4gICAgICAgIH0sXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnYXV0aC10b2tlbic6IHRoaXMuX3Rva2VuXG4gICAgICAgIH0sXG4gICAgICAgIGpzb246IHRydWVcbiAgICAgIH07XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBwYWNrZXRzID0gYXdhaXQgdGhpcy5fZG9tYWluQ2xpZW50LnJlcXVlc3RDb3B5RmFjdG9yeShvcHRzLCB0cnVlKTtcbiAgICAgICAgYXdhaXQgbGlzdGVuZXIub25UcmFuc2FjdGlvbihwYWNrZXRzKTtcbiAgICAgICAgdGhyb3R0bGVUaW1lID0gdGhpcy5fZXJyb3JUaHJvdHRsZVRpbWU7XG4gICAgICAgIGlmKHRoaXMuX3N1YnNjcmliZXJUcmFuc2FjdGlvbkxpc3RlbmVyc1tsaXN0ZW5lcklkXSAmJiBwYWNrZXRzLmxlbmd0aCkge1xuICAgICAgICAgIHN0YXJ0VGltZSA9IG5ldyBEYXRlKG5ldyBEYXRlKHBhY2tldHNbMF0udGltZSkuZ2V0VGltZSgpICsgMSk7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBpZiAoZXJyLm5hbWUgPT09ICdOb3RGb3VuZEVycm9yJykge1xuICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihgU3Vic2NyaWJlciAke3N1YnNjcmliZXJJZH0gbm90IGZvdW5kLCByZW1vdmluZyBsaXN0ZW5lciAke2xpc3RlbmVySWR9YCk7XG4gICAgICAgICAgZGVsZXRlIHRoaXMuX3N1YnNjcmliZXJUcmFuc2FjdGlvbkxpc3RlbmVyc1tsaXN0ZW5lcklkXTsgXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzID0+IHNldFRpbWVvdXQocmVzLCB0aHJvdHRsZVRpbWUpKTtcbiAgICAgICAgICB0aHJvdHRsZVRpbWUgPSBNYXRoLm1pbih0aHJvdHRsZVRpbWUgKiAyLCAzMDAwMCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxufVxuIl19