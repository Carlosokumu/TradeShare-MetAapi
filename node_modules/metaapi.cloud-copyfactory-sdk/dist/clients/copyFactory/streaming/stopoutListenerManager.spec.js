'use strict';

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _httpClient = require('../../httpClient');

var _httpClient2 = _interopRequireDefault(_httpClient);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _domain = require('../../domain.client');

var _domain2 = _interopRequireDefault(_domain);

var _stopoutListener = require('./stopoutListener');

var _stopoutListener2 = _interopRequireDefault(_stopoutListener);

var _stopoutListenerManager = require('./stopoutListenerManager');

var _stopoutListenerManager2 = _interopRequireDefault(_stopoutListenerManager);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @test {StopoutListenerManager}
 */
describe('StopoutListenerManager', () => {

  const token = 'header.payload.sign';
  let httpClient = new _httpClient2.default();
  let domainClient;
  let sandbox;
  let clock;
  let stopoutListenerManager;
  let getStopoutStub, listener, callStub;

  let expected = [{
    subscriberId: 'accountId',
    reason: 'monthly-balance',
    stoppedAt: new Date('2020-08-08T07:57:30.328Z'),
    strategy: {
      id: 'ABCD',
      name: 'Strategy'
    },
    reasonDescription: 'total strategy equity drawdown exceeded limit',
    sequenceNumber: 2
  }, {
    subscriberId: 'accountId',
    reason: 'monthly-balance',
    stoppedAt: new Date('2020-08-08T07:57:31.328Z'),
    strategy: {
      id: 'ABCD',
      name: 'Strategy'
    },
    reasonDescription: 'total strategy equity drawdown exceeded limit',
    sequenceNumber: 3
  }];

  let expected2 = [{
    subscriberId: 'accountId',
    reason: 'monthly-balance',
    stoppedAt: new Date('2020-08-08T07:57:32.328Z'),
    strategy: {
      id: 'ABCD',
      name: 'Strategy'
    },
    reasonDescription: 'total strategy equity drawdown exceeded limit',
    sequenceNumber: 4
  }, {
    subscriberId: 'accountId',
    reason: 'monthly-balance',
    stoppedAt: new Date('2020-08-08T07:57:33.328Z'),
    strategy: {
      id: 'ABCD',
      name: 'Strategy'
    },
    reasonDescription: 'total strategy equity drawdown exceeded limit',
    sequenceNumber: 5
  }];

  before(() => {
    sandbox = _sinon2.default.createSandbox();
  });

  beforeEach(() => {
    clock = sandbox.useFakeTimers({ shouldAdvanceTime: true });
    domainClient = new _domain2.default(httpClient, token);
    stopoutListenerManager = new _stopoutListenerManager2.default(domainClient);
    getStopoutStub = sandbox.stub(domainClient, 'requestCopyFactory');
    getStopoutStub.callsFake(async opts => {
      await new _promise2.default(res => setTimeout(res, 1000));
      return [];
    }).withArgs({
      url: '/users/current/stopouts/stream',
      method: 'GET',
      qs: {
        previousSequenceNumber: 1,
        subscriberId: 'accountId',
        strategyId: 'ABCD',
        limit: 1000
      },
      headers: {
        'auth-token': token
      },
      json: true
    }).callsFake(async opts => {
      await new _promise2.default(res => setTimeout(res, 1000));
      return expected;
    }).withArgs({
      url: '/users/current/stopouts/stream',
      method: 'GET',
      qs: {
        previousSequenceNumber: 3,
        subscriberId: 'accountId',
        strategyId: 'ABCD',
        limit: 1000
      },
      headers: {
        'auth-token': token
      },
      json: true
    }).callsFake(async opts => {
      await new _promise2.default(res => setTimeout(res, 1000));
      return expected2;
    });

    callStub = _sinon2.default.stub();

    class Listener extends _stopoutListener2.default {

      async onStopout(strategyStopoutEvent) {
        callStub(strategyStopoutEvent);
      }

    }

    listener = new Listener();
  });

  afterEach(() => {
    sandbox.restore();
    clock.restore();
  });

  /**
   * @test {StopoutListenerManager#addStopoutListener}
   */
  it('should add stopout listener', async () => {
    const id = stopoutListenerManager.addStopoutListener(listener, 'accountId', 'ABCD', 1);
    await clock.tickAsync(2200);
    _sinon2.default.assert.calledWith(callStub, expected);
    _sinon2.default.assert.calledWith(callStub, expected2);
    stopoutListenerManager.removeStopoutListener(id);
  });

  /**
   * @test {StopoutListenerManager#addStopoutListener}
   */
  it('should remove stopout listener', async () => {
    const id = stopoutListenerManager.addStopoutListener(listener, 'accountId', 'ABCD', 1);
    await clock.tickAsync(800);
    stopoutListenerManager.removeStopoutListener(id);
    await clock.tickAsync(2200);
    _sinon2.default.assert.calledWith(callStub, expected);
    _sinon2.default.assert.callCount(callStub, 1);
  });

  /**
   * @test {StopoutListenerManager#addStopoutListener}
   */
  it('should wait if error returned', async () => {
    getStopoutStub.callsFake(async opts => {
      await new _promise2.default(res => setTimeout(res, 500));
      return [];
    }).withArgs({
      url: '/users/current/stopouts/stream',
      method: 'GET',
      qs: {
        previousSequenceNumber: 1,
        subscriberId: 'accountId',
        strategyId: 'ABCD',
        limit: 1000
      },
      headers: {
        'auth-token': token
      },
      json: true
    }).callsFake(async opts => {
      await new _promise2.default(res => setTimeout(res, 500));
      return expected;
    }).onFirstCall().rejects(new Error('test')).onSecondCall().rejects(new Error('test'));
    const id = stopoutListenerManager.addStopoutListener(listener, 'accountId', 'ABCD', 1);
    await clock.tickAsync(600);
    _sinon2.default.assert.callCount(getStopoutStub, 1);
    _sinon2.default.assert.notCalled(callStub);
    await clock.tickAsync(600);
    _sinon2.default.assert.callCount(getStopoutStub, 2);
    _sinon2.default.assert.notCalled(callStub);
    await clock.tickAsync(2000);
    _sinon2.default.assert.callCount(getStopoutStub, 3);
    _sinon2.default.assert.notCalled(callStub);
    await clock.tickAsync(800);
    _sinon2.default.assert.calledWith(callStub, expected);
    stopoutListenerManager.removeStopoutListener(id);
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2xpYi9jbGllbnRzL2NvcHlGYWN0b3J5L3N0cmVhbWluZy9zdG9wb3V0TGlzdGVuZXJNYW5hZ2VyLnNwZWMuZXM2Il0sIm5hbWVzIjpbImRlc2NyaWJlIiwidG9rZW4iLCJodHRwQ2xpZW50IiwiSHR0cENsaWVudCIsImRvbWFpbkNsaWVudCIsInNhbmRib3giLCJjbG9jayIsInN0b3BvdXRMaXN0ZW5lck1hbmFnZXIiLCJnZXRTdG9wb3V0U3R1YiIsImxpc3RlbmVyIiwiY2FsbFN0dWIiLCJleHBlY3RlZCIsInN1YnNjcmliZXJJZCIsInJlYXNvbiIsInN0b3BwZWRBdCIsIkRhdGUiLCJzdHJhdGVneSIsImlkIiwibmFtZSIsInJlYXNvbkRlc2NyaXB0aW9uIiwic2VxdWVuY2VOdW1iZXIiLCJleHBlY3RlZDIiLCJiZWZvcmUiLCJzaW5vbiIsImNyZWF0ZVNhbmRib3giLCJiZWZvcmVFYWNoIiwidXNlRmFrZVRpbWVycyIsInNob3VsZEFkdmFuY2VUaW1lIiwiRG9tYWluQ2xpZW50IiwiU3RvcG91dExpc3RlbmVyTWFuYWdlciIsInN0dWIiLCJjYWxsc0Zha2UiLCJvcHRzIiwicmVzIiwic2V0VGltZW91dCIsIndpdGhBcmdzIiwidXJsIiwibWV0aG9kIiwicXMiLCJwcmV2aW91c1NlcXVlbmNlTnVtYmVyIiwic3RyYXRlZ3lJZCIsImxpbWl0IiwiaGVhZGVycyIsImpzb24iLCJMaXN0ZW5lciIsIlN0b3BvdXRMaXN0ZW5lciIsIm9uU3RvcG91dCIsInN0cmF0ZWd5U3RvcG91dEV2ZW50IiwiYWZ0ZXJFYWNoIiwicmVzdG9yZSIsIml0IiwiYWRkU3RvcG91dExpc3RlbmVyIiwidGlja0FzeW5jIiwiYXNzZXJ0IiwiY2FsbGVkV2l0aCIsInJlbW92ZVN0b3BvdXRMaXN0ZW5lciIsImNhbGxDb3VudCIsIm9uRmlyc3RDYWxsIiwicmVqZWN0cyIsIkVycm9yIiwib25TZWNvbmRDYWxsIiwibm90Q2FsbGVkIl0sIm1hcHBpbmdzIjoiQUFB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a0JBQXZCLENBQTBDMUMsUUFBMUMsRUFBb0QsV0FBcEQsRUFBaUUsTUFBakUsRUFBeUUsQ0FBekUsQ0FBWDtBQUNBLFVBQU1ILE1BQU04QyxTQUFOLENBQWdCLEdBQWhCLENBQU47QUFDQTdCLG9CQUFNOEIsTUFBTixDQUFhRyxTQUFiLENBQXVCaEQsY0FBdkIsRUFBdUMsQ0FBdkM7QUFDQWUsb0JBQU04QixNQUFOLENBQWFRLFNBQWIsQ0FBdUJuRCxRQUF2QjtBQUNBLFVBQU1KLE1BQU04QyxTQUFOLENBQWdCLEdBQWhCLENBQU47QUFDQTdCLG9CQUFNOEIsTUFBTixDQUFhRyxTQUFiLENBQXVCaEQsY0FBdkIsRUFBdUMsQ0FBdkM7QUFDQWUsb0JBQU04QixNQUFOLENBQWFRLFNBQWIsQ0FBdUJuRCxRQUF2QjtBQUNBLFVBQU1KLE1BQU04QyxTQUFOLENBQWdCLElBQWhCLENBQU47QUFDQTdCLG9CQUFNOEIsTUFBTixDQUFhRyxTQUFiLENBQXVCaEQsY0FBdkIsRUFBdUMsQ0FBdkM7QUFDQWUsb0JBQU04QixNQUFOLENBQWFRLFNBQWIsQ0FBdUJuRCxRQUF2QjtBQUNBLFVBQU1KLE1BQU04QyxTQUFOLENBQWdCLEdBQWhCLENBQU47QUFDQTdCLG9CQUFNOEIsTUFBTixDQUFhQyxVQUFiLENBQXdCNUMsUUFBeEIsRUFBa0NDLFFBQWxDO0FBQ0FKLDJCQUF1QmdELHFCQUF2QixDQUE2Q3RDLEVBQTdDO0FBQ0QsR0F0Q0Q7QUF3Q0QsQ0E5TEQiLCJmaWxlIjoic3RvcG91dExpc3RlbmVyTWFuYWdlci5zcGVjLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgSHR0cENsaWVudCBmcm9tICcuLi8uLi9odHRwQ2xpZW50JztcbmltcG9ydCBzaW5vbiBmcm9tICdzaW5vbic7XG5pbXBvcnQgRG9tYWluQ2xpZW50IGZyb20gJy4uLy4uL2RvbWFpbi5jbGllbnQnO1xuaW1wb3J0IFN0b3BvdXRMaXN0ZW5lciBmcm9tICcuL3N0b3BvdXRMaXN0ZW5lcic7XG5pbXBvcnQgU3RvcG91dExpc3RlbmVyTWFuYWdlciBmcm9tICcuL3N0b3BvdXRMaXN0ZW5lck1hbmFnZXInO1xuXG4vKipcbiAqIEB0ZXN0IHtTdG9wb3V0TGlzdGVuZXJNYW5hZ2VyfVxuICovXG5kZXNjcmliZSgnU3RvcG91dExpc3RlbmVyTWFuYWdlcicsICgpID0+IHtcblxuICBjb25zdCB0b2tlbiA9ICdoZWFkZXIucGF5bG9hZC5zaWduJztcbiAgbGV0IGh0dHBDbGllbnQgPSBuZXcgSHR0cENsaWVudCgpO1xuICBsZXQgZG9tYWluQ2xpZW50O1xuICBsZXQgc2FuZGJveDtcbiAgbGV0IGNsb2NrO1xuICBsZXQgc3RvcG91dExpc3RlbmVyTWFuYWdlcjtcbiAgbGV0IGdldFN0b3BvdXRTdHViLCBsaXN0ZW5lciwgY2FsbFN0dWI7XG5cbiAgbGV0IGV4cGVjdGVkID0gW3tcbiAgICBzdWJzY3JpYmVySWQ6ICdhY2NvdW50SWQnLFxuICAgIHJlYXNvbjogJ21vbnRobHktYmFsYW5jZScsXG4gICAgc3RvcHBlZEF0OiBuZXcgRGF0ZSgnMjAyMC0wOC0wOFQwNzo1NzozMC4zMjhaJyksXG4gICAgc3RyYXRlZ3k6IHtcbiAgICAgIGlkOiAnQUJDRCcsXG4gICAgICBuYW1lOiAnU3RyYXRlZ3knXG4gICAgfSxcbiAgICByZWFzb25EZXNjcmlwdGlvbjogJ3RvdGFsIHN0cmF0ZWd5IGVxdWl0eSBkcmF3ZG93biBleGNlZWRlZCBsaW1pdCcsXG4gICAgc2VxdWVuY2VOdW1iZXI6IDJcbiAgfSxcbiAge1xuICAgIHN1YnNjcmliZXJJZDogJ2FjY291bnRJZCcsXG4gICAgcmVhc29uOiAnbW9udGhseS1iYWxhbmNlJyxcbiAgICBzdG9wcGVkQXQ6IG5ldyBEYXRlKCcyMDIwLTA4LTA4VDA3OjU3OjMxLjMyOFonKSxcbiAgICBzdHJhdGVneToge1xuICAgICAgaWQ6ICdBQkNEJyxcbiAgICAgIG5hbWU6ICdTdHJhdGVneSdcbiAgICB9LFxuICAgIHJlYXNvbkRlc2NyaXB0aW9uOiAndG90YWwgc3RyYXRlZ3kgZXF1aXR5IGRyYXdkb3duIGV4Y2VlZGVkIGxpbWl0JyxcbiAgICBzZXF1ZW5jZU51bWJlcjogM1xuICB9XTtcblxuICBsZXQgZXhwZWN0ZWQyID0gW3tcbiAgICBzdWJzY3JpYmVySWQ6ICdhY2NvdW50SWQnLFxuICAgIHJlYXNvbjogJ21vbnRobHktYmFsYW5jZScsXG4gICAgc3RvcHBlZEF0OiBuZXcgRGF0ZSgnMjAyMC0wOC0wOFQwNzo1NzozMi4zMjhaJyksXG4gICAgc3RyYXRlZ3k6IHtcbiAgICAgIGlkOiAnQUJDRCcsXG4gICAgICBuYW1lOiAnU3RyYXRlZ3knXG4gICAgfSxcbiAgICByZWFzb25EZXNjcmlwdGlvbjogJ3RvdGFsIHN0cmF0ZWd5IGVxdWl0eSBkcmF3ZG93biBleGNlZWRlZCBsaW1pdCcsXG4gICAgc2VxdWVuY2VOdW1iZXI6IDRcbiAgfSxcbiAge1xuICAgIHN1YnNjcmliZXJJZDogJ2FjY291bnRJZCcsXG4gICAgcmVhc29uOiAnbW9udGhseS1iYWxhbmNlJyxcbiAgICBzdG9wcGVkQXQ6IG5ldyBEYXRlKCcyMDIwLTA4LTA4VDA3OjU3OjMzLjMyOFonKSxcbiAgICBzdHJhdGVneToge1xuICAgICAgaWQ6ICdBQkNEJyxcbiAgICAgIG5hbWU6ICdTdHJhdGVneSdcbiAgICB9LFxuICAgIHJlYXNvbkRlc2NyaXB0aW9uOiAndG90YWwgc3RyYXRlZ3kgZXF1aXR5IGRyYXdkb3duIGV4Y2VlZGVkIGxpbWl0JyxcbiAgICBzZXF1ZW5jZU51bWJlcjogNVxuICB9XTtcblxuXG4gIGJlZm9yZSgoKSA9PiB7XG4gICAgc2FuZGJveCA9IHNpbm9uLmNyZWF0ZVNhbmRib3goKTtcbiAgfSk7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgY2xvY2sgPSBzYW5kYm94LnVzZUZha2VUaW1lcnMoe3Nob3VsZEFkdmFuY2VUaW1lOiB0cnVlfSk7XG4gICAgZG9tYWluQ2xpZW50ID0gbmV3IERvbWFpbkNsaWVudChodHRwQ2xpZW50LCB0b2tlbik7XG4gICAgc3RvcG91dExpc3RlbmVyTWFuYWdlciA9IG5ldyBTdG9wb3V0TGlzdGVuZXJNYW5hZ2VyKGRvbWFpbkNsaWVudCk7XG4gICAgZ2V0U3RvcG91dFN0dWIgPSBzYW5kYm94LnN0dWIoZG9tYWluQ2xpZW50LCAncmVxdWVzdENvcHlGYWN0b3J5Jyk7XG4gICAgZ2V0U3RvcG91dFN0dWJcbiAgICAgIC5jYWxsc0Zha2UoYXN5bmMgKG9wdHMpID0+IHtcbiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzID0+IHNldFRpbWVvdXQocmVzLCAxMDAwKSk7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICAgIH0pXG4gICAgICAud2l0aEFyZ3Moe1xuICAgICAgICB1cmw6ICcvdXNlcnMvY3VycmVudC9zdG9wb3V0cy9zdHJlYW0nLFxuICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICBxczoge1xuICAgICAgICAgIHByZXZpb3VzU2VxdWVuY2VOdW1iZXI6IDEsXG4gICAgICAgICAgc3Vic2NyaWJlcklkOiAnYWNjb3VudElkJyxcbiAgICAgICAgICBzdHJhdGVneUlkOiAnQUJDRCcsXG4gICAgICAgICAgbGltaXQ6IDEwMDBcbiAgICAgICAgfSxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdhdXRoLXRva2VuJzogdG9rZW5cbiAgICAgICAgfSxcbiAgICAgICAganNvbjogdHJ1ZVxuICAgICAgfSkuY2FsbHNGYWtlKGFzeW5jIChvcHRzKSA9PiB7XG4gICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlcyA9PiBzZXRUaW1lb3V0KHJlcywgMTAwMCkpO1xuICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7XG4gICAgICB9KVxuICAgICAgLndpdGhBcmdzKHtcbiAgICAgICAgdXJsOiAnL3VzZXJzL2N1cnJlbnQvc3RvcG91dHMvc3RyZWFtJyxcbiAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgcXM6IHtcbiAgICAgICAgICBwcmV2aW91c1NlcXVlbmNlTnVtYmVyOiAzLFxuICAgICAgICAgIHN1YnNjcmliZXJJZDogJ2FjY291bnRJZCcsXG4gICAgICAgICAgc3RyYXRlZ3lJZDogJ0FCQ0QnLFxuICAgICAgICAgIGxpbWl0OiAxMDAwXG4gICAgICAgIH0sXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnYXV0aC10b2tlbic6IHRva2VuXG4gICAgICAgIH0sXG4gICAgICAgIGpzb246IHRydWVcbiAgICAgIH0pLmNhbGxzRmFrZShhc3luYyAob3B0cykgPT4ge1xuICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXMgPT4gc2V0VGltZW91dChyZXMsIDEwMDApKTtcbiAgICAgICAgcmV0dXJuIGV4cGVjdGVkMjtcbiAgICAgIH0pO1xuXG4gICAgY2FsbFN0dWIgPSBzaW5vbi5zdHViKCk7XG5cbiAgICBjbGFzcyBMaXN0ZW5lciBleHRlbmRzIFN0b3BvdXRMaXN0ZW5lciB7XG5cbiAgICAgIGFzeW5jIG9uU3RvcG91dChzdHJhdGVneVN0b3BvdXRFdmVudCkge1xuICAgICAgICBjYWxsU3R1YihzdHJhdGVneVN0b3BvdXRFdmVudCk7XG4gICAgICB9XG5cbiAgICB9XG5cbiAgICBsaXN0ZW5lciA9IG5ldyBMaXN0ZW5lcigpO1xuICB9KTtcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIHNhbmRib3gucmVzdG9yZSgpO1xuICAgIGNsb2NrLnJlc3RvcmUoKTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtTdG9wb3V0TGlzdGVuZXJNYW5hZ2VyI2FkZFN0b3BvdXRMaXN0ZW5lcn1cbiAgICovXG4gIGl0KCdzaG91bGQgYWRkIHN0b3BvdXQgbGlzdGVuZXInLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgaWQgPSBzdG9wb3V0TGlzdGVuZXJNYW5hZ2VyLmFkZFN0b3BvdXRMaXN0ZW5lcihsaXN0ZW5lciwgJ2FjY291bnRJZCcsICdBQkNEJywgMSk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDIyMDApO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKGNhbGxTdHViLCBleHBlY3RlZCk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZFdpdGgoY2FsbFN0dWIsIGV4cGVjdGVkMik7XG4gICAgc3RvcG91dExpc3RlbmVyTWFuYWdlci5yZW1vdmVTdG9wb3V0TGlzdGVuZXIoaWQpO1xuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge1N0b3BvdXRMaXN0ZW5lck1hbmFnZXIjYWRkU3RvcG91dExpc3RlbmVyfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCByZW1vdmUgc3RvcG91dCBsaXN0ZW5lcicsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBpZCA9IHN0b3BvdXRMaXN0ZW5lck1hbmFnZXIuYWRkU3RvcG91dExpc3RlbmVyKGxpc3RlbmVyLCAnYWNjb3VudElkJywgJ0FCQ0QnLCAxKTtcbiAgICBhd2FpdCBjbG9jay50aWNrQXN5bmMoODAwKTtcbiAgICBzdG9wb3V0TGlzdGVuZXJNYW5hZ2VyLnJlbW92ZVN0b3BvdXRMaXN0ZW5lcihpZCk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDIyMDApO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKGNhbGxTdHViLCBleHBlY3RlZCk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxDb3VudChjYWxsU3R1YiwgMSk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7U3RvcG91dExpc3RlbmVyTWFuYWdlciNhZGRTdG9wb3V0TGlzdGVuZXJ9XG4gICAqL1xuICBpdCgnc2hvdWxkIHdhaXQgaWYgZXJyb3IgcmV0dXJuZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgZ2V0U3RvcG91dFN0dWJcbiAgICAgIC5jYWxsc0Zha2UoYXN5bmMgKG9wdHMpID0+IHtcbiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzID0+IHNldFRpbWVvdXQocmVzLCA1MDApKTtcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgfSlcbiAgICAgIC53aXRoQXJncyh7XG4gICAgICAgIHVybDogJy91c2Vycy9jdXJyZW50L3N0b3BvdXRzL3N0cmVhbScsXG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgIHFzOiB7XG4gICAgICAgICAgcHJldmlvdXNTZXF1ZW5jZU51bWJlcjogMSxcbiAgICAgICAgICBzdWJzY3JpYmVySWQ6ICdhY2NvdW50SWQnLFxuICAgICAgICAgIHN0cmF0ZWd5SWQ6ICdBQkNEJyxcbiAgICAgICAgICBsaW1pdDogMTAwMFxuICAgICAgICB9LFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ2F1dGgtdG9rZW4nOiB0b2tlblxuICAgICAgICB9LFxuICAgICAgICBqc29uOiB0cnVlXG4gICAgICB9KS5jYWxsc0Zha2UoYXN5bmMgKG9wdHMpID0+IHtcbiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzID0+IHNldFRpbWVvdXQocmVzLCA1MDApKTtcbiAgICAgICAgcmV0dXJuIGV4cGVjdGVkO1xuICAgICAgfSlcbiAgICAgIC5vbkZpcnN0Q2FsbCgpLnJlamVjdHMobmV3IEVycm9yKCd0ZXN0JykpXG4gICAgICAub25TZWNvbmRDYWxsKCkucmVqZWN0cyhuZXcgRXJyb3IoJ3Rlc3QnKSk7XG4gICAgY29uc3QgaWQgPSBzdG9wb3V0TGlzdGVuZXJNYW5hZ2VyLmFkZFN0b3BvdXRMaXN0ZW5lcihsaXN0ZW5lciwgJ2FjY291bnRJZCcsICdBQkNEJywgMSk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDYwMCk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxDb3VudChnZXRTdG9wb3V0U3R1YiwgMSk7XG4gICAgc2lub24uYXNzZXJ0Lm5vdENhbGxlZChjYWxsU3R1Yik7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDYwMCk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxDb3VudChnZXRTdG9wb3V0U3R1YiwgMik7XG4gICAgc2lub24uYXNzZXJ0Lm5vdENhbGxlZChjYWxsU3R1Yik7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDIwMDApO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsQ291bnQoZ2V0U3RvcG91dFN0dWIsIDMpO1xuICAgIHNpbm9uLmFzc2VydC5ub3RDYWxsZWQoY2FsbFN0dWIpO1xuICAgIGF3YWl0IGNsb2NrLnRpY2tBc3luYyg4MDApO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKGNhbGxTdHViLCBleHBlY3RlZCk7XG4gICAgc3RvcG91dExpc3RlbmVyTWFuYWdlci5yZW1vdmVTdG9wb3V0TGlzdGVuZXIoaWQpO1xuICB9KTtcblxufSk7XG4iXX0=