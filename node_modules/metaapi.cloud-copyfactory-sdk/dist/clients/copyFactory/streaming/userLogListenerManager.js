'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _metaApi = require('../../metaApi.client');

var _metaApi2 = _interopRequireDefault(_metaApi);

var _randomstring = require('randomstring');

var _randomstring2 = _interopRequireDefault(_randomstring);

var _logger = require('../../../logger');

var _logger2 = _interopRequireDefault(_logger);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * User log event listener manager
 */
class UserLogListenerManager extends _metaApi2.default {

  /**
   * Constructs user log event listener manager instance
   * @param {DomainClient} domainClient domain client
   */
  constructor(domainClient) {
    super(domainClient);
    this._domainClient = domainClient;
    this._strategyLogListeners = {};
    this._subscriberLogListeners = {};
    this._errorThrottleTime = 1000;
    this._logger = _logger2.default.getLogger('UserLogListenerManager');
  }

  /**
   * Returns the dictionary of strategy log listeners
   * @returns {Object} dictionary of strategy log listeners
   */
  get strategyLogListeners() {
    return this._strategyLogListeners;
  }

  /**
   * Returns the dictionary of subscriber log listeners
   * @returns {Object} dictionary of subscriber log listeners
   */
  get subscriberLogListeners() {
    return this._subscriberLogListeners;
  }

  /**
   * Adds a strategy log listener
   * @param {UserLogListener} listener user log listener
   * @param {String} strategyId strategy id
   * @param {Date} [startTime] log search start time
   * @returns {String} strategy log listener id
   */
  addStrategyLogListener(listener, strategyId, startTime) {
    const listenerId = _randomstring2.default.generate(10);
    this._strategyLogListeners[listenerId] = listener;
    this._startStrategyLogStreamJob(listenerId, listener, strategyId, startTime);
    return listenerId;
  }

  /**
   * Adds a subscriber log listener
   * @param {UserLogListener} listener user log listener
   * @param {String} subscriberId subscriber id
   * @param {Date} [startTime] log search start time
   * @returns {String} subscriber log listener id
   */
  addSubscriberLogListener(listener, subscriberId, startTime) {
    const listenerId = _randomstring2.default.generate(10);
    this._subscriberLogListeners[listenerId] = listener;
    this._startSubscriberLogStreamJob(listenerId, listener, subscriberId, startTime);
    return listenerId;
  }

  /**
   * Removes strategy log listener by id
   * @param {String} listenerId listener id 
   */
  removeStrategyLogListener(listenerId) {
    delete this._strategyLogListeners[listenerId];
  }

  /**
   * Removes subscriber log listener by id
   * @param {String} listenerId listener id 
   */
  removeSubscriberLogListener(listenerId) {
    delete this._subscriberLogListeners[listenerId];
  }

  async _startStrategyLogStreamJob(listenerId, listener, strategyId, startTime) {
    let throttleTime = this._errorThrottleTime;

    while (this._strategyLogListeners[listenerId]) {
      const opts = {
        url: `/users/current/strategies/${strategyId}/user-log/stream`,
        method: 'GET',
        qs: {
          startTime,
          limit: 1000
        },
        headers: {
          'auth-token': this._token
        },
        json: true
      };
      try {
        const packets = await this._domainClient.requestCopyFactory(opts, true);
        await listener.onUserLog(packets);
        throttleTime = this._errorThrottleTime;
        if (this._strategyLogListeners[listenerId] && packets.length) {
          startTime = new Date(new Date(packets[0].time).getTime() + 1);
        }
      } catch (err) {
        if (err.name === 'NotFoundError') {
          this._logger.error(`Strategy ${strategyId} not found, removing listener ${listenerId}`);
          delete this._strategyLogListeners[listenerId];
        } else {
          await new _promise2.default(res => setTimeout(res, throttleTime));
          throttleTime = Math.min(throttleTime * 2, 30000);
        }
      }
    }
  }

  async _startSubscriberLogStreamJob(listenerId, listener, subscriberId, startTime) {
    let throttleTime = this._errorThrottleTime;

    while (this._subscriberLogListeners[listenerId]) {
      const opts = {
        url: `/users/current/subscribers/${subscriberId}/user-log/stream`,
        method: 'GET',
        qs: {
          startTime,
          limit: 1000
        },
        headers: {
          'auth-token': this._token
        },
        json: true
      };
      try {
        const packets = await this._domainClient.requestCopyFactory(opts, true);
        await listener.onUserLog(packets);
        throttleTime = this._errorThrottleTime;
        if (this._subscriberLogListeners[listenerId] && packets.length) {
          startTime = new Date(new Date(packets[0].time).getTime() + 1);
        }
      } catch (err) {
        if (err.name === 'NotFoundError') {
          this._logger.error(`Subscriber ${subscriberId} not found, removing listener ${listenerId}`);
          delete this._subscriberLogListeners[listenerId];
        } else {
          await new _promise2.default(res => setTimeout(res, throttleTime));
          throttleTime = Math.min(throttleTime * 2, 30000);
        }
      }
    }
  }

}
exports.default = UserLogListenerManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2xpYi9jbGllbnRzL2NvcHlGYWN0b3J5L3N0cmVhbWluZy91c2VyTG9nTGlzdGVuZXJNYW5hZ2VyLmVzNiJdLCJuYW1lcyI6WyJVc2VyTG9nTGlzdGVuZXJNYW5hZ2VyIiwiTWV0YUFwaUNsaWVudCIsImNvbnN0cnVjdG9yIiwiZG9tYWluQ2xpZW50IiwiX2RvbWFpbkNsaWVudCIsIl9zdHJhdGVneUxvZ0xpc3RlbmVycyIsIl9zdWJzY3JpYmVyTG9nTGlzdGVuZXJzIiwiX2Vycm9yVGhyb3R0bGVUaW1lIiwiX2xvZ2dlciIsIkxvZ2dlck1hbmFnZXIiLCJnZXRMb2dnZXIiLCJzdHJhdGVneUxvZ0xpc3RlbmVycyIsInN1YnNjcmliZXJMb2dMaXN0ZW5lcnMiLCJhZGRTdHJhdGVneUxvZ0xpc3RlbmVyIiwibGlzdGVuZXIiLCJzdHJhdGVneUlkIiwic3RhcnRUaW1lIiwibGlzdGVuZXJJZCIsInJhbmRvbXN0cmluZyIsImdlbmVyYXRlIiwiX3N0YXJ0U3RyYXRlZ3lMb2dTdHJlYW1Kb2IiLCJhZGRTdWJzY3JpYmVyTG9nTGlzdGVuZXIiLCJzdWJzY3JpYmVySWQiLCJfc3RhcnRTdWJzY3JpYmVyTG9nU3RyZWFtSm9iIiwicmVtb3ZlU3RyYXRlZ3lMb2dMaXN0ZW5lciIsInJlbW92ZVN1YnNjcmliZXJMb2dMaXN0ZW5lciIsInRocm90dGxlVGltZSIsIm9wdHMiLCJ1cmwiLCJtZXRob2QiLCJxcyIsImxpbWl0IiwiaGVhZGVycyIsIl90b2tlbiIsImpzb24iLCJwYWNrZXRzIiwicmVxdWVzdENvcHlGYWN0b3J5Iiwib25Vc2VyTG9nIiwibGVuZ3RoIiwiRGF0ZSIsInRpbWUiLCJnZXRUaW1lIiwiZXJyIiwibmFtZSIsImVycm9yIiwicmVzIiwic2V0VGltZW91dCIsIk1hdGgiLCJtaW4iXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7O0FBRUE7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7QUFFQTs7O0FBR2UsTUFBTUEsc0JBQU4sU0FBcUND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QUFrQztBQUNoQyxlQUFLbkMsT0FBTCxDQUFhb0MsS0FBYixDQUFvQixjQUFhdEIsWUFBYSxpQ0FBZ0NMLFVBQVcsRUFBekY7QUFDQSxpQkFBTyxLQUFLWCx1QkFBTCxDQUE2QlcsVUFBN0IsQ0FBUDtBQUNELFNBSEQsTUFHTztBQUNMLGdCQUFNLHNCQUFZNEIsT0FBT0MsV0FBV0QsR0FBWCxFQUFnQm5CLFlBQWhCLENBQW5CLENBQU47QUFDQUEseUJBQWVxQixLQUFLQyxHQUFMLENBQVN0QixlQUFlLENBQXhCLEVBQTJCLEtBQTNCLENBQWY7QUFDRDtBQUNGO0FBQ0Y7QUFDRjs7QUEvSStEO2tCQUE3QzFCLHNCIiwiZmlsZSI6InVzZXJMb2dMaXN0ZW5lck1hbmFnZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCBNZXRhQXBpQ2xpZW50IGZyb20gJy4uLy4uL21ldGFBcGkuY2xpZW50JztcbmltcG9ydCByYW5kb21zdHJpbmcgZnJvbSAncmFuZG9tc3RyaW5nJztcbmltcG9ydCBMb2dnZXJNYW5hZ2VyIGZyb20gJy4uLy4uLy4uL2xvZ2dlcic7XG5cbi8qKlxuICogVXNlciBsb2cgZXZlbnQgbGlzdGVuZXIgbWFuYWdlclxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBVc2VyTG9nTGlzdGVuZXJNYW5hZ2VyIGV4dGVuZHMgTWV0YUFwaUNsaWVudCB7XG5cbiAgLyoqXG4gICAqIENvbnN0cnVjdHMgdXNlciBsb2cgZXZlbnQgbGlzdGVuZXIgbWFuYWdlciBpbnN0YW5jZVxuICAgKiBAcGFyYW0ge0RvbWFpbkNsaWVudH0gZG9tYWluQ2xpZW50IGRvbWFpbiBjbGllbnRcbiAgICovXG4gIGNvbnN0cnVjdG9yKGRvbWFpbkNsaWVudCkge1xuICAgIHN1cGVyKGRvbWFpbkNsaWVudCk7XG4gICAgdGhpcy5fZG9tYWluQ2xpZW50ID0gZG9tYWluQ2xpZW50O1xuICAgIHRoaXMuX3N0cmF0ZWd5TG9nTGlzdGVuZXJzID0ge307XG4gICAgdGhpcy5fc3Vic2NyaWJlckxvZ0xpc3RlbmVycyA9IHt9O1xuICAgIHRoaXMuX2Vycm9yVGhyb3R0bGVUaW1lID0gMTAwMDtcbiAgICB0aGlzLl9sb2dnZXIgPSBMb2dnZXJNYW5hZ2VyLmdldExvZ2dlcignVXNlckxvZ0xpc3RlbmVyTWFuYWdlcicpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIGRpY3Rpb25hcnkgb2Ygc3RyYXRlZ3kgbG9nIGxpc3RlbmVyc1xuICAgKiBAcmV0dXJucyB7T2JqZWN0fSBkaWN0aW9uYXJ5IG9mIHN0cmF0ZWd5IGxvZyBsaXN0ZW5lcnNcbiAgICovXG4gIGdldCBzdHJhdGVneUxvZ0xpc3RlbmVycygpIHtcbiAgICByZXR1cm4gdGhpcy5fc3RyYXRlZ3lMb2dMaXN0ZW5lcnM7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgZGljdGlvbmFyeSBvZiBzdWJzY3JpYmVyIGxvZyBsaXN0ZW5lcnNcbiAgICogQHJldHVybnMge09iamVjdH0gZGljdGlvbmFyeSBvZiBzdWJzY3JpYmVyIGxvZyBsaXN0ZW5lcnNcbiAgICovXG4gIGdldCBzdWJzY3JpYmVyTG9nTGlzdGVuZXJzKCkge1xuICAgIHJldHVybiB0aGlzLl9zdWJzY3JpYmVyTG9nTGlzdGVuZXJzO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZHMgYSBzdHJhdGVneSBsb2cgbGlzdGVuZXJcbiAgICogQHBhcmFtIHtVc2VyTG9nTGlzdGVuZXJ9IGxpc3RlbmVyIHVzZXIgbG9nIGxpc3RlbmVyXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBzdHJhdGVneUlkIHN0cmF0ZWd5IGlkXG4gICAqIEBwYXJhbSB7RGF0ZX0gW3N0YXJ0VGltZV0gbG9nIHNlYXJjaCBzdGFydCB0aW1lXG4gICAqIEByZXR1cm5zIHtTdHJpbmd9IHN0cmF0ZWd5IGxvZyBsaXN0ZW5lciBpZFxuICAgKi9cbiAgYWRkU3RyYXRlZ3lMb2dMaXN0ZW5lcihsaXN0ZW5lciwgc3RyYXRlZ3lJZCwgc3RhcnRUaW1lKSB7XG4gICAgY29uc3QgbGlzdGVuZXJJZCA9IHJhbmRvbXN0cmluZy5nZW5lcmF0ZSgxMCk7XG4gICAgdGhpcy5fc3RyYXRlZ3lMb2dMaXN0ZW5lcnNbbGlzdGVuZXJJZF0gPSBsaXN0ZW5lcjtcbiAgICB0aGlzLl9zdGFydFN0cmF0ZWd5TG9nU3RyZWFtSm9iKGxpc3RlbmVySWQsIGxpc3RlbmVyLCBzdHJhdGVneUlkLCBzdGFydFRpbWUpO1xuICAgIHJldHVybiBsaXN0ZW5lcklkO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZHMgYSBzdWJzY3JpYmVyIGxvZyBsaXN0ZW5lclxuICAgKiBAcGFyYW0ge1VzZXJMb2dMaXN0ZW5lcn0gbGlzdGVuZXIgdXNlciBsb2cgbGlzdGVuZXJcbiAgICogQHBhcmFtIHtTdHJpbmd9IHN1YnNjcmliZXJJZCBzdWJzY3JpYmVyIGlkXG4gICAqIEBwYXJhbSB7RGF0ZX0gW3N0YXJ0VGltZV0gbG9nIHNlYXJjaCBzdGFydCB0aW1lXG4gICAqIEByZXR1cm5zIHtTdHJpbmd9IHN1YnNjcmliZXIgbG9nIGxpc3RlbmVyIGlkXG4gICAqL1xuICBhZGRTdWJzY3JpYmVyTG9nTGlzdGVuZXIobGlzdGVuZXIsIHN1YnNjcmliZXJJZCwgc3RhcnRUaW1lKSB7XG4gICAgY29uc3QgbGlzdGVuZXJJZCA9IHJhbmRvbXN0cmluZy5nZW5lcmF0ZSgxMCk7XG4gICAgdGhpcy5fc3Vic2NyaWJlckxvZ0xpc3RlbmVyc1tsaXN0ZW5lcklkXSA9IGxpc3RlbmVyO1xuICAgIHRoaXMuX3N0YXJ0U3Vic2NyaWJlckxvZ1N0cmVhbUpvYihsaXN0ZW5lcklkLCBsaXN0ZW5lciwgc3Vic2NyaWJlcklkLCBzdGFydFRpbWUpO1xuICAgIHJldHVybiBsaXN0ZW5lcklkO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZXMgc3RyYXRlZ3kgbG9nIGxpc3RlbmVyIGJ5IGlkXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBsaXN0ZW5lcklkIGxpc3RlbmVyIGlkIFxuICAgKi9cbiAgcmVtb3ZlU3RyYXRlZ3lMb2dMaXN0ZW5lcihsaXN0ZW5lcklkKSB7XG4gICAgZGVsZXRlIHRoaXMuX3N0cmF0ZWd5TG9nTGlzdGVuZXJzW2xpc3RlbmVySWRdO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZXMgc3Vic2NyaWJlciBsb2cgbGlzdGVuZXIgYnkgaWRcbiAgICogQHBhcmFtIHtTdHJpbmd9IGxpc3RlbmVySWQgbGlzdGVuZXIgaWQgXG4gICAqL1xuICByZW1vdmVTdWJzY3JpYmVyTG9nTGlzdGVuZXIobGlzdGVuZXJJZCkge1xuICAgIGRlbGV0ZSB0aGlzLl9zdWJzY3JpYmVyTG9nTGlzdGVuZXJzW2xpc3RlbmVySWRdO1xuICB9XG5cbiAgYXN5bmMgX3N0YXJ0U3RyYXRlZ3lMb2dTdHJlYW1Kb2IobGlzdGVuZXJJZCwgbGlzdGVuZXIsIHN0cmF0ZWd5SWQsIHN0YXJ0VGltZSkge1xuICAgIGxldCB0aHJvdHRsZVRpbWUgPSB0aGlzLl9lcnJvclRocm90dGxlVGltZTtcblxuICAgIHdoaWxlKHRoaXMuX3N0cmF0ZWd5TG9nTGlzdGVuZXJzW2xpc3RlbmVySWRdKSB7XG4gICAgICBjb25zdCBvcHRzID0ge1xuICAgICAgICB1cmw6IGAvdXNlcnMvY3VycmVudC9zdHJhdGVnaWVzLyR7c3RyYXRlZ3lJZH0vdXNlci1sb2cvc3RyZWFtYCxcbiAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgcXM6IHtcbiAgICAgICAgICBzdGFydFRpbWUsXG4gICAgICAgICAgbGltaXQ6IDEwMDBcbiAgICAgICAgfSxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdhdXRoLXRva2VuJzogdGhpcy5fdG9rZW5cbiAgICAgICAgfSxcbiAgICAgICAganNvbjogdHJ1ZVxuICAgICAgfTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHBhY2tldHMgPSBhd2FpdCB0aGlzLl9kb21haW5DbGllbnQucmVxdWVzdENvcHlGYWN0b3J5KG9wdHMsIHRydWUpO1xuICAgICAgICBhd2FpdCBsaXN0ZW5lci5vblVzZXJMb2cocGFja2V0cyk7XG4gICAgICAgIHRocm90dGxlVGltZSA9IHRoaXMuX2Vycm9yVGhyb3R0bGVUaW1lO1xuICAgICAgICBpZih0aGlzLl9zdHJhdGVneUxvZ0xpc3RlbmVyc1tsaXN0ZW5lcklkXSAmJiBwYWNrZXRzLmxlbmd0aCkge1xuICAgICAgICAgIHN0YXJ0VGltZSA9IG5ldyBEYXRlKG5ldyBEYXRlKHBhY2tldHNbMF0udGltZSkuZ2V0VGltZSgpICsgMSk7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBpZiAoZXJyLm5hbWUgPT09ICdOb3RGb3VuZEVycm9yJykge1xuICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihgU3RyYXRlZ3kgJHtzdHJhdGVneUlkfSBub3QgZm91bmQsIHJlbW92aW5nIGxpc3RlbmVyICR7bGlzdGVuZXJJZH1gKTtcbiAgICAgICAgICBkZWxldGUgdGhpcy5fc3RyYXRlZ3lMb2dMaXN0ZW5lcnNbbGlzdGVuZXJJZF07IFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlcyA9PiBzZXRUaW1lb3V0KHJlcywgdGhyb3R0bGVUaW1lKSk7XG4gICAgICAgICAgdGhyb3R0bGVUaW1lID0gTWF0aC5taW4odGhyb3R0bGVUaW1lICogMiwgMzAwMDApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgX3N0YXJ0U3Vic2NyaWJlckxvZ1N0cmVhbUpvYihsaXN0ZW5lcklkLCBsaXN0ZW5lciwgc3Vic2NyaWJlcklkLCBzdGFydFRpbWUpIHtcbiAgICBsZXQgdGhyb3R0bGVUaW1lID0gdGhpcy5fZXJyb3JUaHJvdHRsZVRpbWU7XG5cbiAgICB3aGlsZSh0aGlzLl9zdWJzY3JpYmVyTG9nTGlzdGVuZXJzW2xpc3RlbmVySWRdKSB7XG4gICAgICBjb25zdCBvcHRzID0ge1xuICAgICAgICB1cmw6IGAvdXNlcnMvY3VycmVudC9zdWJzY3JpYmVycy8ke3N1YnNjcmliZXJJZH0vdXNlci1sb2cvc3RyZWFtYCxcbiAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgcXM6IHtcbiAgICAgICAgICBzdGFydFRpbWUsXG4gICAgICAgICAgbGltaXQ6IDEwMDBcbiAgICAgICAgfSxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdhdXRoLXRva2VuJzogdGhpcy5fdG9rZW5cbiAgICAgICAgfSxcbiAgICAgICAganNvbjogdHJ1ZVxuICAgICAgfTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHBhY2tldHMgPSBhd2FpdCB0aGlzLl9kb21haW5DbGllbnQucmVxdWVzdENvcHlGYWN0b3J5KG9wdHMsIHRydWUpO1xuICAgICAgICBhd2FpdCBsaXN0ZW5lci5vblVzZXJMb2cocGFja2V0cyk7XG4gICAgICAgIHRocm90dGxlVGltZSA9IHRoaXMuX2Vycm9yVGhyb3R0bGVUaW1lO1xuICAgICAgICBpZih0aGlzLl9zdWJzY3JpYmVyTG9nTGlzdGVuZXJzW2xpc3RlbmVySWRdICYmIHBhY2tldHMubGVuZ3RoKSB7XG4gICAgICAgICAgc3RhcnRUaW1lID0gbmV3IERhdGUobmV3IERhdGUocGFja2V0c1swXS50aW1lKS5nZXRUaW1lKCkgKyAxKTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGlmIChlcnIubmFtZSA9PT0gJ05vdEZvdW5kRXJyb3InKSB7XG4gICAgICAgICAgdGhpcy5fbG9nZ2VyLmVycm9yKGBTdWJzY3JpYmVyICR7c3Vic2NyaWJlcklkfSBub3QgZm91bmQsIHJlbW92aW5nIGxpc3RlbmVyICR7bGlzdGVuZXJJZH1gKTtcbiAgICAgICAgICBkZWxldGUgdGhpcy5fc3Vic2NyaWJlckxvZ0xpc3RlbmVyc1tsaXN0ZW5lcklkXTsgXG4gICAgICAgIH0gZWxzZSB7IFxuICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlcyA9PiBzZXRUaW1lb3V0KHJlcywgdGhyb3R0bGVUaW1lKSk7XG4gICAgICAgICAgdGhyb3R0bGVUaW1lID0gTWF0aC5taW4odGhyb3R0bGVUaW1lICogMiwgMzAwMDApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbn1cbiJdfQ==