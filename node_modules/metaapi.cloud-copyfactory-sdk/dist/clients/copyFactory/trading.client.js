'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _metaApi = require('../metaApi.client');

var _metaApi2 = _interopRequireDefault(_metaApi);

var _signal = require('./signal.client');

var _signal2 = _interopRequireDefault(_signal);

var _stopoutListenerManager = require('./streaming/stopoutListenerManager');

var _stopoutListenerManager2 = _interopRequireDefault(_stopoutListenerManager);

var _userLogListenerManager = require('./streaming/userLogListenerManager');

var _userLogListenerManager2 = _interopRequireDefault(_userLogListenerManager);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * metaapi.cloud CopyFactory trading API (trade copying trading API) client (see
 * https://metaapi.cloud/docs/copyfactory/)
 */
class TradingClient extends _metaApi2.default {

  /**
   * Constructs CopyFactory trading API client instance
   * @param {DomainClient} domainClient domain client
   */
  constructor(domainClient) {
    super(domainClient);
    this._domainClient = domainClient;
    this._stopoutListenerManager = new _stopoutListenerManager2.default(domainClient);
    this._userLogListenerManager = new _userLogListenerManager2.default(domainClient);
  }

  /**
   * Resynchronizes the account. See
   * https://metaapi.cloud/docs/copyfactory/restApi/api/trading/resynchronize/
   * @param {String} accountId account id
   * @param {Array<String>} [strategyIds] array of strategy ids to recynchronize. Default is to synchronize all
   * strategies
   * @param {Array<String>} [positionIds] array of position ids to resynchronize. Default is to synchronize all
   * positions
   * @return {Promise} promise which resolves when resynchronization is scheduled
   */
  async resynchronize(accountId, strategyIds, positionIds) {
    if (this._isNotJwtToken()) {
      return this._handleNoAccessError('resynchronize');
    }
    const opts = {
      url: `/users/current/subscribers/${accountId}/resynchronize`,
      method: 'POST',
      headers: {
        'auth-token': this._token
      },
      qs: {
        strategyId: strategyIds,
        positionId: positionIds
      },
      json: true
    };
    return this._domainClient.requestCopyFactory(opts);
  }

  /**
   * Generates an instance of signal client for an account
   * @param {String} accountId account id
   */
  async getSignalClient(accountId) {
    if (this._isNotJwtToken()) {
      return this._handleNoAccessError('getSignalClient');
    }

    let accountData = await this._domainClient.getAccountInfo(accountId);
    const host = await this._domainClient.getSignalClientHost(accountData.regions);
    return new _signal2.default(accountData.id, host, this._domainClient);
  }

  /**
   * CopyFactory strategy stopout reason
   * @typedef {'day-balance-difference' | 'date-balance-difference' | 'week-balance-difference' |
   * 'week-to-date-balance-difference' | 'month-balance-difference' | 'month-to-date-balance-difference' |
   * 'quarter-balance-difference' | 'quarter-to-date-balance-difference' | 'year-balance-difference' |
   * 'year-to-date-balance-difference' | 'lifetime-balance-difference' | 'day-balance-minus-equity' |
   * 'date-balance-minus-equity' | 'week-balance-minus-equity' | 'week-to-date-balance-minus-equity' |
   * 'month-balance-minus-equity' | 'month-to-date-balance-minus-equity' |
   * 'quarter-balance-minus-equity' | 'quarter-to-date-balance-minus-equity' | 'year-balance-minus-equity' |
   * 'year-to-date-balance-minus-equity' | 'lifetime-balance-minus-equity' |
   * 'day-equity-difference' | 'date-equity-difference' | 'week-equity-difference' |
   * 'week-to-date-equity-difference' | 'month-equity-difference' |
   * 'month-to-date-equity-difference' | 'quarter-equity-difference' | 'quarter-to-date-equity-difference' |
   * 'year-equity-difference' | 'year-to-date-equity-difference' |
   * 'lifetime-equity-difference'} CopyFactoryStrategyStopoutReason
   */

  /**
   * CopyFactory strategy stopout
   * @typedef {Object} CopyFactoryStrategyStopout
   * @property {String} subscriberId subscriber id
   * @property {CopyFactoryStrategyIdAndName} strategy strategy which was stopped out
   * @property {Boolean} partial flag indicating that stopout is partial
   * @property {CopyFactoryStrategyStopoutReason} reason stopout reason
   * @property {String} reasonDescription human-readable description of the stopout reason
   * @property {Boolean} [closePositions] flag indicating if positions should be closed
   * @property {Date} stoppedAt time the strategy was stopped at
   * @property {Date} stoppedTill time the strategy is stopped till
   * @property {Number} sequenceNumber stopout event sequence number
   */

  /**
   * Returns subscriber account stopouts. See
   * https://metaapi.cloud/docs/copyfactory/restApi/api/trading/getStopOuts/
   * @param {String} subscriberId subscriber id
   * @return {Promise<Array<CopyFactoryStrategyStopout>>} promise which resolves with stopouts found
   */
  async getStopouts(subscriberId) {
    if (this._isNotJwtToken()) {
      return this._handleNoAccessError('getStopouts');
    }
    const opts = {
      url: `/users/current/subscribers/${subscriberId}/stopouts`,
      method: 'GET',
      headers: {
        'auth-token': this._token
      },
      json: true
    };
    return this._domainClient.requestCopyFactory(opts);
  }

  /**
   * Resets strategy stopouts. See
   * https://metaapi.cloud/docs/copyfactory/restApi/api/trading/resetStopOuts/
   * @param {String} subscriberId subscriber id
   * @param {String} strategyId strategy id
   * @param {CopyFactoryStrategyStopoutReason} reason stopout reason to reset
   * yearly-equity, monthly-equity, daily-equity
   * @return {Promise} promise which resolves when the stopouts are reset
   */
  resetStopouts(subscriberId, strategyId, reason) {
    if (this._isNotJwtToken()) {
      return this._handleNoAccessError('resetStopouts');
    }
    const opts = {
      url: `/users/current/subscribers/${subscriberId}/subscription-strategies/` + `${strategyId}/stopouts/${reason}/reset`,
      method: 'POST',
      headers: {
        'auth-token': this._token
      },
      json: true
    };
    return this._domainClient.requestCopyFactory(opts);
  }

  /**
   * Trade copying user log record
   * @typedef {Object} CopyFactoryUserLogMessage
   * @property {Date} time log record time
   * @property {string} [symbol] symbol traded
   * @property {string} [strategyId] id of the strategy event relates to
   * @property {string} [strategyName] name of the strategy event relates to
   * @property {string} [positionId] position id event relates to
   * @property {string} [side] side of the trade event relates to. One of buy, sell, close
   * @property {string} [type] type of the trade event relates to. One of market, limit, stop
   * @property {number} [openPrice] open price for limit and stop orders
   * @property {string} level log level. One of INFO, WARN, ERROR
   * @property {string} message log message
   */

  /**
   * Returns copy trading user log for an account and time range. See
   * https://metaapi.cloud/docs/copyfactory/restApi/api/trading/getUserLog/
   * @param {string} subscriberId subscriber id
   * @param {Date} [startTime] time to start loading data from
   * @param {Date} [endTime] time to stop loading data at
   * @param {number} [offset] pagination offset. Default is 0
   * @param {number} [limit] pagination limit. Default is 1000
   * @return {Promise<Array<CopyFactoryUserLogMessage>>} promise which resolves with log records found
   */
  async getUserLog(subscriberId, startTime, endTime, offset = 0, limit = 1000) {
    if (this._isNotJwtToken()) {
      return this._handleNoAccessError('getUserLog');
    }
    const opts = {
      url: `/users/current/subscribers/${subscriberId}/user-log`,
      method: 'GET',
      qs: {
        startTime,
        endTime,
        offset,
        limit
      },
      headers: {
        'auth-token': this._token
      },
      json: true
    };
    let result = await this._domainClient.requestCopyFactory(opts, true);
    if (result) {
      result.map(r => r.time = new Date(r.time));
    }
    return result;
  }

  /**
   * Returns event log for CopyFactory strategy, sorted in reverse chronological order. See
   * https://metaapi.cloud/docs/copyfactory/restApi/api/trading/getStrategyLog/ 
   * @param {string} strategyId strategy id to retrieve log for
   * @param {Date} [startTime] time to start loading data from
   * @param {Date} [endTime] time to stop loading data at
   * @param {number} [offset] pagination offset. Default is 0
   * @param {number} [limit] pagination limit. Default is 1000
   * @return {Promise<Array<CopyFactoryUserLogMessage>>} promise which resolves with log records found
   */
  async getStrategyLog(strategyId, startTime, endTime, offset = 0, limit = 1000) {
    if (this._isNotJwtToken()) {
      return this._handleNoAccessError('getStrategyLog');
    }
    const opts = {
      url: `/users/current/strategies/${strategyId}/user-log`,
      method: 'GET',
      qs: {
        startTime,
        endTime,
        offset,
        limit
      },
      headers: {
        'auth-token': this._token
      },
      json: true
    };
    let result = await this._domainClient.requestCopyFactory(opts, true);
    if (result) {
      result.map(r => r.time = new Date(r.time));
    }
    return result;
  }

  /**
   * Adds a stopout listener and creates a job to make requests
   * @param {StopoutListener} listener stopout listener
   * @param {String} [accountId] account id
   * @param {String} [strategyId] strategy id
   * @param {Number} [sequenceNumber] sequence number
   * @return {String} listener id
   */
  addStopoutListener(listener, accountId, strategyId, sequenceNumber) {
    return this._stopoutListenerManager.addStopoutListener(listener, accountId, strategyId, sequenceNumber);
  }

  /**
   * Removes stopout listener and cancels the event stream
   * @param {String} listenerId stopout listener id
   */
  removeStopoutListener(listenerId) {
    this._stopoutListenerManager.removeStopoutListener(listenerId);
  }

  /**
   * Adds a strategy log listener and creates a job to make requests
   * @param {UserLogListener} listener user log listener
   * @param {String} strategyId strategy id
   * @param {Date} [startTime] log search start time
   * @return {String} listener id
   */
  addStrategyLogListener(listener, strategyId, startTime) {
    return this._userLogListenerManager.addStrategyLogListener(listener, strategyId, startTime);
  }

  /**
   * Removes strategy log listener and cancels the event stream
   * @param {String} listenerId strategy log listener id
   */
  removeStrategyLogListener(listenerId) {
    this._userLogListenerManager.removeStrategyLogListener(listenerId);
  }

  /**
   * Adds a subscriber log listener and creates a job to make requests
   * @param {UserLogListener} listener user log listener
   * @param {String} subscriberId subscriber id
   * @param {Date} [startTime] log search start time
   * @return {String} listener id
   */
  addSubscriberLogListener(listener, subscriberId, startTime) {
    return this._userLogListenerManager.addSubscriberLogListener(listener, subscriberId, startTime);
  }

  /**
   * Removes subscriber log listener and cancels the event stream
   * @param {String} listenerId subscriber log listener id
   */
  removeSubscriberLogListener(listenerId) {
    this._userLogListenerManager.removeSubscriberLogListener(listenerId);
  }

}
exports.default = TradingClient;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9jbGllbnRzL2NvcHlGYWN0b3J5L3RyYWRpbmcuY2xpZW50LmVzNiJdLCJuYW1lcyI6WyJUcmFkaW5nQ2xpZW50IiwiTWV0YUFwaUNsaWVudCIsImNvbnN0cnVjdG9yIiwiZG9tYWluQ2xpZW50IiwiX2RvbWFpbkNsaWVudCIsIl9zdG9wb3V0TGlzdGVuZXJNYW5hZ2VyIiwiU3RvcG91dExpc3RlbmVyTWFuYWdlciIsIl91c2VyTG9nTGlzdGVuZXJNYW5hZ2VyIiwiVXNlckxvZ0xpc3RlbmVyTWFuYWdlciIsInJlc3luY2hyb25pemUiLCJhY2NvdW50SWQiLCJzdHJhdGVneUlkcyIsInBvc2l0aW9uSWRzIiwiX2lzTm90Snd0VG9rZW4iLCJfaGFuZGxlTm9BY2Nlc3NFcnJvciIsIm9wdHMiLCJ1cmwiLCJtZXRob2QiLCJoZWFkZXJzIiwiX3Rva2VuIiwicXMiLCJzdHJhdGVneUlkIiwicG9zaXRpb25JZCIsImpzb24iLCJyZXF1ZXN0Q29weUZhY3RvcnkiLCJnZXRTaWduYWxDbGllbnQiLCJhY2NvdW50RGF0YSIsImdldEFjY291bnRJbmZvIiwiaG9zdCIsImdldFNpZ25hbENsaWVudEhvc3QiLCJyZWdpb25zIiwiU2lnbmFsQ2xpZW50IiwiaWQiLCJnZXRTdG9wb3V0cyIsInN1YnNjcmliZXJJZCIsInJlc2V0U3RvcG91dHMiLCJyZWFzb24iLCJnZXRVc2VyTG9nIiwic3RhcnRUaW1lIiwiZW5kVGltZSIsIm9mZnNldCIsImxpbWl0IiwicmVzdWx0IiwibWFwIiwiciIsInRpbWUiLCJEYXRlIiwiZ2V0U3RyYXRlZ3lMb2ciLCJhZGRTdG9wb3V0TGlzdGVuZXIiLCJsaXN0ZW5lciIsInNlcXVlbmNlTnVtYmVyIiwicmVtb3ZlU3RvcG91dExpc3RlbmVyIiwibGlzdGVuZXJJZCIsImFkZFN0cmF0ZWd5TG9nTGlzdGVuZXIiLCJyZW1vdmVTdHJhdGVneUxvZ0xpc3RlbmVyIiwiYWRkU3Vic2NyaWJlckxvZ0xpc3RlbmVyIiwicmVtb3Zl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LFNBQTlFLENBQVA7QUFDRDs7QUFFRDs7OztBQUlBa0IsOEJBQTRCSixVQUE1QixFQUF3QztBQUN0QyxTQUFLN0MsdUJBQUwsQ0FBNkJpRCwyQkFBN0IsQ0FBeURKLFVBQXpEO0FBQ0Q7O0FBbFJzRDtrQkFBcENwRCxhIiwiZmlsZSI6InRyYWRpbmcuY2xpZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgTWV0YUFwaUNsaWVudCBmcm9tICcuLi9tZXRhQXBpLmNsaWVudCc7XG5pbXBvcnQgU2lnbmFsQ2xpZW50IGZyb20gJy4vc2lnbmFsLmNsaWVudCc7XG5pbXBvcnQgU3RvcG91dExpc3RlbmVyTWFuYWdlciBmcm9tICcuL3N0cmVhbWluZy9zdG9wb3V0TGlzdGVuZXJNYW5hZ2VyJztcbmltcG9ydCBVc2VyTG9nTGlzdGVuZXJNYW5hZ2VyIGZyb20gJy4vc3RyZWFtaW5nL3VzZXJMb2dMaXN0ZW5lck1hbmFnZXInO1xuXG4vKipcbiAqIG1ldGFhcGkuY2xvdWQgQ29weUZhY3RvcnkgdHJhZGluZyBBUEkgKHRyYWRlIGNvcHlpbmcgdHJhZGluZyBBUEkpIGNsaWVudCAoc2VlXG4gKiBodHRwczovL21ldGFhcGkuY2xvdWQvZG9jcy9jb3B5ZmFjdG9yeS8pXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRyYWRpbmdDbGllbnQgZXh0ZW5kcyBNZXRhQXBpQ2xpZW50IHtcblxuICAvKipcbiAgICogQ29uc3RydWN0cyBDb3B5RmFjdG9yeSB0cmFkaW5nIEFQSSBjbGllbnQgaW5zdGFuY2VcbiAgICogQHBhcmFtIHtEb21haW5DbGllbnR9IGRvbWFpbkNsaWVudCBkb21haW4gY2xpZW50XG4gICAqL1xuICBjb25zdHJ1Y3Rvcihkb21haW5DbGllbnQpIHtcbiAgICBzdXBlcihkb21haW5DbGllbnQpO1xuICAgIHRoaXMuX2RvbWFpbkNsaWVudCA9IGRvbWFpbkNsaWVudDtcbiAgICB0aGlzLl9zdG9wb3V0TGlzdGVuZXJNYW5hZ2VyID0gbmV3IFN0b3BvdXRMaXN0ZW5lck1hbmFnZXIoZG9tYWluQ2xpZW50KTtcbiAgICB0aGlzLl91c2VyTG9nTGlzdGVuZXJNYW5hZ2VyID0gbmV3IFVzZXJMb2dMaXN0ZW5lck1hbmFnZXIoZG9tYWluQ2xpZW50KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXN5bmNocm9uaXplcyB0aGUgYWNjb3VudC4gU2VlXG4gICAqIGh0dHBzOi8vbWV0YWFwaS5jbG91ZC9kb2NzL2NvcHlmYWN0b3J5L3Jlc3RBcGkvYXBpL3RyYWRpbmcvcmVzeW5jaHJvbml6ZS9cbiAgICogQHBhcmFtIHtTdHJpbmd9IGFjY291bnRJZCBhY2NvdW50IGlkXG4gICAqIEBwYXJhbSB7QXJyYXk8U3RyaW5nPn0gW3N0cmF0ZWd5SWRzXSBhcnJheSBvZiBzdHJhdGVneSBpZHMgdG8gcmVjeW5jaHJvbml6ZS4gRGVmYXVsdCBpcyB0byBzeW5jaHJvbml6ZSBhbGxcbiAgICogc3RyYXRlZ2llc1xuICAgKiBAcGFyYW0ge0FycmF5PFN0cmluZz59IFtwb3NpdGlvbklkc10gYXJyYXkgb2YgcG9zaXRpb24gaWRzIHRvIHJlc3luY2hyb25pemUuIERlZmF1bHQgaXMgdG8gc3luY2hyb25pemUgYWxsXG4gICAqIHBvc2l0aW9uc1xuICAgKiBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlIHdoaWNoIHJlc29sdmVzIHdoZW4gcmVzeW5jaHJvbml6YXRpb24gaXMgc2NoZWR1bGVkXG4gICAqL1xuICBhc3luYyByZXN5bmNocm9uaXplKGFjY291bnRJZCwgc3RyYXRlZ3lJZHMsIHBvc2l0aW9uSWRzKSB7XG4gICAgaWYgKHRoaXMuX2lzTm90Snd0VG9rZW4oKSkge1xuICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZU5vQWNjZXNzRXJyb3IoJ3Jlc3luY2hyb25pemUnKTtcbiAgICB9XG4gICAgY29uc3Qgb3B0cyA9IHtcbiAgICAgIHVybDogYC91c2Vycy9jdXJyZW50L3N1YnNjcmliZXJzLyR7YWNjb3VudElkfS9yZXN5bmNocm9uaXplYCxcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnYXV0aC10b2tlbic6IHRoaXMuX3Rva2VuXG4gICAgICB9LFxuICAgICAgcXM6IHtcbiAgICAgICAgc3RyYXRlZ3lJZDogc3RyYXRlZ3lJZHMsXG4gICAgICAgIHBvc2l0aW9uSWQ6IHBvc2l0aW9uSWRzXG4gICAgICB9LFxuICAgICAganNvbjogdHJ1ZVxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMuX2RvbWFpbkNsaWVudC5yZXF1ZXN0Q29weUZhY3Rvcnkob3B0cyk7XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGVzIGFuIGluc3RhbmNlIG9mIHNpZ25hbCBjbGllbnQgZm9yIGFuIGFjY291bnRcbiAgICogQHBhcmFtIHtTdHJpbmd9IGFjY291bnRJZCBhY2NvdW50IGlkXG4gICAqL1xuICBhc3luYyBnZXRTaWduYWxDbGllbnQoYWNjb3VudElkKSB7XG4gICAgaWYgKHRoaXMuX2lzTm90Snd0VG9rZW4oKSkge1xuICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZU5vQWNjZXNzRXJyb3IoJ2dldFNpZ25hbENsaWVudCcpO1xuICAgIH1cblxuICAgIGxldCBhY2NvdW50RGF0YSA9IGF3YWl0IHRoaXMuX2RvbWFpbkNsaWVudC5nZXRBY2NvdW50SW5mbyhhY2NvdW50SWQpO1xuICAgIGNvbnN0IGhvc3QgPSBhd2FpdCB0aGlzLl9kb21haW5DbGllbnQuZ2V0U2lnbmFsQ2xpZW50SG9zdChhY2NvdW50RGF0YS5yZWdpb25zKTtcbiAgICByZXR1cm4gbmV3IFNpZ25hbENsaWVudChhY2NvdW50RGF0YS5pZCwgaG9zdCwgdGhpcy5fZG9tYWluQ2xpZW50KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb3B5RmFjdG9yeSBzdHJhdGVneSBzdG9wb3V0IHJlYXNvblxuICAgKiBAdHlwZWRlZiB7J2RheS1iYWxhbmNlLWRpZmZlcmVuY2UnIHwgJ2RhdGUtYmFsYW5jZS1kaWZmZXJlbmNlJyB8ICd3ZWVrLWJhbGFuY2UtZGlmZmVyZW5jZScgfFxuICAgKiAnd2Vlay10by1kYXRlLWJhbGFuY2UtZGlmZmVyZW5jZScgfCAnbW9udGgtYmFsYW5jZS1kaWZmZXJlbmNlJyB8ICdtb250aC10by1kYXRlLWJhbGFuY2UtZGlmZmVyZW5jZScgfFxuICAgKiAncXVhcnRlci1iYWxhbmNlLWRpZmZlcmVuY2UnIHwgJ3F1YXJ0ZXItdG8tZGF0ZS1iYWxhbmNlLWRpZmZlcmVuY2UnIHwgJ3llYXItYmFsYW5jZS1kaWZmZXJlbmNlJyB8XG4gICAqICd5ZWFyLXRvLWRhdGUtYmFsYW5jZS1kaWZmZXJlbmNlJyB8ICdsaWZldGltZS1iYWxhbmNlLWRpZmZlcmVuY2UnIHwgJ2RheS1iYWxhbmNlLW1pbnVzLWVxdWl0eScgfFxuICAgKiAnZGF0ZS1iYWxhbmNlLW1pbnVzLWVxdWl0eScgfCAnd2Vlay1iYWxhbmNlLW1pbnVzLWVxdWl0eScgfCAnd2Vlay10by1kYXRlLWJhbGFuY2UtbWludXMtZXF1aXR5JyB8XG4gICAqICdtb250aC1iYWxhbmNlLW1pbnVzLWVxdWl0eScgfCAnbW9udGgtdG8tZGF0ZS1iYWxhbmNlLW1pbnVzLWVxdWl0eScgfFxuICAgKiAncXVhcnRlci1iYWxhbmNlLW1pbnVzLWVxdWl0eScgfCAncXVhcnRlci10by1kYXRlLWJhbGFuY2UtbWludXMtZXF1aXR5JyB8ICd5ZWFyLWJhbGFuY2UtbWludXMtZXF1aXR5JyB8XG4gICAqICd5ZWFyLXRvLWRhdGUtYmFsYW5jZS1taW51cy1lcXVpdHknIHwgJ2xpZmV0aW1lLWJhbGFuY2UtbWludXMtZXF1aXR5JyB8XG4gICAqICdkYXktZXF1aXR5LWRpZmZlcmVuY2UnIHwgJ2RhdGUtZXF1aXR5LWRpZmZlcmVuY2UnIHwgJ3dlZWstZXF1aXR5LWRpZmZlcmVuY2UnIHxcbiAgICogJ3dlZWstdG8tZGF0ZS1lcXVpdHktZGlmZmVyZW5jZScgfCAnbW9udGgtZXF1aXR5LWRpZmZlcmVuY2UnIHxcbiAgICogJ21vbnRoLXRvLWRhdGUtZXF1aXR5LWRpZmZlcmVuY2UnIHwgJ3F1YXJ0ZXItZXF1aXR5LWRpZmZlcmVuY2UnIHwgJ3F1YXJ0ZXItdG8tZGF0ZS1lcXVpdHktZGlmZmVyZW5jZScgfFxuICAgKiAneWVhci1lcXVpdHktZGlmZmVyZW5jZScgfCAneWVhci10by1kYXRlLWVxdWl0eS1kaWZmZXJlbmNlJyB8XG4gICAqICdsaWZldGltZS1lcXVpdHktZGlmZmVyZW5jZSd9IENvcHlGYWN0b3J5U3RyYXRlZ3lTdG9wb3V0UmVhc29uXG4gICAqL1xuXG4gIC8qKlxuICAgKiBDb3B5RmFjdG9yeSBzdHJhdGVneSBzdG9wb3V0XG4gICAqIEB0eXBlZGVmIHtPYmplY3R9IENvcHlGYWN0b3J5U3RyYXRlZ3lTdG9wb3V0XG4gICAqIEBwcm9wZXJ0eSB7U3RyaW5nfSBzdWJzY3JpYmVySWQgc3Vic2NyaWJlciBpZFxuICAgKiBAcHJvcGVydHkge0NvcHlGYWN0b3J5U3RyYXRlZ3lJZEFuZE5hbWV9IHN0cmF0ZWd5IHN0cmF0ZWd5IHdoaWNoIHdhcyBzdG9wcGVkIG91dFxuICAgKiBAcHJvcGVydHkge0Jvb2xlYW59IHBhcnRpYWwgZmxhZyBpbmRpY2F0aW5nIHRoYXQgc3RvcG91dCBpcyBwYXJ0aWFsXG4gICAqIEBwcm9wZXJ0eSB7Q29weUZhY3RvcnlTdHJhdGVneVN0b3BvdXRSZWFzb259IHJlYXNvbiBzdG9wb3V0IHJlYXNvblxuICAgKiBAcHJvcGVydHkge1N0cmluZ30gcmVhc29uRGVzY3JpcHRpb24gaHVtYW4tcmVhZGFibGUgZGVzY3JpcHRpb24gb2YgdGhlIHN0b3BvdXQgcmVhc29uXG4gICAqIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gW2Nsb3NlUG9zaXRpb25zXSBmbGFnIGluZGljYXRpbmcgaWYgcG9zaXRpb25zIHNob3VsZCBiZSBjbG9zZWRcbiAgICogQHByb3BlcnR5IHtEYXRlfSBzdG9wcGVkQXQgdGltZSB0aGUgc3RyYXRlZ3kgd2FzIHN0b3BwZWQgYXRcbiAgICogQHByb3BlcnR5IHtEYXRlfSBzdG9wcGVkVGlsbCB0aW1lIHRoZSBzdHJhdGVneSBpcyBzdG9wcGVkIHRpbGxcbiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IHNlcXVlbmNlTnVtYmVyIHN0b3BvdXQgZXZlbnQgc2VxdWVuY2UgbnVtYmVyXG4gICAqL1xuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHN1YnNjcmliZXIgYWNjb3VudCBzdG9wb3V0cy4gU2VlXG4gICAqIGh0dHBzOi8vbWV0YWFwaS5jbG91ZC9kb2NzL2NvcHlmYWN0b3J5L3Jlc3RBcGkvYXBpL3RyYWRpbmcvZ2V0U3RvcE91dHMvXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBzdWJzY3JpYmVySWQgc3Vic2NyaWJlciBpZFxuICAgKiBAcmV0dXJuIHtQcm9taXNlPEFycmF5PENvcHlGYWN0b3J5U3RyYXRlZ3lTdG9wb3V0Pj59IHByb21pc2Ugd2hpY2ggcmVzb2x2ZXMgd2l0aCBzdG9wb3V0cyBmb3VuZFxuICAgKi9cbiAgYXN5bmMgZ2V0U3RvcG91dHMoc3Vic2NyaWJlcklkKSB7XG4gICAgaWYgKHRoaXMuX2lzTm90Snd0VG9rZW4oKSkge1xuICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZU5vQWNjZXNzRXJyb3IoJ2dldFN0b3BvdXRzJyk7XG4gICAgfVxuICAgIGNvbnN0IG9wdHMgPSB7XG4gICAgICB1cmw6IGAvdXNlcnMvY3VycmVudC9zdWJzY3JpYmVycy8ke3N1YnNjcmliZXJJZH0vc3RvcG91dHNgLFxuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ2F1dGgtdG9rZW4nOiB0aGlzLl90b2tlblxuICAgICAgfSxcbiAgICAgIGpzb246IHRydWVcbiAgICB9O1xuICAgIHJldHVybiB0aGlzLl9kb21haW5DbGllbnQucmVxdWVzdENvcHlGYWN0b3J5KG9wdHMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc2V0cyBzdHJhdGVneSBzdG9wb3V0cy4gU2VlXG4gICAqIGh0dHBzOi8vbWV0YWFwaS5jbG91ZC9kb2NzL2NvcHlmYWN0b3J5L3Jlc3RBcGkvYXBpL3RyYWRpbmcvcmVzZXRTdG9wT3V0cy9cbiAgICogQHBhcmFtIHtTdHJpbmd9IHN1YnNjcmliZXJJZCBzdWJzY3JpYmVyIGlkXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBzdHJhdGVneUlkIHN0cmF0ZWd5IGlkXG4gICAqIEBwYXJhbSB7Q29weUZhY3RvcnlTdHJhdGVneVN0b3BvdXRSZWFzb259IHJlYXNvbiBzdG9wb3V0IHJlYXNvbiB0byByZXNldFxuICAgKiB5ZWFybHktZXF1aXR5LCBtb250aGx5LWVxdWl0eSwgZGFpbHktZXF1aXR5XG4gICAqIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2Ugd2hpY2ggcmVzb2x2ZXMgd2hlbiB0aGUgc3RvcG91dHMgYXJlIHJlc2V0XG4gICAqL1xuICByZXNldFN0b3BvdXRzKHN1YnNjcmliZXJJZCwgc3RyYXRlZ3lJZCwgcmVhc29uKSB7XG4gICAgaWYgKHRoaXMuX2lzTm90Snd0VG9rZW4oKSkge1xuICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZU5vQWNjZXNzRXJyb3IoJ3Jlc2V0U3RvcG91dHMnKTtcbiAgICB9XG4gICAgY29uc3Qgb3B0cyA9IHtcbiAgICAgIHVybDogYC91c2Vycy9jdXJyZW50L3N1YnNjcmliZXJzLyR7c3Vic2NyaWJlcklkfS9zdWJzY3JpcHRpb24tc3RyYXRlZ2llcy9gICtcbiAgICAgICAgYCR7c3RyYXRlZ3lJZH0vc3RvcG91dHMvJHtyZWFzb259L3Jlc2V0YCxcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnYXV0aC10b2tlbic6IHRoaXMuX3Rva2VuXG4gICAgICB9LFxuICAgICAganNvbjogdHJ1ZVxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMuX2RvbWFpbkNsaWVudC5yZXF1ZXN0Q29weUZhY3Rvcnkob3B0cyk7XG4gIH1cblxuICAvKipcbiAgICogVHJhZGUgY29weWluZyB1c2VyIGxvZyByZWNvcmRcbiAgICogQHR5cGVkZWYge09iamVjdH0gQ29weUZhY3RvcnlVc2VyTG9nTWVzc2FnZVxuICAgKiBAcHJvcGVydHkge0RhdGV9IHRpbWUgbG9nIHJlY29yZCB0aW1lXG4gICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbc3ltYm9sXSBzeW1ib2wgdHJhZGVkXG4gICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbc3RyYXRlZ3lJZF0gaWQgb2YgdGhlIHN0cmF0ZWd5IGV2ZW50IHJlbGF0ZXMgdG9cbiAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtzdHJhdGVneU5hbWVdIG5hbWUgb2YgdGhlIHN0cmF0ZWd5IGV2ZW50IHJlbGF0ZXMgdG9cbiAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtwb3NpdGlvbklkXSBwb3NpdGlvbiBpZCBldmVudCByZWxhdGVzIHRvXG4gICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbc2lkZV0gc2lkZSBvZiB0aGUgdHJhZGUgZXZlbnQgcmVsYXRlcyB0by4gT25lIG9mIGJ1eSwgc2VsbCwgY2xvc2VcbiAgICogQHByb3BlcnR5IHtzdHJpbmd9IFt0eXBlXSB0eXBlIG9mIHRoZSB0cmFkZSBldmVudCByZWxhdGVzIHRvLiBPbmUgb2YgbWFya2V0LCBsaW1pdCwgc3RvcFxuICAgKiBAcHJvcGVydHkge251bWJlcn0gW29wZW5QcmljZV0gb3BlbiBwcmljZSBmb3IgbGltaXQgYW5kIHN0b3Agb3JkZXJzXG4gICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBsZXZlbCBsb2cgbGV2ZWwuIE9uZSBvZiBJTkZPLCBXQVJOLCBFUlJPUlxuICAgKiBAcHJvcGVydHkge3N0cmluZ30gbWVzc2FnZSBsb2cgbWVzc2FnZVxuICAgKi9cblxuICAvKipcbiAgICogUmV0dXJucyBjb3B5IHRyYWRpbmcgdXNlciBsb2cgZm9yIGFuIGFjY291bnQgYW5kIHRpbWUgcmFuZ2UuIFNlZVxuICAgKiBodHRwczovL21ldGFhcGkuY2xvdWQvZG9jcy9jb3B5ZmFjdG9yeS9yZXN0QXBpL2FwaS90cmFkaW5nL2dldFVzZXJMb2cvXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzdWJzY3JpYmVySWQgc3Vic2NyaWJlciBpZFxuICAgKiBAcGFyYW0ge0RhdGV9IFtzdGFydFRpbWVdIHRpbWUgdG8gc3RhcnQgbG9hZGluZyBkYXRhIGZyb21cbiAgICogQHBhcmFtIHtEYXRlfSBbZW5kVGltZV0gdGltZSB0byBzdG9wIGxvYWRpbmcgZGF0YSBhdFxuICAgKiBAcGFyYW0ge251bWJlcn0gW29mZnNldF0gcGFnaW5hdGlvbiBvZmZzZXQuIERlZmF1bHQgaXMgMFxuICAgKiBAcGFyYW0ge251bWJlcn0gW2xpbWl0XSBwYWdpbmF0aW9uIGxpbWl0LiBEZWZhdWx0IGlzIDEwMDBcbiAgICogQHJldHVybiB7UHJvbWlzZTxBcnJheTxDb3B5RmFjdG9yeVVzZXJMb2dNZXNzYWdlPj59IHByb21pc2Ugd2hpY2ggcmVzb2x2ZXMgd2l0aCBsb2cgcmVjb3JkcyBmb3VuZFxuICAgKi9cbiAgYXN5bmMgZ2V0VXNlckxvZyhzdWJzY3JpYmVySWQsIHN0YXJ0VGltZSwgZW5kVGltZSwgb2Zmc2V0ID0gMCwgbGltaXQgPSAxMDAwKSB7XG4gICAgaWYgKHRoaXMuX2lzTm90Snd0VG9rZW4oKSkge1xuICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZU5vQWNjZXNzRXJyb3IoJ2dldFVzZXJMb2cnKTtcbiAgICB9XG4gICAgY29uc3Qgb3B0cyA9IHtcbiAgICAgIHVybDogYC91c2Vycy9jdXJyZW50L3N1YnNjcmliZXJzLyR7c3Vic2NyaWJlcklkfS91c2VyLWxvZ2AsXG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgcXM6IHtcbiAgICAgICAgc3RhcnRUaW1lLFxuICAgICAgICBlbmRUaW1lLFxuICAgICAgICBvZmZzZXQsXG4gICAgICAgIGxpbWl0XG4gICAgICB9LFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnYXV0aC10b2tlbic6IHRoaXMuX3Rva2VuXG4gICAgICB9LFxuICAgICAganNvbjogdHJ1ZVxuICAgIH07XG4gICAgbGV0IHJlc3VsdCA9IGF3YWl0IHRoaXMuX2RvbWFpbkNsaWVudC5yZXF1ZXN0Q29weUZhY3Rvcnkob3B0cywgdHJ1ZSk7XG4gICAgaWYgKHJlc3VsdCkge1xuICAgICAgcmVzdWx0Lm1hcChyID0+IHIudGltZSA9IG5ldyBEYXRlKHIudGltZSkpO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgZXZlbnQgbG9nIGZvciBDb3B5RmFjdG9yeSBzdHJhdGVneSwgc29ydGVkIGluIHJldmVyc2UgY2hyb25vbG9naWNhbCBvcmRlci4gU2VlXG4gICAqIGh0dHBzOi8vbWV0YWFwaS5jbG91ZC9kb2NzL2NvcHlmYWN0b3J5L3Jlc3RBcGkvYXBpL3RyYWRpbmcvZ2V0U3RyYXRlZ3lMb2cvIFxuICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyYXRlZ3lJZCBzdHJhdGVneSBpZCB0byByZXRyaWV2ZSBsb2cgZm9yXG4gICAqIEBwYXJhbSB7RGF0ZX0gW3N0YXJ0VGltZV0gdGltZSB0byBzdGFydCBsb2FkaW5nIGRhdGEgZnJvbVxuICAgKiBAcGFyYW0ge0RhdGV9IFtlbmRUaW1lXSB0aW1lIHRvIHN0b3AgbG9hZGluZyBkYXRhIGF0XG4gICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0XSBwYWdpbmF0aW9uIG9mZnNldC4gRGVmYXVsdCBpcyAwXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBbbGltaXRdIHBhZ2luYXRpb24gbGltaXQuIERlZmF1bHQgaXMgMTAwMFxuICAgKiBAcmV0dXJuIHtQcm9taXNlPEFycmF5PENvcHlGYWN0b3J5VXNlckxvZ01lc3NhZ2U+Pn0gcHJvbWlzZSB3aGljaCByZXNvbHZlcyB3aXRoIGxvZyByZWNvcmRzIGZvdW5kXG4gICAqL1xuICBhc3luYyBnZXRTdHJhdGVneUxvZyhzdHJhdGVneUlkLCBzdGFydFRpbWUsIGVuZFRpbWUsIG9mZnNldCA9IDAsIGxpbWl0ID0gMTAwMCkge1xuICAgIGlmICh0aGlzLl9pc05vdEp3dFRva2VuKCkpIHtcbiAgICAgIHJldHVybiB0aGlzLl9oYW5kbGVOb0FjY2Vzc0Vycm9yKCdnZXRTdHJhdGVneUxvZycpO1xuICAgIH1cbiAgICBjb25zdCBvcHRzID0ge1xuICAgICAgdXJsOiBgL3VzZXJzL2N1cnJlbnQvc3RyYXRlZ2llcy8ke3N0cmF0ZWd5SWR9L3VzZXItbG9nYCxcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICBxczoge1xuICAgICAgICBzdGFydFRpbWUsXG4gICAgICAgIGVuZFRpbWUsXG4gICAgICAgIG9mZnNldCxcbiAgICAgICAgbGltaXRcbiAgICAgIH0sXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdhdXRoLXRva2VuJzogdGhpcy5fdG9rZW5cbiAgICAgIH0sXG4gICAgICBqc29uOiB0cnVlXG4gICAgfTtcbiAgICBsZXQgcmVzdWx0ID0gYXdhaXQgdGhpcy5fZG9tYWluQ2xpZW50LnJlcXVlc3RDb3B5RmFjdG9yeShvcHRzLCB0cnVlKTtcbiAgICBpZiAocmVzdWx0KSB7XG4gICAgICByZXN1bHQubWFwKHIgPT4gci50aW1lID0gbmV3IERhdGUoci50aW1lKSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICAvKipcbiAgICogQWRkcyBhIHN0b3BvdXQgbGlzdGVuZXIgYW5kIGNyZWF0ZXMgYSBqb2IgdG8gbWFrZSByZXF1ZXN0c1xuICAgKiBAcGFyYW0ge1N0b3BvdXRMaXN0ZW5lcn0gbGlzdGVuZXIgc3RvcG91dCBsaXN0ZW5lclxuICAgKiBAcGFyYW0ge1N0cmluZ30gW2FjY291bnRJZF0gYWNjb3VudCBpZFxuICAgKiBAcGFyYW0ge1N0cmluZ30gW3N0cmF0ZWd5SWRdIHN0cmF0ZWd5IGlkXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBbc2VxdWVuY2VOdW1iZXJdIHNlcXVlbmNlIG51bWJlclxuICAgKiBAcmV0dXJuIHtTdHJpbmd9IGxpc3RlbmVyIGlkXG4gICAqL1xuICBhZGRTdG9wb3V0TGlzdGVuZXIobGlzdGVuZXIsIGFjY291bnRJZCwgc3RyYXRlZ3lJZCwgc2VxdWVuY2VOdW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5fc3RvcG91dExpc3RlbmVyTWFuYWdlci5hZGRTdG9wb3V0TGlzdGVuZXIobGlzdGVuZXIsIGFjY291bnRJZCwgc3RyYXRlZ3lJZCwgc2VxdWVuY2VOdW1iZXIpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZXMgc3RvcG91dCBsaXN0ZW5lciBhbmQgY2FuY2VscyB0aGUgZXZlbnQgc3RyZWFtXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBsaXN0ZW5lcklkIHN0b3BvdXQgbGlzdGVuZXIgaWRcbiAgICovXG4gIHJlbW92ZVN0b3BvdXRMaXN0ZW5lcihsaXN0ZW5lcklkKSB7XG4gICAgdGhpcy5fc3RvcG91dExpc3RlbmVyTWFuYWdlci5yZW1vdmVTdG9wb3V0TGlzdGVuZXIobGlzdGVuZXJJZCk7XG4gIH1cblxuICAvKipcbiAgICogQWRkcyBhIHN0cmF0ZWd5IGxvZyBsaXN0ZW5lciBhbmQgY3JlYXRlcyBhIGpvYiB0byBtYWtlIHJlcXVlc3RzXG4gICAqIEBwYXJhbSB7VXNlckxvZ0xpc3RlbmVyfSBsaXN0ZW5lciB1c2VyIGxvZyBsaXN0ZW5lclxuICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyYXRlZ3lJZCBzdHJhdGVneSBpZFxuICAgKiBAcGFyYW0ge0RhdGV9IFtzdGFydFRpbWVdIGxvZyBzZWFyY2ggc3RhcnQgdGltZVxuICAgKiBAcmV0dXJuIHtTdHJpbmd9IGxpc3RlbmVyIGlkXG4gICAqL1xuICBhZGRTdHJhdGVneUxvZ0xpc3RlbmVyKGxpc3RlbmVyLCBzdHJhdGVneUlkLCBzdGFydFRpbWUpIHtcbiAgICByZXR1cm4gdGhpcy5fdXNlckxvZ0xpc3RlbmVyTWFuYWdlci5hZGRTdHJhdGVneUxvZ0xpc3RlbmVyKGxpc3RlbmVyLCBzdHJhdGVneUlkLCBzdGFydFRpbWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZXMgc3RyYXRlZ3kgbG9nIGxpc3RlbmVyIGFuZCBjYW5jZWxzIHRoZSBldmVudCBzdHJlYW1cbiAgICogQHBhcmFtIHtTdHJpbmd9IGxpc3RlbmVySWQgc3RyYXRlZ3kgbG9nIGxpc3RlbmVyIGlkXG4gICAqL1xuICByZW1vdmVTdHJhdGVneUxvZ0xpc3RlbmVyKGxpc3RlbmVySWQpIHtcbiAgICB0aGlzLl91c2VyTG9nTGlzdGVuZXJNYW5hZ2VyLnJlbW92ZVN0cmF0ZWd5TG9nTGlzdGVuZXIobGlzdGVuZXJJZCk7XG4gIH1cblxuICAvKipcbiAgICogQWRkcyBhIHN1YnNjcmliZXIgbG9nIGxpc3RlbmVyIGFuZCBjcmVhdGVzIGEgam9iIHRvIG1ha2UgcmVxdWVzdHNcbiAgICogQHBhcmFtIHtVc2VyTG9nTGlzdGVuZXJ9IGxpc3RlbmVyIHVzZXIgbG9nIGxpc3RlbmVyXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBzdWJzY3JpYmVySWQgc3Vic2NyaWJlciBpZFxuICAgKiBAcGFyYW0ge0RhdGV9IFtzdGFydFRpbWVdIGxvZyBzZWFyY2ggc3RhcnQgdGltZVxuICAgKiBAcmV0dXJuIHtTdHJpbmd9IGxpc3RlbmVyIGlkXG4gICAqL1xuICBhZGRTdWJzY3JpYmVyTG9nTGlzdGVuZXIobGlzdGVuZXIsIHN1YnNjcmliZXJJZCwgc3RhcnRUaW1lKSB7XG4gICAgcmV0dXJuIHRoaXMuX3VzZXJMb2dMaXN0ZW5lck1hbmFnZXIuYWRkU3Vic2NyaWJlckxvZ0xpc3RlbmVyKGxpc3RlbmVyLCBzdWJzY3JpYmVySWQsIHN0YXJ0VGltZSk7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyBzdWJzY3JpYmVyIGxvZyBsaXN0ZW5lciBhbmQgY2FuY2VscyB0aGUgZXZlbnQgc3RyZWFtXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBsaXN0ZW5lcklkIHN1YnNjcmliZXIgbG9nIGxpc3RlbmVyIGlkXG4gICAqL1xuICByZW1vdmVTdWJzY3JpYmVyTG9nTGlzdGVuZXIobGlzdGVuZXJJZCkge1xuICAgIHRoaXMuX3VzZXJMb2dMaXN0ZW5lck1hbmFnZXIucmVtb3ZlU3Vic2NyaWJlckxvZ0xpc3RlbmVyKGxpc3RlbmVySWQpO1xuICB9XG5cbn1cbiJdfQ==