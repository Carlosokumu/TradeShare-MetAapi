'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _metaApi = require('../metaApi.client');

var _metaApi2 = _interopRequireDefault(_metaApi);

var _transactionListenerManager = require('./streaming/transactionListenerManager');

var _transactionListenerManager2 = _interopRequireDefault(_transactionListenerManager);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * metaapi.cloud CopyFactory history API (trade copying history API) client (see
 * https://metaapi.cloud/docs/copyfactory/)
 */
class HistoryClient extends _metaApi2.default {

  /**
   * Constructs CopyFactory history API client instance
   * @param {DomainClient} domainClient domain client
   */
  constructor(domainClient) {
    super(domainClient);
    this._domainClient = domainClient;
    this._transactionListenerManager = new _transactionListenerManager2.default(domainClient);
  }

  /**
   * CopyFactory provider or subscriber user
   * @typedef {Object} CopyFactorySubscriberOrProviderUser
   * @property {String} id profile id
   * @property {String} name user name
   * @property {Array<CopyFactoryStrategyIdAndName>} strategies array of strategy IDs provided by provider
   * or subscribed to by subscriber
   */

  /**
   * CopyFactory strategy id and name
   * @typedef {Object} CopyFactoryStrategyIdAndName
   * @property {String} id unique strategy id
   * @property {String} name human-readable strategy name
   */

  /**
   * CopyFactory transaction
   * @typedef {Object} CopyFactoryTransaction
   * @property {String} id transaction id
   * @property {String} type transaction type (one of DEAL_TYPE_BUY, DEAL_TYPE_SELL, DEAL_TYPE_BALANCE,
   * DEAL_TYPE_CREDIT, DEAL_TYPE_CHARGE, DEAL_TYPE_CORRECTION, DEAL_TYPE_BONUS, DEAL_TYPE_COMMISSION,
   * DEAL_TYPE_COMMISSION_DAILY, DEAL_TYPE_COMMISSION_MONTHLY, DEAL_TYPE_COMMISSION_AGENT_DAILY,
   * DEAL_TYPE_COMMISSION_AGENT_MONTHLY, DEAL_TYPE_INTEREST, DEAL_TYPE_BUY_CANCELED, DEAL_TYPE_SELL_CANCELED,
   * DEAL_DIVIDEND, DEAL_DIVIDEND_FRANKED, DEAL_TAX). See
   * https://www.mql5.com/en/docs/constants/tradingconstants/dealproperties#enum_deal_type
   * @property {Date} time transaction time
   * @property {String} subscriberId CopyFactory subscriber id
   * @property {String} [symbol] symbol traded
   * @property {CopyFactorySubscriberOrProviderUser} subscriberUser strategy subscriber
   * @property {Boolean} demo demo account flag
   * @property {CopyFactorySubscriberOrProviderUser} providerUser strategy provider
   * @property {CopyFactoryStrategyIdAndName} strategy strategy
   * @property {String} [positionId] source position id
   * @property {String} [slavePositionId] slave position id
   * @property {Number} improvement high-water mark strategy balance improvement
   * @property {Number} providerCommission provider commission
   * @property {Number} platformCommission platform commission
   * @property {Number} [incomingProviderCommission] commission paid by provider to underlying providers
   * @property {Number} [incomingPlatformCommission] platform commission paid by provider to underlying providers
   * @property {Number} [quantity] trade volume
   * @property {Number} [lotPrice] trade lot price
   * @property {Number} [tickPrice] trade tick price
   * @property {Number} [amount] trade amount
   * @property {Number} [commission] trade commission
   * @property {Number} swap trade swap
   * @property {Number} profit trade profit
   * @property {CopyFactoryTransactionMetrics} [metrics] trade copying metrics such as slippage and latencies. Measured
   * selectively for copied trades
   */

  /**
   * Trade copying metrics such as slippage and latencies
   * @typedef {Object} CopyFactoryTransactionMetrics
   * @property {Number} [tradeCopyingLatency] trade copying latency, measured in milliseconds based on transaction time
   * provided by broker
   * @property {Number} [tradeCopyingSlippageInBasisPoints] trade copying slippage, measured in basis points (0.01
   * percent) based on transaction price provided by broker
   * @property {Number} [tradeCopyingSlippageInAccountCurrency] trade copying slippage, measured in account currency
   * based on transaction price provided by broker
   * @property {Number} [mtAndBrokerSignalLatency] trade signal latency introduced by broker and MT platform, measured
   * in milliseconds
   * @property {Number} [tradeAlgorithmLatency] trade algorithm latency introduced by CopyFactory servers, measured in
   * milliseconds
   * @property {Number} [mtAndBrokerTradeLatency] trade latency for a copied trade introduced by broker and MT platform,
   * measured in milliseconds
   */

  /**
   * Returns list of transactions on the strategies the current user provides to other users
   * https://metaapi.cloud/docs/copyfactory/restApi/api/history/getProvidedTransactions/
   * @param {Date} from time to load transactions from
   * @param {Date} till time to load transactions till
   * @param {Array<string>} [strategyIds] list of strategy ids to filter transactions by
   * @param {Array<string>} [subscriberIds] the list of CopyFactory subscriber account ids to filter by
   * @param {number} [offset] pagination offset. Default value is 0
   * @param {number} [limit] pagination limit. Default value is 1000
   * @return {Promise<Array<CopyFactoryTransaction>>} promise resolving with transactions found
   */
  async getProvidedTransactions(from, till, strategyIds, subscriberIds, offset, limit) {
    if (this._isNotJwtToken()) {
      return this._handleNoAccessError('getProvidedTransactions');
    }
    let qs = {
      from,
      till
    };
    if (strategyIds) {
      qs.strategyId = strategyIds;
    }
    if (subscriberIds) {
      qs.subscriberId = subscriberIds;
    }
    if (offset !== undefined) {
      qs.offset = offset;
    }
    if (limit) {
      qs.limit = limit;
    }
    const opts = {
      url: '/users/current/provided-transactions',
      method: 'GET',
      headers: {
        'auth-token': this._token
      },
      qs,
      json: true
    };
    let transactions = await this._domainClient.requestCopyFactory(opts, true);
    transactions.forEach(t => t.time = new Date(t.time));
    return transactions;
  }

  /**
   * Returns list of trades on the strategies the current user subscribed to
   * https://metaapi.cloud/docs/copyfactory/restApi/api/history/getSubscriptionTransactions/
   * @param {Date} from time to load transactions from
   * @param {Date} till time to load transactions till
   * @param {Array<String>} [strategyIds] list of strategy ids to filter transactions by
   * @param {Array<string>} [subscriberIds] the list of CopyFactory subscriber account ids to filter by
   * @param {Number} offset pagination offset. Default value is 0
   * @param {Number} limit pagination limit. Default value is 1000
   * @return {Promise<Array<CopyFactoryTransaction>>} promise resolving with transactions found
   */
  async getSubscriptionTransactions(from, till, strategyIds, subscriberIds, offset, limit) {
    if (this._isNotJwtToken()) {
      return this._handleNoAccessError('getSubscriptionTransactions');
    }
    let qs = {
      from,
      till
    };
    if (strategyIds) {
      qs.strategyId = strategyIds;
    }
    if (subscriberIds) {
      qs.subscriberId = subscriberIds;
    }
    if (offset !== undefined) {
      qs.offset = offset;
    }
    if (limit) {
      qs.limit = limit;
    }
    const opts = {
      url: '/users/current/subscription-transactions',
      method: 'GET',
      headers: {
        'auth-token': this._token
      },
      qs,
      json: true
    };
    let transactions = await this._domainClient.requestCopyFactory(opts, true);
    transactions.forEach(t => t.time = new Date(t.time));
    return transactions;
  }

  /**
   * Adds a strategy transaction listener and creates a job to make requests
   * @param {TransactionListener} listener transaction listener
   * @param {String} strategyId strategy id
   * @param {Date} [startTime] transaction search start time
   * @return {String} listener id
   */
  addStrategyTransactionListener(listener, strategyId, startTime) {
    return this._transactionListenerManager.addStrategyTransactionListener(listener, strategyId, startTime);
  }

  /**
   * Removes strategy transaction listener and cancels the event stream
   * @param {String} listenerId strategy transaction listener id
   */
  removeStrategyTransactionListener(listenerId) {
    this._transactionListenerManager.removeStrategyTransactionListener(listenerId);
  }

  /**
   * Adds a subscriber transaction listener and creates a job to make requests
   * @param {TransactionListener} listener transaction listener
   * @param {String} subscriberId subscriber id
   * @param {Date} [startTime] transaction search start time
   * @return {String} listener id
   */
  addSubscriberTransactionListener(listener, subscriberId, startTime) {
    return this._transactionListenerManager.addSubscriberTransactionListener(listener, subscriberId, startTime);
  }

  /**
   * Removes subscriber transaction listener and cancels the event stream
   * @param {String} listenerId subscriber transaction listener id
   */
  removeSubscriberTransactionListener(listenerId) {
    this._transactionListenerManager.removeSubscriberTransactionListener(listenerId);
  }

}
exports.default = HistoryClient;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9jbGllbnRzL2NvcHlGYWN0b3J5L2hpc3RvcnkuY2xpZW50LmVzNiJdLCJuYW1lcyI6WyJIaXN0b3J5Q2xpZW50IiwiTWV0YUFwaUNsaWVudCIsImNvbnN0cnVjdG9yIiwiZG9tYWluQ2xpZW50IiwiX2RvbWFpbkNsaWVudCIsIl90cmFuc2FjdGlvbkxpc3RlbmVyTWFuYWdlciIsIlRyYW5zYWN0aW9uTGlzdGVuZXJNYW5hZ2VyIiwiZ2V0UHJvdmlkZWRUcmFuc2FjdGlvbnMiLCJmcm9tIiwidGlsbCIsInN0cmF0ZWd5SWRzIiwic3Vic2NyaWJlcklkcyIsIm9mZnNldCIsImxpbWl0IiwiX2lzTm90Snd0VG9rZW4iLCJfaGFuZGxlTm9BY2Nlc3NFcnJvciIsInFzIiwic3RyYXRlZ3lJZCIsInN1YnNjcmliZXJJZCIsInVuZGVmaW5lZCIsIm9wdHMiLCJ1cmwiLCJtZXRob2QiLCJoZWFkZXJzIiwiX3Rva2VuIiwianNvbiIsInRyYW5zYWN0aW9ucyIsInJlcXVlc3RDb3B5RmFjdG9yeSIsImZvckVhY2giLCJ0IiwidGltZSIsIkRhdGUiLCJnZXRTdWJzY3JpcHRpb25UcmFuc2FjdGlvbnMiLCJhZGRTdHJhdGVneVRyYW5zYWN0aW9uTGlzdGVuZXIiLCJsaXN0ZW5lciIsInN0YXJ0VGltZSIsInJlbW92ZVN0cmF0ZWd5VHJhbnNhY3Rpb25MaXN0ZW5lciIsImxpc3RlbmVySWQiLCJhZGRTdWJzY3JpYmVyVHJhbnNhY3Rpb25MaXN0ZW5lciIsInJlbW92ZVN1YnNjcmliZXJUcmFuc2FjdGlvbkxpc3RlbmVyIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUE7Ozs7QUFDQTs7Ozs7O0FBRUE7Ozs7QUFJZSxNQUFNQSxhQUFOLFNBQTRCQyxpQkFBNUIsQ0FBMEM7O0FBRXZEOzs7O0FBSUFDLGNBQVlDLFlBQVosRUFBMEI7QUFDeEIsVUFBTUEsWUFBTjtBQUNBLFNBQUtDLGFBQUwsR0FBcUJELFlBQXJCO0FBQ0EsU0FBS0UsMkJBQUwsR0FB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QXNGa0IsU0FBdEYsQ0FBUDtBQUNEOztBQUVEOzs7O0FBSUFDLG9DQUFrQ0MsVUFBbEMsRUFBOEM7QUFDNUMsU0FBS2hDLDJCQUFMLENBQWlDK0IsaUNBQWpDLENBQW1FQyxVQUFuRTtBQUNEOztBQUVEOzs7Ozs7O0FBT0FDLG1DQUFpQ0osUUFBakMsRUFBMkNoQixZQUEzQyxFQUF5RGlCLFNBQXpELEVBQW9FO0FBQ2xFLFdBQU8sS0FBSzlCLDJCQUFMLENBQWlDaUMsZ0NBQWpDLENBQWtFSixRQUFsRSxFQUE0RWhCLFlBQTVFLEVBQTBGaUIsU0FBMUYsQ0FBUDtBQUNEOztBQUVEOzs7O0FBSUFJLHNDQUFvQ0YsVUFBcEMsRUFBZ0Q7QUFDOUMsU0FBS2hDLDJCQUFMLENBQWlDa0MsbUNBQWpDLENBQXFFRixVQUFyRTtBQUNEOztBQTlNc0Q7a0JBQXBDckMsYSIsImZpbGUiOiJoaXN0b3J5LmNsaWVudC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IE1ldGFBcGlDbGllbnQgZnJvbSAnLi4vbWV0YUFwaS5jbGllbnQnO1xuaW1wb3J0IFRyYW5zYWN0aW9uTGlzdGVuZXJNYW5hZ2VyIGZyb20gJy4vc3RyZWFtaW5nL3RyYW5zYWN0aW9uTGlzdGVuZXJNYW5hZ2VyJztcblxuLyoqXG4gKiBtZXRhYXBpLmNsb3VkIENvcHlGYWN0b3J5IGhpc3RvcnkgQVBJICh0cmFkZSBjb3B5aW5nIGhpc3RvcnkgQVBJKSBjbGllbnQgKHNlZVxuICogaHR0cHM6Ly9tZXRhYXBpLmNsb3VkL2RvY3MvY29weWZhY3RvcnkvKVxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBIaXN0b3J5Q2xpZW50IGV4dGVuZHMgTWV0YUFwaUNsaWVudCB7XG5cbiAgLyoqXG4gICAqIENvbnN0cnVjdHMgQ29weUZhY3RvcnkgaGlzdG9yeSBBUEkgY2xpZW50IGluc3RhbmNlXG4gICAqIEBwYXJhbSB7RG9tYWluQ2xpZW50fSBkb21haW5DbGllbnQgZG9tYWluIGNsaWVudFxuICAgKi9cbiAgY29uc3RydWN0b3IoZG9tYWluQ2xpZW50KSB7XG4gICAgc3VwZXIoZG9tYWluQ2xpZW50KTtcbiAgICB0aGlzLl9kb21haW5DbGllbnQgPSBkb21haW5DbGllbnQ7XG4gICAgdGhpcy5fdHJhbnNhY3Rpb25MaXN0ZW5lck1hbmFnZXIgPSBuZXcgVHJhbnNhY3Rpb25MaXN0ZW5lck1hbmFnZXIoZG9tYWluQ2xpZW50KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb3B5RmFjdG9yeSBwcm92aWRlciBvciBzdWJzY3JpYmVyIHVzZXJcbiAgICogQHR5cGVkZWYge09iamVjdH0gQ29weUZhY3RvcnlTdWJzY3JpYmVyT3JQcm92aWRlclVzZXJcbiAgICogQHByb3BlcnR5IHtTdHJpbmd9IGlkIHByb2ZpbGUgaWRcbiAgICogQHByb3BlcnR5IHtTdHJpbmd9IG5hbWUgdXNlciBuYW1lXG4gICAqIEBwcm9wZXJ0eSB7QXJyYXk8Q29weUZhY3RvcnlTdHJhdGVneUlkQW5kTmFtZT59IHN0cmF0ZWdpZXMgYXJyYXkgb2Ygc3RyYXRlZ3kgSURzIHByb3ZpZGVkIGJ5IHByb3ZpZGVyXG4gICAqIG9yIHN1YnNjcmliZWQgdG8gYnkgc3Vic2NyaWJlclxuICAgKi9cblxuICAvKipcbiAgICogQ29weUZhY3Rvcnkgc3RyYXRlZ3kgaWQgYW5kIG5hbWVcbiAgICogQHR5cGVkZWYge09iamVjdH0gQ29weUZhY3RvcnlTdHJhdGVneUlkQW5kTmFtZVxuICAgKiBAcHJvcGVydHkge1N0cmluZ30gaWQgdW5pcXVlIHN0cmF0ZWd5IGlkXG4gICAqIEBwcm9wZXJ0eSB7U3RyaW5nfSBuYW1lIGh1bWFuLXJlYWRhYmxlIHN0cmF0ZWd5IG5hbWVcbiAgICovXG5cbiAgLyoqXG4gICAqIENvcHlGYWN0b3J5IHRyYW5zYWN0aW9uXG4gICAqIEB0eXBlZGVmIHtPYmplY3R9IENvcHlGYWN0b3J5VHJhbnNhY3Rpb25cbiAgICogQHByb3BlcnR5IHtTdHJpbmd9IGlkIHRyYW5zYWN0aW9uIGlkXG4gICAqIEBwcm9wZXJ0eSB7U3RyaW5nfSB0eXBlIHRyYW5zYWN0aW9uIHR5cGUgKG9uZSBvZiBERUFMX1RZUEVfQlVZLCBERUFMX1RZUEVfU0VMTCwgREVBTF9UWVBFX0JBTEFOQ0UsXG4gICAqIERFQUxfVFlQRV9DUkVESVQsIERFQUxfVFlQRV9DSEFSR0UsIERFQUxfVFlQRV9DT1JSRUNUSU9OLCBERUFMX1RZUEVfQk9OVVMsIERFQUxfVFlQRV9DT01NSVNTSU9OLFxuICAgKiBERUFMX1RZUEVfQ09NTUlTU0lPTl9EQUlMWSwgREVBTF9UWVBFX0NPTU1JU1NJT05fTU9OVEhMWSwgREVBTF9UWVBFX0NPTU1JU1NJT05fQUdFTlRfREFJTFksXG4gICAqIERFQUxfVFlQRV9DT01NSVNTSU9OX0FHRU5UX01PTlRITFksIERFQUxfVFlQRV9JTlRFUkVTVCwgREVBTF9UWVBFX0JVWV9DQU5DRUxFRCwgREVBTF9UWVBFX1NFTExfQ0FOQ0VMRUQsXG4gICAqIERFQUxfRElWSURFTkQsIERFQUxfRElWSURFTkRfRlJBTktFRCwgREVBTF9UQVgpLiBTZWVcbiAgICogaHR0cHM6Ly93d3cubXFsNS5jb20vZW4vZG9jcy9jb25zdGFudHMvdHJhZGluZ2NvbnN0YW50cy9kZWFscHJvcGVydGllcyNlbnVtX2RlYWxfdHlwZVxuICAgKiBAcHJvcGVydHkge0RhdGV9IHRpbWUgdHJhbnNhY3Rpb24gdGltZVxuICAgKiBAcHJvcGVydHkge1N0cmluZ30gc3Vic2NyaWJlcklkIENvcHlGYWN0b3J5IHN1YnNjcmliZXIgaWRcbiAgICogQHByb3BlcnR5IHtTdHJpbmd9IFtzeW1ib2xdIHN5bWJvbCB0cmFkZWRcbiAgICogQHByb3BlcnR5IHtDb3B5RmFjdG9yeVN1YnNjcmliZXJPclByb3ZpZGVyVXNlcn0gc3Vic2NyaWJlclVzZXIgc3RyYXRlZ3kgc3Vic2NyaWJlclxuICAgKiBAcHJvcGVydHkge0Jvb2xlYW59IGRlbW8gZGVtbyBhY2NvdW50IGZsYWdcbiAgICogQHByb3BlcnR5IHtDb3B5RmFjdG9yeVN1YnNjcmliZXJPclByb3ZpZGVyVXNlcn0gcHJvdmlkZXJVc2VyIHN0cmF0ZWd5IHByb3ZpZGVyXG4gICAqIEBwcm9wZXJ0eSB7Q29weUZhY3RvcnlTdHJhdGVneUlkQW5kTmFtZX0gc3RyYXRlZ3kgc3RyYXRlZ3lcbiAgICogQHByb3BlcnR5IHtTdHJpbmd9IFtwb3NpdGlvbklkXSBzb3VyY2UgcG9zaXRpb24gaWRcbiAgICogQHByb3BlcnR5IHtTdHJpbmd9IFtzbGF2ZVBvc2l0aW9uSWRdIHNsYXZlIHBvc2l0aW9uIGlkXG4gICAqIEBwcm9wZXJ0eSB7TnVtYmVyfSBpbXByb3ZlbWVudCBoaWdoLXdhdGVyIG1hcmsgc3RyYXRlZ3kgYmFsYW5jZSBpbXByb3ZlbWVudFxuICAgKiBAcHJvcGVydHkge051bWJlcn0gcHJvdmlkZXJDb21taXNzaW9uIHByb3ZpZGVyIGNvbW1pc3Npb25cbiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IHBsYXRmb3JtQ29tbWlzc2lvbiBwbGF0Zm9ybSBjb21taXNzaW9uXG4gICAqIEBwcm9wZXJ0eSB7TnVtYmVyfSBbaW5jb21pbmdQcm92aWRlckNvbW1pc3Npb25dIGNvbW1pc3Npb24gcGFpZCBieSBwcm92aWRlciB0byB1bmRlcmx5aW5nIHByb3ZpZGVyc1xuICAgKiBAcHJvcGVydHkge051bWJlcn0gW2luY29taW5nUGxhdGZvcm1Db21taXNzaW9uXSBwbGF0Zm9ybSBjb21taXNzaW9uIHBhaWQgYnkgcHJvdmlkZXIgdG8gdW5kZXJseWluZyBwcm92aWRlcnNcbiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IFtxdWFudGl0eV0gdHJhZGUgdm9sdW1lXG4gICAqIEBwcm9wZXJ0eSB7TnVtYmVyfSBbbG90UHJpY2VdIHRyYWRlIGxvdCBwcmljZVxuICAgKiBAcHJvcGVydHkge051bWJlcn0gW3RpY2tQcmljZV0gdHJhZGUgdGljayBwcmljZVxuICAgKiBAcHJvcGVydHkge051bWJlcn0gW2Ftb3VudF0gdHJhZGUgYW1vdW50XG4gICAqIEBwcm9wZXJ0eSB7TnVtYmVyfSBbY29tbWlzc2lvbl0gdHJhZGUgY29tbWlzc2lvblxuICAgKiBAcHJvcGVydHkge051bWJlcn0gc3dhcCB0cmFkZSBzd2FwXG4gICAqIEBwcm9wZXJ0eSB7TnVtYmVyfSBwcm9maXQgdHJhZGUgcHJvZml0XG4gICAqIEBwcm9wZXJ0eSB7Q29weUZhY3RvcnlUcmFuc2FjdGlvbk1ldHJpY3N9IFttZXRyaWNzXSB0cmFkZSBjb3B5aW5nIG1ldHJpY3Mgc3VjaCBhcyBzbGlwcGFnZSBhbmQgbGF0ZW5jaWVzLiBNZWFzdXJlZFxuICAgKiBzZWxlY3RpdmVseSBmb3IgY29waWVkIHRyYWRlc1xuICAgKi9cblxuICAvKipcbiAgICogVHJhZGUgY29weWluZyBtZXRyaWNzIHN1Y2ggYXMgc2xpcHBhZ2UgYW5kIGxhdGVuY2llc1xuICAgKiBAdHlwZWRlZiB7T2JqZWN0fSBDb3B5RmFjdG9yeVRyYW5zYWN0aW9uTWV0cmljc1xuICAgKiBAcHJvcGVydHkge051bWJlcn0gW3RyYWRlQ29weWluZ0xhdGVuY3ldIHRyYWRlIGNvcHlpbmcgbGF0ZW5jeSwgbWVhc3VyZWQgaW4gbWlsbGlzZWNvbmRzIGJhc2VkIG9uIHRyYW5zYWN0aW9uIHRpbWVcbiAgICogcHJvdmlkZWQgYnkgYnJva2VyXG4gICAqIEBwcm9wZXJ0eSB7TnVtYmVyfSBbdHJhZGVDb3B5aW5nU2xpcHBhZ2VJbkJhc2lzUG9pbnRzXSB0cmFkZSBjb3B5aW5nIHNsaXBwYWdlLCBtZWFzdXJlZCBpbiBiYXNpcyBwb2ludHMgKDAuMDFcbiAgICogcGVyY2VudCkgYmFzZWQgb24gdHJhbnNhY3Rpb24gcHJpY2UgcHJvdmlkZWQgYnkgYnJva2VyXG4gICAqIEBwcm9wZXJ0eSB7TnVtYmVyfSBbdHJhZGVDb3B5aW5nU2xpcHBhZ2VJbkFjY291bnRDdXJyZW5jeV0gdHJhZGUgY29weWluZyBzbGlwcGFnZSwgbWVhc3VyZWQgaW4gYWNjb3VudCBjdXJyZW5jeVxuICAgKiBiYXNlZCBvbiB0cmFuc2FjdGlvbiBwcmljZSBwcm92aWRlZCBieSBicm9rZXJcbiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IFttdEFuZEJyb2tlclNpZ25hbExhdGVuY3ldIHRyYWRlIHNpZ25hbCBsYXRlbmN5IGludHJvZHVjZWQgYnkgYnJva2VyIGFuZCBNVCBwbGF0Zm9ybSwgbWVhc3VyZWRcbiAgICogaW4gbWlsbGlzZWNvbmRzXG4gICAqIEBwcm9wZXJ0eSB7TnVtYmVyfSBbdHJhZGVBbGdvcml0aG1MYXRlbmN5XSB0cmFkZSBhbGdvcml0aG0gbGF0ZW5jeSBpbnRyb2R1Y2VkIGJ5IENvcHlGYWN0b3J5IHNlcnZlcnMsIG1lYXN1cmVkIGluXG4gICAqIG1pbGxpc2Vjb25kc1xuICAgKiBAcHJvcGVydHkge051bWJlcn0gW210QW5kQnJva2VyVHJhZGVMYXRlbmN5XSB0cmFkZSBsYXRlbmN5IGZvciBhIGNvcGllZCB0cmFkZSBpbnRyb2R1Y2VkIGJ5IGJyb2tlciBhbmQgTVQgcGxhdGZvcm0sXG4gICAqIG1lYXN1cmVkIGluIG1pbGxpc2Vjb25kc1xuICAgKi9cblxuICAvKipcbiAgICogUmV0dXJucyBsaXN0IG9mIHRyYW5zYWN0aW9ucyBvbiB0aGUgc3RyYXRlZ2llcyB0aGUgY3VycmVudCB1c2VyIHByb3ZpZGVzIHRvIG90aGVyIHVzZXJzXG4gICAqIGh0dHBzOi8vbWV0YWFwaS5jbG91ZC9kb2NzL2NvcHlmYWN0b3J5L3Jlc3RBcGkvYXBpL2hpc3RvcnkvZ2V0UHJvdmlkZWRUcmFuc2FjdGlvbnMvXG4gICAqIEBwYXJhbSB7RGF0ZX0gZnJvbSB0aW1lIHRvIGxvYWQgdHJhbnNhY3Rpb25zIGZyb21cbiAgICogQHBhcmFtIHtEYXRlfSB0aWxsIHRpbWUgdG8gbG9hZCB0cmFuc2FjdGlvbnMgdGlsbFxuICAgKiBAcGFyYW0ge0FycmF5PHN0cmluZz59IFtzdHJhdGVneUlkc10gbGlzdCBvZiBzdHJhdGVneSBpZHMgdG8gZmlsdGVyIHRyYW5zYWN0aW9ucyBieVxuICAgKiBAcGFyYW0ge0FycmF5PHN0cmluZz59IFtzdWJzY3JpYmVySWRzXSB0aGUgbGlzdCBvZiBDb3B5RmFjdG9yeSBzdWJzY3JpYmVyIGFjY291bnQgaWRzIHRvIGZpbHRlciBieVxuICAgKiBAcGFyYW0ge251bWJlcn0gW29mZnNldF0gcGFnaW5hdGlvbiBvZmZzZXQuIERlZmF1bHQgdmFsdWUgaXMgMFxuICAgKiBAcGFyYW0ge251bWJlcn0gW2xpbWl0XSBwYWdpbmF0aW9uIGxpbWl0LiBEZWZhdWx0IHZhbHVlIGlzIDEwMDBcbiAgICogQHJldHVybiB7UHJvbWlzZTxBcnJheTxDb3B5RmFjdG9yeVRyYW5zYWN0aW9uPj59IHByb21pc2UgcmVzb2x2aW5nIHdpdGggdHJhbnNhY3Rpb25zIGZvdW5kXG4gICAqL1xuICBhc3luYyBnZXRQcm92aWRlZFRyYW5zYWN0aW9ucyhmcm9tLCB0aWxsLCBzdHJhdGVneUlkcywgc3Vic2NyaWJlcklkcywgb2Zmc2V0LCBsaW1pdCkge1xuICAgIGlmICh0aGlzLl9pc05vdEp3dFRva2VuKCkpIHtcbiAgICAgIHJldHVybiB0aGlzLl9oYW5kbGVOb0FjY2Vzc0Vycm9yKCdnZXRQcm92aWRlZFRyYW5zYWN0aW9ucycpO1xuICAgIH1cbiAgICBsZXQgcXMgPSB7XG4gICAgICBmcm9tLFxuICAgICAgdGlsbFxuICAgIH07XG4gICAgaWYgKHN0cmF0ZWd5SWRzKSB7XG4gICAgICBxcy5zdHJhdGVneUlkID0gc3RyYXRlZ3lJZHM7XG4gICAgfVxuICAgIGlmIChzdWJzY3JpYmVySWRzKSB7XG4gICAgICBxcy5zdWJzY3JpYmVySWQgPSBzdWJzY3JpYmVySWRzO1xuICAgIH1cbiAgICBpZiAob2Zmc2V0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHFzLm9mZnNldCA9IG9mZnNldDtcbiAgICB9XG4gICAgaWYgKGxpbWl0KSB7XG4gICAgICBxcy5saW1pdCA9IGxpbWl0O1xuICAgIH1cbiAgICBjb25zdCBvcHRzID0ge1xuICAgICAgdXJsOiAnL3VzZXJzL2N1cnJlbnQvcHJvdmlkZWQtdHJhbnNhY3Rpb25zJyxcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdhdXRoLXRva2VuJzogdGhpcy5fdG9rZW5cbiAgICAgIH0sXG4gICAgICBxcyxcbiAgICAgIGpzb246IHRydWVcbiAgICB9O1xuICAgIGxldCB0cmFuc2FjdGlvbnMgPSBhd2FpdCB0aGlzLl9kb21haW5DbGllbnQucmVxdWVzdENvcHlGYWN0b3J5KG9wdHMsIHRydWUpO1xuICAgIHRyYW5zYWN0aW9ucy5mb3JFYWNoKHQgPT4gdC50aW1lID0gbmV3IERhdGUodC50aW1lKSk7XG4gICAgcmV0dXJuIHRyYW5zYWN0aW9ucztcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGxpc3Qgb2YgdHJhZGVzIG9uIHRoZSBzdHJhdGVnaWVzIHRoZSBjdXJyZW50IHVzZXIgc3Vic2NyaWJlZCB0b1xuICAgKiBodHRwczovL21ldGFhcGkuY2xvdWQvZG9jcy9jb3B5ZmFjdG9yeS9yZXN0QXBpL2FwaS9oaXN0b3J5L2dldFN1YnNjcmlwdGlvblRyYW5zYWN0aW9ucy9cbiAgICogQHBhcmFtIHtEYXRlfSBmcm9tIHRpbWUgdG8gbG9hZCB0cmFuc2FjdGlvbnMgZnJvbVxuICAgKiBAcGFyYW0ge0RhdGV9IHRpbGwgdGltZSB0byBsb2FkIHRyYW5zYWN0aW9ucyB0aWxsXG4gICAqIEBwYXJhbSB7QXJyYXk8U3RyaW5nPn0gW3N0cmF0ZWd5SWRzXSBsaXN0IG9mIHN0cmF0ZWd5IGlkcyB0byBmaWx0ZXIgdHJhbnNhY3Rpb25zIGJ5XG4gICAqIEBwYXJhbSB7QXJyYXk8c3RyaW5nPn0gW3N1YnNjcmliZXJJZHNdIHRoZSBsaXN0IG9mIENvcHlGYWN0b3J5IHN1YnNjcmliZXIgYWNjb3VudCBpZHMgdG8gZmlsdGVyIGJ5XG4gICAqIEBwYXJhbSB7TnVtYmVyfSBvZmZzZXQgcGFnaW5hdGlvbiBvZmZzZXQuIERlZmF1bHQgdmFsdWUgaXMgMFxuICAgKiBAcGFyYW0ge051bWJlcn0gbGltaXQgcGFnaW5hdGlvbiBsaW1pdC4gRGVmYXVsdCB2YWx1ZSBpcyAxMDAwXG4gICAqIEByZXR1cm4ge1Byb21pc2U8QXJyYXk8Q29weUZhY3RvcnlUcmFuc2FjdGlvbj4+fSBwcm9taXNlIHJlc29sdmluZyB3aXRoIHRyYW5zYWN0aW9ucyBmb3VuZFxuICAgKi9cbiAgYXN5bmMgZ2V0U3Vic2NyaXB0aW9uVHJhbnNhY3Rpb25zKGZyb20sIHRpbGwsIHN0cmF0ZWd5SWRzLCBzdWJzY3JpYmVySWRzLCBvZmZzZXQsIGxpbWl0KSB7XG4gICAgaWYgKHRoaXMuX2lzTm90Snd0VG9rZW4oKSkge1xuICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZU5vQWNjZXNzRXJyb3IoJ2dldFN1YnNjcmlwdGlvblRyYW5zYWN0aW9ucycpO1xuICAgIH1cbiAgICBsZXQgcXMgPSB7XG4gICAgICBmcm9tLFxuICAgICAgdGlsbFxuICAgIH07XG4gICAgaWYgKHN0cmF0ZWd5SWRzKSB7XG4gICAgICBxcy5zdHJhdGVneUlkID0gc3RyYXRlZ3lJZHM7XG4gICAgfVxuICAgIGlmIChzdWJzY3JpYmVySWRzKSB7XG4gICAgICBxcy5zdWJzY3JpYmVySWQgPSBzdWJzY3JpYmVySWRzO1xuICAgIH1cbiAgICBpZiAob2Zmc2V0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHFzLm9mZnNldCA9IG9mZnNldDtcbiAgICB9XG4gICAgaWYgKGxpbWl0KSB7XG4gICAgICBxcy5saW1pdCA9IGxpbWl0O1xuICAgIH1cbiAgICBjb25zdCBvcHRzID0ge1xuICAgICAgdXJsOiAnL3VzZXJzL2N1cnJlbnQvc3Vic2NyaXB0aW9uLXRyYW5zYWN0aW9ucycsXG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnYXV0aC10b2tlbic6IHRoaXMuX3Rva2VuXG4gICAgICB9LFxuICAgICAgcXMsXG4gICAgICBqc29uOiB0cnVlXG4gICAgfTtcbiAgICBsZXQgdHJhbnNhY3Rpb25zID0gYXdhaXQgdGhpcy5fZG9tYWluQ2xpZW50LnJlcXVlc3RDb3B5RmFjdG9yeShvcHRzLCB0cnVlKTtcbiAgICB0cmFuc2FjdGlvbnMuZm9yRWFjaCh0ID0+IHQudGltZSA9IG5ldyBEYXRlKHQudGltZSkpO1xuICAgIHJldHVybiB0cmFuc2FjdGlvbnM7XG4gIH1cblxuICAvKipcbiAgICogQWRkcyBhIHN0cmF0ZWd5IHRyYW5zYWN0aW9uIGxpc3RlbmVyIGFuZCBjcmVhdGVzIGEgam9iIHRvIG1ha2UgcmVxdWVzdHNcbiAgICogQHBhcmFtIHtUcmFuc2FjdGlvbkxpc3RlbmVyfSBsaXN0ZW5lciB0cmFuc2FjdGlvbiBsaXN0ZW5lclxuICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyYXRlZ3lJZCBzdHJhdGVneSBpZFxuICAgKiBAcGFyYW0ge0RhdGV9IFtzdGFydFRpbWVdIHRyYW5zYWN0aW9uIHNlYXJjaCBzdGFydCB0aW1lXG4gICAqIEByZXR1cm4ge1N0cmluZ30gbGlzdGVuZXIgaWRcbiAgICovXG4gIGFkZFN0cmF0ZWd5VHJhbnNhY3Rpb25MaXN0ZW5lcihsaXN0ZW5lciwgc3RyYXRlZ3lJZCwgc3RhcnRUaW1lKSB7XG4gICAgcmV0dXJuIHRoaXMuX3RyYW5zYWN0aW9uTGlzdGVuZXJNYW5hZ2VyLmFkZFN0cmF0ZWd5VHJhbnNhY3Rpb25MaXN0ZW5lcihsaXN0ZW5lciwgc3RyYXRlZ3lJZCwgc3RhcnRUaW1lKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmVzIHN0cmF0ZWd5IHRyYW5zYWN0aW9uIGxpc3RlbmVyIGFuZCBjYW5jZWxzIHRoZSBldmVudCBzdHJlYW1cbiAgICogQHBhcmFtIHtTdHJpbmd9IGxpc3RlbmVySWQgc3RyYXRlZ3kgdHJhbnNhY3Rpb24gbGlzdGVuZXIgaWRcbiAgICovXG4gIHJlbW92ZVN0cmF0ZWd5VHJhbnNhY3Rpb25MaXN0ZW5lcihsaXN0ZW5lcklkKSB7XG4gICAgdGhpcy5fdHJhbnNhY3Rpb25MaXN0ZW5lck1hbmFnZXIucmVtb3ZlU3RyYXRlZ3lUcmFuc2FjdGlvbkxpc3RlbmVyKGxpc3RlbmVySWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZHMgYSBzdWJzY3JpYmVyIHRyYW5zYWN0aW9uIGxpc3RlbmVyIGFuZCBjcmVhdGVzIGEgam9iIHRvIG1ha2UgcmVxdWVzdHNcbiAgICogQHBhcmFtIHtUcmFuc2FjdGlvbkxpc3RlbmVyfSBsaXN0ZW5lciB0cmFuc2FjdGlvbiBsaXN0ZW5lclxuICAgKiBAcGFyYW0ge1N0cmluZ30gc3Vic2NyaWJlcklkIHN1YnNjcmliZXIgaWRcbiAgICogQHBhcmFtIHtEYXRlfSBbc3RhcnRUaW1lXSB0cmFuc2FjdGlvbiBzZWFyY2ggc3RhcnQgdGltZVxuICAgKiBAcmV0dXJuIHtTdHJpbmd9IGxpc3RlbmVyIGlkXG4gICAqL1xuICBhZGRTdWJzY3JpYmVyVHJhbnNhY3Rpb25MaXN0ZW5lcihsaXN0ZW5lciwgc3Vic2NyaWJlcklkLCBzdGFydFRpbWUpIHtcbiAgICByZXR1cm4gdGhpcy5fdHJhbnNhY3Rpb25MaXN0ZW5lck1hbmFnZXIuYWRkU3Vic2NyaWJlclRyYW5zYWN0aW9uTGlzdGVuZXIobGlzdGVuZXIsIHN1YnNjcmliZXJJZCwgc3RhcnRUaW1lKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmVzIHN1YnNjcmliZXIgdHJhbnNhY3Rpb24gbGlzdGVuZXIgYW5kIGNhbmNlbHMgdGhlIGV2ZW50IHN0cmVhbVxuICAgKiBAcGFyYW0ge1N0cmluZ30gbGlzdGVuZXJJZCBzdWJzY3JpYmVyIHRyYW5zYWN0aW9uIGxpc3RlbmVyIGlkXG4gICAqL1xuICByZW1vdmVTdWJzY3JpYmVyVHJhbnNhY3Rpb25MaXN0ZW5lcihsaXN0ZW5lcklkKSB7XG4gICAgdGhpcy5fdHJhbnNhY3Rpb25MaXN0ZW5lck1hbmFnZXIucmVtb3ZlU3Vic2NyaWJlclRyYW5zYWN0aW9uTGlzdGVuZXIobGlzdGVuZXJJZCk7XG4gIH1cblxufVxuIl19