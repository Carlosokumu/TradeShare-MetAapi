'use strict';

var _httpClient = require('../httpClient');

var _httpClient2 = _interopRequireDefault(_httpClient);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _historicalMarketData = require('./historicalMarketData.client');

var _historicalMarketData2 = _interopRequireDefault(_historicalMarketData);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const marketDataClientApiUrl = 'https://mt-market-data-client-api-v1.vint-hill.agiliumlabs.cloud';

/**
 * @test {HistoricalMarketDataClient}
 */
describe('HistoricalMarketDataClient', () => {

  let client;
  const token = 'header.payload.sign';
  let httpClient = new _httpClient2.default();
  let domainClient;
  let sandbox;
  let requestStub;
  let marketDataStub;

  before(() => {
    sandbox = _sinon2.default.createSandbox();
  });

  beforeEach(() => {
    domainClient = {
      token,
      domain: 'agiliumtrade.agiliumtrade.ai',
      getUrl: () => {}
    };
    client = new _historicalMarketData2.default(httpClient, domainClient);
    requestStub = sandbox.stub(httpClient, 'request');
    sandbox.stub(domainClient, 'getUrl').resolves(marketDataClientApiUrl);
    requestStub.withArgs({
      url: 'https://mt-provisioning-api-v1.agiliumtrade.agiliumtrade.ai/users/current/regions',
      method: 'GET',
      headers: {
        'auth-token': token
      },
      json: true
    }).resolves(['vint-hill', 'us-west']).withArgs({
      url: 'https://mt-provisioning-api-v1.agiliumtrade.agiliumtrade.ai/users/current/servers/mt-client-api',
      method: 'GET',
      headers: {
        'auth-token': token
      },
      json: true
    }).resolves({ domain: 'agiliumlabs.cloud' });
    marketDataStub = requestStub;
  });

  afterEach(() => {
    sandbox.restore();
  });

  /**
   * @test {HistoricalMarketDataClient#getHistoricalCandles}
   */
  it('should download historical candles from API', async () => {
    let expected = [{
      symbol: 'AUDNZD',
      timeframe: '15m',
      time: new Date('2020-04-07T03:45:00.000Z'),
      brokerTime: '2020-04-07 06:45:00.000',
      open: 1.03297,
      high: 1.06309,
      low: 1.02705,
      close: 1.043,
      tickVolume: 1435,
      spread: 17,
      volume: 345
    }];
    marketDataStub.resolves(expected);
    let candles = await client.getHistoricalCandles('accountId', 'vint-hill', 'AUDNZD', '15m', new Date('2020-04-07T03:45:00.000Z'), 1);
    candles.should.equal(expected);
    _sinon2.default.assert.calledWith(httpClient.request, {
      url: `${marketDataClientApiUrl}/users/current/accounts/accountId/historical-market-data/symbols/AUDNZD/` + 'timeframes/15m/candles',
      method: 'GET',
      qs: {
        startTime: new Date('2020-04-07T03:45:00.000Z'),
        limit: 1
      },
      headers: {
        'auth-token': token
      },
      json: true
    }, 'getHistoricalCandles');
  });

  /**
   * @test {HistoricalMarketDataClient#getHistoricalCandles}
   */
  it('should download historical candles from API for symbol with special characters', async () => {
    let expected = [{
      symbol: 'GBPJPY#',
      timeframe: '15m',
      time: new Date('2020-04-07T03:45:00.000Z'),
      brokerTime: '2020-04-07 06:45:00.000',
      open: 1.03297,
      high: 1.06309,
      low: 1.02705,
      close: 1.043,
      tickVolume: 1435,
      spread: 17,
      volume: 345
    }];
    marketDataStub.resolves(expected);
    let candles = await client.getHistoricalCandles('accountId', 'vint-hill', 'GBPJPY#', '15m', new Date('2020-04-07T03:45:00.000Z'), 1);
    candles.should.equal(expected);
    _sinon2.default.assert.calledWith(httpClient.request, {
      url: `${marketDataClientApiUrl}/users/current/accounts/accountId/historical-market-data/symbols/GBPJPY%23/` + 'timeframes/15m/candles',
      method: 'GET',
      qs: {
        startTime: new Date('2020-04-07T03:45:00.000Z'),
        limit: 1
      },
      headers: {
        'auth-token': token
      },
      json: true
    }, 'getHistoricalCandles');
  });

  /**
   * @test {HistoricalMarketDataClient#getHistoricalTicks}
   */
  it('should download historical ticks from API', async () => {
    let expected = [{
      symbol: 'AUDNZD',
      time: new Date('2020-04-07T03:45:00.000Z'),
      brokerTime: '2020-04-07 06:45:00.000',
      bid: 1.05297,
      ask: 1.05309,
      last: 0.5298,
      volume: 0.13,
      side: 'buy'
    }];
    requestStub.resolves(expected);
    let ticks = await client.getHistoricalTicks('accountId', 'vint-hill', 'AUDNZD', new Date('2020-04-07T03:45:00.000Z'), 0, 1);
    ticks.should.equal(expected);
    _sinon2.default.assert.calledWith(httpClient.request, {
      url: `${marketDataClientApiUrl}/users/current/accounts/accountId/historical-market-data/symbols/AUDNZD/ticks`,
      method: 'GET',
      qs: {
        startTime: new Date('2020-04-07T03:45:00.000Z'),
        offset: 0,
        limit: 1
      },
      headers: {
        'auth-token': token
      },
      json: true
    }, 'getHistoricalTicks');
  });

  /**
   * @test {HistoricalMarketDataClient#getHistoricalTicks}
   */
  it('should download historical ticks from API for symbol with special characters', async () => {
    let expected = [{
      symbol: 'GBPJPY#',
      time: new Date('2020-04-07T03:45:00.000Z'),
      brokerTime: '2020-04-07 06:45:00.000',
      bid: 1.05297,
      ask: 1.05309,
      last: 0.5298,
      volume: 0.13,
      side: 'buy'
    }];
    requestStub.resolves(expected);
    let ticks = await client.getHistoricalTicks('accountId', 'vint-hill', 'GBPJPY#', new Date('2020-04-07T03:45:00.000Z'), 0, 1);
    ticks.should.equal(expected);
    _sinon2.default.assert.calledWith(httpClient.request, {
      url: `${marketDataClientApiUrl}/users/current/accounts/accountId/historical-market-data/symbols/GBPJPY%23/ticks`,
      method: 'GET',
      qs: {
        startTime: new Date('2020-04-07T03:45:00.000Z'),
        offset: 0,
        limit: 1
      },
      headers: {
        'auth-token': token
      },
      json: true
    }, 'getHistoricalTicks');
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9jbGllbnRzL21ldGFBcGkvaGlzdG9yaWNhbE1hcmtldERhdGEuY2xpZW50LnNwZWMuZXM2Il0sIm5hbWVzIjpbIm1hcmtldERhdGFDbGllbnRBcGlVcmwiLCJkZXNjcmliZSIsImNsaWVudCIsInRva2VuIiwiaHR0cENsaWVudCIsIkh0dHBDbGllbnQiLCJkb21haW5DbGllbnQiLCJzYW5kYm94IiwicmVxdWVzdFN0dWIiLCJtYXJrZXREYXRhU3R1YiIsImJlZm9yZSIsInNpbm9uIiwiY3JlYXRlU2FuZGJveCIsImJlZm9yZUVhY2giLCJkb21haW4iLCJnZXRVcmwiLCJIaXN0b3JpY2FsTWFya2V0RGF0YUNsaWVudCIsInN0dWIiLCJyZXNvbHZlcyIsIndpdGhBcmdzIiwidXJsIiwibWV0aG9kIiwiaGVhZGVycyIsImpzb24iLCJhZnRlckVhY2giLCJyZXN0b3JlIiwiaXQiLCJleHBlY3RlZCIsInN5bWJvbCIsInRpbWVmcmFtZSIsInRpbWUiLCJEYXRlIiwiYnJva2VyVGltZSIsIm9wZW4iLCJoaWdoIiwibG93IiwiY2xvc2UiLCJ0aWNrVm9sdW1lIiwic3ByZWFkIiwidm9sdW1lIiwiY2FuZGxlcyIsImdldEhpc3RvcmljYWxDYW5kbGVzIiwic2hvdWxkIiwiZXF1YWwiLCJhc3NlcnQiLCJjYWxsZWRXaXRoIiwicmVxdWVzdCIsInFzIiwic3RhcnRUaW1lIiwibGltaXQiLCJiaWQiLCJhc2siLCJsYXN0Iiwic2lkZSIsInRpY2tzIiwiZ2V0SGlzdG9yaWNhbFRpY2tzIiwib2Zmc2V0Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTs7OztBQUNBOzs7O0FBQ0E7Ozs7OztBQUVBLE1BQU1BLHlCQUF5QixrRUFBL0I7O0FBRUE7OztBQUdBQyxTQUFTLDRCQUFULEVBQXVDLE1BQU07O0FBRTNDLE1BQUlDLE1BQUo7QUFDQSxRQUFNQyxRQUFRLHFCQUFkO0FBQ0EsTUFBSUMsYUFBYSxJQUFJQyxvQkFBSixFQUFqQjtBQUNBLE1BQUlDLFlB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RUZ5QixnQkFBUSxDQUZOO0FBR0ZQLGVBQU87QUFITCxPQUhzQztBQVExQzNCLGVBQVM7QUFDUCxzQkFBY25CO0FBRFAsT0FSaUM7QUFXMUNvQixZQUFNO0FBWG9DLEtBQTVDLEVBWUcsb0JBWkg7QUFhRCxHQTVCRDtBQThCRCxDQXhMRCIsImZpbGUiOiJoaXN0b3JpY2FsTWFya2V0RGF0YS5jbGllbnQuc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IEh0dHBDbGllbnQgZnJvbSAnLi4vaHR0cENsaWVudCc7XG5pbXBvcnQgc2lub24gZnJvbSAnc2lub24nO1xuaW1wb3J0IEhpc3RvcmljYWxNYXJrZXREYXRhQ2xpZW50IGZyb20gJy4vaGlzdG9yaWNhbE1hcmtldERhdGEuY2xpZW50JztcblxuY29uc3QgbWFya2V0RGF0YUNsaWVudEFwaVVybCA9ICdodHRwczovL210LW1hcmtldC1kYXRhLWNsaWVudC1hcGktdjEudmludC1oaWxsLmFnaWxpdW1sYWJzLmNsb3VkJztcblxuLyoqXG4gKiBAdGVzdCB7SGlzdG9yaWNhbE1hcmtldERhdGFDbGllbnR9XG4gKi9cbmRlc2NyaWJlKCdIaXN0b3JpY2FsTWFya2V0RGF0YUNsaWVudCcsICgpID0+IHtcblxuICBsZXQgY2xpZW50O1xuICBjb25zdCB0b2tlbiA9ICdoZWFkZXIucGF5bG9hZC5zaWduJztcbiAgbGV0IGh0dHBDbGllbnQgPSBuZXcgSHR0cENsaWVudCgpO1xuICBsZXQgZG9tYWluQ2xpZW50O1xuICBsZXQgc2FuZGJveDtcbiAgbGV0IHJlcXVlc3RTdHViO1xuICBsZXQgbWFya2V0RGF0YVN0dWI7XG5cbiAgYmVmb3JlKCgpID0+IHtcbiAgICBzYW5kYm94ID0gc2lub24uY3JlYXRlU2FuZGJveCgpO1xuICB9KTtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBkb21haW5DbGllbnQgPSB7XG4gICAgICB0b2tlbixcbiAgICAgIGRvbWFpbjogJ2FnaWxpdW10cmFkZS5hZ2lsaXVtdHJhZGUuYWknLFxuICAgICAgZ2V0VXJsOiAoKSA9PiB7fVxuICAgIH07XG4gICAgY2xpZW50ID0gbmV3IEhpc3RvcmljYWxNYXJrZXREYXRhQ2xpZW50KGh0dHBDbGllbnQsIGRvbWFpbkNsaWVudCk7XG4gICAgcmVxdWVzdFN0dWIgPSBzYW5kYm94LnN0dWIoaHR0cENsaWVudCwgJ3JlcXVlc3QnKTtcbiAgICBzYW5kYm94LnN0dWIoZG9tYWluQ2xpZW50LCAnZ2V0VXJsJykucmVzb2x2ZXMobWFya2V0RGF0YUNsaWVudEFwaVVybCk7XG4gICAgcmVxdWVzdFN0dWIud2l0aEFyZ3Moe1xuICAgICAgdXJsOiAnaHR0cHM6Ly9tdC1wcm92aXNpb25pbmctYXBpLXYxLmFnaWxpdW10cmFkZS5hZ2lsaXVtdHJhZGUuYWkvdXNlcnMvY3VycmVudC9yZWdpb25zJyxcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdhdXRoLXRva2VuJzogdG9rZW5cbiAgICAgIH0sXG4gICAgICBqc29uOiB0cnVlLFxuICAgIH0pLnJlc29sdmVzKFsndmludC1oaWxsJywgJ3VzLXdlc3QnXSlcbiAgICAgIC53aXRoQXJncyh7XG4gICAgICAgIHVybDogJ2h0dHBzOi8vbXQtcHJvdmlzaW9uaW5nLWFwaS12MS5hZ2lsaXVtdHJhZGUuYWdpbGl1bXRyYWRlLmFpL3VzZXJzL2N1cnJlbnQvc2VydmVycy9tdC1jbGllbnQtYXBpJyxcbiAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdhdXRoLXRva2VuJzogdG9rZW5cbiAgICAgICAgfSxcbiAgICAgICAganNvbjogdHJ1ZSxcbiAgICAgIH0pLnJlc29sdmVzKHtkb21haW46ICdhZ2lsaXVtbGFicy5jbG91ZCd9KTtcbiAgICBtYXJrZXREYXRhU3R1YiA9IHJlcXVlc3RTdHViO1xuICB9KTtcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIHNhbmRib3gucmVzdG9yZSgpO1xuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge0hpc3RvcmljYWxNYXJrZXREYXRhQ2xpZW50I2dldEhpc3RvcmljYWxDYW5kbGVzfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCBkb3dubG9hZCBoaXN0b3JpY2FsIGNhbmRsZXMgZnJvbSBBUEknLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IGV4cGVjdGVkID0gW3tcbiAgICAgIHN5bWJvbDogJ0FVRE5aRCcsXG4gICAgICB0aW1lZnJhbWU6ICcxNW0nLFxuICAgICAgdGltZTogbmV3IERhdGUoJzIwMjAtMDQtMDdUMDM6NDU6MDAuMDAwWicpLFxuICAgICAgYnJva2VyVGltZTogJzIwMjAtMDQtMDcgMDY6NDU6MDAuMDAwJyxcbiAgICAgIG9wZW46IDEuMDMyOTcsXG4gICAgICBoaWdoOiAxLjA2MzA5LFxuICAgICAgbG93OiAxLjAyNzA1LFxuICAgICAgY2xvc2U6IDEuMDQzLFxuICAgICAgdGlja1ZvbHVtZTogMTQzNSxcbiAgICAgIHNwcmVhZDogMTcsXG4gICAgICB2b2x1bWU6IDM0NVxuICAgIH1dO1xuICAgIG1hcmtldERhdGFTdHViLnJlc29sdmVzKGV4cGVjdGVkKTtcbiAgICBsZXQgY2FuZGxlcyA9IGF3YWl0IGNsaWVudC5nZXRIaXN0b3JpY2FsQ2FuZGxlcygnYWNjb3VudElkJywgJ3ZpbnQtaGlsbCcsICdBVUROWkQnLCAnMTVtJyxcbiAgICAgIG5ldyBEYXRlKCcyMDIwLTA0LTA3VDAzOjQ1OjAwLjAwMFonKSwgMSk7XG4gICAgY2FuZGxlcy5zaG91bGQuZXF1YWwoZXhwZWN0ZWQpO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKGh0dHBDbGllbnQucmVxdWVzdCwge1xuICAgICAgdXJsOiBgJHttYXJrZXREYXRhQ2xpZW50QXBpVXJsfS91c2Vycy9jdXJyZW50L2FjY291bnRzL2FjY291bnRJZC9oaXN0b3JpY2FsLW1hcmtldC1kYXRhL3N5bWJvbHMvQVVETlpEL2AgK1xuICAgICAgICAndGltZWZyYW1lcy8xNW0vY2FuZGxlcycsXG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgcXM6IHtcbiAgICAgICAgc3RhcnRUaW1lOiBuZXcgRGF0ZSgnMjAyMC0wNC0wN1QwMzo0NTowMC4wMDBaJyksXG4gICAgICAgIGxpbWl0OiAxXG4gICAgICB9LFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnYXV0aC10b2tlbic6IHRva2VuXG4gICAgICB9LFxuICAgICAganNvbjogdHJ1ZVxuICAgIH0sICdnZXRIaXN0b3JpY2FsQ2FuZGxlcycpO1xuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge0hpc3RvcmljYWxNYXJrZXREYXRhQ2xpZW50I2dldEhpc3RvcmljYWxDYW5kbGVzfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCBkb3dubG9hZCBoaXN0b3JpY2FsIGNhbmRsZXMgZnJvbSBBUEkgZm9yIHN5bWJvbCB3aXRoIHNwZWNpYWwgY2hhcmFjdGVycycsIGFzeW5jICgpID0+IHtcbiAgICBsZXQgZXhwZWN0ZWQgPSBbe1xuICAgICAgc3ltYm9sOiAnR0JQSlBZIycsXG4gICAgICB0aW1lZnJhbWU6ICcxNW0nLFxuICAgICAgdGltZTogbmV3IERhdGUoJzIwMjAtMDQtMDdUMDM6NDU6MDAuMDAwWicpLFxuICAgICAgYnJva2VyVGltZTogJzIwMjAtMDQtMDcgMDY6NDU6MDAuMDAwJyxcbiAgICAgIG9wZW46IDEuMDMyOTcsXG4gICAgICBoaWdoOiAxLjA2MzA5LFxuICAgICAgbG93OiAxLjAyNzA1LFxuICAgICAgY2xvc2U6IDEuMDQzLFxuICAgICAgdGlja1ZvbHVtZTogMTQzNSxcbiAgICAgIHNwcmVhZDogMTcsXG4gICAgICB2b2x1bWU6IDM0NVxuICAgIH1dO1xuICAgIG1hcmtldERhdGFTdHViLnJlc29sdmVzKGV4cGVjdGVkKTtcbiAgICBsZXQgY2FuZGxlcyA9IGF3YWl0IGNsaWVudC5nZXRIaXN0b3JpY2FsQ2FuZGxlcygnYWNjb3VudElkJywgJ3ZpbnQtaGlsbCcsICdHQlBKUFkjJywgJzE1bScsXG4gICAgICBuZXcgRGF0ZSgnMjAyMC0wNC0wN1QwMzo0NTowMC4wMDBaJyksIDEpO1xuICAgIGNhbmRsZXMuc2hvdWxkLmVxdWFsKGV4cGVjdGVkKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbGVkV2l0aChodHRwQ2xpZW50LnJlcXVlc3QsIHtcbiAgICAgIHVybDogYCR7bWFya2V0RGF0YUNsaWVudEFwaVVybH0vdXNlcnMvY3VycmVudC9hY2NvdW50cy9hY2NvdW50SWQvaGlzdG9yaWNhbC1tYXJrZXQtZGF0YS9zeW1ib2xzL0dCUEpQWSUyMy9gICtcbiAgICAgICAgICAndGltZWZyYW1lcy8xNW0vY2FuZGxlcycsXG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgcXM6IHtcbiAgICAgICAgc3RhcnRUaW1lOiBuZXcgRGF0ZSgnMjAyMC0wNC0wN1QwMzo0NTowMC4wMDBaJyksXG4gICAgICAgIGxpbWl0OiAxXG4gICAgICB9LFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnYXV0aC10b2tlbic6IHRva2VuXG4gICAgICB9LFxuICAgICAganNvbjogdHJ1ZVxuICAgIH0sICdnZXRIaXN0b3JpY2FsQ2FuZGxlcycpO1xuICB9KTtcbiAgXG4gIC8qKlxuICAgKiBAdGVzdCB7SGlzdG9yaWNhbE1hcmtldERhdGFDbGllbnQjZ2V0SGlzdG9yaWNhbFRpY2tzfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCBkb3dubG9hZCBoaXN0b3JpY2FsIHRpY2tzIGZyb20gQVBJJywgYXN5bmMgKCkgPT4ge1xuICAgIGxldCBleHBlY3RlZCA9IFt7XG4gICAgICBzeW1ib2w6ICdBVUROWkQnLFxuICAgICAgdGltZTogbmV3IERhdGUoJzIwMjAtMDQtMDdUMDM6NDU6MDAuMDAwWicpLFxuICAgICAgYnJva2VyVGltZTogJzIwMjAtMDQtMDcgMDY6NDU6MDAuMDAwJyxcbiAgICAgIGJpZDogMS4wNTI5NyxcbiAgICAgIGFzazogMS4wNTMwOSxcbiAgICAgIGxhc3Q6IDAuNTI5OCxcbiAgICAgIHZvbHVtZTogMC4xMyxcbiAgICAgIHNpZGU6ICdidXknXG4gICAgfV07XG4gICAgcmVxdWVzdFN0dWIucmVzb2x2ZXMoZXhwZWN0ZWQpO1xuICAgIGxldCB0aWNrcyA9IGF3YWl0IGNsaWVudC5nZXRIaXN0b3JpY2FsVGlja3MoJ2FjY291bnRJZCcsICd2aW50LWhpbGwnLCAnQVVETlpEJywgXG4gICAgICBuZXcgRGF0ZSgnMjAyMC0wNC0wN1QwMzo0NTowMC4wMDBaJyksIDAsIDEpO1xuICAgIHRpY2tzLnNob3VsZC5lcXVhbChleHBlY3RlZCk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZFdpdGgoaHR0cENsaWVudC5yZXF1ZXN0LCB7XG4gICAgICB1cmw6IGAke21hcmtldERhdGFDbGllbnRBcGlVcmx9L3VzZXJzL2N1cnJlbnQvYWNjb3VudHMvYWNjb3VudElkL2hpc3RvcmljYWwtbWFya2V0LWRhdGEvc3ltYm9scy9BVUROWkQvdGlja3NgLFxuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIHFzOiB7XG4gICAgICAgIHN0YXJ0VGltZTogbmV3IERhdGUoJzIwMjAtMDQtMDdUMDM6NDU6MDAuMDAwWicpLFxuICAgICAgICBvZmZzZXQ6IDAsXG4gICAgICAgIGxpbWl0OiAxXG4gICAgICB9LFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnYXV0aC10b2tlbic6IHRva2VuXG4gICAgICB9LFxuICAgICAganNvbjogdHJ1ZVxuICAgIH0sICdnZXRIaXN0b3JpY2FsVGlja3MnKTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtIaXN0b3JpY2FsTWFya2V0RGF0YUNsaWVudCNnZXRIaXN0b3JpY2FsVGlja3N9XG4gICAqL1xuICBpdCgnc2hvdWxkIGRvd25sb2FkIGhpc3RvcmljYWwgdGlja3MgZnJvbSBBUEkgZm9yIHN5bWJvbCB3aXRoIHNwZWNpYWwgY2hhcmFjdGVycycsIGFzeW5jICgpID0+IHtcbiAgICBsZXQgZXhwZWN0ZWQgPSBbe1xuICAgICAgc3ltYm9sOiAnR0JQSlBZIycsXG4gICAgICB0aW1lOiBuZXcgRGF0ZSgnMjAyMC0wNC0wN1QwMzo0NTowMC4wMDBaJyksXG4gICAgICBicm9rZXJUaW1lOiAnMjAyMC0wNC0wNyAwNjo0NTowMC4wMDAnLFxuICAgICAgYmlkOiAxLjA1Mjk3LFxuICAgICAgYXNrOiAxLjA1MzA5LFxuICAgICAgbGFzdDogMC41Mjk4LFxuICAgICAgdm9sdW1lOiAwLjEzLFxuICAgICAgc2lkZTogJ2J1eSdcbiAgICB9XTtcbiAgICByZXF1ZXN0U3R1Yi5yZXNvbHZlcyhleHBlY3RlZCk7XG4gICAgbGV0IHRpY2tzID0gYXdhaXQgY2xpZW50LmdldEhpc3RvcmljYWxUaWNrcygnYWNjb3VudElkJywgJ3ZpbnQtaGlsbCcsICdHQlBKUFkjJyxcbiAgICAgIG5ldyBEYXRlKCcyMDIwLTA0LTA3VDAzOjQ1OjAwLjAwMFonKSwgMCwgMSk7XG4gICAgdGlja3Muc2hvdWxkLmVxdWFsKGV4cGVjdGVkKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbGVkV2l0aChodHRwQ2xpZW50LnJlcXVlc3QsIHtcbiAgICAgIHVybDogYCR7bWFya2V0RGF0YUNsaWVudEFwaVVybH0vdXNlcnMvY3VycmVudC9hY2NvdW50cy9hY2NvdW50SWQvaGlzdG9yaWNhbC1tYXJrZXQtZGF0YS9zeW1ib2xzL0dCUEpQWSUyMy90aWNrc2AsXG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgcXM6IHtcbiAgICAgICAgc3RhcnRUaW1lOiBuZXcgRGF0ZSgnMjAyMC0wNC0wN1QwMzo0NTowMC4wMDBaJyksXG4gICAgICAgIG9mZnNldDogMCxcbiAgICAgICAgbGltaXQ6IDFcbiAgICAgIH0sXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdhdXRoLXRva2VuJzogdG9rZW5cbiAgICAgIH0sXG4gICAgICBqc29uOiB0cnVlXG4gICAgfSwgJ2dldEhpc3RvcmljYWxUaWNrcycpO1xuICB9KTtcblxufSk7Il19