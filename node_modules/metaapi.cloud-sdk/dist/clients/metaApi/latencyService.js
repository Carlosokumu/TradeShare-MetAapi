'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _socket = require('socket.io-client');

var _socket2 = _interopRequireDefault(_socket);

var _logger = require('../../logger');

var _logger2 = _interopRequireDefault(_logger);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Service for managing account replicas based on region latency
 */
class LatencyService {

  /**
   * Constructs latency service instance
   * @param {MetaApiWebsocketClient} websocketClient MetaApi websocket client
   * @param {String} token authorization token
   * @param {Number} connectTimeout websocket connect timeout in seconds
   */
  constructor(websocketClient, token, connectTimeout) {
    this._websocketClient = websocketClient;
    this._token = token;
    this._connectTimeout = connectTimeout;
    this._latencyCache = {};
    this._connectedInstancesCache = {};
    this._synchronizedInstancesCache = {};
    this._refreshPromisesByRegion = {};
    this._logger = _logger2.default.getLogger('LatencyService');
    this._refreshRegionLatencyJob = this._refreshRegionLatencyJob.bind(this);
    setInterval(this._refreshRegionLatencyJob, 15 * 60 * 1000);
  }

  /**
   * Returns the list of regions sorted by latency
   * @returns {String[]} list of regions sorted by latency
   */
  get regionsSortedByLatency() {
    const regions = (0, _keys2.default)(this._latencyCache);
    regions.sort((a, b) => this._latencyCache[a] - this._latencyCache[b]);
    return regions;
  }

  /**
   * Invoked when an instance has been disconnected
   * @param {String} instanceId instance id
   */
  onDisconnected(instanceId) {
    try {
      const accountId = this._getAccountIdFromInstance(instanceId);
      const disconnectedRegion = this._getRegionFromInstance(instanceId);
      this._disconnectInstance(instanceId);
      const instances = this._getAccountInstances(accountId);
      if (!instances.map(instance => this._connectedInstancesCache[instance]).includes(true)) {
        const regions = this._getAccountRegions(accountId);
        regions.filter(region => region !== disconnectedRegion).forEach(region => this._subscribeAccountReplica(accountId, region));
      }
    } catch (err) {
      this._logger.error(`Failed to process onDisconnected event for instance ${instanceId}`, err);
    }
  }

  /**
   * Invoked when an account has been unsubscribed
   * @param {String} accountId account id
   */
  onUnsubscribe(accountId) {
    try {
      const region = this._websocketClient.getAccountRegion(accountId);
      const primaryAccountId = this._websocketClient.accountsByReplicaId[accountId];
      const instances = this._getAccountInstances(primaryAccountId);
      instances.filter(instanceId => instanceId.startsWith(`${primaryAccountId}:${region}:`)).forEach(instanceId => this._disconnectInstance(instanceId));
    } catch (err) {
      this._logger.error(`Failed to process onUnsubscribe event for account ${accountId}`, err);
    }
  }

  /**
   * Invoked when an instance has been connected
   * @param {String} instanceId instance id
   */
  async onConnected(instanceId) {
    try {
      this._connectedInstancesCache[instanceId] = true;
      const accountId = this._getAccountIdFromInstance(instanceId);
      const region = this._getRegionFromInstance(instanceId);
      if (!this._latencyCache[region]) {
        await this._refreshLatency(region);
      }
      const instances = this.getActiveAccountInstances(accountId);
      const synchronizedInstances = this.getSynchronizedAccountInstances(accountId);
      const regions = instances.map(instance => this._getRegionFromInstance(instance));
      if (instances.length > 1 && !synchronizedInstances.length) {
        const regionsToDisconnect = this.regionsSortedByLatency.filter(sortedRegion => regions.includes(sortedRegion)).slice(1);
        regionsToDisconnect.forEach(regionItem => {
          this._websocketClient.unsubscribe(this._websocketClient.accountReplicas[accountId][regionItem]);
          this._websocketClient.unsubscribeAccountRegion(accountId, regionItem);
        });
      }
    } catch (err) {
      this._logger.error(`Failed to process onConnected event for instance ${instanceId}`, err);
    }
  }

  /**
   * Invoked when an instance has been synchronized
   * @param {String} instanceId instance id
   */
  async onDealsSynchronized(instanceId) {
    try {
      this._synchronizedInstancesCache[instanceId] = true;
      const accountId = this._getAccountIdFromInstance(instanceId);
      const region = this._getRegionFromInstance(instanceId);
      if (!this._latencyCache[region]) {
        await this._refreshLatency(region);
      }
      const instances = this.getSynchronizedAccountInstances(accountId);
      const regions = instances.map(instance => this._getRegionFromInstance(instance));
      if (instances.length > 1) {
        const regionsToDisconnect = this.regionsSortedByLatency.filter(sortedRegion => regions.includes(sortedRegion)).slice(1);
        regionsToDisconnect.forEach(regionItem => {
          this._websocketClient.unsubscribe(this._websocketClient.accountReplicas[accountId][regionItem]);
          this._websocketClient.unsubscribeAccountRegion(accountId, regionItem);
        });
      }
    } catch (err) {
      this._logger.error(`Failed to process onDealsSynchronized event for instance ${instanceId}`, err);
    }
  }

  /**
   * Returns the list of currently connected account instances
   * @param {String} accountId account id
   * @returns {String[]} list of connected account instances
   */
  getActiveAccountInstances(accountId) {
    return this._getAccountInstances(accountId).filter(instance => this._connectedInstancesCache[instance]);
  }

  /**
   * Returns the list of currently synchronized account instances
   * @param {String} accountId account id
   * @returns {String[]} list of synchronized account instances
   */
  getSynchronizedAccountInstances(accountId) {
    return this._getAccountInstances(accountId).filter(instance => this._synchronizedInstancesCache[instance]);
  }

  _getAccountInstances(accountId) {
    return (0, _keys2.default)(this._connectedInstancesCache).filter(instanceId => instanceId.startsWith(`${accountId}:`));
  }

  _getAccountRegions(accountId) {
    const regions = [];
    const instances = this._getAccountInstances(accountId);
    instances.forEach(instance => {
      const region = this._getRegionFromInstance(instance);
      if (!regions.includes(region)) {
        regions.push(region);
      }
    });
    return regions;
  }

  _getAccountIdFromInstance(instanceId) {
    return instanceId.split(':')[0];
  }

  _getRegionFromInstance(instanceId) {
    return instanceId.split(':')[1];
  }

  _disconnectInstance(instanceId) {
    this._connectedInstancesCache[instanceId] = false;
    if (this._synchronizedInstancesCache[instanceId]) {
      this._synchronizedInstancesCache[instanceId] = false;
    }
  }

  _subscribeAccountReplica(accountId, region) {
    this._websocketClient.ensureSubscribe(this._websocketClient.accountReplicas[accountId][region], 0);
    this._websocketClient.ensureSubscribe(this._websocketClient.accountReplicas[accountId][region], 1);
  }

  async _refreshRegionLatencyJob() {
    for (let region of (0, _keys2.default)(this._latencyCache)) {
      await this._refreshLatency(region);
    }

    // For every account, switch to a better region if such exists
    const accountIds = [];
    (0, _keys2.default)(this._connectedInstancesCache).filter(instanceId => this._connectedInstancesCache[instanceId]).forEach(instanceId => {
      const accountId = this._getAccountIdFromInstance(instanceId);
      if (!accountIds.includes(accountId)) {
        accountIds.push(accountId);
      }
    });

    const sortedRegions = this.regionsSortedByLatency;

    accountIds.forEach(accountId => {
      const accountRegions = this._getAccountRegions(accountId);
      const activeInstances = this.getActiveAccountInstances(accountId);
      if (activeInstances.length === 1) {
        const activeInstance = activeInstances[0];
        const activeRegion = this._getRegionFromInstance(activeInstance);
        const accountBestRegions = sortedRegions.filter(region => accountRegions.includes(region));
        if (accountBestRegions[0] !== activeRegion) {
          this._subscribeAccountReplica(accountId, accountBestRegions[0]);
        }
      }
    });
  }

  async _refreshLatency(region) {
    if (this._refreshPromisesByRegion[region]) {
      return await this._refreshPromisesByRegion[region];
    }
    let resolve;
    this._refreshPromisesByRegion[region] = new _promise2.default((res, rej) => {
      resolve = res;
    });
    const serverUrl = await this._websocketClient.getUrlSettings(0, region);
    const startDate = Date.now();

    const socketInstance = (0, _socket2.default)(serverUrl.url, {
      path: '/ws',
      reconnection: true,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      reconnectionAttempts: Infinity,
      timeout: this._connectTimeout,
      query: {
        'auth-token': this._token,
        protocol: 3
      }
    });
    socketInstance.on('connect', async () => {
      resolve();
      const latency = Date.now() - startDate;
      this._latencyCache[region] = latency;
      socketInstance.close();
    });
    await this._refreshPromisesByRegion[region];
    delete this._refreshPromisesByRegion[region];
  }

}
exports.default = LatencyService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9jbGllbnRzL21ldGFBcGkvbGF0ZW5jeVNlcnZpY2UuZXM2Il0sIm5hbWVzIjpbIkxhdGVuY3lTZXJ2aWNlIiwiY29uc3RydWN0b3IiLCJ3ZWJzb2NrZXRDbGllbnQiLCJ0b2tlbiIsImNvbm5lY3RUaW1lb3V0IiwiX3dlYnNvY2tldENsaWVudCIsIl90b2tlbiIsIl9jb25uZWN0VGltZW91dCIsIl9sYXRlbmN5Q2FjaGUiLCJfY29ubmVjdGVkSW5zdGFuY2VzQ2FjaGUiLCJfc3luY2hyb25pemVkSW5zdGFuY2VzQ2FjaGUiLCJfcmVmcmVzaFByb21pc2VzQnlSZWdpb24iLCJfbG9nZ2VyIiwiTG9nZ2VyTWFuYWdlciIsImdldExvZ2dlciIsIl9yZWZyZXNoUmVnaW9uTGF0ZW5jeUpvYiIsImJpbmQiLCJzZXRJbnRlcnZhbCIsInJlZ2lvbnNTb3J0ZWRCeUxhdGVuY3kiLCJyZWdpb25zIiwic29ydCIsImEiLCJiIiwib25EaXNjb25uZWN0ZWQiLCJpbnN0YW5jZUlkIiwiYWNjb3VudElkIiwiX2dldEFjY291bnRJZEZyb21JbnN0YW5jZSIsImRpc2Nvbm5lY3RlZFJlZ2lvbiIsIl9nZXRSZWdpb25Gcm9tSW5zdGFuY2UiLCJfZGlzY29ubmVjdEluc3RhbmNlIiwiaW5zdGFuY2VzIiwiX2dldEFjY291bnRJbnN0YW5jZXMiLCJtYXAiLCJpbnN0YW5jZSIsImluY2x1ZGVzIiwiX2dldEFjY291bnRSZWdpb25zIiwiZmlsdGVyIiwicmVnaW9uIiwiZm9yRWFjaCIsIl9zdWJzY3JpYmVBY2NvdW50UmVwbGljYSIsImVyciIsImVycm9yIiwib25VbnN1YnNjcmliZSIsImdldEFjY291bnRSZWdpb24iLCJwcmltYXJ5QWNjb3VudElkIiwiYWNjb3VudHNCeVJlcGxpY2FJZCIsInN0YXJ0c1dpdGgiLCJvbkNvbm5lY3RlZCIsIl9yZWZyZXNoTGF0ZW5jeSIsImdldEFjdGl2ZUFjY291bnRJbnN0YW5jZXMiLCJzeW5jaHJvbml6ZWRJbnN0YW5jZXMiLCJnZXRTeW5jaHJvbml6ZWRBY2NvdW50SW5zdGFuY2VzIiwibGVuZ3RoIiwicmVnaW9uc1RvRGlzY29ubmVjdCIsInNvcnRlZFJlZ2lvbiIsInNsaWNlIiwicmVnaW9uSXRlbSIsInVuc3Vic2NyaWJlIiwiYWNjb3VudFJlcGxpY2FzIiwidW5zdWJzY3JpYmVBY2NvdW50UmVnaW9uIiwib25EZWFsc1N5bmNocm9uaXplZCIsInB1c2giLCJzcGxpdCIsImVuc3VyZVN1YnNjcmliZSIsImFjY291bnRJZHMiLCJzb3J0ZWRSZWdpb25zIiwiYWNjb3VudFJlZ2lvbnMiLCJhY3RpdmVJbnN0YW5jZXMiLCJhY3RpdmVJbnN0YW5jZSIsImFjdGl2ZVJlZ2lvbiIsImFjY291bnRCZXN0UmVnaW9ucyIsInJlc29sdmUiLCJyZXMiLCJyZWoiLCJzZXJ2ZXJVcmwiLCJnZXRVcmxTZXR0aW5ncyIsInN0YXJ0RGF0ZSIsIkRhdGUiLCJub3ciLCJzb2NrZXRJbnN0YW5jZSIsInVybCIsInBhdGgiLCJyZWNvbm5lY3Rpb24iLCJyZWNvbm5lY3Rpb25EZWxheSIsInJlY29ubmVjdGlvbkRlbGF5TWF4IiwicmVjb25uZWN0aW9uQXR0ZW1wdHMiLCJJbmZpbml0eSIsInRpbWVvdXQiLCJxdWVyeSIsInByb3RvY29sIiwib24iLCJsYXRlbmN5IiwiY2xvc2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7Ozs7O0FBRUE7OztBQUdlLE1BQU1BLGNBQU4sQ0FBcUI7O0FBRWxDOzs7Ozs7QUFNQUMsY0FBWUMsZUFBWixFQUE2QkMsS0FBN0IsRUFBb0NDLGNBQXBDLEVBQW9EO0FBQ2xELFNBQUtDLGdCQUFMLEdBQXdCSCxlQUF4QjtBQUNBLFNBQUtJLE1BQUwsR0FBY0gsS0FBZDtBQUNBLFNBQUtJLGVBQUwsR0FBdUJILGNBQXZCO0FBQ0EsU0FBS0ksYUFBTCxHQUFxQixFQUFyQjtBQUNBLFNBQUtDLHdCQUFMLEdBQWdDLEVBQWhDO0FBQ0EsU0FBS0MsMkJBQUwsR0FBbUMsRUFBbkM7QUFDQSxT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QjtBQUNBLFdBQUtwRSxhQUFMLENBQW1CNkIsTUFBbkIsSUFBNkJzRCxPQUE3QjtBQUNBWixxQkFBZWEsS0FBZjtBQUNELEtBTEQ7QUFNQSxVQUFNLEtBQUtqRix3QkFBTCxDQUE4QjBCLE1BQTlCLENBQU47QUFDQSxXQUFPLEtBQUsxQix3QkFBTCxDQUE4QjBCLE1BQTlCLENBQVA7QUFDRDs7QUEvT2lDO2tCQUFmckMsYyIsImZpbGUiOiJsYXRlbmN5U2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBzb2NrZXRJTyBmcm9tICdzb2NrZXQuaW8tY2xpZW50JztcbmltcG9ydCBMb2dnZXJNYW5hZ2VyIGZyb20gJy4uLy4uL2xvZ2dlcic7XG5cbi8qKlxuICogU2VydmljZSBmb3IgbWFuYWdpbmcgYWNjb3VudCByZXBsaWNhcyBiYXNlZCBvbiByZWdpb24gbGF0ZW5jeVxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBMYXRlbmN5U2VydmljZSB7XG5cbiAgLyoqXG4gICAqIENvbnN0cnVjdHMgbGF0ZW5jeSBzZXJ2aWNlIGluc3RhbmNlXG4gICAqIEBwYXJhbSB7TWV0YUFwaVdlYnNvY2tldENsaWVudH0gd2Vic29ja2V0Q2xpZW50IE1ldGFBcGkgd2Vic29ja2V0IGNsaWVudFxuICAgKiBAcGFyYW0ge1N0cmluZ30gdG9rZW4gYXV0aG9yaXphdGlvbiB0b2tlblxuICAgKiBAcGFyYW0ge051bWJlcn0gY29ubmVjdFRpbWVvdXQgd2Vic29ja2V0IGNvbm5lY3QgdGltZW91dCBpbiBzZWNvbmRzXG4gICAqL1xuICBjb25zdHJ1Y3Rvcih3ZWJzb2NrZXRDbGllbnQsIHRva2VuLCBjb25uZWN0VGltZW91dCkge1xuICAgIHRoaXMuX3dlYnNvY2tldENsaWVudCA9IHdlYnNvY2tldENsaWVudDtcbiAgICB0aGlzLl90b2tlbiA9IHRva2VuO1xuICAgIHRoaXMuX2Nvbm5lY3RUaW1lb3V0ID0gY29ubmVjdFRpbWVvdXQ7XG4gICAgdGhpcy5fbGF0ZW5jeUNhY2hlID0ge307XG4gICAgdGhpcy5fY29ubmVjdGVkSW5zdGFuY2VzQ2FjaGUgPSB7fTtcbiAgICB0aGlzLl9zeW5jaHJvbml6ZWRJbnN0YW5jZXNDYWNoZSA9IHt9O1xuICAgIHRoaXMuX3JlZnJlc2hQcm9taXNlc0J5UmVnaW9uID0ge307XG4gICAgdGhpcy5fbG9nZ2VyID0gTG9nZ2VyTWFuYWdlci5nZXRMb2dnZXIoJ0xhdGVuY3lTZXJ2aWNlJyk7XG4gICAgdGhpcy5fcmVmcmVzaFJlZ2lvbkxhdGVuY3lKb2IgPSB0aGlzLl9yZWZyZXNoUmVnaW9uTGF0ZW5jeUpvYi5iaW5kKHRoaXMpO1xuICAgIHNldEludGVydmFsKHRoaXMuX3JlZnJlc2hSZWdpb25MYXRlbmN5Sm9iLCAxNSAqIDYwICogMTAwMCk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgbGlzdCBvZiByZWdpb25zIHNvcnRlZCBieSBsYXRlbmN5XG4gICAqIEByZXR1cm5zIHtTdHJpbmdbXX0gbGlzdCBvZiByZWdpb25zIHNvcnRlZCBieSBsYXRlbmN5XG4gICAqL1xuICBnZXQgcmVnaW9uc1NvcnRlZEJ5TGF0ZW5jeSgpIHtcbiAgICBjb25zdCByZWdpb25zID0gT2JqZWN0LmtleXModGhpcy5fbGF0ZW5jeUNhY2hlKTtcbiAgICByZWdpb25zLnNvcnQoKGEsIGIpID0+IHRoaXMuX2xhdGVuY3lDYWNoZVthXSAtIHRoaXMuX2xhdGVuY3lDYWNoZVtiXSk7XG4gICAgcmV0dXJuIHJlZ2lvbnM7XG4gIH1cblxuICAvKipcbiAgICogSW52b2tlZCB3aGVuIGFuIGluc3RhbmNlIGhhcyBiZWVuIGRpc2Nvbm5lY3RlZFxuICAgKiBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VJZCBpbnN0YW5jZSBpZFxuICAgKi9cbiAgb25EaXNjb25uZWN0ZWQoaW5zdGFuY2VJZCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBhY2NvdW50SWQgPSB0aGlzLl9nZXRBY2NvdW50SWRGcm9tSW5zdGFuY2UoaW5zdGFuY2VJZCk7XG4gICAgICBjb25zdCBkaXNjb25uZWN0ZWRSZWdpb24gPSB0aGlzLl9nZXRSZWdpb25Gcm9tSW5zdGFuY2UoaW5zdGFuY2VJZCk7XG4gICAgICB0aGlzLl9kaXNjb25uZWN0SW5zdGFuY2UoaW5zdGFuY2VJZCk7XG4gICAgICBjb25zdCBpbnN0YW5jZXMgPSB0aGlzLl9nZXRBY2NvdW50SW5zdGFuY2VzKGFjY291bnRJZCk7XG4gICAgICBpZighaW5zdGFuY2VzLm1hcChpbnN0YW5jZSA9PiB0aGlzLl9jb25uZWN0ZWRJbnN0YW5jZXNDYWNoZVtpbnN0YW5jZV0pLmluY2x1ZGVzKHRydWUpKSB7XG4gICAgICAgIGNvbnN0IHJlZ2lvbnMgPSB0aGlzLl9nZXRBY2NvdW50UmVnaW9ucyhhY2NvdW50SWQpO1xuICAgICAgICByZWdpb25zLmZpbHRlcihyZWdpb24gPT4gcmVnaW9uICE9PSBkaXNjb25uZWN0ZWRSZWdpb24pXG4gICAgICAgICAgLmZvckVhY2gocmVnaW9uID0+IHRoaXMuX3N1YnNjcmliZUFjY291bnRSZXBsaWNhKGFjY291bnRJZCwgcmVnaW9uKSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoYEZhaWxlZCB0byBwcm9jZXNzIG9uRGlzY29ubmVjdGVkIGV2ZW50IGZvciBpbnN0YW5jZSAke2luc3RhbmNlSWR9YCwgZXJyKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSW52b2tlZCB3aGVuIGFuIGFjY291bnQgaGFzIGJlZW4gdW5zdWJzY3JpYmVkXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBhY2NvdW50SWQgYWNjb3VudCBpZFxuICAgKi9cbiAgb25VbnN1YnNjcmliZShhY2NvdW50SWQpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVnaW9uID0gdGhpcy5fd2Vic29ja2V0Q2xpZW50LmdldEFjY291bnRSZWdpb24oYWNjb3VudElkKTtcbiAgICAgIGNvbnN0IHByaW1hcnlBY2NvdW50SWQgPSB0aGlzLl93ZWJzb2NrZXRDbGllbnQuYWNjb3VudHNCeVJlcGxpY2FJZFthY2NvdW50SWRdO1xuICAgICAgY29uc3QgaW5zdGFuY2VzID0gdGhpcy5fZ2V0QWNjb3VudEluc3RhbmNlcyhwcmltYXJ5QWNjb3VudElkKTtcbiAgICAgIGluc3RhbmNlcy5maWx0ZXIoaW5zdGFuY2VJZCA9PiBpbnN0YW5jZUlkLnN0YXJ0c1dpdGgoYCR7cHJpbWFyeUFjY291bnRJZH06JHtyZWdpb259OmApKVxuICAgICAgICAuZm9yRWFjaChpbnN0YW5jZUlkID0+IHRoaXMuX2Rpc2Nvbm5lY3RJbnN0YW5jZShpbnN0YW5jZUlkKSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoYEZhaWxlZCB0byBwcm9jZXNzIG9uVW5zdWJzY3JpYmUgZXZlbnQgZm9yIGFjY291bnQgJHthY2NvdW50SWR9YCwgZXJyKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSW52b2tlZCB3aGVuIGFuIGluc3RhbmNlIGhhcyBiZWVuIGNvbm5lY3RlZFxuICAgKiBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VJZCBpbnN0YW5jZSBpZFxuICAgKi9cbiAgYXN5bmMgb25Db25uZWN0ZWQoaW5zdGFuY2VJZCkge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLl9jb25uZWN0ZWRJbnN0YW5jZXNDYWNoZVtpbnN0YW5jZUlkXSA9IHRydWU7XG4gICAgICBjb25zdCBhY2NvdW50SWQgPSB0aGlzLl9nZXRBY2NvdW50SWRGcm9tSW5zdGFuY2UoaW5zdGFuY2VJZCk7XG4gICAgICBjb25zdCByZWdpb24gPSB0aGlzLl9nZXRSZWdpb25Gcm9tSW5zdGFuY2UoaW5zdGFuY2VJZCk7XG4gICAgICBpZighdGhpcy5fbGF0ZW5jeUNhY2hlW3JlZ2lvbl0pIHtcbiAgICAgICAgYXdhaXQgdGhpcy5fcmVmcmVzaExhdGVuY3kocmVnaW9uKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGluc3RhbmNlcyA9IHRoaXMuZ2V0QWN0aXZlQWNjb3VudEluc3RhbmNlcyhhY2NvdW50SWQpO1xuICAgICAgY29uc3Qgc3luY2hyb25pemVkSW5zdGFuY2VzID0gdGhpcy5nZXRTeW5jaHJvbml6ZWRBY2NvdW50SW5zdGFuY2VzKGFjY291bnRJZCk7XG4gICAgICBjb25zdCByZWdpb25zID0gaW5zdGFuY2VzLm1hcChpbnN0YW5jZSA9PiB0aGlzLl9nZXRSZWdpb25Gcm9tSW5zdGFuY2UoaW5zdGFuY2UpKTtcbiAgICAgIGlmIChpbnN0YW5jZXMubGVuZ3RoID4gMSAmJiAhc3luY2hyb25pemVkSW5zdGFuY2VzLmxlbmd0aCkge1xuICAgICAgICBjb25zdCByZWdpb25zVG9EaXNjb25uZWN0ID0gdGhpcy5yZWdpb25zU29ydGVkQnlMYXRlbmN5XG4gICAgICAgICAgLmZpbHRlcihzb3J0ZWRSZWdpb24gPT4gcmVnaW9ucy5pbmNsdWRlcyhzb3J0ZWRSZWdpb24pKS5zbGljZSgxKTtcbiAgICAgICAgcmVnaW9uc1RvRGlzY29ubmVjdC5mb3JFYWNoKHJlZ2lvbkl0ZW0gPT4ge1xuICAgICAgICAgIHRoaXMuX3dlYnNvY2tldENsaWVudC51bnN1YnNjcmliZSh0aGlzLl93ZWJzb2NrZXRDbGllbnQuYWNjb3VudFJlcGxpY2FzW2FjY291bnRJZF1bcmVnaW9uSXRlbV0pO1xuICAgICAgICAgIHRoaXMuX3dlYnNvY2tldENsaWVudC51bnN1YnNjcmliZUFjY291bnRSZWdpb24oYWNjb3VudElkLCByZWdpb25JdGVtKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoYEZhaWxlZCB0byBwcm9jZXNzIG9uQ29ubmVjdGVkIGV2ZW50IGZvciBpbnN0YW5jZSAke2luc3RhbmNlSWR9YCwgZXJyKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSW52b2tlZCB3aGVuIGFuIGluc3RhbmNlIGhhcyBiZWVuIHN5bmNocm9uaXplZFxuICAgKiBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VJZCBpbnN0YW5jZSBpZFxuICAgKi9cbiAgYXN5bmMgb25EZWFsc1N5bmNocm9uaXplZChpbnN0YW5jZUlkKSB7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMuX3N5bmNocm9uaXplZEluc3RhbmNlc0NhY2hlW2luc3RhbmNlSWRdID0gdHJ1ZTtcbiAgICAgIGNvbnN0IGFjY291bnRJZCA9IHRoaXMuX2dldEFjY291bnRJZEZyb21JbnN0YW5jZShpbnN0YW5jZUlkKTtcbiAgICAgIGNvbnN0IHJlZ2lvbiA9IHRoaXMuX2dldFJlZ2lvbkZyb21JbnN0YW5jZShpbnN0YW5jZUlkKTtcbiAgICAgIGlmKCF0aGlzLl9sYXRlbmN5Q2FjaGVbcmVnaW9uXSkge1xuICAgICAgICBhd2FpdCB0aGlzLl9yZWZyZXNoTGF0ZW5jeShyZWdpb24pO1xuICAgICAgfVxuICAgICAgY29uc3QgaW5zdGFuY2VzID0gdGhpcy5nZXRTeW5jaHJvbml6ZWRBY2NvdW50SW5zdGFuY2VzKGFjY291bnRJZCk7XG4gICAgICBjb25zdCByZWdpb25zID0gaW5zdGFuY2VzLm1hcChpbnN0YW5jZSA9PiB0aGlzLl9nZXRSZWdpb25Gcm9tSW5zdGFuY2UoaW5zdGFuY2UpKTtcbiAgICAgIGlmIChpbnN0YW5jZXMubGVuZ3RoID4gMSkge1xuICAgICAgICBjb25zdCByZWdpb25zVG9EaXNjb25uZWN0ID0gdGhpcy5yZWdpb25zU29ydGVkQnlMYXRlbmN5XG4gICAgICAgICAgLmZpbHRlcihzb3J0ZWRSZWdpb24gPT4gcmVnaW9ucy5pbmNsdWRlcyhzb3J0ZWRSZWdpb24pKS5zbGljZSgxKTtcbiAgICAgICAgcmVnaW9uc1RvRGlzY29ubmVjdC5mb3JFYWNoKHJlZ2lvbkl0ZW0gPT4ge1xuICAgICAgICAgIHRoaXMuX3dlYnNvY2tldENsaWVudC51bnN1YnNjcmliZSh0aGlzLl93ZWJzb2NrZXRDbGllbnQuYWNjb3VudFJlcGxpY2FzW2FjY291bnRJZF1bcmVnaW9uSXRlbV0pO1xuICAgICAgICAgIHRoaXMuX3dlYnNvY2tldENsaWVudC51bnN1YnNjcmliZUFjY291bnRSZWdpb24oYWNjb3VudElkLCByZWdpb25JdGVtKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoYEZhaWxlZCB0byBwcm9jZXNzIG9uRGVhbHNTeW5jaHJvbml6ZWQgZXZlbnQgZm9yIGluc3RhbmNlICR7aW5zdGFuY2VJZH1gLCBlcnIpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBsaXN0IG9mIGN1cnJlbnRseSBjb25uZWN0ZWQgYWNjb3VudCBpbnN0YW5jZXNcbiAgICogQHBhcmFtIHtTdHJpbmd9IGFjY291bnRJZCBhY2NvdW50IGlkXG4gICAqIEByZXR1cm5zIHtTdHJpbmdbXX0gbGlzdCBvZiBjb25uZWN0ZWQgYWNjb3VudCBpbnN0YW5jZXNcbiAgICovXG4gIGdldEFjdGl2ZUFjY291bnRJbnN0YW5jZXMoYWNjb3VudElkKSB7XG4gICAgcmV0dXJuIHRoaXMuX2dldEFjY291bnRJbnN0YW5jZXMoYWNjb3VudElkKS5maWx0ZXIoaW5zdGFuY2UgPT4gdGhpcy5fY29ubmVjdGVkSW5zdGFuY2VzQ2FjaGVbaW5zdGFuY2VdKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBsaXN0IG9mIGN1cnJlbnRseSBzeW5jaHJvbml6ZWQgYWNjb3VudCBpbnN0YW5jZXNcbiAgICogQHBhcmFtIHtTdHJpbmd9IGFjY291bnRJZCBhY2NvdW50IGlkXG4gICAqIEByZXR1cm5zIHtTdHJpbmdbXX0gbGlzdCBvZiBzeW5jaHJvbml6ZWQgYWNjb3VudCBpbnN0YW5jZXNcbiAgICovXG4gIGdldFN5bmNocm9uaXplZEFjY291bnRJbnN0YW5jZXMoYWNjb3VudElkKSB7XG4gICAgcmV0dXJuIHRoaXMuX2dldEFjY291bnRJbnN0YW5jZXMoYWNjb3VudElkKS5maWx0ZXIoaW5zdGFuY2UgPT4gdGhpcy5fc3luY2hyb25pemVkSW5zdGFuY2VzQ2FjaGVbaW5zdGFuY2VdKTtcbiAgfVxuXG4gIF9nZXRBY2NvdW50SW5zdGFuY2VzKGFjY291bnRJZCkge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLl9jb25uZWN0ZWRJbnN0YW5jZXNDYWNoZSkuZmlsdGVyKGluc3RhbmNlSWQgPT4gaW5zdGFuY2VJZC5zdGFydHNXaXRoKGAke2FjY291bnRJZH06YCkpO1xuICB9XG5cbiAgX2dldEFjY291bnRSZWdpb25zKGFjY291bnRJZCkge1xuICAgIGNvbnN0IHJlZ2lvbnMgPSBbXTtcbiAgICBjb25zdCBpbnN0YW5jZXMgPSB0aGlzLl9nZXRBY2NvdW50SW5zdGFuY2VzKGFjY291bnRJZCk7XG4gICAgaW5zdGFuY2VzLmZvckVhY2goaW5zdGFuY2UgPT4ge1xuICAgICAgY29uc3QgcmVnaW9uID0gdGhpcy5fZ2V0UmVnaW9uRnJvbUluc3RhbmNlKGluc3RhbmNlKTtcbiAgICAgIGlmKCFyZWdpb25zLmluY2x1ZGVzKHJlZ2lvbikpIHtcbiAgICAgICAgcmVnaW9ucy5wdXNoKHJlZ2lvbik7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlZ2lvbnM7XG4gIH1cblxuICBfZ2V0QWNjb3VudElkRnJvbUluc3RhbmNlKGluc3RhbmNlSWQpIHtcbiAgICByZXR1cm4gaW5zdGFuY2VJZC5zcGxpdCgnOicpWzBdO1xuICB9XG5cbiAgX2dldFJlZ2lvbkZyb21JbnN0YW5jZShpbnN0YW5jZUlkKSB7XG4gICAgcmV0dXJuIGluc3RhbmNlSWQuc3BsaXQoJzonKVsxXTtcbiAgfVxuXG4gIF9kaXNjb25uZWN0SW5zdGFuY2UoaW5zdGFuY2VJZCkge1xuICAgIHRoaXMuX2Nvbm5lY3RlZEluc3RhbmNlc0NhY2hlW2luc3RhbmNlSWRdID0gZmFsc2U7XG4gICAgaWYodGhpcy5fc3luY2hyb25pemVkSW5zdGFuY2VzQ2FjaGVbaW5zdGFuY2VJZF0pIHtcbiAgICAgIHRoaXMuX3N5bmNocm9uaXplZEluc3RhbmNlc0NhY2hlW2luc3RhbmNlSWRdID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgX3N1YnNjcmliZUFjY291bnRSZXBsaWNhKGFjY291bnRJZCwgcmVnaW9uKSB7XG4gICAgdGhpcy5fd2Vic29ja2V0Q2xpZW50LmVuc3VyZVN1YnNjcmliZSh0aGlzLl93ZWJzb2NrZXRDbGllbnQuYWNjb3VudFJlcGxpY2FzW2FjY291bnRJZF1bcmVnaW9uXSwgMCk7XG4gICAgdGhpcy5fd2Vic29ja2V0Q2xpZW50LmVuc3VyZVN1YnNjcmliZSh0aGlzLl93ZWJzb2NrZXRDbGllbnQuYWNjb3VudFJlcGxpY2FzW2FjY291bnRJZF1bcmVnaW9uXSwgMSk7XG4gIH1cblxuICBhc3luYyBfcmVmcmVzaFJlZ2lvbkxhdGVuY3lKb2IoKSB7XG4gICAgZm9yKGxldCByZWdpb24gb2YgT2JqZWN0LmtleXModGhpcy5fbGF0ZW5jeUNhY2hlKSkge1xuICAgICAgYXdhaXQgdGhpcy5fcmVmcmVzaExhdGVuY3kocmVnaW9uKTtcbiAgICB9XG5cbiAgICAvLyBGb3IgZXZlcnkgYWNjb3VudCwgc3dpdGNoIHRvIGEgYmV0dGVyIHJlZ2lvbiBpZiBzdWNoIGV4aXN0c1xuICAgIGNvbnN0IGFjY291bnRJZHMgPSBbXTtcbiAgICBPYmplY3Qua2V5cyh0aGlzLl9jb25uZWN0ZWRJbnN0YW5jZXNDYWNoZSlcbiAgICAgIC5maWx0ZXIoaW5zdGFuY2VJZCA9PiB0aGlzLl9jb25uZWN0ZWRJbnN0YW5jZXNDYWNoZVtpbnN0YW5jZUlkXSlcbiAgICAgIC5mb3JFYWNoKGluc3RhbmNlSWQgPT4ge1xuICAgICAgICBjb25zdCBhY2NvdW50SWQgPSB0aGlzLl9nZXRBY2NvdW50SWRGcm9tSW5zdGFuY2UoaW5zdGFuY2VJZCk7XG4gICAgICAgIGlmKCFhY2NvdW50SWRzLmluY2x1ZGVzKGFjY291bnRJZCkpIHtcbiAgICAgICAgICBhY2NvdW50SWRzLnB1c2goYWNjb3VudElkKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICBjb25zdCBzb3J0ZWRSZWdpb25zID0gdGhpcy5yZWdpb25zU29ydGVkQnlMYXRlbmN5O1xuXG4gICAgYWNjb3VudElkcy5mb3JFYWNoKGFjY291bnRJZCA9PiB7XG4gICAgICBjb25zdCBhY2NvdW50UmVnaW9ucyA9IHRoaXMuX2dldEFjY291bnRSZWdpb25zKGFjY291bnRJZCk7XG4gICAgICBjb25zdCBhY3RpdmVJbnN0YW5jZXMgPSB0aGlzLmdldEFjdGl2ZUFjY291bnRJbnN0YW5jZXMoYWNjb3VudElkKTtcbiAgICAgIGlmKGFjdGl2ZUluc3RhbmNlcy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgY29uc3QgYWN0aXZlSW5zdGFuY2UgPSBhY3RpdmVJbnN0YW5jZXNbMF07XG4gICAgICAgIGNvbnN0IGFjdGl2ZVJlZ2lvbiA9IHRoaXMuX2dldFJlZ2lvbkZyb21JbnN0YW5jZShhY3RpdmVJbnN0YW5jZSk7XG4gICAgICAgIGNvbnN0IGFjY291bnRCZXN0UmVnaW9ucyA9IHNvcnRlZFJlZ2lvbnMuZmlsdGVyKHJlZ2lvbiA9PiBhY2NvdW50UmVnaW9ucy5pbmNsdWRlcyhyZWdpb24pKTtcbiAgICAgICAgaWYoYWNjb3VudEJlc3RSZWdpb25zWzBdICE9PSBhY3RpdmVSZWdpb24pIHtcbiAgICAgICAgICB0aGlzLl9zdWJzY3JpYmVBY2NvdW50UmVwbGljYShhY2NvdW50SWQsIGFjY291bnRCZXN0UmVnaW9uc1swXSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIF9yZWZyZXNoTGF0ZW5jeShyZWdpb24pIHtcbiAgICBpZih0aGlzLl9yZWZyZXNoUHJvbWlzZXNCeVJlZ2lvbltyZWdpb25dKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5fcmVmcmVzaFByb21pc2VzQnlSZWdpb25bcmVnaW9uXTtcbiAgICB9XG4gICAgbGV0IHJlc29sdmU7XG4gICAgdGhpcy5fcmVmcmVzaFByb21pc2VzQnlSZWdpb25bcmVnaW9uXSA9IG5ldyBQcm9taXNlKChyZXMsIHJlaikgPT4ge1xuICAgICAgcmVzb2x2ZSA9IHJlcztcbiAgICB9KTtcbiAgICBjb25zdCBzZXJ2ZXJVcmwgPSBhd2FpdCB0aGlzLl93ZWJzb2NrZXRDbGllbnQuZ2V0VXJsU2V0dGluZ3MoMCwgcmVnaW9uKTtcbiAgICBjb25zdCBzdGFydERhdGUgPSBEYXRlLm5vdygpO1xuICBcbiAgICBjb25zdCBzb2NrZXRJbnN0YW5jZSA9IHNvY2tldElPKHNlcnZlclVybC51cmwsIHtcbiAgICAgIHBhdGg6ICcvd3MnLFxuICAgICAgcmVjb25uZWN0aW9uOiB0cnVlLFxuICAgICAgcmVjb25uZWN0aW9uRGVsYXk6IDEwMDAsXG4gICAgICByZWNvbm5lY3Rpb25EZWxheU1heDogNTAwMCxcbiAgICAgIHJlY29ubmVjdGlvbkF0dGVtcHRzOiBJbmZpbml0eSxcbiAgICAgIHRpbWVvdXQ6IHRoaXMuX2Nvbm5lY3RUaW1lb3V0LFxuICAgICAgcXVlcnk6IHtcbiAgICAgICAgJ2F1dGgtdG9rZW4nOiB0aGlzLl90b2tlbixcbiAgICAgICAgcHJvdG9jb2w6IDNcbiAgICAgIH1cbiAgICB9KTtcbiAgICBzb2NrZXRJbnN0YW5jZS5vbignY29ubmVjdCcsIGFzeW5jICgpID0+IHtcbiAgICAgIHJlc29sdmUoKTtcbiAgICAgIGNvbnN0IGxhdGVuY3kgPSBEYXRlLm5vdygpIC0gc3RhcnREYXRlO1xuICAgICAgdGhpcy5fbGF0ZW5jeUNhY2hlW3JlZ2lvbl0gPSBsYXRlbmN5O1xuICAgICAgc29ja2V0SW5zdGFuY2UuY2xvc2UoKTtcbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLl9yZWZyZXNoUHJvbWlzZXNCeVJlZ2lvbltyZWdpb25dO1xuICAgIGRlbGV0ZSB0aGlzLl9yZWZyZXNoUHJvbWlzZXNCeVJlZ2lvbltyZWdpb25dO1xuICB9XG5cbn1cbiJdfQ==