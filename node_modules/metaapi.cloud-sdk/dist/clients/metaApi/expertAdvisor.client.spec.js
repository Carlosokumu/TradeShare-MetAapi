'use strict';

var _httpClient = require('../httpClient');

var _httpClient2 = _interopRequireDefault(_httpClient);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _expertAdvisor = require('./expertAdvisor.client');

var _expertAdvisor2 = _interopRequireDefault(_expertAdvisor);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const provisioningApiUrl = 'https://mt-provisioning-api-v1.agiliumtrade.agiliumtrade.ai';

/**
 * @test {ExpertAdvisorClient}
 */
describe('ExpertAdvisorClient', () => {

  let expertAdvisorClient;
  const token = 'header.payload.sign';
  let httpClient = new _httpClient2.default();
  let domainClient;
  let sandbox;
  let requestStub;

  before(() => {
    sandbox = _sinon2.default.createSandbox();
  });

  beforeEach(() => {
    domainClient = {
      token,
      domain: 'agiliumtrade.agiliumtrade.ai'
    };
    expertAdvisorClient = new _expertAdvisor2.default(httpClient, domainClient);
    requestStub = sandbox.stub(httpClient, 'request');
  });

  afterEach(() => {
    sandbox.restore();
  });

  /**
   * @test {ExpertAdvisorClient#getExpertAdvisors}
   */
  it('should retrieve expert advisors from API', async () => {
    const expected = [{
      expertId: 'my-ea',
      period: '1H',
      symbol: 'EURUSD',
      fileUploaded: false
    }];
    requestStub.resolves(expected);
    let expertAdvisors = await expertAdvisorClient.getExpertAdvisors('id');
    expertAdvisors.should.equal(expected);
    _sinon2.default.assert.calledOnceWithExactly(httpClient.request, {
      url: `${provisioningApiUrl}/users/current/accounts/id/expert-advisors`,
      method: 'GET',
      headers: {
        'auth-token': token
      },
      json: true
    }, 'getExpertAdvisors');
  });

  /**
   * @test {ExpertAdvisorClient#getExpertAdvisors}
   */
  it('should not retrieve expert advisors from API with account token', async () => {
    domainClient.token = 'token';
    expertAdvisorClient = new _expertAdvisor2.default(httpClient, domainClient);
    try {
      await expertAdvisorClient.getExpertAdvisors('id');
      _sinon2.default.assert.fail();
    } catch (error) {
      error.message.should.equal('You can not invoke getExpertAdvisors method, because you have connected with account access token. ' + 'Please use API access token from https://app.metaapi.cloud/token page to invoke this method.');
    }
  });

  /**
   * @test {ExpertAdvisorClient#getExpertAdvisor}
   */
  it('should retrieve expert advisor from API', async () => {
    let expected = {
      expertId: 'my-ea',
      period: '1H',
      symbol: 'EURUSD',
      fileUploaded: false
    };
    requestStub.resolves(expected);
    let advisor = await expertAdvisorClient.getExpertAdvisor('id', 'my-ea');
    advisor.should.equal(expected);
    _sinon2.default.assert.calledOnceWithExactly(httpClient.request, {
      url: `${provisioningApiUrl}/users/current/accounts/id/expert-advisors/my-ea`,
      method: 'GET',
      headers: {
        'auth-token': token
      },
      json: true
    }, 'getExpertAdvisor');
  });

  /**
   * @test {ExpertAdvisorClient#getExpertAdvisor}
   */
  it('should not retrieve expert advisor from API with account token', async () => {
    domainClient.token = 'token';
    expertAdvisorClient = new _expertAdvisor2.default(httpClient, domainClient);
    try {
      await expertAdvisorClient.getExpertAdvisor('id', 'my-ea');
      _sinon2.default.assert.fail();
    } catch (error) {
      error.message.should.equal('You can not invoke getExpertAdvisor method, because you have connected with account access token. ' + 'Please use API access token from https://app.metaapi.cloud/token page to invoke this method.');
    }
  });

  /**
   * @test {ExpertAdvisorClient#deleteExpertAdvisor}
   */
  it('should delete expert advisor via API', async () => {
    await expertAdvisorClient.deleteExpertAdvisor('id', 'my-ea');
    _sinon2.default.assert.calledOnceWithExactly(httpClient.request, {
      url: `${provisioningApiUrl}/users/current/accounts/id/expert-advisors/my-ea`,
      method: 'DELETE',
      headers: {
        'auth-token': token
      },
      json: true
    }, 'deleteExpertAdvisor');
  });

  /**
   * @test {ExpertAdvisorClient#deleteExpertAdvisor}
   */
  it('should not delete expert advisor from API with account token', async () => {
    domainClient.token = 'token';
    expertAdvisorClient = new _expertAdvisor2.default(httpClient, domainClient);
    try {
      await expertAdvisorClient.deleteExpertAdvisor('id', 'my-ea');
      _sinon2.default.assert.fail();
    } catch (error) {
      error.message.should.equal('You can not invoke deleteExpertAdvisor method, because you have connected with account access token. ' + 'Please use API access token from https://app.metaapi.cloud/token page to invoke this method.');
    }
  });

  /**
   * @test {ExpertAdvisorClient#updateExpertAdvisor}
   */
  it('should update expert advisor via API', async () => {
    await expertAdvisorClient.updateExpertAdvisor('id', 'my-ea', {
      preset: 'a2V5MT12YWx1ZTEKa2V5Mj12YWx1ZTIKa2V5Mz12YWx1ZTMKc3VwZXI9dHJ1ZQ==',
      period: '15m',
      symbol: 'EURUSD'
    });
    _sinon2.default.assert.calledOnceWithExactly(httpClient.request, {
      url: `${provisioningApiUrl}/users/current/accounts/id/expert-advisors/my-ea`,
      method: 'PUT',
      headers: {
        'auth-token': token
      },
      json: true,
      body: {
        preset: 'a2V5MT12YWx1ZTEKa2V5Mj12YWx1ZTIKa2V5Mz12YWx1ZTMKc3VwZXI9dHJ1ZQ==',
        period: '15m',
        symbol: 'EURUSD'
      }
    }, 'updateExpertAdvisor');
  });

  /**
   * @test {ExpertAdvisorClient#updateExpertAdvisor}
   */
  it('should not update expert advisor via API with account token', async () => {
    domainClient.token = 'token';
    expertAdvisorClient = new _expertAdvisor2.default(httpClient, domainClient);
    try {
      await expertAdvisorClient.updateExpertAdvisor('id', 'my-ea', {
        preset: 'a2V5MT12YWx1ZTEKa2V5Mj12YWx1ZTIKa2V5Mz12YWx1ZTMKc3VwZXI9dHJ1ZQ==',
        period: '15m',
        symbol: 'EURUSD'
      });
      _sinon2.default.assert.fail();
    } catch (error) {
      error.message.should.equal('You can not invoke updateExpertAdvisor method, because you have connected with account access token. ' + 'Please use API access token from https://app.metaapi.cloud/token page to invoke this method.');
    }
  });

  /**
   * @test {ExpertAdvisorClient#uploadExpertAdvisorFile}
   */
  it('should upload file to a expert advisor via API', async () => {
    let file = Buffer.from('test', 'utf8');
    await expertAdvisorClient.uploadExpertAdvisorFile('id', 'my-ea', file);
    _sinon2.default.assert.calledOnceWithExactly(httpClient.request, {
      url: `${provisioningApiUrl}/users/current/accounts/id/expert-advisors/my-ea/file`,
      method: 'PUT',
      headers: {
        'auth-token': token
      },
      formData: {
        file
      },
      json: true
    }, 'uploadExpertAdvisorFile');
  });

  /**
   * @test {ExpertAdvisorClient#uploadExpertAdvisorFile}
   */
  it('should not upload file to an expert advisor via API with account token', async () => {
    domainClient.token = 'token';
    expertAdvisorClient = new _expertAdvisor2.default(httpClient, domainClient);
    try {
      let file = Buffer.from('test', 'utf8');
      await expertAdvisorClient.uploadExpertAdvisorFile('id', 'my-ea', file);
      _sinon2.default.assert.fail();
    } catch (error) {
      error.message.should.equal('You can not invoke uploadExpertAdvisorFile method, because you have connected with account access token. ' + 'Please use API access token from https://app.metaapi.cloud/token page to invoke this method.');
    }
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9jbGllbnRzL21ldGFBcGkvZXhwZXJ0QWR2aXNvci5jbGllbnQuc3BlYy5lczYiXSwibmFtZXMiOlsicHJvdmlzaW9uaW5nQXBpVXJsIiwiZGVzY3JpYmUiLCJleHBlcnRBZHZpc29yQ2xpZW50IiwidG9rZW4iLCJodHRwQ2xpZW50IiwiSHR0cENsaWVudCIsImRvbWFpbkNsaWVudCIsInNhbmRib3giLCJyZXF1ZXN0U3R1YiIsImJlZm9yZSIsInNpbm9uIiwiY3JlYXRlU2FuZGJveCIsImJlZm9yZUVhY2giLCJkb21haW4iLCJFeHBlcnRBZHZpc29yQ2xpZW50Iiwic3R1YiIsImFmdGVyRWFjaCIsInJlc3RvcmUiLCJpdCIsImV4cGVjdGVkIiwiZXhwZXJ0SWQiLCJwZXJpb2QiLCJzeW1ib2wiLCJmaWxlVXBsb2FkZWQiLCJyZXNvbHZlcyIsImV4cGVydEFkdmlzb3JzIiwiZ2V0RXhwZXJ0QWR2aXNvcnMiLCJzaG91bGQiLCJlcXVhbCIsImFzc2VydCIsImNhbGxlZE9uY2VXaXRoRXhhY3RseSIsInJlcXVlc3QiLCJ1cmwiLCJtZXRob2QiLCJoZWFkZXJzIiwianNvbiIsImZhaWwiLCJlcnJvciIsIm1lc3NhZ2UiLCJhZHZpc29yIiwiZ2V0RXhwZXJ0QWR2aXNvciIsImRlbGV0ZUV4cGVydEFkdmlzb3IiLCJ1cGRhdGVFeHBlcnRBZHZpc29yIiwicHJlc2V0IiwiYm9keSIsImZpbGUiLCJCdWZmZXIiLCJmcm9tIiwidXBsb2FkRXhwZXJ0QWR2aXNvckZpbGUiLCJmb3JtRGF0YSJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7QUFFQSxNQUFNQSxxQkFBcUIsNkRBQTNCOztBQUVBOzs7QUFHQUMsU0FBUyxxQkFBVCxFQUFnQyxNQUFNOztBQUVwQyxNQUFJQyxtQkFBSjtBQUNBLFFBQU1DLFFBQVEscUJBQWQ7QUFDQSxNQUFJQyxhQUFhLElBQUlDLG9CQUFKLEVBQWpCO0FBQ0EsTUFBSUMsWUFBSjtB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QVM7QUFDUCxzQkFBYy9CO0FBRFAsT0FINEM7QUFNckQ4QyxnQkFBVTtBQUNSSjtBQURRLE9BTjJDO0FBU3JEVixZQUFNO0FBVCtDLEtBQXZELEVBVUcseUJBVkg7QUFXRCxHQWREOztBQWdCQTs7O0FBR0FqQixLQUFHLHdFQUFILEVBQTZFLFlBQVk7QUFDdkZaLGlCQUFhSCxLQUFiLEdBQXFCLE9BQXJCO0FBQ0FELDBCQUFzQixJQUFJWSx1QkFBSixDQUF3QlYsVUFBeEIsRUFBb0NFLFlBQXBDLENBQXRCO0FBQ0EsUUFBSTtBQUNGLFVBQUl1QyxPQUFPQyxPQUFPQyxJQUFQLENBQVksTUFBWixFQUFvQixNQUFwQixDQUFYO0FBQ0EsWUFBTTdDLG9CQUFvQjhDLHVCQUFwQixDQUE0QyxJQUE1QyxFQUFrRCxPQUFsRCxFQUEyREgsSUFBM0QsQ0FBTjtBQUNBbkMsc0JBQU1tQixNQUFOLENBQWFPLElBQWI7QUFDRCxLQUpELENBSUUsT0FBT0MsS0FBUCxFQUFjO0FBQ2RBLFlBQU1DLE9BQU4sQ0FBY1gsTUFBZCxDQUFxQkMsS0FBckIsQ0FDRSw4R0FDQSw4RkFGRjtBQUlEO0FBQ0YsR0FiRDtBQWVELENBNU5EIiwiZmlsZSI6ImV4cGVydEFkdmlzb3IuY2xpZW50LnNwZWMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCBIdHRwQ2xpZW50IGZyb20gJy4uL2h0dHBDbGllbnQnO1xuaW1wb3J0IHNpbm9uIGZyb20gJ3Npbm9uJztcbmltcG9ydCBFeHBlcnRBZHZpc29yQ2xpZW50IGZyb20gJy4vZXhwZXJ0QWR2aXNvci5jbGllbnQnO1xuXG5jb25zdCBwcm92aXNpb25pbmdBcGlVcmwgPSAnaHR0cHM6Ly9tdC1wcm92aXNpb25pbmctYXBpLXYxLmFnaWxpdW10cmFkZS5hZ2lsaXVtdHJhZGUuYWknO1xuXG4vKipcbiAqIEB0ZXN0IHtFeHBlcnRBZHZpc29yQ2xpZW50fVxuICovXG5kZXNjcmliZSgnRXhwZXJ0QWR2aXNvckNsaWVudCcsICgpID0+IHtcblxuICBsZXQgZXhwZXJ0QWR2aXNvckNsaWVudDtcbiAgY29uc3QgdG9rZW4gPSAnaGVhZGVyLnBheWxvYWQuc2lnbic7XG4gIGxldCBodHRwQ2xpZW50ID0gbmV3IEh0dHBDbGllbnQoKTtcbiAgbGV0IGRvbWFpbkNsaWVudDtcbiAgbGV0IHNhbmRib3g7XG4gIGxldCByZXF1ZXN0U3R1YjtcblxuICBiZWZvcmUoKCkgPT4ge1xuICAgIHNhbmRib3ggPSBzaW5vbi5jcmVhdGVTYW5kYm94KCk7XG4gIH0pO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGRvbWFpbkNsaWVudCA9IHtcbiAgICAgIHRva2VuLFxuICAgICAgZG9tYWluOiAnYWdpbGl1bXRyYWRlLmFnaWxpdW10cmFkZS5haSdcbiAgICB9O1xuICAgIGV4cGVydEFkdmlzb3JDbGllbnQgPSBuZXcgRXhwZXJ0QWR2aXNvckNsaWVudChodHRwQ2xpZW50LCBkb21haW5DbGllbnQpO1xuICAgIHJlcXVlc3RTdHViID0gc2FuZGJveC5zdHViKGh0dHBDbGllbnQsICdyZXF1ZXN0Jyk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgc2FuZGJveC5yZXN0b3JlKCk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7RXhwZXJ0QWR2aXNvckNsaWVudCNnZXRFeHBlcnRBZHZpc29yc31cbiAgICovXG4gIGl0KCdzaG91bGQgcmV0cmlldmUgZXhwZXJ0IGFkdmlzb3JzIGZyb20gQVBJJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGV4cGVjdGVkID0gW3tcbiAgICAgIGV4cGVydElkOiAnbXktZWEnLFxuICAgICAgcGVyaW9kOiAnMUgnLFxuICAgICAgc3ltYm9sOiAnRVVSVVNEJyxcbiAgICAgIGZpbGVVcGxvYWRlZDogZmFsc2VcbiAgICB9XTtcbiAgICByZXF1ZXN0U3R1Yi5yZXNvbHZlcyhleHBlY3RlZCk7XG4gICAgbGV0IGV4cGVydEFkdmlzb3JzID0gYXdhaXQgZXhwZXJ0QWR2aXNvckNsaWVudC5nZXRFeHBlcnRBZHZpc29ycygnaWQnKTtcbiAgICBleHBlcnRBZHZpc29ycy5zaG91bGQuZXF1YWwoZXhwZWN0ZWQpO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRPbmNlV2l0aEV4YWN0bHkoaHR0cENsaWVudC5yZXF1ZXN0LCB7XG4gICAgICB1cmw6IGAke3Byb3Zpc2lvbmluZ0FwaVVybH0vdXNlcnMvY3VycmVudC9hY2NvdW50cy9pZC9leHBlcnQtYWR2aXNvcnNgLFxuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ2F1dGgtdG9rZW4nOiB0b2tlblxuICAgICAgfSxcbiAgICAgIGpzb246IHRydWUsXG4gICAgfSwgJ2dldEV4cGVydEFkdmlzb3JzJyk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7RXhwZXJ0QWR2aXNvckNsaWVudCNnZXRFeHBlcnRBZHZpc29yc31cbiAgICovXG4gIGl0KCdzaG91bGQgbm90IHJldHJpZXZlIGV4cGVydCBhZHZpc29ycyBmcm9tIEFQSSB3aXRoIGFjY291bnQgdG9rZW4nLCBhc3luYyAoKSA9PiB7XG4gICAgZG9tYWluQ2xpZW50LnRva2VuID0gJ3Rva2VuJztcbiAgICBleHBlcnRBZHZpc29yQ2xpZW50ID0gbmV3IEV4cGVydEFkdmlzb3JDbGllbnQoaHR0cENsaWVudCwgZG9tYWluQ2xpZW50KTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZXhwZXJ0QWR2aXNvckNsaWVudC5nZXRFeHBlcnRBZHZpc29ycygnaWQnKTtcbiAgICAgIHNpbm9uLmFzc2VydC5mYWlsKCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGVycm9yLm1lc3NhZ2Uuc2hvdWxkLmVxdWFsKFxuICAgICAgICAnWW91IGNhbiBub3QgaW52b2tlIGdldEV4cGVydEFkdmlzb3JzIG1ldGhvZCwgYmVjYXVzZSB5b3UgaGF2ZSBjb25uZWN0ZWQgd2l0aCBhY2NvdW50IGFjY2VzcyB0b2tlbi4gJyArXG4gICAgICAgICdQbGVhc2UgdXNlIEFQSSBhY2Nlc3MgdG9rZW4gZnJvbSBodHRwczovL2FwcC5tZXRhYXBpLmNsb3VkL3Rva2VuIHBhZ2UgdG8gaW52b2tlIHRoaXMgbWV0aG9kLidcbiAgICAgICk7XG4gICAgfVxuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge0V4cGVydEFkdmlzb3JDbGllbnQjZ2V0RXhwZXJ0QWR2aXNvcn1cbiAgICovXG4gIGl0KCdzaG91bGQgcmV0cmlldmUgZXhwZXJ0IGFkdmlzb3IgZnJvbSBBUEknLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IGV4cGVjdGVkID0ge1xuICAgICAgZXhwZXJ0SWQ6ICdteS1lYScsXG4gICAgICBwZXJpb2Q6ICcxSCcsXG4gICAgICBzeW1ib2w6ICdFVVJVU0QnLFxuICAgICAgZmlsZVVwbG9hZGVkOiBmYWxzZVxuICAgIH07XG4gICAgcmVxdWVzdFN0dWIucmVzb2x2ZXMoZXhwZWN0ZWQpO1xuICAgIGxldCBhZHZpc29yID0gYXdhaXQgZXhwZXJ0QWR2aXNvckNsaWVudC5nZXRFeHBlcnRBZHZpc29yKCdpZCcsICdteS1lYScpO1xuICAgIGFkdmlzb3Iuc2hvdWxkLmVxdWFsKGV4cGVjdGVkKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbGVkT25jZVdpdGhFeGFjdGx5KGh0dHBDbGllbnQucmVxdWVzdCwge1xuICAgICAgdXJsOiBgJHtwcm92aXNpb25pbmdBcGlVcmx9L3VzZXJzL2N1cnJlbnQvYWNjb3VudHMvaWQvZXhwZXJ0LWFkdmlzb3JzL215LWVhYCxcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdhdXRoLXRva2VuJzogdG9rZW5cbiAgICAgIH0sXG4gICAgICBqc29uOiB0cnVlLFxuICAgIH0sICdnZXRFeHBlcnRBZHZpc29yJyk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7RXhwZXJ0QWR2aXNvckNsaWVudCNnZXRFeHBlcnRBZHZpc29yfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCBub3QgcmV0cmlldmUgZXhwZXJ0IGFkdmlzb3IgZnJvbSBBUEkgd2l0aCBhY2NvdW50IHRva2VuJywgYXN5bmMgKCkgPT4ge1xuICAgIGRvbWFpbkNsaWVudC50b2tlbiA9ICd0b2tlbic7XG4gICAgZXhwZXJ0QWR2aXNvckNsaWVudCA9IG5ldyBFeHBlcnRBZHZpc29yQ2xpZW50KGh0dHBDbGllbnQsIGRvbWFpbkNsaWVudCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGV4cGVydEFkdmlzb3JDbGllbnQuZ2V0RXhwZXJ0QWR2aXNvcignaWQnLCAnbXktZWEnKTtcbiAgICAgIHNpbm9uLmFzc2VydC5mYWlsKCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGVycm9yLm1lc3NhZ2Uuc2hvdWxkLmVxdWFsKFxuICAgICAgICAnWW91IGNhbiBub3QgaW52b2tlIGdldEV4cGVydEFkdmlzb3IgbWV0aG9kLCBiZWNhdXNlIHlvdSBoYXZlIGNvbm5lY3RlZCB3aXRoIGFjY291bnQgYWNjZXNzIHRva2VuLiAnICtcbiAgICAgICAgJ1BsZWFzZSB1c2UgQVBJIGFjY2VzcyB0b2tlbiBmcm9tIGh0dHBzOi8vYXBwLm1ldGFhcGkuY2xvdWQvdG9rZW4gcGFnZSB0byBpbnZva2UgdGhpcyBtZXRob2QuJ1xuICAgICAgKTtcbiAgICB9XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7RXhwZXJ0QWR2aXNvckNsaWVudCNkZWxldGVFeHBlcnRBZHZpc29yfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCBkZWxldGUgZXhwZXJ0IGFkdmlzb3IgdmlhIEFQSScsIGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBleHBlcnRBZHZpc29yQ2xpZW50LmRlbGV0ZUV4cGVydEFkdmlzb3IoJ2lkJywgJ215LWVhJyk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZE9uY2VXaXRoRXhhY3RseShodHRwQ2xpZW50LnJlcXVlc3QsIHtcbiAgICAgIHVybDogYCR7cHJvdmlzaW9uaW5nQXBpVXJsfS91c2Vycy9jdXJyZW50L2FjY291bnRzL2lkL2V4cGVydC1hZHZpc29ycy9teS1lYWAsXG4gICAgICBtZXRob2Q6ICdERUxFVEUnLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnYXV0aC10b2tlbic6IHRva2VuXG4gICAgICB9LFxuICAgICAganNvbjogdHJ1ZSxcbiAgICB9LCAnZGVsZXRlRXhwZXJ0QWR2aXNvcicpO1xuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge0V4cGVydEFkdmlzb3JDbGllbnQjZGVsZXRlRXhwZXJ0QWR2aXNvcn1cbiAgICovXG4gIGl0KCdzaG91bGQgbm90IGRlbGV0ZSBleHBlcnQgYWR2aXNvciBmcm9tIEFQSSB3aXRoIGFjY291bnQgdG9rZW4nLCBhc3luYyAoKSA9PiB7XG4gICAgZG9tYWluQ2xpZW50LnRva2VuID0gJ3Rva2VuJztcbiAgICBleHBlcnRBZHZpc29yQ2xpZW50ID0gbmV3IEV4cGVydEFkdmlzb3JDbGllbnQoaHR0cENsaWVudCwgZG9tYWluQ2xpZW50KTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZXhwZXJ0QWR2aXNvckNsaWVudC5kZWxldGVFeHBlcnRBZHZpc29yKCdpZCcsICdteS1lYScpO1xuICAgICAgc2lub24uYXNzZXJ0LmZhaWwoKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgZXJyb3IubWVzc2FnZS5zaG91bGQuZXF1YWwoXG4gICAgICAgICdZb3UgY2FuIG5vdCBpbnZva2UgZGVsZXRlRXhwZXJ0QWR2aXNvciBtZXRob2QsIGJlY2F1c2UgeW91IGhhdmUgY29ubmVjdGVkIHdpdGggYWNjb3VudCBhY2Nlc3MgdG9rZW4uICcgK1xuICAgICAgICAnUGxlYXNlIHVzZSBBUEkgYWNjZXNzIHRva2VuIGZyb20gaHR0cHM6Ly9hcHAubWV0YWFwaS5jbG91ZC90b2tlbiBwYWdlIHRvIGludm9rZSB0aGlzIG1ldGhvZC4nXG4gICAgICApO1xuICAgIH1cbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtFeHBlcnRBZHZpc29yQ2xpZW50I3VwZGF0ZUV4cGVydEFkdmlzb3J9XG4gICAqL1xuICBpdCgnc2hvdWxkIHVwZGF0ZSBleHBlcnQgYWR2aXNvciB2aWEgQVBJJywgYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGV4cGVydEFkdmlzb3JDbGllbnQudXBkYXRlRXhwZXJ0QWR2aXNvcignaWQnLCAnbXktZWEnLCB7XG4gICAgICBwcmVzZXQ6ICdhMlY1TVQxMllXeDFaVEVLYTJWNU1qMTJZV3gxWlRJS2EyVjVNejEyWVd4MVpUTUtjM1Z3WlhJOWRISjFaUT09JyxcbiAgICAgIHBlcmlvZDogJzE1bScsXG4gICAgICBzeW1ib2w6ICdFVVJVU0QnXG4gICAgfSk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZE9uY2VXaXRoRXhhY3RseShodHRwQ2xpZW50LnJlcXVlc3QsIHtcbiAgICAgIHVybDogYCR7cHJvdmlzaW9uaW5nQXBpVXJsfS91c2Vycy9jdXJyZW50L2FjY291bnRzL2lkL2V4cGVydC1hZHZpc29ycy9teS1lYWAsXG4gICAgICBtZXRob2Q6ICdQVVQnLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnYXV0aC10b2tlbic6IHRva2VuXG4gICAgICB9LFxuICAgICAganNvbjogdHJ1ZSxcbiAgICAgIGJvZHk6IHtcbiAgICAgICAgcHJlc2V0OiAnYTJWNU1UMTJZV3gxWlRFS2EyVjVNajEyWVd4MVpUSUthMlY1TXoxMllXeDFaVE1LYzNWd1pYSTlkSEoxWlE9PScsXG4gICAgICAgIHBlcmlvZDogJzE1bScsXG4gICAgICAgIHN5bWJvbDogJ0VVUlVTRCdcbiAgICAgIH1cbiAgICB9LCAndXBkYXRlRXhwZXJ0QWR2aXNvcicpO1xuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge0V4cGVydEFkdmlzb3JDbGllbnQjdXBkYXRlRXhwZXJ0QWR2aXNvcn1cbiAgICovXG4gIGl0KCdzaG91bGQgbm90IHVwZGF0ZSBleHBlcnQgYWR2aXNvciB2aWEgQVBJIHdpdGggYWNjb3VudCB0b2tlbicsIGFzeW5jICgpID0+IHtcbiAgICBkb21haW5DbGllbnQudG9rZW4gPSAndG9rZW4nO1xuICAgIGV4cGVydEFkdmlzb3JDbGllbnQgPSBuZXcgRXhwZXJ0QWR2aXNvckNsaWVudChodHRwQ2xpZW50LCBkb21haW5DbGllbnQpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBleHBlcnRBZHZpc29yQ2xpZW50LnVwZGF0ZUV4cGVydEFkdmlzb3IoJ2lkJywgJ215LWVhJywge1xuICAgICAgICBwcmVzZXQ6ICdhMlY1TVQxMllXeDFaVEVLYTJWNU1qMTJZV3gxWlRJS2EyVjVNejEyWVd4MVpUTUtjM1Z3WlhJOWRISjFaUT09JyxcbiAgICAgICAgcGVyaW9kOiAnMTVtJyxcbiAgICAgICAgc3ltYm9sOiAnRVVSVVNEJ1xuICAgICAgfSk7XG4gICAgICBzaW5vbi5hc3NlcnQuZmFpbCgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBlcnJvci5tZXNzYWdlLnNob3VsZC5lcXVhbChcbiAgICAgICAgJ1lvdSBjYW4gbm90IGludm9rZSB1cGRhdGVFeHBlcnRBZHZpc29yIG1ldGhvZCwgYmVjYXVzZSB5b3UgaGF2ZSBjb25uZWN0ZWQgd2l0aCBhY2NvdW50IGFjY2VzcyB0b2tlbi4gJyArXG4gICAgICAgICdQbGVhc2UgdXNlIEFQSSBhY2Nlc3MgdG9rZW4gZnJvbSBodHRwczovL2FwcC5tZXRhYXBpLmNsb3VkL3Rva2VuIHBhZ2UgdG8gaW52b2tlIHRoaXMgbWV0aG9kLidcbiAgICAgICk7XG4gICAgfVxuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge0V4cGVydEFkdmlzb3JDbGllbnQjdXBsb2FkRXhwZXJ0QWR2aXNvckZpbGV9XG4gICAqL1xuICBpdCgnc2hvdWxkIHVwbG9hZCBmaWxlIHRvIGEgZXhwZXJ0IGFkdmlzb3IgdmlhIEFQSScsIGFzeW5jICgpID0+IHtcbiAgICBsZXQgZmlsZSA9IEJ1ZmZlci5mcm9tKCd0ZXN0JywgJ3V0ZjgnKTtcbiAgICBhd2FpdCBleHBlcnRBZHZpc29yQ2xpZW50LnVwbG9hZEV4cGVydEFkdmlzb3JGaWxlKCdpZCcsICdteS1lYScsIGZpbGUpO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRPbmNlV2l0aEV4YWN0bHkoaHR0cENsaWVudC5yZXF1ZXN0LCB7XG4gICAgICB1cmw6IGAke3Byb3Zpc2lvbmluZ0FwaVVybH0vdXNlcnMvY3VycmVudC9hY2NvdW50cy9pZC9leHBlcnQtYWR2aXNvcnMvbXktZWEvZmlsZWAsXG4gICAgICBtZXRob2Q6ICdQVVQnLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnYXV0aC10b2tlbic6IHRva2VuXG4gICAgICB9LFxuICAgICAgZm9ybURhdGE6IHtcbiAgICAgICAgZmlsZVxuICAgICAgfSxcbiAgICAgIGpzb246IHRydWUsXG4gICAgfSwgJ3VwbG9hZEV4cGVydEFkdmlzb3JGaWxlJyk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7RXhwZXJ0QWR2aXNvckNsaWVudCN1cGxvYWRFeHBlcnRBZHZpc29yRmlsZX1cbiAgICovXG4gIGl0KCdzaG91bGQgbm90IHVwbG9hZCBmaWxlIHRvIGFuIGV4cGVydCBhZHZpc29yIHZpYSBBUEkgd2l0aCBhY2NvdW50IHRva2VuJywgYXN5bmMgKCkgPT4ge1xuICAgIGRvbWFpbkNsaWVudC50b2tlbiA9ICd0b2tlbic7XG4gICAgZXhwZXJ0QWR2aXNvckNsaWVudCA9IG5ldyBFeHBlcnRBZHZpc29yQ2xpZW50KGh0dHBDbGllbnQsIGRvbWFpbkNsaWVudCk7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBmaWxlID0gQnVmZmVyLmZyb20oJ3Rlc3QnLCAndXRmOCcpO1xuICAgICAgYXdhaXQgZXhwZXJ0QWR2aXNvckNsaWVudC51cGxvYWRFeHBlcnRBZHZpc29yRmlsZSgnaWQnLCAnbXktZWEnLCBmaWxlKTtcbiAgICAgIHNpbm9uLmFzc2VydC5mYWlsKCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGVycm9yLm1lc3NhZ2Uuc2hvdWxkLmVxdWFsKFxuICAgICAgICAnWW91IGNhbiBub3QgaW52b2tlIHVwbG9hZEV4cGVydEFkdmlzb3JGaWxlIG1ldGhvZCwgYmVjYXVzZSB5b3UgaGF2ZSBjb25uZWN0ZWQgd2l0aCBhY2NvdW50IGFjY2VzcyB0b2tlbi4gJyArXG4gICAgICAgICdQbGVhc2UgdXNlIEFQSSBhY2Nlc3MgdG9rZW4gZnJvbSBodHRwczovL2FwcC5tZXRhYXBpLmNsb3VkL3Rva2VuIHBhZ2UgdG8gaW52b2tlIHRoaXMgbWV0aG9kLidcbiAgICAgICk7XG4gICAgfVxuICB9KTtcblxufSk7XG4iXX0=