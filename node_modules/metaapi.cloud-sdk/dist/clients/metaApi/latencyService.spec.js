'use strict';

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _should = require('should');

var _should2 = _interopRequireDefault(_should);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _latencyService = require('./latencyService');

var _latencyService2 = _interopRequireDefault(_latencyService);

var _socket = require('socket.io');

var _socket2 = _interopRequireDefault(_socket);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @test {LatencyService}
 */
describe('LatencyService', () => {

  let io;
  let clock;
  let service;
  let sandbox;
  const token = 'token';
  let client = {
    ensureSubscribe: () => {},
    unsubscribe: () => {},
    getUrlSettings: () => {},
    unsubscribeAccountRegion: () => {},
    getAccountRegion: replicaId => {
      if (replicaId === 'accountIdReplica') {
        return 'new-york';
      } else {
        return 'vint-hill';
      }
    },
    accountReplicas: {
      accountId: {
        'vint-hill': 'accountId',
        'new-york': 'accountIdReplica'
      }
    },
    accountsByReplicaId: {
      accountId: 'accountId',
      accountIdReplica: 'accountId'
    }
  };
  let unsubscribeStub;
  let getUrlSettingsStub;
  let ensureSubscribeStub;
  let unsubscribeRegionStub;

  before(() => {
    sandbox = _sinon2.default.createSandbox();
  });

  beforeEach(async () => {
    clock = _sinon2.default.useFakeTimers({ shouldAdvanceTime: true });
    service = new _latencyService2.default(client, token, 5000);

    io = new _socket2.default(6785, { path: '/ws', pingTimeout: 1000000 });
    io.on('connect', socket => {
      if (socket.request._query['auth-token'] !== 'token') {
        socket.emit({ error: 'UnauthorizedError', message: 'Authorization token invalid' });
        socket.close();
      }
    });
    getUrlSettingsStub = sandbox.stub(client, 'getUrlSettings').resolves({ url: 'http://localhost:6785', isSharedClientApi: true });
    unsubscribeStub = sandbox.stub(client, 'unsubscribe').resolves();
    ensureSubscribeStub = sandbox.stub(client, 'ensureSubscribe').resolves();
    unsubscribeRegionStub = sandbox.stub(client, 'unsubscribeAccountRegion').resolves();
  });

  afterEach(async () => {
    clock.restore();
    sandbox.restore();
    let resolve;
    let promise = new _promise2.default(res => resolve = res);
    io.close(() => resolve());
    await promise;
  });

  /**
   * @test {LatencyService#onConnected}
   */
  it('should process onConnected event', async () => {
    await service.onConnected('accountId:vint-hill:0:ps-mpa-1');
    _sinon2.default.assert.match(service.getActiveAccountInstances('accountId'), ['accountId:vint-hill:0:ps-mpa-1']);
  });

  /**
   * @test {LatencyService#onConnected}
   */
  it('should disconnect connected instances with bigger ping', async () => {
    clock.tickAsync(3000);
    await service.onConnected('accountId:new-york:0:ps-mpa-1');
    await service.onConnected('accountId:vint-hill:0:ps-mpa-1');
    _sinon2.default.assert.match(service.getActiveAccountInstances('accountId'), ['accountId:new-york:0:ps-mpa-1', 'accountId:vint-hill:0:ps-mpa-1']);
    _sinon2.default.assert.calledWith(unsubscribeStub, 'accountIdReplica');
    _sinon2.default.assert.calledWith(unsubscribeRegionStub, 'accountId', 'new-york');
  });

  /**
   * @test {LatencyService#onDealsSynchronized}
   */
  it('should disconnect synchronized instances with bigger ping', async () => {
    clock.tickAsync(3000);
    await service.onConnected('accountId:new-york:0:ps-mpa-1');
    await service.onDealsSynchronized('accountId:new-york:0:ps-mpa-1');
    await service.onConnected('accountId:vint-hill:0:ps-mpa-1');
    _sinon2.default.assert.match(service.getActiveAccountInstances('accountId'), ['accountId:new-york:0:ps-mpa-1', 'accountId:vint-hill:0:ps-mpa-1']);
    _sinon2.default.assert.notCalled(unsubscribeStub);
    await service.onDealsSynchronized('accountId:vint-hill:0:ps-mpa-1');
    _sinon2.default.assert.calledWith(unsubscribeStub, 'accountIdReplica');
    _sinon2.default.assert.calledWith(unsubscribeRegionStub, 'accountId', 'new-york');
  });

  /**
   * @test {LatencyService#onConnected}
   */
  it('should not double check ping if two accounts connected at the same time', async () => {
    service.onConnected('accountId:new-york:0:ps-mpa-1');
    await service.onConnected('accountId2:new-york:0:ps-mpa-1');
    _sinon2.default.assert.match(service.getActiveAccountInstances('accountId'), ['accountId:new-york:0:ps-mpa-1']);
    _sinon2.default.assert.match(service.getActiveAccountInstances('accountId2'), ['accountId2:new-york:0:ps-mpa-1']);
    _sinon2.default.assert.calledOnce(getUrlSettingsStub);
  });

  /**
   * @test {LatencyService#_refreshRegionLatencyJob}
   */
  it('should deploy to a better ping if ping stats changed on refresh', async () => {
    clock.tickAsync(3000);
    await service.onConnected('accountId:vint-hill:0:ps-mpa-1');
    await service.onDealsSynchronized('accountId:vint-hill:0:ps-mpa-1');
    await service.onConnected('accountId:new-york:0:ps-mpa-1');
    await service.onDealsSynchronized('accountId:new-york:0:ps-mpa-1');
    _sinon2.default.assert.calledWith(unsubscribeStub, 'accountId');
    _sinon2.default.assert.calledWith(unsubscribeRegionStub, 'accountId', 'vint-hill');
    await service.onUnsubscribe('accountId');
    await clock.tickAsync(15 * 60 * 1000 - 2900);
    await service._refreshPromisesByRegion['vint-hill'];
    await clock.tickAsync(1000);
    await new _promise2.default(res => setTimeout(res, 50));
    _sinon2.default.assert.calledWith(ensureSubscribeStub, 'accountId', 0);
    _sinon2.default.assert.calledWith(ensureSubscribeStub, 'accountId', 1);
  });

  /**
   * @test {LatencyService#onDisconnected}
   */
  it('should subscribe replicas on disconnected event if all replicas offline', async () => {
    await service.onConnected('accountId:vint-hill:0:ps-mpa-1');
    await service.onDealsSynchronized('accountId:vint-hill:0:ps-mpa-1');
    await service.onConnected('accountId:new-york:0:ps-mpa-1');
    await service.onDealsSynchronized('accountId:new-york:0:ps-mpa-1');
    _sinon2.default.assert.match(service.getActiveAccountInstances('accountId'), ['accountId:vint-hill:0:ps-mpa-1', 'accountId:new-york:0:ps-mpa-1']);
    _sinon2.default.assert.match(service.getSynchronizedAccountInstances('accountId'), ['accountId:vint-hill:0:ps-mpa-1', 'accountId:new-york:0:ps-mpa-1']);
    await service.onDisconnected('accountId:new-york:0:ps-mpa-1');
    _sinon2.default.assert.match(service.getActiveAccountInstances('accountId'), ['accountId:vint-hill:0:ps-mpa-1']);
    _sinon2.default.assert.match(service.getSynchronizedAccountInstances('accountId'), ['accountId:vint-hill:0:ps-mpa-1']);
    _sinon2.default.assert.notCalled(ensureSubscribeStub);
    await service.onDisconnected('accountId:vint-hill:0:ps-mpa-1');
    _sinon2.default.assert.match(service.getActiveAccountInstances('accountId'), []);
    _sinon2.default.assert.match(service.getSynchronizedAccountInstances('accountId'), []);
    _sinon2.default.assert.calledWith(ensureSubscribeStub, 'accountIdReplica', 0);
    _sinon2.default.assert.calledWith(ensureSubscribeStub, 'accountIdReplica', 1);
  });

  /**
   * @test {LatencyService#onUnsubscribe}
   */
  it('should mark accounts as disconnected on unsubscribe', async () => {
    await service.onConnected('accountId:vint-hill:0:ps-mpa-1');
    await service.onDealsSynchronized('accountId:vint-hill:0:ps-mpa-1');
    await service.onConnected('accountId:new-york:0:ps-mpa-1');
    await service.onDealsSynchronized('accountId:new-york:0:ps-mpa-1');
    _sinon2.default.assert.match(service.getActiveAccountInstances('accountId'), ['accountId:vint-hill:0:ps-mpa-1', 'accountId:new-york:0:ps-mpa-1']);
    _sinon2.default.assert.match(service.getSynchronizedAccountInstances('accountId'), ['accountId:vint-hill:0:ps-mpa-1', 'accountId:new-york:0:ps-mpa-1']);
    await service.onUnsubscribe('accountIdReplica');
    _sinon2.default.assert.match(service.getActiveAccountInstances('accountId'), ['accountId:vint-hill:0:ps-mpa-1']);
    _sinon2.default.assert.match(service.getSynchronizedAccountInstances('accountId'), ['accountId:vint-hill:0:ps-mpa-1']);
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9jbGllbnRzL21ldGFBcGkvbGF0ZW5jeVNlcnZpY2Uuc3BlYy5lczYiXSwibmFtZXMiOlsiZGVzY3JpYmUiLCJpbyIsImNsb2NrIiwic2VydmljZSIsInNhbmRib3giLCJ0b2tlbiIsImNsaWVudCIsImVuc3VyZVN1YnNjcmliZSIsInVuc3Vic2NyaWJlIiwiZ2V0VXJsU2V0dGluZ3MiLCJ1bnN1YnNjcmliZUFjY291bnRSZWdpb24iLCJnZXRBY2NvdW50UmVnaW9uIiwicmVwbGljYUlkIiwiYWNjb3VudFJlcGxpY2FzIiwiYWNjb3VudElkIiwiYWNjb3VudHNCeVJlcGxpY2FJZCIsImFjY291bnRJZFJlcGxpY2EiLCJ1bnN1YnNjcmliZVN0dWIiLCJnZXRVcmxTZXR0aW5nc1N0dWIiLCJlbnN1cmVTdWJzY3JpYmVTdHViIiwidW5zdWJzY3JpYmVSZWdpb25TdHViIiwiYmVmb3JlIiwic2lub24iLCJjcmVhdGVTYW5kYm94IiwiYmVmb3JlRWFjaCIsInVzZUZha2VUaW1lcnMiLCJzaG91bGRBZHZhbmNlVGltZSIsIkxhdGVuY3lTZXJ2aWNlIiwiU2VydmVyIiwicGF0aCIsInBpbmdUaW1lb3V0Iiwib24iLCJzb2NrZXQiLCJyZXF1ZXN0IiwiX3F1ZXJ5IiwiZW1pdCIsImVycm9yIiwibWVzc2FnZSIsImNsb3NlIiwic3R1YiIsInJlc29sdmVzIiwidXJsIiwiaXNTaGFyZWRDbGllbnRBcGkiLCJhZnRlckVhY2giLCJyZXN0b3JlIiwicmVzb2x2ZSIsInByb21pc2UiLCJyZXMiLCJpdCIsIm9uQ29ubmVjdGVkIiwiYXNzZXJ0IiwibWF0Y2giLCJnZXRBY3RpdmVBY2NvdW50SW5zdGFuY2VzIiwidGlja0FzeW5jIiwiY2FsbGVkV2l0aCIsIm9uRGVhbHNTeW5jaHJvbml6ZWQiLCJub3RDYWxsZWQiLCJjYWxsZWRPbmNlIiwib25VbnN1YnNjcmliZSIsIl9yZWZyZXNoUHJvbWlzZXNCeVJlZ2lvbiIsInNldFRpbWVvdXQiLCJnZXRTeW5jaHJvbml6ZWRBY2NvdW50SW5zdGFuY2VzIiwib25EaXNjb25uZWN0ZWQiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7QUFFQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBRUE7OztBQUdBQSxTQUFTLGdCQUFULEVBQTJCLE1BQU07O0FBRS9CLE1BQUlDLEVBQUo7QUFDQSxNQUFJQyxLQUFKO0FBQ0EsTUFBSUMsT0FBSjtBQUNBLE1BQUlDLE9BQUo7QUFDQSxRQUFNQyxRQUFRLE9BQWQ7QUFDQSxNQUFJQyxTQUFTO0FBQ1hDLHFCQUFpQixNQUFNLENBQUUsQ0FEZDtBQUVYQyxpQkFBYSxNQUFNLENBQUUsQ0FGVjtBQUdYQyxvQkFBZ0IsTUFBTSxDQUFFLENBSGI7QUFJWEMsOEJBQTBCLE1BQU0sQ0FBRSxDQUp2QjtBQUtYQyxzQkFBbUJDLFNBQUQsSUFBZTtBQUMvQixVQUFHQSxjQUFjLGtCQUFqQixFQUFxQztBQUNuQyxlQUFPLFVBQVA7QUFDRCxPQUZELE1BRU87QUFDTCxlQUFPLFdBQVA7QUFDRDtBQUNGLEtBWFU7QUFZWEMscUJBQWlCO0FBQ2ZDLGlCQUFXO0FBQ1QscUJBQWEsV0FESjtBQUVULG9CQUFZO0FBRkg7QUFESSxLQVpOO0FBa0JYQyx5QkFBcUI7QUFDbkJELGlCQUFXLFdBRFE7QUFFbkJFLHdCQUFrQjtBQUZDO0FBbEJWLEdBQWI7QUF1QkEsTUFBSUMsZUFBSjtBQUNBLE1BQUlDLGtCQUFKO0FBQ0EsTUFBSUMsbUJBQUo7QUFDQSxNQUFJQyxxQkFBSjs7QUFFQUMsU0FBTyxNQUFNO0FBQ1hqQixjQUFVa0IsZ0JBQU1DLGFBQU4sRUFBVjtBQUNELEdBRkQ7O0FBSUFDLGFBQVcsWUFBWTtBQUNyQnRCLFlBQVFvQixnQkFBTUcsYUFBTixDQUFvQixFQUFDQyxtQkFBbUIsSUFBcEIsRUFBcEIsQ0FBUjtBQUNBdkIsY0FBVSxJQUFJd0Isd0JBQUosQ0FBbUJyQixNQUFuQixFQUEyQkQsS0FBM0IsRUFBa0MsSUFBbEMsQ0FBVjs7QUFFQUosU0FBSyxJQUFJMkIsZ0JBQUosQ0FBVyxJQUFYLEVBQWlCLEVBQUNDLE1BQU0sS0FBUCxFQUFjQyxhQUFhLE9BQTNCLEVBQWpCLENBQUw7QUFDQTdCLE9BQUc4QixFQUFILENBQU0sU0FBTixFQUFpQkMsVUFBVTtBQUN6QixVQUFJQSxPQUFPQyxPQUFQLENBQWVDLE1BQWYsQ0FBc0IsWUFBdEIsTUFBd0MsT0FBNUMsRUFBcUQ7QUFDbkRGLGVBQU9HLElBQVAsQ0FBWSxFQUFDQyxPQUFPLG1CQUFSLEVBQTZCQyxTQUFTLDZCQUF0QyxFQUFaO0FBQ0FMLGVBQU9NLEtBQVA7QUFDRDtBQUNGLEtBTEQ7QUFNQXBCLHlCQUFxQmQsUUFBUW1DLElBQVIsQ0FBYWpDLE1BQWIsRUFBcUIsZ0JBQXJCLEVBQ2xCa0MsUUFEa0IsQ0FDVCxFQUFDQyxLQUFLLHVCQUFOLEVBQStCQyxtQkFBbUIsSUFBbEQsRUFEUyxDQUFyQjtBQUVBekIsc0JBQWtCYixRQUFRbUMsSUFBUixDQUFhakMsTUFBYixFQUFxQixhQUFyQixFQUFvQ2tDLFFBQXBDLEVBQWxCO0FBQ0FyQiwwQkFBc0JmLFFBQVFtQyxJQUFSLENBQWFqQyxNQUFiLEVBQXFCLGlCQUFyQixFQUF3Q2tDLFFBQXhDLEVBQXRCO0FBQ0FwQiw0QkFBd0JoQixRQUFRbUMsSUFBUixDQUFhakMsTUFBYixFQUFxQiwwQkFBckIsRUFBaURrQyxRQUFqRCxFQUF4QjtBQUNELEdBaEJEOztBQWtCQUcsWUFBVSxZQUFZO0FBQ3BCekMsVUFBTTBDLE9BQU47QUFDQXhDLFlBQVF3QyxPQUFSO0FBQ0EsUUFBSUMsT0FBSjtBQUNBLFFBQUlDLFVBQVUsc0JBQVlDLE9BQU9GLFVBQVVFLEdBQTdCLENBQWQ7QUFDQTlDLE9BQUdxQyxLQUFILENBQVMsTUFBTU8sU0FBZjtBQUNBLFVBQU1DLE9BQU47QUFDRCxHQVBEOztBQVNBOzs7QUFHQUUsS0FBRyxrQ0FBSCxFQUF1QyxZQUFZO0FBQ2pELFVBQU03QyxRQUFROEMsV0FBUixDQUFvQixnQ0FBcEIsQ0FBTjtBQUNBM0Isb0JBQU00QixNQUFOLENBQWFDLEtBQWIsQ0FBbUJoRCxRQUFRaUQseUJBQVIsQ0FBa0MsV0FBbEMsQ0FBbkIsRUFBbUUsQ0FBQyxnQ0FBRCxDQUFuRTtBQUNELEdBSEQ7O0FBS0E7OztBQUdBSixLQUFHLHdEQUFILEVBQTZELFlBQVk7QUFDdkU5QyxVQUFNbUQsU0FBTixDQUFnQixJQUFoQjtBQUNBLFVBQU1sRCxRQUFROEMsV0FBUixDQUFvQiwrQkFBcEIsQ0FBTjtBQUNBLFVBQU05QyxRQUFROEMsV0FBUixDQUFvQixnQ0FBcEIsQ0FBTjtBQUNBM0Isb0JBQU00QixNQUFOLENBQWFDLEtBQWIsQ0FBbUJoRCxRQUFRaUQseUJBQVIsQ0FBa0MsV0FBbEMsQ0FBbkIsRUFDRSxDQUFDLCtCQUFELEVBQWtDLGdDQUFsQyxDQURGO0FBRUE5QixvQkFBTTRCLE1BQU4sQ0FBYUksVUFBYixDQUF3QnJDLGVBQXhCLEVBQXlDLGtCQUF6QztBQUNBSyxvQkFBTTRCLE1BQU4sQ0FBYUksVUFBYixDQUF3QmxDLHFCQUF4QixFQUErQyxXQUEvQyxFQUE0RCxVQUE1RDtBQUNELEdBUkQ7O0FBVUE7OztBQUdBNEIsS0FBRywyREFBSCxFQUFnRSxZQUFZO0FBQzFFOUMsVUFBTW1ELFNBQU4sQ0FBZ0IsSUFBaEI7QUFDQSxVQUFNbEQsUUFBUThDLFdBQVIsQ0FBb0IsK0JBQXBCLENBQU47QUFDQSxVQUFNOUMsUUFBUW9ELG1CQUFSLENBQTRCLCtCQUE1QixDQUFOO0FBQ0EsVUFBTXBELFFBQVE4QyxXQUFSLENBQW9CLGdDQUFwQixDQUFOO0FBQ0EzQixvQkFBTTRCLE1BQU4sQ0FBYUMsS0FBYixDQUFtQmhELFFBQVFpRCx5QkFBUixDQUFrQyxXQUFsQyxDQUFuQixFQUNFLENBQUMsK0JBQUQsRUFBa0MsZ0NBQWxDLENBREY7QUFFQTlCLG9CQUFNNEIsTUFBTixDQUFhTSxTQUFiLENBQXVCdkMsZUFBdkI7QUFDQSxVQUFNZCxRQUFRb0QsbUJBQVIsQ0FBNEIsZ0NBQTVCLENBQU47QUFDQWpDLG9CQUFNNEIsTUFBTixDQUFhSSxVQUFiLENBQXdCckMsZUFBeEIsRUFBeUMsa0JBQXpDO0FBQ0FLLG9CQUFNNEIsTUFBTixDQUFhSSxVQUFiLENBQXdCbEMscUJBQXhCLEVBQStDLFdBQS9DLEVBQTRELFVBQTVEO0FBQ0QsR0FYRDs7QUFhQTs7O0FBR0E0QixLQUFHLHlFQUFILEVBQThFLFlBQVk7QUFDeEY3QyxZQUFROEMsV0FBUixDQUFvQiwrQkFBcEI7QUFDQSxVQUFNOUMsUUFBUThDLFdBQVIsQ0FBb0IsZ0NBQXBCLENBQU47QUFDQTNCLG9CQUFNNEIsTUFBTixDQUFhQyxLQUFiLENBQW1CaEQsUUFBUWlELHlCQUFSLENBQWtDLFdBQWxDLENBQW5CLEVBQ0UsQ0FBQywrQkFBRCxDQURGO0FBRUE5QixvQkFBTTRCLE1BQU4sQ0FBYUMsS0FBYixDQUFtQmhELFFBQVFpRCx5QkFBUixDQUFrQyxZQUFsQyxDQUFuQixFQUNFLENBQUMsZ0NBQUQsQ0FERjtBQUVBOUIsb0JBQU00QixNQUFOLENBQWFPLFVBQWIsQ0FBd0J2QyxrQkFBeEI7QUFDRCxHQVJEOztBQVVBOzs7QUFHQThCLEtBQUcsaUVBQUgsRUFBc0UsWUFBWTtBQUNoRjlDLFVBQU1tRCxTQUFOLENBQWdCLElBQWhCO0FBQ0EsVUFBTWxELFFBQVE4QyxXQUFSLENBQW9CLGdDQUFwQixDQUFOO0FBQ0EsVUFBTTlDLFFBQVFvRCxtQkFBUixDQUE0QixnQ0FBNUIsQ0FBTjtBQUNBLFVBQU1wRCxRQUFROEMsV0FBUixDQUFvQiwrQkFBcEIsQ0FBTjtBQUNBLFVBQU05QyxRQUFRb0QsbUJBQVIsQ0FBNEIsK0JBQTVCLENBQU47QUFDQWpDLG9CQUFNNEIsTUFBTixDQUFhSSxVQUFiLENBQXdCckMsZUFBeEIsRUFBeUMsV0FBekM7QUFDQUssb0JBQU00QixNQUFOLENBQWFJLFVBQWIsQ0FBd0JsQyxxQkFBeEIsRUFBK0MsV0FBL0MsRUFBNEQsV0FBNUQ7QUFDQSxVQUFNakIsUUFBUXVELGFBQVIsQ0FBc0IsV0FBdEIsQ0FBTjtBQUNBLFVBQU14RCxNQUFNbUQsU0FBTixDQUFnQixLQUFLLEVBQUwsR0FBVSxJQUFWLEdBQWlCLElBQWpDLENBQU47QUFDQSxVQUFNbEQsUUFBUXdELHdCQUFSLENBQWlDLFdBQWpDLENBQU47QUFDQSxVQUFNekQsTUFBTW1ELFNBQU4sQ0FBZ0IsSUFBaEIsQ0FBTjtBQUNBLFVBQU0sc0JBQVlOLE9BQU9hLFdBQVdiLEdBQVgsRUFBZ0IsRUFBaEIsQ0FBbkIsQ0FBTjtBQUNBekIsb0JBQU00QixNQUFOLENBQWFJLFVBQWIsQ0FBd0JuQyxtQkFBeEIsRUFBNkMsV0FBN0MsRUFBMEQsQ0FBMUQ7QUFDQUcsb0JBQU00QixNQUFOLENBQWFJLFVBQWIsQ0FBd0JuQyxtQkFBeEIsRUFBNkMsV0FBN0MsRUFBMEQsQ0FBMUQ7QUFDRCxHQWZEOztBQWlCQTs7O0FBR0E2QixLQUFHLHlFQUFILEVBQThFLFlBQVk7QUFDeEYsVUFBTTdDLFFBQVE4QyxXQUFSLENBQW9CLGdDQUFwQixDQUFOO0FBQ0EsVUFBTTlDLFFBQVFvRCxtQkFBUixDQUE0QixnQ0FBNUIsQ0FBTjtBQUNBLFVBQU1wRCxRQUFROEMsV0FBUixDQUFvQiwrQkFBcEIsQ0FBTjtBQUNBLFVBQU05QyxRQUFRb0QsbUJBQVIsQ0FBNEIsK0JBQTVCLENBQU47QUFDQWpDLG9CQUFNNEIsTUFBTixDQUFhQyxLQUFiLENBQW1CaEQsUUFBUWlELHlCQUFSLENBQWtDLFdBQWxDLENBQW5CLEVBQ0UsQ0FBQyxnQ0FBRCxFQUFtQywrQkFBbkMsQ0FERjtBQUVBOUIsb0JBQU00QixNQUFOLENBQWFDLEtBQWIsQ0FBbUJoRCxRQUFRMEQsK0JBQVIsQ0FBd0MsV0FBeEMsQ0FBbkIsRUFDRSxDQUFDLGdDQUFELEVBQW1DLCtCQUFuQyxDQURGO0FBRUEsVUFBTTFELFFBQVEyRCxjQUFSLENBQXVCLCtCQUF2QixDQUFOO0FBQ0F4QyxvQkFBTTRCLE1BQU4sQ0FBYUMsS0FBYixDQUFtQmhELFFBQVFpRCx5QkFBUixDQUFrQyxXQUFsQyxDQUFuQixFQUNFLENBQUMsZ0NBQUQsQ0FERjtBQUVBOUIsb0JBQU00QixNQUFOLENBQWFDLEtBQWIsQ0FBbUJoRCxRQUFRMEQsK0JBQVIsQ0FBd0MsV0FBeEMsQ0FBbkIsRUFDRSxDQUFDLGdDQUFELENBREY7QUFFQXZDLG9CQUFNNEIsTUFBTixDQUFhTSxTQUFiLENBQXVCckMsbUJBQXZCO0FBQ0EsVUFBTWhCLFFBQVEyRCxjQUFSLENBQXVCLGdDQUF2QixDQUFOO0FBQ0F4QyxvQkFBTTRCLE1BQU4sQ0FBYUMsS0FBYixDQUFtQmhELFFBQVFpRCx5QkFBUixDQUFrQyxXQUFsQyxDQUFuQixFQUFtRSxFQUFuRTtBQUNBOUIsb0JBQU00QixNQUFOLENBQWFDLEtBQWIsQ0FBbUJoRCxRQUFRMEQsK0JBQVIsQ0FBd0MsV0FBeEMsQ0FBbkIsRUFBeUUsRUFBekU7QUFDQXZDLG9CQUFNNEIsTUFBTixDQUFhSSxVQUFiLENBQXdCbkMsbUJBQXhCLEVBQTZDLGtCQUE3QyxFQUFpRSxDQUFqRTtBQUNBRyxvQkFBTTRCLE1BQU4sQ0FBYUksVUFBYixDQUF3Qm5DLG1CQUF4QixFQUE2QyxrQkFBN0MsRUFBaUUsQ0FBakU7QUFDRCxHQXBCRDs7QUFzQkE7OztBQUdBNkIsS0FBRyxxREFBSCxFQUEwRCxZQUFZO0FBQ3BFLFVBQU03QyxRQUFROEMsV0FBUixDQUFvQixnQ0FBcEIsQ0FBTjtBQUNBLFVBQU05QyxRQUFRb0QsbUJBQVIsQ0FBNEIsZ0NBQTVCLENBQU47QUFDQSxVQUFNcEQsUUFBUThDLFdBQVIsQ0FBb0IsK0JBQXBCLENBQU47QUFDQSxVQUFNOUMsUUFBUW9ELG1CQUFSLENBQTRCLCtCQUE1QixDQUFOO0FBQ0FqQyxvQkFBTTRCLE1BQU4sQ0FBYUMsS0FBYixDQUFtQmhELFFBQVFpRCx5QkFBUixDQUFrQyxXQUFsQyxDQUFuQixFQUNFLENBQUMsZ0NBQUQsRUFBbUMsK0JBQW5DLENBREY7QUFFQTlCLG9CQUFNNEIsTUFBTixDQUFhQyxLQUFiLENBQW1CaEQsUUFBUTBELCtCQUFSLENBQXdDLFdBQXhDLENBQW5CLEVBQ0UsQ0FBQyxnQ0FBRCxFQUFtQywrQkFBbkMsQ0FERjtBQUVBLFVBQU0xRCxRQUFRdUQsYUFBUixDQUFzQixrQkFBdEIsQ0FBTjtBQUNBcEMsb0JBQU00QixNQUFOLENBQWFDLEtBQWIsQ0FBbUJoRCxRQUFRaUQseUJBQVIsQ0FBa0MsV0FBbEMsQ0FBbkIsRUFDRSxDQUFDLGdDQUFELENBREY7QUFFQTlCLG9CQUFNNEIsTUFBTixDQUFhQyxLQUFiLENBQW1CaEQsUUFBUTBELCtCQUFSLENBQXdDLFdBQXhDLENBQW5CLEVBQ0UsQ0FBQyxnQ0FBRCxDQURGO0FBRUQsR0FkRDtBQWdCRCxDQXBMRCIsImZpbGUiOiJsYXRlbmN5U2VydmljZS5zcGVjLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgc2hvdWxkIGZyb20gJ3Nob3VsZCc7XG5pbXBvcnQgc2lub24gZnJvbSAnc2lub24nO1xuaW1wb3J0IExhdGVuY3lTZXJ2aWNlIGZyb20gJy4vbGF0ZW5jeVNlcnZpY2UnO1xuaW1wb3J0IFNlcnZlciBmcm9tICdzb2NrZXQuaW8nO1xuIFxuLyoqXG4gKiBAdGVzdCB7TGF0ZW5jeVNlcnZpY2V9XG4gKi9cbmRlc2NyaWJlKCdMYXRlbmN5U2VydmljZScsICgpID0+IHtcblxuICBsZXQgaW87XG4gIGxldCBjbG9jaztcbiAgbGV0IHNlcnZpY2U7XG4gIGxldCBzYW5kYm94O1xuICBjb25zdCB0b2tlbiA9ICd0b2tlbic7XG4gIGxldCBjbGllbnQgPSB7XG4gICAgZW5zdXJlU3Vic2NyaWJlOiAoKSA9PiB7fSxcbiAgICB1bnN1YnNjcmliZTogKCkgPT4ge30sXG4gICAgZ2V0VXJsU2V0dGluZ3M6ICgpID0+IHt9LFxuICAgIHVuc3Vic2NyaWJlQWNjb3VudFJlZ2lvbjogKCkgPT4ge30sXG4gICAgZ2V0QWNjb3VudFJlZ2lvbjogKHJlcGxpY2FJZCkgPT4ge1xuICAgICAgaWYocmVwbGljYUlkID09PSAnYWNjb3VudElkUmVwbGljYScpIHtcbiAgICAgICAgcmV0dXJuICduZXcteW9yayc7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gJ3ZpbnQtaGlsbCc7XG4gICAgICB9XG4gICAgfSxcbiAgICBhY2NvdW50UmVwbGljYXM6IHtcbiAgICAgIGFjY291bnRJZDoge1xuICAgICAgICAndmludC1oaWxsJzogJ2FjY291bnRJZCcsXG4gICAgICAgICduZXcteW9yayc6ICdhY2NvdW50SWRSZXBsaWNhJ1xuICAgICAgfVxuICAgIH0sXG4gICAgYWNjb3VudHNCeVJlcGxpY2FJZDoge1xuICAgICAgYWNjb3VudElkOiAnYWNjb3VudElkJyxcbiAgICAgIGFjY291bnRJZFJlcGxpY2E6ICdhY2NvdW50SWQnXG4gICAgfVxuICB9O1xuICBsZXQgdW5zdWJzY3JpYmVTdHViO1xuICBsZXQgZ2V0VXJsU2V0dGluZ3NTdHViO1xuICBsZXQgZW5zdXJlU3Vic2NyaWJlU3R1YjtcbiAgbGV0IHVuc3Vic2NyaWJlUmVnaW9uU3R1YjtcblxuICBiZWZvcmUoKCkgPT4ge1xuICAgIHNhbmRib3ggPSBzaW5vbi5jcmVhdGVTYW5kYm94KCk7XG4gIH0pO1xuIFxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBjbG9jayA9IHNpbm9uLnVzZUZha2VUaW1lcnMoe3Nob3VsZEFkdmFuY2VUaW1lOiB0cnVlfSk7XG4gICAgc2VydmljZSA9IG5ldyBMYXRlbmN5U2VydmljZShjbGllbnQsIHRva2VuLCA1MDAwKTtcblxuICAgIGlvID0gbmV3IFNlcnZlcig2Nzg1LCB7cGF0aDogJy93cycsIHBpbmdUaW1lb3V0OiAxMDAwMDAwfSk7XG4gICAgaW8ub24oJ2Nvbm5lY3QnLCBzb2NrZXQgPT4ge1xuICAgICAgaWYgKHNvY2tldC5yZXF1ZXN0Ll9xdWVyeVsnYXV0aC10b2tlbiddICE9PSAndG9rZW4nKSB7XG4gICAgICAgIHNvY2tldC5lbWl0KHtlcnJvcjogJ1VuYXV0aG9yaXplZEVycm9yJywgbWVzc2FnZTogJ0F1dGhvcml6YXRpb24gdG9rZW4gaW52YWxpZCd9KTtcbiAgICAgICAgc29ja2V0LmNsb3NlKCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgZ2V0VXJsU2V0dGluZ3NTdHViID0gc2FuZGJveC5zdHViKGNsaWVudCwgJ2dldFVybFNldHRpbmdzJylcbiAgICAgIC5yZXNvbHZlcyh7dXJsOiAnaHR0cDovL2xvY2FsaG9zdDo2Nzg1JywgaXNTaGFyZWRDbGllbnRBcGk6IHRydWV9KTtcbiAgICB1bnN1YnNjcmliZVN0dWIgPSBzYW5kYm94LnN0dWIoY2xpZW50LCAndW5zdWJzY3JpYmUnKS5yZXNvbHZlcygpO1xuICAgIGVuc3VyZVN1YnNjcmliZVN0dWIgPSBzYW5kYm94LnN0dWIoY2xpZW50LCAnZW5zdXJlU3Vic2NyaWJlJykucmVzb2x2ZXMoKTtcbiAgICB1bnN1YnNjcmliZVJlZ2lvblN0dWIgPSBzYW5kYm94LnN0dWIoY2xpZW50LCAndW5zdWJzY3JpYmVBY2NvdW50UmVnaW9uJykucmVzb2x2ZXMoKTtcbiAgfSk7XG4gXG4gIGFmdGVyRWFjaChhc3luYyAoKSA9PiB7XG4gICAgY2xvY2sucmVzdG9yZSgpO1xuICAgIHNhbmRib3gucmVzdG9yZSgpO1xuICAgIGxldCByZXNvbHZlO1xuICAgIGxldCBwcm9taXNlID0gbmV3IFByb21pc2UocmVzID0+IHJlc29sdmUgPSByZXMpO1xuICAgIGlvLmNsb3NlKCgpID0+IHJlc29sdmUoKSk7XG4gICAgYXdhaXQgcHJvbWlzZTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtMYXRlbmN5U2VydmljZSNvbkNvbm5lY3RlZH1cbiAgICovXG4gIGl0KCdzaG91bGQgcHJvY2VzcyBvbkNvbm5lY3RlZCBldmVudCcsIGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBzZXJ2aWNlLm9uQ29ubmVjdGVkKCdhY2NvdW50SWQ6dmludC1oaWxsOjA6cHMtbXBhLTEnKTtcbiAgICBzaW5vbi5hc3NlcnQubWF0Y2goc2VydmljZS5nZXRBY3RpdmVBY2NvdW50SW5zdGFuY2VzKCdhY2NvdW50SWQnKSwgWydhY2NvdW50SWQ6dmludC1oaWxsOjA6cHMtbXBhLTEnXSk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7TGF0ZW5jeVNlcnZpY2Ujb25Db25uZWN0ZWR9XG4gICAqL1xuICBpdCgnc2hvdWxkIGRpc2Nvbm5lY3QgY29ubmVjdGVkIGluc3RhbmNlcyB3aXRoIGJpZ2dlciBwaW5nJywgYXN5bmMgKCkgPT4ge1xuICAgIGNsb2NrLnRpY2tBc3luYygzMDAwKTtcbiAgICBhd2FpdCBzZXJ2aWNlLm9uQ29ubmVjdGVkKCdhY2NvdW50SWQ6bmV3LXlvcms6MDpwcy1tcGEtMScpO1xuICAgIGF3YWl0IHNlcnZpY2Uub25Db25uZWN0ZWQoJ2FjY291bnRJZDp2aW50LWhpbGw6MDpwcy1tcGEtMScpO1xuICAgIHNpbm9uLmFzc2VydC5tYXRjaChzZXJ2aWNlLmdldEFjdGl2ZUFjY291bnRJbnN0YW5jZXMoJ2FjY291bnRJZCcpLCBcbiAgICAgIFsnYWNjb3VudElkOm5ldy15b3JrOjA6cHMtbXBhLTEnLCAnYWNjb3VudElkOnZpbnQtaGlsbDowOnBzLW1wYS0xJ10pO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKHVuc3Vic2NyaWJlU3R1YiwgJ2FjY291bnRJZFJlcGxpY2EnKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbGVkV2l0aCh1bnN1YnNjcmliZVJlZ2lvblN0dWIsICdhY2NvdW50SWQnLCAnbmV3LXlvcmsnKTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtMYXRlbmN5U2VydmljZSNvbkRlYWxzU3luY2hyb25pemVkfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCBkaXNjb25uZWN0IHN5bmNocm9uaXplZCBpbnN0YW5jZXMgd2l0aCBiaWdnZXIgcGluZycsIGFzeW5jICgpID0+IHtcbiAgICBjbG9jay50aWNrQXN5bmMoMzAwMCk7XG4gICAgYXdhaXQgc2VydmljZS5vbkNvbm5lY3RlZCgnYWNjb3VudElkOm5ldy15b3JrOjA6cHMtbXBhLTEnKTtcbiAgICBhd2FpdCBzZXJ2aWNlLm9uRGVhbHNTeW5jaHJvbml6ZWQoJ2FjY291bnRJZDpuZXcteW9yazowOnBzLW1wYS0xJyk7XG4gICAgYXdhaXQgc2VydmljZS5vbkNvbm5lY3RlZCgnYWNjb3VudElkOnZpbnQtaGlsbDowOnBzLW1wYS0xJyk7XG4gICAgc2lub24uYXNzZXJ0Lm1hdGNoKHNlcnZpY2UuZ2V0QWN0aXZlQWNjb3VudEluc3RhbmNlcygnYWNjb3VudElkJyksIFxuICAgICAgWydhY2NvdW50SWQ6bmV3LXlvcms6MDpwcy1tcGEtMScsICdhY2NvdW50SWQ6dmludC1oaWxsOjA6cHMtbXBhLTEnXSk7XG4gICAgc2lub24uYXNzZXJ0Lm5vdENhbGxlZCh1bnN1YnNjcmliZVN0dWIpO1xuICAgIGF3YWl0IHNlcnZpY2Uub25EZWFsc1N5bmNocm9uaXplZCgnYWNjb3VudElkOnZpbnQtaGlsbDowOnBzLW1wYS0xJyk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZFdpdGgodW5zdWJzY3JpYmVTdHViLCAnYWNjb3VudElkUmVwbGljYScpO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKHVuc3Vic2NyaWJlUmVnaW9uU3R1YiwgJ2FjY291bnRJZCcsICduZXcteW9yaycpO1xuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge0xhdGVuY3lTZXJ2aWNlI29uQ29ubmVjdGVkfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCBub3QgZG91YmxlIGNoZWNrIHBpbmcgaWYgdHdvIGFjY291bnRzIGNvbm5lY3RlZCBhdCB0aGUgc2FtZSB0aW1lJywgYXN5bmMgKCkgPT4ge1xuICAgIHNlcnZpY2Uub25Db25uZWN0ZWQoJ2FjY291bnRJZDpuZXcteW9yazowOnBzLW1wYS0xJyk7XG4gICAgYXdhaXQgc2VydmljZS5vbkNvbm5lY3RlZCgnYWNjb3VudElkMjpuZXcteW9yazowOnBzLW1wYS0xJyk7XG4gICAgc2lub24uYXNzZXJ0Lm1hdGNoKHNlcnZpY2UuZ2V0QWN0aXZlQWNjb3VudEluc3RhbmNlcygnYWNjb3VudElkJyksIFxuICAgICAgWydhY2NvdW50SWQ6bmV3LXlvcms6MDpwcy1tcGEtMSddKTtcbiAgICBzaW5vbi5hc3NlcnQubWF0Y2goc2VydmljZS5nZXRBY3RpdmVBY2NvdW50SW5zdGFuY2VzKCdhY2NvdW50SWQyJyksIFxuICAgICAgWydhY2NvdW50SWQyOm5ldy15b3JrOjA6cHMtbXBhLTEnXSk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZE9uY2UoZ2V0VXJsU2V0dGluZ3NTdHViKTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtMYXRlbmN5U2VydmljZSNfcmVmcmVzaFJlZ2lvbkxhdGVuY3lKb2J9XG4gICAqL1xuICBpdCgnc2hvdWxkIGRlcGxveSB0byBhIGJldHRlciBwaW5nIGlmIHBpbmcgc3RhdHMgY2hhbmdlZCBvbiByZWZyZXNoJywgYXN5bmMgKCkgPT4ge1xuICAgIGNsb2NrLnRpY2tBc3luYygzMDAwKTtcbiAgICBhd2FpdCBzZXJ2aWNlLm9uQ29ubmVjdGVkKCdhY2NvdW50SWQ6dmludC1oaWxsOjA6cHMtbXBhLTEnKTtcbiAgICBhd2FpdCBzZXJ2aWNlLm9uRGVhbHNTeW5jaHJvbml6ZWQoJ2FjY291bnRJZDp2aW50LWhpbGw6MDpwcy1tcGEtMScpO1xuICAgIGF3YWl0IHNlcnZpY2Uub25Db25uZWN0ZWQoJ2FjY291bnRJZDpuZXcteW9yazowOnBzLW1wYS0xJyk7XG4gICAgYXdhaXQgc2VydmljZS5vbkRlYWxzU3luY2hyb25pemVkKCdhY2NvdW50SWQ6bmV3LXlvcms6MDpwcy1tcGEtMScpO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKHVuc3Vic2NyaWJlU3R1YiwgJ2FjY291bnRJZCcpO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKHVuc3Vic2NyaWJlUmVnaW9uU3R1YiwgJ2FjY291bnRJZCcsICd2aW50LWhpbGwnKTtcbiAgICBhd2FpdCBzZXJ2aWNlLm9uVW5zdWJzY3JpYmUoJ2FjY291bnRJZCcpO1xuICAgIGF3YWl0IGNsb2NrLnRpY2tBc3luYygxNSAqIDYwICogMTAwMCAtIDI5MDApO1xuICAgIGF3YWl0IHNlcnZpY2UuX3JlZnJlc2hQcm9taXNlc0J5UmVnaW9uWyd2aW50LWhpbGwnXTtcbiAgICBhd2FpdCBjbG9jay50aWNrQXN5bmMoMTAwMCk7XG4gICAgYXdhaXQgbmV3IFByb21pc2UocmVzID0+IHNldFRpbWVvdXQocmVzLCA1MCkpO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKGVuc3VyZVN1YnNjcmliZVN0dWIsICdhY2NvdW50SWQnLCAwKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbGVkV2l0aChlbnN1cmVTdWJzY3JpYmVTdHViLCAnYWNjb3VudElkJywgMSk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7TGF0ZW5jeVNlcnZpY2Ujb25EaXNjb25uZWN0ZWR9XG4gICAqL1xuICBpdCgnc2hvdWxkIHN1YnNjcmliZSByZXBsaWNhcyBvbiBkaXNjb25uZWN0ZWQgZXZlbnQgaWYgYWxsIHJlcGxpY2FzIG9mZmxpbmUnLCBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgc2VydmljZS5vbkNvbm5lY3RlZCgnYWNjb3VudElkOnZpbnQtaGlsbDowOnBzLW1wYS0xJyk7XG4gICAgYXdhaXQgc2VydmljZS5vbkRlYWxzU3luY2hyb25pemVkKCdhY2NvdW50SWQ6dmludC1oaWxsOjA6cHMtbXBhLTEnKTtcbiAgICBhd2FpdCBzZXJ2aWNlLm9uQ29ubmVjdGVkKCdhY2NvdW50SWQ6bmV3LXlvcms6MDpwcy1tcGEtMScpO1xuICAgIGF3YWl0IHNlcnZpY2Uub25EZWFsc1N5bmNocm9uaXplZCgnYWNjb3VudElkOm5ldy15b3JrOjA6cHMtbXBhLTEnKTtcbiAgICBzaW5vbi5hc3NlcnQubWF0Y2goc2VydmljZS5nZXRBY3RpdmVBY2NvdW50SW5zdGFuY2VzKCdhY2NvdW50SWQnKSwgXG4gICAgICBbJ2FjY291bnRJZDp2aW50LWhpbGw6MDpwcy1tcGEtMScsICdhY2NvdW50SWQ6bmV3LXlvcms6MDpwcy1tcGEtMSddKTtcbiAgICBzaW5vbi5hc3NlcnQubWF0Y2goc2VydmljZS5nZXRTeW5jaHJvbml6ZWRBY2NvdW50SW5zdGFuY2VzKCdhY2NvdW50SWQnKSwgXG4gICAgICBbJ2FjY291bnRJZDp2aW50LWhpbGw6MDpwcy1tcGEtMScsICdhY2NvdW50SWQ6bmV3LXlvcms6MDpwcy1tcGEtMSddKTtcbiAgICBhd2FpdCBzZXJ2aWNlLm9uRGlzY29ubmVjdGVkKCdhY2NvdW50SWQ6bmV3LXlvcms6MDpwcy1tcGEtMScpO1xuICAgIHNpbm9uLmFzc2VydC5tYXRjaChzZXJ2aWNlLmdldEFjdGl2ZUFjY291bnRJbnN0YW5jZXMoJ2FjY291bnRJZCcpLCBcbiAgICAgIFsnYWNjb3VudElkOnZpbnQtaGlsbDowOnBzLW1wYS0xJ10pO1xuICAgIHNpbm9uLmFzc2VydC5tYXRjaChzZXJ2aWNlLmdldFN5bmNocm9uaXplZEFjY291bnRJbnN0YW5jZXMoJ2FjY291bnRJZCcpLCBcbiAgICAgIFsnYWNjb3VudElkOnZpbnQtaGlsbDowOnBzLW1wYS0xJ10pO1xuICAgIHNpbm9uLmFzc2VydC5ub3RDYWxsZWQoZW5zdXJlU3Vic2NyaWJlU3R1Yik7XG4gICAgYXdhaXQgc2VydmljZS5vbkRpc2Nvbm5lY3RlZCgnYWNjb3VudElkOnZpbnQtaGlsbDowOnBzLW1wYS0xJyk7XG4gICAgc2lub24uYXNzZXJ0Lm1hdGNoKHNlcnZpY2UuZ2V0QWN0aXZlQWNjb3VudEluc3RhbmNlcygnYWNjb3VudElkJyksIFtdKTtcbiAgICBzaW5vbi5hc3NlcnQubWF0Y2goc2VydmljZS5nZXRTeW5jaHJvbml6ZWRBY2NvdW50SW5zdGFuY2VzKCdhY2NvdW50SWQnKSwgW10pO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKGVuc3VyZVN1YnNjcmliZVN0dWIsICdhY2NvdW50SWRSZXBsaWNhJywgMCk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZFdpdGgoZW5zdXJlU3Vic2NyaWJlU3R1YiwgJ2FjY291bnRJZFJlcGxpY2EnLCAxKTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtMYXRlbmN5U2VydmljZSNvblVuc3Vic2NyaWJlfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCBtYXJrIGFjY291bnRzIGFzIGRpc2Nvbm5lY3RlZCBvbiB1bnN1YnNjcmliZScsIGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBzZXJ2aWNlLm9uQ29ubmVjdGVkKCdhY2NvdW50SWQ6dmludC1oaWxsOjA6cHMtbXBhLTEnKTtcbiAgICBhd2FpdCBzZXJ2aWNlLm9uRGVhbHNTeW5jaHJvbml6ZWQoJ2FjY291bnRJZDp2aW50LWhpbGw6MDpwcy1tcGEtMScpO1xuICAgIGF3YWl0IHNlcnZpY2Uub25Db25uZWN0ZWQoJ2FjY291bnRJZDpuZXcteW9yazowOnBzLW1wYS0xJyk7XG4gICAgYXdhaXQgc2VydmljZS5vbkRlYWxzU3luY2hyb25pemVkKCdhY2NvdW50SWQ6bmV3LXlvcms6MDpwcy1tcGEtMScpO1xuICAgIHNpbm9uLmFzc2VydC5tYXRjaChzZXJ2aWNlLmdldEFjdGl2ZUFjY291bnRJbnN0YW5jZXMoJ2FjY291bnRJZCcpLCBcbiAgICAgIFsnYWNjb3VudElkOnZpbnQtaGlsbDowOnBzLW1wYS0xJywgJ2FjY291bnRJZDpuZXcteW9yazowOnBzLW1wYS0xJ10pO1xuICAgIHNpbm9uLmFzc2VydC5tYXRjaChzZXJ2aWNlLmdldFN5bmNocm9uaXplZEFjY291bnRJbnN0YW5jZXMoJ2FjY291bnRJZCcpLCBcbiAgICAgIFsnYWNjb3VudElkOnZpbnQtaGlsbDowOnBzLW1wYS0xJywgJ2FjY291bnRJZDpuZXcteW9yazowOnBzLW1wYS0xJ10pO1xuICAgIGF3YWl0IHNlcnZpY2Uub25VbnN1YnNjcmliZSgnYWNjb3VudElkUmVwbGljYScpO1xuICAgIHNpbm9uLmFzc2VydC5tYXRjaChzZXJ2aWNlLmdldEFjdGl2ZUFjY291bnRJbnN0YW5jZXMoJ2FjY291bnRJZCcpLCBcbiAgICAgIFsnYWNjb3VudElkOnZpbnQtaGlsbDowOnBzLW1wYS0xJ10pO1xuICAgIHNpbm9uLmFzc2VydC5tYXRjaChzZXJ2aWNlLmdldFN5bmNocm9uaXplZEFjY291bnRJbnN0YW5jZXMoJ2FjY291bnRJZCcpLCBcbiAgICAgIFsnYWNjb3VudElkOnZpbnQtaGlsbDowOnBzLW1wYS0xJ10pO1xuICB9KTtcblxufSk7XG4iXX0=