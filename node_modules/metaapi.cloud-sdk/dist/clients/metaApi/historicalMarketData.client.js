'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _metaApi = require('../metaApi.client');

var _metaApi2 = _interopRequireDefault(_metaApi);

var _errorHandler = require('../errorHandler');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * metaapi.cloud historical market data API client
 */
class HistoricalMarketDataClient extends _metaApi2.default {

  /**
   * Constructs historical market data API client instance
   * @param {HttpClient} httpClient HTTP client
   * @param {DomainClient} domainClient domain client
   */
  constructor(httpClient, domainClient) {
    super(httpClient, domainClient);
    this._host = 'https://mt-market-data-client-api-v1';
  }

  /**
   * Returns historical candles for a specific symbol and timeframe from a MetaTrader account.
   * See https://metaapi.cloud/docs/client/restApi/api/retrieveMarketData/readHistoricalCandles/
   * @param {string} accountId MetaTrader account id
   * @param {string} region account region
   * @param {string} symbol symbol to retrieve candles for (e.g. a currency pair or an index)
   * @param {string} timeframe defines the timeframe according to which the candles must be generated. Allowed values
   * for MT5 are 1m, 2m, 3m, 4m, 5m, 6m, 10m, 12m, 15m, 20m, 30m, 1h, 2h, 3h, 4h, 6h, 8h, 12h, 1d, 1w, 1mn. Allowed
   * values for MT4 are 1m, 5m, 15m 30m, 1h, 4h, 1d, 1w, 1mn
   * @param {Date} [startTime] time to start loading candles from. Note that candles are loaded in backwards direction, so
   * this should be the latest time. Leave empty to request latest candles.
   * @param {number} [limit] maximum number of candles to retrieve. Must be less or equal to 1000
   * @return {Promise<Array<MetatraderCandle>>} promise resolving with historical candles downloaded
   */
  async getHistoricalCandles(accountId, region, symbol, timeframe, startTime, limit) {
    symbol = encodeURIComponent(symbol);
    const host = await this._domainClient.getUrl(this._host, region);
    const opts = {
      url: `${host}/users/current/accounts/${accountId}/historical-market-data/symbols/${symbol}/` + `timeframes/${timeframe}/candles`,
      method: 'GET',
      qs: {
        startTime,
        limit
      },
      headers: {
        'auth-token': this._token
      },
      json: true
    };
    let candles = await this._httpClient.request(opts, 'getHistoricalCandles');
    candles = candles || [];
    candles.forEach(c => c.time = new Date(c.time));
    return candles;
  }

  /**
   * Returns historical ticks for a specific symbol from a MetaTrader account. This API is not supported by MT4
   * accounts.
   * See https://metaapi.cloud/docs/client/restApi/api/retrieveMarketData/readHistoricalTicks/
   * @param {string} accountId MetaTrader account id
   * @param {string} region account region
   * @param {string} symbol symbol to retrieve ticks for (e.g. a currency pair or an index)
   * @param {Date} [startTime] time to start loading ticks from. Note that candles are loaded in forward direction, so
   * this should be the earliest time. Leave empty to request latest candles.
   * @param {number} [offset] number of ticks to skip (you can use it to avoid requesting ticks from previous request
   * twice)
   * @param {number} [limit] maximum number of ticks to retrieve. Must be less or equal to 1000
   * @return {Promise<Array<MetatraderTick>>} promise resolving with historical ticks downloaded
   */
  async getHistoricalTicks(accountId, region, symbol, startTime, offset, limit) {
    symbol = encodeURIComponent(symbol);
    const host = await this._domainClient.getUrl(this._host, region);
    const opts = {
      url: `${host}/users/current/accounts/${accountId}/historical-market-data/symbols/${symbol}/ticks`,
      method: 'GET',
      qs: {
        startTime,
        offset,
        limit
      },
      headers: {
        'auth-token': this._token
      },
      json: true
    };
    let ticks = await this._httpClient.request(opts, 'getHistoricalTicks');
    ticks = ticks || [];
    ticks.forEach(t => t.time = new Date(t.time));
    return ticks;
  }

}
exports.default = HistoricalMarketDataClient;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9jbGllbnRzL21ldGFBcGkvaGlzdG9yaWNhbE1hcmtldERhdGEuY2xpZW50LmVzNiJdLCJuYW1lcyI6WyJIaXN0b3JpY2FsTWFya2V0RGF0YUNsaWVudCIsIk1ldGFBcGlDbGllbnQiLCJjb25zdHJ1Y3RvciIsImh0dHBDbGllbnQiLCJkb21haW5DbGllbnQiLCJfaG9zdCIsImdldEhpc3RvcmljYWxDYW5kbGVzIiwiYWNjb3VudElkIiwicmVnaW9uIiwic3ltYm9sIiwidGltZWZyYW1lIiwic3RhcnRUaW1lIiwibGltaXQiLCJlbmNvZGVVUklDb21wb25lbnQiLCJob3N0IiwiX2RvbWFpbkNsaWVudCIsImdldFVybCIsIm9wdHMiLCJ1cmwiLCJtZXRob2QiLCJxcyIsImhlYWRlcnMiLCJfdG9rZW4iLCJqc29uIiwiY2FuZGxlcyIsIl9odHRwQ2xpZW50IiwicmVxdWVzdCIsImZvckVhY2giLCJjIiwidGltZSIsIkRhdGUiLCJnZXRIaXN0b3JpY2FsVGlja3MiLCJvZmZzZXQiLCJ0aWNrcyIsInQiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7QUFFQTs7OztBQUNBOzs7O0FBRUE7OztBQUdlLE1BQU1BLDBCQUFOLFNBQXlDQyxpQkFBekMsQ0FBdUQ7O0FBRXBFOzs7OztBQUtBQyxjQUFZQyxVQUFaLEVBQXdCQyxZQUF4QixFQUFzQztBQUNwQyxVQUFNRCxVQUFOLEVBQWtCQyxZQUFsQjtBQUNBLFNBQUtDLEtBQUwsR0FBYSxzQ0FBYjtBQUNEOztBQUVEOzs7Ozs7Ozs7Ozs7OztBQWNBLFFBQU1DLG9CQUFOLENBQTJCQyxTQUEzQixFQUFzQ0MsTUFBdEMsRUFBOENDLE1BQTlDLEVBQXNEQyxTQUF0RCxFQUFpRUMsU0FBakUsRUFBNEVDLEtBQTVFLEVBQW1GO0FBQ2pGSCxhQUFTSSxtQkFBbUJKLE1BQW5CLENBQVQ7QUFDQSxVQUFNSyxPQUFPLE1BQU0sS0FBS0MsYUFBTCxDQUFtQkMsTUFBbkIsQ0FBMEIsS0FBS1gsS0FBL0IsRUFBc0NHLE1BQXRDLENBQW5CO0FBQ0EsVUFBTVMsT0FBTztBQUNYQyxXQUFNLEdBQUVKLElBQUssMkJBQTBCUCxTQUFVLG1DQUFrQ0UsTUFBTyxHQUFyRixHQUNGLGNBQWFDLFNBQVUsVUFGZjtBQUdYUyxjQUFRLEtBSEc7QUFJWEMsVUFBSTtBQUNGVCxpQkFERTtBQUVGQztBQUZFLE9BSk87QUFRWFMsZUFBUztBQUNQLHNCQUFjLEtBQUtDO0FBRFosT0FSRTtBQVdYQyxZQUFNO0FBWEssS0FBYjtBQWFBLFFBQUlDLFVBQVUsTUFBTSxLQUFLQyxXQUFMLENBQWlCQyxPQUFqQixDQUF5QlQsSUFBekIsRUFBK0Isc0JBQS9CLENBQXBCO0FBQ0FPLGNBQVVBLFdBQVcsRUFBckI7QUFDQUEsWUFBUUcsT0FBUixDQUFnQkMsS0FBS0EsRUFBRUMsSUFBRixHQUFTLElBQUlDLElBQUosQ0FBU0YsRUFBRUMsSUFBWCxDQUE5QjtBQUNBLFdBQU9MLE9BQVA7QUFDRDs7QUFFRDs7Ozs7Ozs7Ozs7Ozs7QUFjQSxRQUFNTyxrQkFBTixDQUF5QnhCLFNBQXpCLEVBQW9DQyxNQUFwQyxFQUE0Q0MsTUFBNUMsRUFBb0RFLFNBQXBELEVBQStEcUIsTUFBL0QsRUFBdUVwQixLQUF2RSxFQUE4RTtBQUM1RUgsYUFBU0ksbUJBQW1CSixNQUFuQixDQUFUO0FBQ0EsVUFBTUssT0FBTyxNQUFNLEtBQUtDLGFBQUwsQ0FBbUJDLE1BQW5CLENBQTBCLEtBQUtYLEtBQS9CLEVBQXNDRyxNQUF0QyxDQUFuQjtBQUNBLFVBQU1TLE9BQU87QUFDWEMsV0FBTSxHQUFFSixJQUFLLDJCQUEwQlAsU0FBVSxtQ0FBa0NFLE1BQU8sUUFEL0U7QUFFWFUsY0FBUSxLQUZHO0FBR1hDLFVBQUk7QUFDRlQsaUJBREU7QUFFRnFCLGNBRkU7QUFHRnBCO0FBSEUsT0FITztBQVFYUyxlQUFTO0FBQ1Asc0JBQWMsS0FBS0M7QUFEWixPQVJFO0FBV1hDLFlBQU07QUFYSyxLQUFiO0FBYUEsUUFBSVUsUUFBUSxNQUFNLEtBQUtSLFdBQUwsQ0FBaUJDLE9BQWpCLENBQXlCVCxJQUF6QixFQUErQixvQkFBL0IsQ0FBbEI7QUFDQWdCLFlBQVFBLFNBQVMsRUFBakI7QUFDQUEsVUFBTU4sT0FBTixDQUFjTyxLQUFLQSxFQUFFTCxJQUFGLEdBQVMsSUFBSUMsSUFBSixDQUFTSSxFQUFFTCxJQUFYLENBQTVCO0FBQ0EsV0FBT0ksS0FBUDtBQUNEOztBQWxGbUU7a0JBQWpEakMsMEIiLCJmaWxlIjoiaGlzdG9yaWNhbE1hcmtldERhdGEuY2xpZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgTWV0YUFwaUNsaWVudCBmcm9tICcuLi9tZXRhQXBpLmNsaWVudCc7XG5pbXBvcnQge05vdEZvdW5kRXJyb3J9IGZyb20gJy4uL2Vycm9ySGFuZGxlcic7XG5cbi8qKlxuICogbWV0YWFwaS5jbG91ZCBoaXN0b3JpY2FsIG1hcmtldCBkYXRhIEFQSSBjbGllbnRcbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSGlzdG9yaWNhbE1hcmtldERhdGFDbGllbnQgZXh0ZW5kcyBNZXRhQXBpQ2xpZW50IHtcblxuICAvKipcbiAgICogQ29uc3RydWN0cyBoaXN0b3JpY2FsIG1hcmtldCBkYXRhIEFQSSBjbGllbnQgaW5zdGFuY2VcbiAgICogQHBhcmFtIHtIdHRwQ2xpZW50fSBodHRwQ2xpZW50IEhUVFAgY2xpZW50XG4gICAqIEBwYXJhbSB7RG9tYWluQ2xpZW50fSBkb21haW5DbGllbnQgZG9tYWluIGNsaWVudFxuICAgKi9cbiAgY29uc3RydWN0b3IoaHR0cENsaWVudCwgZG9tYWluQ2xpZW50KSB7XG4gICAgc3VwZXIoaHR0cENsaWVudCwgZG9tYWluQ2xpZW50KTtcbiAgICB0aGlzLl9ob3N0ID0gJ2h0dHBzOi8vbXQtbWFya2V0LWRhdGEtY2xpZW50LWFwaS12MSc7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBoaXN0b3JpY2FsIGNhbmRsZXMgZm9yIGEgc3BlY2lmaWMgc3ltYm9sIGFuZCB0aW1lZnJhbWUgZnJvbSBhIE1ldGFUcmFkZXIgYWNjb3VudC5cbiAgICogU2VlIGh0dHBzOi8vbWV0YWFwaS5jbG91ZC9kb2NzL2NsaWVudC9yZXN0QXBpL2FwaS9yZXRyaWV2ZU1hcmtldERhdGEvcmVhZEhpc3RvcmljYWxDYW5kbGVzL1xuICAgKiBAcGFyYW0ge3N0cmluZ30gYWNjb3VudElkIE1ldGFUcmFkZXIgYWNjb3VudCBpZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gcmVnaW9uIGFjY291bnQgcmVnaW9uXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzeW1ib2wgc3ltYm9sIHRvIHJldHJpZXZlIGNhbmRsZXMgZm9yIChlLmcuIGEgY3VycmVuY3kgcGFpciBvciBhbiBpbmRleClcbiAgICogQHBhcmFtIHtzdHJpbmd9IHRpbWVmcmFtZSBkZWZpbmVzIHRoZSB0aW1lZnJhbWUgYWNjb3JkaW5nIHRvIHdoaWNoIHRoZSBjYW5kbGVzIG11c3QgYmUgZ2VuZXJhdGVkLiBBbGxvd2VkIHZhbHVlc1xuICAgKiBmb3IgTVQ1IGFyZSAxbSwgMm0sIDNtLCA0bSwgNW0sIDZtLCAxMG0sIDEybSwgMTVtLCAyMG0sIDMwbSwgMWgsIDJoLCAzaCwgNGgsIDZoLCA4aCwgMTJoLCAxZCwgMXcsIDFtbi4gQWxsb3dlZFxuICAgKiB2YWx1ZXMgZm9yIE1UNCBhcmUgMW0sIDVtLCAxNW0gMzBtLCAxaCwgNGgsIDFkLCAxdywgMW1uXG4gICAqIEBwYXJhbSB7RGF0ZX0gW3N0YXJ0VGltZV0gdGltZSB0byBzdGFydCBsb2FkaW5nIGNhbmRsZXMgZnJvbS4gTm90ZSB0aGF0IGNhbmRsZXMgYXJlIGxvYWRlZCBpbiBiYWNrd2FyZHMgZGlyZWN0aW9uLCBzb1xuICAgKiB0aGlzIHNob3VsZCBiZSB0aGUgbGF0ZXN0IHRpbWUuIExlYXZlIGVtcHR5IHRvIHJlcXVlc3QgbGF0ZXN0IGNhbmRsZXMuXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBbbGltaXRdIG1heGltdW0gbnVtYmVyIG9mIGNhbmRsZXMgdG8gcmV0cmlldmUuIE11c3QgYmUgbGVzcyBvciBlcXVhbCB0byAxMDAwXG4gICAqIEByZXR1cm4ge1Byb21pc2U8QXJyYXk8TWV0YXRyYWRlckNhbmRsZT4+fSBwcm9taXNlIHJlc29sdmluZyB3aXRoIGhpc3RvcmljYWwgY2FuZGxlcyBkb3dubG9hZGVkXG4gICAqL1xuICBhc3luYyBnZXRIaXN0b3JpY2FsQ2FuZGxlcyhhY2NvdW50SWQsIHJlZ2lvbiwgc3ltYm9sLCB0aW1lZnJhbWUsIHN0YXJ0VGltZSwgbGltaXQpIHtcbiAgICBzeW1ib2wgPSBlbmNvZGVVUklDb21wb25lbnQoc3ltYm9sKTtcbiAgICBjb25zdCBob3N0ID0gYXdhaXQgdGhpcy5fZG9tYWluQ2xpZW50LmdldFVybCh0aGlzLl9ob3N0LCByZWdpb24pO1xuICAgIGNvbnN0IG9wdHMgPSB7XG4gICAgICB1cmw6IGAke2hvc3R9L3VzZXJzL2N1cnJlbnQvYWNjb3VudHMvJHthY2NvdW50SWR9L2hpc3RvcmljYWwtbWFya2V0LWRhdGEvc3ltYm9scy8ke3N5bWJvbH0vYCArXG4gICAgICAgIGB0aW1lZnJhbWVzLyR7dGltZWZyYW1lfS9jYW5kbGVzYCxcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICBxczoge1xuICAgICAgICBzdGFydFRpbWUsXG4gICAgICAgIGxpbWl0XG4gICAgICB9LFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnYXV0aC10b2tlbic6IHRoaXMuX3Rva2VuXG4gICAgICB9LFxuICAgICAganNvbjogdHJ1ZVxuICAgIH07XG4gICAgbGV0IGNhbmRsZXMgPSBhd2FpdCB0aGlzLl9odHRwQ2xpZW50LnJlcXVlc3Qob3B0cywgJ2dldEhpc3RvcmljYWxDYW5kbGVzJyk7XG4gICAgY2FuZGxlcyA9IGNhbmRsZXMgfHwgW107XG4gICAgY2FuZGxlcy5mb3JFYWNoKGMgPT4gYy50aW1lID0gbmV3IERhdGUoYy50aW1lKSk7XG4gICAgcmV0dXJuIGNhbmRsZXM7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBoaXN0b3JpY2FsIHRpY2tzIGZvciBhIHNwZWNpZmljIHN5bWJvbCBmcm9tIGEgTWV0YVRyYWRlciBhY2NvdW50LiBUaGlzIEFQSSBpcyBub3Qgc3VwcG9ydGVkIGJ5IE1UNFxuICAgKiBhY2NvdW50cy5cbiAgICogU2VlIGh0dHBzOi8vbWV0YWFwaS5jbG91ZC9kb2NzL2NsaWVudC9yZXN0QXBpL2FwaS9yZXRyaWV2ZU1hcmtldERhdGEvcmVhZEhpc3RvcmljYWxUaWNrcy9cbiAgICogQHBhcmFtIHtzdHJpbmd9IGFjY291bnRJZCBNZXRhVHJhZGVyIGFjY291bnQgaWRcbiAgICogQHBhcmFtIHtzdHJpbmd9IHJlZ2lvbiBhY2NvdW50IHJlZ2lvblxuICAgKiBAcGFyYW0ge3N0cmluZ30gc3ltYm9sIHN5bWJvbCB0byByZXRyaWV2ZSB0aWNrcyBmb3IgKGUuZy4gYSBjdXJyZW5jeSBwYWlyIG9yIGFuIGluZGV4KVxuICAgKiBAcGFyYW0ge0RhdGV9IFtzdGFydFRpbWVdIHRpbWUgdG8gc3RhcnQgbG9hZGluZyB0aWNrcyBmcm9tLiBOb3RlIHRoYXQgY2FuZGxlcyBhcmUgbG9hZGVkIGluIGZvcndhcmQgZGlyZWN0aW9uLCBzb1xuICAgKiB0aGlzIHNob3VsZCBiZSB0aGUgZWFybGllc3QgdGltZS4gTGVhdmUgZW1wdHkgdG8gcmVxdWVzdCBsYXRlc3QgY2FuZGxlcy5cbiAgICogQHBhcmFtIHtudW1iZXJ9IFtvZmZzZXRdIG51bWJlciBvZiB0aWNrcyB0byBza2lwICh5b3UgY2FuIHVzZSBpdCB0byBhdm9pZCByZXF1ZXN0aW5nIHRpY2tzIGZyb20gcHJldmlvdXMgcmVxdWVzdFxuICAgKiB0d2ljZSlcbiAgICogQHBhcmFtIHtudW1iZXJ9IFtsaW1pdF0gbWF4aW11bSBudW1iZXIgb2YgdGlja3MgdG8gcmV0cmlldmUuIE11c3QgYmUgbGVzcyBvciBlcXVhbCB0byAxMDAwXG4gICAqIEByZXR1cm4ge1Byb21pc2U8QXJyYXk8TWV0YXRyYWRlclRpY2s+Pn0gcHJvbWlzZSByZXNvbHZpbmcgd2l0aCBoaXN0b3JpY2FsIHRpY2tzIGRvd25sb2FkZWRcbiAgICovXG4gIGFzeW5jIGdldEhpc3RvcmljYWxUaWNrcyhhY2NvdW50SWQsIHJlZ2lvbiwgc3ltYm9sLCBzdGFydFRpbWUsIG9mZnNldCwgbGltaXQpIHtcbiAgICBzeW1ib2wgPSBlbmNvZGVVUklDb21wb25lbnQoc3ltYm9sKTtcbiAgICBjb25zdCBob3N0ID0gYXdhaXQgdGhpcy5fZG9tYWluQ2xpZW50LmdldFVybCh0aGlzLl9ob3N0LCByZWdpb24pO1xuICAgIGNvbnN0IG9wdHMgPSB7XG4gICAgICB1cmw6IGAke2hvc3R9L3VzZXJzL2N1cnJlbnQvYWNjb3VudHMvJHthY2NvdW50SWR9L2hpc3RvcmljYWwtbWFya2V0LWRhdGEvc3ltYm9scy8ke3N5bWJvbH0vdGlja3NgLFxuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIHFzOiB7XG4gICAgICAgIHN0YXJ0VGltZSxcbiAgICAgICAgb2Zmc2V0LFxuICAgICAgICBsaW1pdFxuICAgICAgfSxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ2F1dGgtdG9rZW4nOiB0aGlzLl90b2tlblxuICAgICAgfSxcbiAgICAgIGpzb246IHRydWVcbiAgICB9O1xuICAgIGxldCB0aWNrcyA9IGF3YWl0IHRoaXMuX2h0dHBDbGllbnQucmVxdWVzdChvcHRzLCAnZ2V0SGlzdG9yaWNhbFRpY2tzJyk7XG4gICAgdGlja3MgPSB0aWNrcyB8fCBbXTtcbiAgICB0aWNrcy5mb3JFYWNoKHQgPT4gdC50aW1lID0gbmV3IERhdGUodC50aW1lKSk7XG4gICAgcmV0dXJuIHRpY2tzO1xuICB9XG5cbn1cbiJdfQ==