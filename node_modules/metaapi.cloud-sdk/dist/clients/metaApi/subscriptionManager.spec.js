'use strict';

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _create = require('babel-runtime/core-js/object/create');

var _create2 = _interopRequireDefault(_create);

var _subscriptionManager = require('./subscriptionManager');

var _subscriptionManager2 = _interopRequireDefault(_subscriptionManager);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _timeoutError = require('../timeoutError');

var _timeoutError2 = _interopRequireDefault(_timeoutError);

var _errorHandler = require('../errorHandler');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @test {SubscriptionManager}
 */
describe('SubscriptionManager', () => {
  let sandbox;
  let clock;
  let manager;
  let client;

  before(() => {
    sandbox = _sinon2.default.createSandbox();
    const mockMath = (0, _create2.default)(global.Math);
    mockMath.random = () => 0.2;
    global.Math = mockMath;
  });

  beforeEach(async () => {
    const socketInstances = { 'vint-hill': { 0: [{ socket: { connected: true } }, { socket: { connected: false } }] } };
    client = {
      connect: () => {},
      connected: (instanceNumber, socketInstanceIndex) => socketInstances['vint-hill'][instanceNumber][socketInstanceIndex].socket.connected,
      socketInstances: socketInstances,
      getAccountRegion: () => 'vint-hill',
      socketInstancesByAccounts: { 0: { accountId: 0 } },
      rpcRequest: () => {}
    };
    clock = _sinon2.default.useFakeTimers({ shouldAdvanceTime: true });
    manager = new _subscriptionManager2.default(client);
  });

  afterEach(async () => {
    sandbox.restore();
    clock.restore();
  });

  /**
   * @test {SubscriptionManager#scheduleSubscribe}
   */
  it('should subscribe to terminal', async () => {
    sandbox.stub(client, 'rpcRequest').resolves();
    setTimeout(() => {
      manager.cancelSubscribe('accountId:0');
    }, 50);
    await manager.scheduleSubscribe('accountId', 0);
    _sinon2.default.assert.calledWith(client.rpcRequest, 'accountId', { type: 'subscribe', instanceIndex: 0 });
  });

  /**
   * @test {SubscriptionManager#scheduleSubscribe}
   */
  it('should retry subscribe if no response received', async () => {
    const response = { type: 'response', accountId: 'accountId', requestId: 'requestId' };
    sandbox.stub(client, 'rpcRequest').onFirstCall().resolves(new _timeoutError2.default('timeout')).onSecondCall().resolves(response).onThirdCall().resolves(response);
    setTimeout(() => {
      manager.cancelSubscribe('accountId:0');
    }, 3600);
    manager.scheduleSubscribe('accountId', 0);
    await clock.tickAsync(10000);
    _sinon2.default.assert.calledTwice(client.rpcRequest);
    _sinon2.default.assert.calledWith(client.rpcRequest, 'accountId', { type: 'subscribe', instanceIndex: 0 });
  });

  /**
   * @test {SubscriptionManager#scheduleSubscribe}
   */
  it('should wait for recommended time if too many requests error received', async () => {
    const response = { type: 'response', accountId: 'accountId', requestId: 'requestId' };
    sandbox.stub(client, 'rpcRequest').onFirstCall().rejects(new _errorHandler.TooManyRequestsError('timeout', {
      periodInMinutes: 60, maxRequestsForPeriod: 10000,
      type: 'LIMIT_REQUEST_RATE_PER_USER',
      recommendedRetryTime: new Date(Date.now() + 5000) })).onSecondCall().resolves(response).onThirdCall().resolves(response);
    manager.scheduleSubscribe('accountId', 0);
    await clock.tickAsync(3600);
    _sinon2.default.assert.callCount(client.rpcRequest, 1);
    await clock.tickAsync(2000);
    manager.cancelSubscribe('accountId:0');
    _sinon2.default.assert.callCount(client.rpcRequest, 2);
  });

  /**
   * @test {SubscriptionManager#onReconnected}
   */
  it('should cancel all subscriptions on reconnect', async () => {
    sandbox.stub(client, 'rpcRequest').resolves();
    client.socketInstancesByAccounts[0] = { accountId: 0, accountId2: 0, accountId3: 1 };
    manager.scheduleSubscribe('accountId', 0);
    manager.scheduleSubscribe('accountId2', 0);
    manager.scheduleSubscribe('accountId3', 0);
    await clock.tickAsync(1000);
    manager.onReconnected(0, 0, []);
    await clock.tickAsync(5000);
    _sinon2.default.assert.callCount(client.rpcRequest, 4);
  });

  /**
   * @test {SubscriptionManager#onReconnected}
   */
  it('should restart subscriptions on reconnect', async () => {
    sandbox.stub(client, 'connect').resolves();
    sandbox.stub(client, 'rpcRequest').resolves();
    client.socketInstancesByAccounts[0] = { accountId: 0, accountId2: 0, accountId3: 0 };
    manager.scheduleSubscribe('accountId', 0);
    manager.scheduleSubscribe('accountId2', 0);
    manager.scheduleSubscribe('accountId3', 0);
    await clock.tickAsync(1000);
    manager.onReconnected(0, 0, ['accountId', 'accountId2']);
    await clock.tickAsync(2000);
    _sinon2.default.assert.callCount(client.rpcRequest, 5);
  });

  /**
   * @test {SubscriptionManager#onReconnected}
   */
  it('should wait until previous subscription ends on reconnect', async () => {
    sandbox.stub(client, 'rpcRequest').callsFake(async () => {
      await new _promise2.default(res => setTimeout(res, 2000));
    });

    sandbox.stub(client, 'connect').resolves();
    client.socketInstancesByAccounts[0] = { accountId: 0 };
    manager.scheduleSubscribe('accountId', 0);
    await clock.tickAsync(1000);
    manager.onReconnected(0, 0, ['accountId']);
    await clock.tickAsync(3000);
    _sinon2.default.assert.callCount(client.rpcRequest, 2);
  });

  /**
   * @test {SubscriptionManager#scheduleSubscribe}
   */
  it('should not send multiple subscribe requests at the same time', async () => {
    sandbox.stub(client, 'rpcRequest').resolves();
    manager.scheduleSubscribe('accountId', 0);
    manager.scheduleSubscribe('accountId', 0);
    await clock.tickAsync(1000);
    manager.cancelSubscribe('accountId:0');
    await clock.tickAsync(2500);
    _sinon2.default.assert.calledWith(client.rpcRequest, 'accountId', { type: 'subscribe', instanceIndex: 0 });
    _sinon2.default.assert.calledOnce(client.rpcRequest);
  });

  /**
   * @test {SubscriptionManager#onTimeout}
   */
  it('should resubscribe on timeout', async () => {
    sandbox.stub(client, 'rpcRequest').resolves();
    client.socketInstances['vint-hill'][0][0].socket.connected = true;
    client.socketInstancesByAccounts[0].accountId2 = 1;
    setTimeout(() => {
      manager.cancelSubscribe('accountId:0');
      manager.cancelSubscribe('accountId2:0');
    }, 100);
    manager.onTimeout('accountId', 0);
    manager.onTimeout('accountId2', 0);
    await clock.tickAsync(200);
    _sinon2.default.assert.calledWith(client.rpcRequest, 'accountId', { type: 'subscribe', instanceIndex: 0 });
    _sinon2.default.assert.callCount(client.rpcRequest, 1);
  });

  /**
   * @test {SubscriptionManager#onTimeout}
   */
  it('should not retry subscribe to terminal if connection is closed', async () => {
    sandbox.stub(client, 'rpcRequest').resolves();
    client.socketInstances['vint-hill'][0][0].socket.connected = false;
    setTimeout(() => {
      manager.cancelSubscribe('accountId:0');
    }, 100);
    manager.onTimeout('accountId', 0);
    await clock.tickAsync(200);
    _sinon2.default.assert.notCalled(client.rpcRequest);
  });

  /**
   * @test {SubscriptionManager#cancelAccount}
   */
  it('should cancel all subscriptions for an account', async () => {
    sandbox.stub(client, 'rpcRequest').resolves();
    manager.scheduleSubscribe('accountId', 0);
    manager.scheduleSubscribe('accountId', 1);
    await clock.tickAsync(100);
    manager.cancelAccount('accountId');
    await clock.tickAsync(500);
    _sinon2.default.assert.calledTwice(client.rpcRequest);
  });

  /**
   * @test {SubscriptionManager#cancelSubscribe}
   */
  it('should destroy subscribe process on cancel', async () => {
    const subscribe = sandbox.stub().resolves();
    const delaySubscribe = async () => {
      await subscribe();
      await new _promise2.default(res => setTimeout(res, 400));
    };
    client.rpcRequest = delaySubscribe;
    manager.scheduleSubscribe('accountId', 0);
    await clock.tickAsync(50);
    manager.cancelSubscribe('accountId:0');
    await clock.tickAsync(50);
    manager.scheduleSubscribe('accountId', 0);
    await clock.tickAsync(50);
    _sinon2.default.assert.calledTwice(subscribe);
  });

  /**
   * @test {SubscriptionManager#cancelSubscribe}
   */
  it('should check if account is subscribing', async () => {
    manager.scheduleSubscribe('accountId', 1);
    await clock.tickAsync(50);
    _sinon2.default.assert.match(manager.isAccountSubscribing('accountId'), true);
    _sinon2.default.assert.match(manager.isAccountSubscribing('accountId', 0), false);
    _sinon2.default.assert.match(manager.isAccountSubscribing('accountId', 1), true);
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9jbGllbnRzL21ldGFBcGkvc3Vic2NyaXB0aW9uTWFuYWdlci5zcGVjLmVzNiJdLCJuYW1lcyI6WyJkZXNjcmliZSIsInNhbmRib3giLCJjbG9jayIsIm1hbmFnZXIiLCJjbGllbnQiLCJiZWZvcmUiLCJzaW5vbiIsImNyZWF0ZVNhbmRib3giLCJtb2NrTWF0aCIsImdsb2JhbCIsIk1hdGgiLCJyYW5kb20iLCJiZWZvcmVFYWNoIiwic29ja2V0SW5zdGFuY2VzIiwic29ja2V0IiwiY29ubmVjdGVkIiwiY29ubmVjdCIsImluc3RhbmNlTnVtYmVyIiwic29ja2V0SW5zdGFuY2VJbmRleCIsImdldEFjY291bnRSZWdpb24iLCJzb2NrZXRJbnN0YW5jZXNCeUFjY291bnRzIiwiYWNjb3VudElkIiwicnBjUmVxdWVzdCIsInVzZUZha2VUaW1lcnMiLCJzaG91bGRBZHZhbmNlVGltZSIsIlN1YnNjcmlwdGlvbk1hbmFnZXIiLCJhZnRlckVhY2giLCJyZXN0b3JlIiwiaXQiLCJzdHViIiwicmVzb2x2ZXMiLCJzZXRUaW1lb3V0IiwiY2FuY2VsU3Vic2NyaWJlIiwic2NoZWR1bGVTdWJzY3JpYmUiLCJhc3NlcnQiLCJjYWxsZWRXaXRoIiwidHlwZSIsImluc3RhbmNlSW5kZXgiLCJyZXNwb25zZSIsInJlcXVlc3RJZCIsIm9uRmlyc3RDYWxsIiwiVGltZW91dEVycm9yIiwib25TZWNvbmRDYWxsIiwib25UaGlyZENhbGwiLCJ0aWNrQXN5bmMiLCJjYWxsZWRUd2ljZSIsInJlamVjdHMiLCJUb29NYW55UmVxdWVzdHNFcnJvciIsInBlcmlvZEluTWludXRlcyIsIm1heFJlcXVlc3RzRm9yUGVyaW9kIiwicmVjb21tZW5kZWRSZXRyeVRpbWUiLCJEYXRlIiwibm93IiwiY2FsbENvdW50IiwiYWNjb3VudElkMiIsImFjY291bnRJZDMiLCJvblJlY29ubmVjdGVkIiwiY2FsbHNGYWtlIiwicmVzIiwiY2FsbGVkT25jZSIsIm9uVGltZW91dCIsIm5vdENhbGxlZCIsImNhbmNlbEFjY291bnQiLCJzdWJzY3JpYmUiLCJkZWxheVN1YnNjcmliZSIsIm1hdGNoIiwiaXNBY2NvdW50U3Vic2NyaWJpbmciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOzs7QUFHQUEsU0FBUyxxQkFBVCxFQUFnQyxNQUFNO0FBQ3BDLE1BQUlDLE9BQUo7QUFDQSxNQUFJQyxLQUFKO0FBQ0EsTUFBSUMsT0FBSjtBQUNBLE1BQUlDLE1BQUo7O0FBRUFDLFNBQU8sTUFBTTtBQUNYSixjQUFVSyxnQkFBTUMsYUFBTixFQUFWO0FBQ0EsVUFBTUMsV0FBVyxzQkFBY0MsT0FBT0MsSUFBckIsQ0FBakI7QUFDQUYsYUFBU0csTUFBVCxHQUFrQixNQUFNLEdBQXhCO0FBQ0FGLFdBQU9DLElBQVAsR0FBY0YsUUFBZDtBQUNELEdBTEQ7O0FBT0FJLGFBQVcsWUFBWTtBQUNyQixVQUFNQyxrQkFBa0IsRUFBQyxhQUFhLEVBQUMsR0FBRyxDQUFDLEVBQUNDLFFBQVEsRUFBQ0MsV0FBVyxJQUFaLEVBQVQsRUFBRCxFQUE4QixFQUFDRCxRQUFRLEVBQUNDLFdBQVcsS0FBWixFQUFULEVBQTlCLENBQUosRUFBZCxFQUF4QjtBQUNBWCxhQUFTO0FBQ1BZLGVBQVMsTUFBTSxDQUFFLENBRFY7QUFFUEQsaUJBQVcsQ0FBQ0UsY0FBRCxFQUFpQkMsbUJBQWpCLEtBQ1RMLGdCQUFnQixXQUFoQixFQUE2QkksY0FBN0IsRUFBNkNDLG1CQUE3QyxFQUFrRUosTUFBbEUsQ0FBeUVDLFNBSHBFO0FBSVBGLHVCQUFpQkEsZUFKVjtBQUtQTSx3QkFBa0IsTUFBTSxXQUxqQjtBQU1QQyxpQ0FBMkIsRUFBQyxHQUFHLEVBQUNDLFdBQVcsQ0FBWixFQUFKLEVBTnBCO0FBT1BDLGtCQUFZLE1BQU0sQ0FBRTtBQVBiLEtBQVQ7QUFTQXBCLFlBQVFJLGdCQUFNaUIsYUFBTixDQUFvQixFQUFDQyxtQkFBbUIsSUFBcEIsRUFBcEIsQ0FBUjtBQUNBckIsY0FB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NU5EIiwiZmlsZSI6InN1YnNjcmlwdGlvbk1hbmFnZXIuc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBTdWJzY3JpcHRpb25NYW5hZ2VyIGZyb20gJy4vc3Vic2NyaXB0aW9uTWFuYWdlcic7XG5pbXBvcnQgc2lub24gZnJvbSAnc2lub24nO1xuaW1wb3J0IFRpbWVvdXRFcnJvciBmcm9tICcuLi90aW1lb3V0RXJyb3InO1xuaW1wb3J0IHsgVG9vTWFueVJlcXVlc3RzRXJyb3IgfSBmcm9tICcuLi9lcnJvckhhbmRsZXInO1xuXG4vKipcbiAqIEB0ZXN0IHtTdWJzY3JpcHRpb25NYW5hZ2VyfVxuICovXG5kZXNjcmliZSgnU3Vic2NyaXB0aW9uTWFuYWdlcicsICgpID0+IHtcbiAgbGV0IHNhbmRib3g7XG4gIGxldCBjbG9jaztcbiAgbGV0IG1hbmFnZXI7XG4gIGxldCBjbGllbnQ7XG5cbiAgYmVmb3JlKCgpID0+IHtcbiAgICBzYW5kYm94ID0gc2lub24uY3JlYXRlU2FuZGJveCgpO1xuICAgIGNvbnN0IG1vY2tNYXRoID0gT2JqZWN0LmNyZWF0ZShnbG9iYWwuTWF0aCk7XG4gICAgbW9ja01hdGgucmFuZG9tID0gKCkgPT4gMC4yO1xuICAgIGdsb2JhbC5NYXRoID0gbW9ja01hdGg7XG4gIH0pO1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4geyAgXG4gICAgY29uc3Qgc29ja2V0SW5zdGFuY2VzID0geyd2aW50LWhpbGwnOiB7MDogW3tzb2NrZXQ6IHtjb25uZWN0ZWQ6IHRydWV9fSwge3NvY2tldDoge2Nvbm5lY3RlZDogZmFsc2V9fV19fTtcbiAgICBjbGllbnQgPSB7XG4gICAgICBjb25uZWN0OiAoKSA9PiB7fSxcbiAgICAgIGNvbm5lY3RlZDogKGluc3RhbmNlTnVtYmVyLCBzb2NrZXRJbnN0YW5jZUluZGV4KSA9PiBcbiAgICAgICAgc29ja2V0SW5zdGFuY2VzWyd2aW50LWhpbGwnXVtpbnN0YW5jZU51bWJlcl1bc29ja2V0SW5zdGFuY2VJbmRleF0uc29ja2V0LmNvbm5lY3RlZCxcbiAgICAgIHNvY2tldEluc3RhbmNlczogc29ja2V0SW5zdGFuY2VzLFxuICAgICAgZ2V0QWNjb3VudFJlZ2lvbjogKCkgPT4gJ3ZpbnQtaGlsbCcsXG4gICAgICBzb2NrZXRJbnN0YW5jZXNCeUFjY291bnRzOiB7MDoge2FjY291bnRJZDogMH19LFxuICAgICAgcnBjUmVxdWVzdDogKCkgPT4ge31cbiAgICB9O1xuICAgIGNsb2NrID0gc2lub24udXNlRmFrZVRpbWVycyh7c2hvdWxkQWR2YW5jZVRpbWU6IHRydWV9KTtcbiAgICBtYW5hZ2VyID0gbmV3IFN1YnNjcmlwdGlvbk1hbmFnZXIoY2xpZW50KTtcbiAgfSk7XG5cbiAgYWZ0ZXJFYWNoKGFzeW5jICgpID0+IHtcbiAgICBzYW5kYm94LnJlc3RvcmUoKTtcbiAgICBjbG9jay5yZXN0b3JlKCk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7U3Vic2NyaXB0aW9uTWFuYWdlciNzY2hlZHVsZVN1YnNjcmliZX1cbiAgICovXG4gIGl0KCdzaG91bGQgc3Vic2NyaWJlIHRvIHRlcm1pbmFsJywgYXN5bmMgKCkgPT4ge1xuICAgIHNhbmRib3guc3R1YihjbGllbnQsICdycGNSZXF1ZXN0JykucmVzb2x2ZXMoKTtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIG1hbmFnZXIuY2FuY2VsU3Vic2NyaWJlKCdhY2NvdW50SWQ6MCcpO1xuICAgIH0sIDUwKTtcbiAgICBhd2FpdCBtYW5hZ2VyLnNjaGVkdWxlU3Vic2NyaWJlKCdhY2NvdW50SWQnLCAwKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbGVkV2l0aChjbGllbnQucnBjUmVxdWVzdCwgJ2FjY291bnRJZCcsIHt0eXBlOiAnc3Vic2NyaWJlJywgaW5zdGFuY2VJbmRleDogMH0pO1xuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge1N1YnNjcmlwdGlvbk1hbmFnZXIjc2NoZWR1bGVTdWJzY3JpYmV9XG4gICAqL1xuICBpdCgnc2hvdWxkIHJldHJ5IHN1YnNjcmliZSBpZiBubyByZXNwb25zZSByZWNlaXZlZCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCByZXNwb25zZSA9IHt0eXBlOiAncmVzcG9uc2UnLCBhY2NvdW50SWQ6ICdhY2NvdW50SWQnLCByZXF1ZXN0SWQ6ICdyZXF1ZXN0SWQnfTtcbiAgICBzYW5kYm94LnN0dWIoY2xpZW50LCAncnBjUmVxdWVzdCcpXG4gICAgICAub25GaXJzdENhbGwoKS5yZXNvbHZlcyhuZXcgVGltZW91dEVycm9yKCd0aW1lb3V0JykpXG4gICAgICAub25TZWNvbmRDYWxsKCkucmVzb2x2ZXMocmVzcG9uc2UpXG4gICAgICAub25UaGlyZENhbGwoKS5yZXNvbHZlcyhyZXNwb25zZSk7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBtYW5hZ2VyLmNhbmNlbFN1YnNjcmliZSgnYWNjb3VudElkOjAnKTtcbiAgICB9LCAzNjAwKTtcbiAgICBtYW5hZ2VyLnNjaGVkdWxlU3Vic2NyaWJlKCdhY2NvdW50SWQnLCAwKTtcbiAgICBhd2FpdCBjbG9jay50aWNrQXN5bmMoMTAwMDApO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRUd2ljZShjbGllbnQucnBjUmVxdWVzdCk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZFdpdGgoY2xpZW50LnJwY1JlcXVlc3QsICdhY2NvdW50SWQnLCB7dHlwZTogJ3N1YnNjcmliZScsIGluc3RhbmNlSW5kZXg6IDB9KTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtTdWJzY3JpcHRpb25NYW5hZ2VyI3NjaGVkdWxlU3Vic2NyaWJlfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCB3YWl0IGZvciByZWNvbW1lbmRlZCB0aW1lIGlmIHRvbyBtYW55IHJlcXVlc3RzIGVycm9yIHJlY2VpdmVkJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlc3BvbnNlID0ge3R5cGU6ICdyZXNwb25zZScsIGFjY291bnRJZDogJ2FjY291bnRJZCcsIHJlcXVlc3RJZDogJ3JlcXVlc3RJZCd9O1xuICAgIHNhbmRib3guc3R1YihjbGllbnQsICdycGNSZXF1ZXN0JylcbiAgICAgIC5vbkZpcnN0Q2FsbCgpLnJlamVjdHMobmV3IFRvb01hbnlSZXF1ZXN0c0Vycm9yKCd0aW1lb3V0Jywge1xuICAgICAgICBwZXJpb2RJbk1pbnV0ZXM6IDYwLCBtYXhSZXF1ZXN0c0ZvclBlcmlvZDogMTAwMDAsXG4gICAgICAgIHR5cGU6ICdMSU1JVF9SRVFVRVNUX1JBVEVfUEVSX1VTRVInLFxuICAgICAgICByZWNvbW1lbmRlZFJldHJ5VGltZTogbmV3IERhdGUoRGF0ZS5ub3coKSArIDUwMDApfSkpXG4gICAgICAub25TZWNvbmRDYWxsKCkucmVzb2x2ZXMocmVzcG9uc2UpXG4gICAgICAub25UaGlyZENhbGwoKS5yZXNvbHZlcyhyZXNwb25zZSk7XG4gICAgbWFuYWdlci5zY2hlZHVsZVN1YnNjcmliZSgnYWNjb3VudElkJywgMCk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDM2MDApO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsQ291bnQoY2xpZW50LnJwY1JlcXVlc3QsIDEpO1xuICAgIGF3YWl0IGNsb2NrLnRpY2tBc3luYygyMDAwKTtcbiAgICBtYW5hZ2VyLmNhbmNlbFN1YnNjcmliZSgnYWNjb3VudElkOjAnKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbENvdW50KGNsaWVudC5ycGNSZXF1ZXN0LCAyKTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtTdWJzY3JpcHRpb25NYW5hZ2VyI29uUmVjb25uZWN0ZWR9XG4gICAqL1xuICBpdCgnc2hvdWxkIGNhbmNlbCBhbGwgc3Vic2NyaXB0aW9ucyBvbiByZWNvbm5lY3QnLCBhc3luYyAoKSA9PiB7XG4gICAgc2FuZGJveC5zdHViKGNsaWVudCwgJ3JwY1JlcXVlc3QnKS5yZXNvbHZlcygpO1xuICAgIGNsaWVudC5zb2NrZXRJbnN0YW5jZXNCeUFjY291bnRzWzBdID0ge2FjY291bnRJZDogMCwgYWNjb3VudElkMjogMCwgYWNjb3VudElkMzogMX07XG4gICAgbWFuYWdlci5zY2hlZHVsZVN1YnNjcmliZSgnYWNjb3VudElkJywgMCk7XG4gICAgbWFuYWdlci5zY2hlZHVsZVN1YnNjcmliZSgnYWNjb3VudElkMicsIDApO1xuICAgIG1hbmFnZXIuc2NoZWR1bGVTdWJzY3JpYmUoJ2FjY291bnRJZDMnLCAwKTtcbiAgICBhd2FpdCBjbG9jay50aWNrQXN5bmMoMTAwMCk7XG4gICAgbWFuYWdlci5vblJlY29ubmVjdGVkKDAsIDAsIFtdKTtcbiAgICBhd2FpdCBjbG9jay50aWNrQXN5bmMoNTAwMCk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxDb3VudChjbGllbnQucnBjUmVxdWVzdCwgNCk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7U3Vic2NyaXB0aW9uTWFuYWdlciNvblJlY29ubmVjdGVkfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCByZXN0YXJ0IHN1YnNjcmlwdGlvbnMgb24gcmVjb25uZWN0JywgYXN5bmMgKCkgPT4ge1xuICAgIHNhbmRib3guc3R1YihjbGllbnQsICdjb25uZWN0JykucmVzb2x2ZXMoKTtcbiAgICBzYW5kYm94LnN0dWIoY2xpZW50LCAncnBjUmVxdWVzdCcpLnJlc29sdmVzKCk7XG4gICAgY2xpZW50LnNvY2tldEluc3RhbmNlc0J5QWNjb3VudHNbMF0gPSB7YWNjb3VudElkOiAwLCBhY2NvdW50SWQyOiAwLCBhY2NvdW50SWQzOiAwfTtcbiAgICBtYW5hZ2VyLnNjaGVkdWxlU3Vic2NyaWJlKCdhY2NvdW50SWQnLCAwKTtcbiAgICBtYW5hZ2VyLnNjaGVkdWxlU3Vic2NyaWJlKCdhY2NvdW50SWQyJywgMCk7XG4gICAgbWFuYWdlci5zY2hlZHVsZVN1YnNjcmliZSgnYWNjb3VudElkMycsIDApO1xuICAgIGF3YWl0IGNsb2NrLnRpY2tBc3luYygxMDAwKTtcbiAgICBtYW5hZ2VyLm9uUmVjb25uZWN0ZWQoMCwgMCwgWydhY2NvdW50SWQnLCAnYWNjb3VudElkMiddKTtcbiAgICBhd2FpdCBjbG9jay50aWNrQXN5bmMoMjAwMCk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxDb3VudChjbGllbnQucnBjUmVxdWVzdCwgNSk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7U3Vic2NyaXB0aW9uTWFuYWdlciNvblJlY29ubmVjdGVkfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCB3YWl0IHVudGlsIHByZXZpb3VzIHN1YnNjcmlwdGlvbiBlbmRzIG9uIHJlY29ubmVjdCcsIGFzeW5jICgpID0+IHtcbiAgICBzYW5kYm94LnN0dWIoY2xpZW50LCAncnBjUmVxdWVzdCcpLmNhbGxzRmFrZShhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXMgPT4gc2V0VGltZW91dChyZXMsIDIwMDApKTtcbiAgICB9KTtcblxuICAgIHNhbmRib3guc3R1YihjbGllbnQsICdjb25uZWN0JykucmVzb2x2ZXMoKTtcbiAgICBjbGllbnQuc29ja2V0SW5zdGFuY2VzQnlBY2NvdW50c1swXSA9IHthY2NvdW50SWQ6IDB9O1xuICAgIG1hbmFnZXIuc2NoZWR1bGVTdWJzY3JpYmUoJ2FjY291bnRJZCcsIDApO1xuICAgIGF3YWl0IGNsb2NrLnRpY2tBc3luYygxMDAwKTtcbiAgICBtYW5hZ2VyLm9uUmVjb25uZWN0ZWQoMCwgMCwgWydhY2NvdW50SWQnXSk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDMwMDApO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsQ291bnQoY2xpZW50LnJwY1JlcXVlc3QsIDIpO1xuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge1N1YnNjcmlwdGlvbk1hbmFnZXIjc2NoZWR1bGVTdWJzY3JpYmV9XG4gICAqL1xuICBpdCgnc2hvdWxkIG5vdCBzZW5kIG11bHRpcGxlIHN1YnNjcmliZSByZXF1ZXN0cyBhdCB0aGUgc2FtZSB0aW1lJywgYXN5bmMgKCkgPT4ge1xuICAgIHNhbmRib3guc3R1YihjbGllbnQsICdycGNSZXF1ZXN0JykucmVzb2x2ZXMoKTtcbiAgICBtYW5hZ2VyLnNjaGVkdWxlU3Vic2NyaWJlKCdhY2NvdW50SWQnLCAwKTtcbiAgICBtYW5hZ2VyLnNjaGVkdWxlU3Vic2NyaWJlKCdhY2NvdW50SWQnLCAwKTtcbiAgICBhd2FpdCBjbG9jay50aWNrQXN5bmMoMTAwMCk7XG4gICAgbWFuYWdlci5jYW5jZWxTdWJzY3JpYmUoJ2FjY291bnRJZDowJyk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDI1MDApO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKGNsaWVudC5ycGNSZXF1ZXN0LCAnYWNjb3VudElkJywge3R5cGU6ICdzdWJzY3JpYmUnLCBpbnN0YW5jZUluZGV4OiAwfSk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZE9uY2UoY2xpZW50LnJwY1JlcXVlc3QpO1xuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge1N1YnNjcmlwdGlvbk1hbmFnZXIjb25UaW1lb3V0fVxuICAgKi9cbiAgaXQoJ3Nob3VsZCByZXN1YnNjcmliZSBvbiB0aW1lb3V0JywgYXN5bmMgKCkgPT4ge1xuICAgIHNhbmRib3guc3R1YihjbGllbnQsICdycGNSZXF1ZXN0JykucmVzb2x2ZXMoKTtcbiAgICBjbGllbnQuc29ja2V0SW5zdGFuY2VzWyd2aW50LWhpbGwnXVswXVswXS5zb2NrZXQuY29ubmVjdGVkID0gdHJ1ZTtcbiAgICBjbGllbnQuc29ja2V0SW5zdGFuY2VzQnlBY2NvdW50c1swXS5hY2NvdW50SWQyID0gMTtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIG1hbmFnZXIuY2FuY2VsU3Vic2NyaWJlKCdhY2NvdW50SWQ6MCcpO1xuICAgICAgbWFuYWdlci5jYW5jZWxTdWJzY3JpYmUoJ2FjY291bnRJZDI6MCcpO1xuICAgIH0sIDEwMCk7XG4gICAgbWFuYWdlci5vblRpbWVvdXQoJ2FjY291bnRJZCcsIDApO1xuICAgIG1hbmFnZXIub25UaW1lb3V0KCdhY2NvdW50SWQyJywgMCk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDIwMCk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZFdpdGgoY2xpZW50LnJwY1JlcXVlc3QsICdhY2NvdW50SWQnLCB7dHlwZTogJ3N1YnNjcmliZScsIGluc3RhbmNlSW5kZXg6IDB9KTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbENvdW50KGNsaWVudC5ycGNSZXF1ZXN0LCAxKTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtTdWJzY3JpcHRpb25NYW5hZ2VyI29uVGltZW91dH1cbiAgICovXG4gIGl0KCdzaG91bGQgbm90IHJldHJ5IHN1YnNjcmliZSB0byB0ZXJtaW5hbCBpZiBjb25uZWN0aW9uIGlzIGNsb3NlZCcsIGFzeW5jICgpID0+IHtcbiAgICBzYW5kYm94LnN0dWIoY2xpZW50LCAncnBjUmVxdWVzdCcpLnJlc29sdmVzKCk7XG4gICAgY2xpZW50LnNvY2tldEluc3RhbmNlc1sndmludC1oaWxsJ11bMF1bMF0uc29ja2V0LmNvbm5lY3RlZCA9IGZhbHNlO1xuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgbWFuYWdlci5jYW5jZWxTdWJzY3JpYmUoJ2FjY291bnRJZDowJyk7XG4gICAgfSwgMTAwKTtcbiAgICBtYW5hZ2VyLm9uVGltZW91dCgnYWNjb3VudElkJywgMCk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDIwMCk7XG4gICAgc2lub24uYXNzZXJ0Lm5vdENhbGxlZChjbGllbnQucnBjUmVxdWVzdCk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7U3Vic2NyaXB0aW9uTWFuYWdlciNjYW5jZWxBY2NvdW50fVxuICAgKi9cbiAgaXQoJ3Nob3VsZCBjYW5jZWwgYWxsIHN1YnNjcmlwdGlvbnMgZm9yIGFuIGFjY291bnQnLCBhc3luYyAoKSA9PiB7XG4gICAgc2FuZGJveC5zdHViKGNsaWVudCwgJ3JwY1JlcXVlc3QnKS5yZXNvbHZlcygpO1xuICAgIG1hbmFnZXIuc2NoZWR1bGVTdWJzY3JpYmUoJ2FjY291bnRJZCcsIDApO1xuICAgIG1hbmFnZXIuc2NoZWR1bGVTdWJzY3JpYmUoJ2FjY291bnRJZCcsIDEpO1xuICAgIGF3YWl0IGNsb2NrLnRpY2tBc3luYygxMDApO1xuICAgIG1hbmFnZXIuY2FuY2VsQWNjb3VudCgnYWNjb3VudElkJyk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDUwMCk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZFR3aWNlKGNsaWVudC5ycGNSZXF1ZXN0KTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtTdWJzY3JpcHRpb25NYW5hZ2VyI2NhbmNlbFN1YnNjcmliZX1cbiAgICovXG4gIGl0KCdzaG91bGQgZGVzdHJveSBzdWJzY3JpYmUgcHJvY2VzcyBvbiBjYW5jZWwnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3Qgc3Vic2NyaWJlID0gc2FuZGJveC5zdHViKCkucmVzb2x2ZXMoKTtcbiAgICBjb25zdCBkZWxheVN1YnNjcmliZSA9IGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHN1YnNjcmliZSgpO1xuICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzID0+IHNldFRpbWVvdXQocmVzLCA0MDApKTtcbiAgICB9O1xuICAgIGNsaWVudC5ycGNSZXF1ZXN0ID0gZGVsYXlTdWJzY3JpYmU7XG4gICAgbWFuYWdlci5zY2hlZHVsZVN1YnNjcmliZSgnYWNjb3VudElkJywgMCk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDUwKTtcbiAgICBtYW5hZ2VyLmNhbmNlbFN1YnNjcmliZSgnYWNjb3VudElkOjAnKTtcbiAgICBhd2FpdCBjbG9jay50aWNrQXN5bmMoNTApO1xuICAgIG1hbmFnZXIuc2NoZWR1bGVTdWJzY3JpYmUoJ2FjY291bnRJZCcsIDApO1xuICAgIGF3YWl0IGNsb2NrLnRpY2tBc3luYyg1MCk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZFR3aWNlKHN1YnNjcmliZSk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7U3Vic2NyaXB0aW9uTWFuYWdlciNjYW5jZWxTdWJzY3JpYmV9XG4gICAqL1xuICBpdCgnc2hvdWxkIGNoZWNrIGlmIGFjY291bnQgaXMgc3Vic2NyaWJpbmcnLCBhc3luYyAoKSA9PiB7XG4gICAgbWFuYWdlci5zY2hlZHVsZVN1YnNjcmliZSgnYWNjb3VudElkJywgMSk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDUwKTtcbiAgICBzaW5vbi5hc3NlcnQubWF0Y2gobWFuYWdlci5pc0FjY291bnRTdWJzY3JpYmluZygnYWNjb3VudElkJyksIHRydWUpO1xuICAgIHNpbm9uLmFzc2VydC5tYXRjaChtYW5hZ2VyLmlzQWNjb3VudFN1YnNjcmliaW5nKCdhY2NvdW50SWQnLCAwKSwgZmFsc2UpO1xuICAgIHNpbm9uLmFzc2VydC5tYXRjaChtYW5hZ2VyLmlzQWNjb3VudFN1YnNjcmliaW5nKCdhY2NvdW50SWQnLCAxKSwgdHJ1ZSk7XG4gIH0pO1xuXG59KTtcbiJdfQ==