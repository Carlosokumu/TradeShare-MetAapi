'use strict';

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _httpClient = require('./httpClient');

var _httpClient2 = _interopRequireDefault(_httpClient);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _domain = require('./domain.client');

var _domain2 = _interopRequireDefault(_domain);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @test {DomainClient}
 */
describe('DomainClient', () => {

  const token = 'header.payload.sign';
  const host = 'https://mt-client-api-v1';
  const region = 'vint-hill';
  let expected;
  let hostData;
  let httpClient = new _httpClient2.default();
  let domainClient;
  let sandbox;
  let requestStub;
  let clock;

  before(() => {
    sandbox = _sinon2.default.createSandbox();
  });

  beforeEach(() => {
    domainClient = new _domain2.default(httpClient, token);
    expected = 'https://mt-client-api-v1.vint-hill.agiliumtrade.ai';
    hostData = {
      url: 'https://mt-client-api-v1.agiliumtrade.agiliumtrade.ai',
      hostname: 'mt-client-api-v1',
      domain: 'agiliumtrade.ai'
    };
    requestStub = sandbox.stub(httpClient, 'request').resolves(hostData);
    clock = sandbox.useFakeTimers({
      shouldAdvanceTime: true,
      now: new Date('2020-10-05T07:00:00.000Z')
    });
  });

  afterEach(() => {
    sandbox.restore();
    clock.restore();
  });

  /**
   * @test {DomainClient#getUrl}
   */
  it('should return url', async () => {
    const url = await domainClient.getUrl(host, region);
    url.should.equal(expected);
    _sinon2.default.assert.calledOnceWithExactly(httpClient.request, {
      url: 'https://mt-provisioning-api-v1.agiliumtrade.agiliumtrade.ai/users/current/servers/mt-client-api',
      method: 'GET',
      json: true,
      headers: {
        'auth-token': token
      }
    }, '_updateDomain');
  });

  /**
   * @test {DomainClient#getUrl}
   */
  it('should return cached url if requested again', async () => {
    const url = await domainClient.getUrl(host, region);
    url.should.equal(expected);
    const url2 = await domainClient.getUrl(host, region);
    url2.should.equal(expected);
    _sinon2.default.assert.calledOnceWithExactly(httpClient.request, {
      url: 'https://mt-provisioning-api-v1.agiliumtrade.agiliumtrade.ai/users/current/servers/mt-client-api',
      method: 'GET',
      json: true,
      headers: {
        'auth-token': token
      }
    }, '_updateDomain');
  });

  /**
   * @test {DomainClient#getUrl}
   */
  it('should make a new request if cache expired', async () => {
    const url = await domainClient.getUrl(host, region);
    url.should.equal(expected);
    await clock.tickAsync(11 * 60 * 1000);
    const url2 = await domainClient.getUrl(host, region);
    url2.should.equal(expected);
    _sinon2.default.assert.calledTwice(httpClient.request);
  });

  /**
   * @test {DomainClient#getUrl}
   */
  it('should wait for promise if url is being requested', async () => {
    requestStub.callsFake(async arg => {
      await new _promise2.default(res => setTimeout(res, 50));
      return hostData;
    });

    let urls = await _promise2.default.all([domainClient.getUrl(host, region), domainClient.getUrl(host, region)]);
    urls[0].should.equal(expected);
    urls[1].should.equal(expected);
    _sinon2.default.assert.calledOnceWithExactly(httpClient.request, {
      url: 'https://mt-provisioning-api-v1.agiliumtrade.agiliumtrade.ai/users/current/servers/mt-client-api',
      method: 'GET',
      json: true,
      headers: {
        'auth-token': token
      }
    }, '_updateDomain');
  });

  /**
   * @test {DomainClient#getUrl}
   */
  it('should retry request if received error', async () => {
    let callNumber = 0;
    requestStub.callsFake(async arg => {
      await new _promise2.default(res => setTimeout(res, 50));
      callNumber++;
      if (callNumber < 3) {
        throw new Error('test');
      } else {
        return hostData;
      }
    });

    let responses = [domainClient.getUrl(host, region), domainClient.getUrl(host, region)];
    await clock.tickAsync(6000);
    responses = [await responses[0], await responses[1]];
    responses[0].should.equal(expected);
    responses[1].should.equal(expected);
    _sinon2.default.assert.callCount(httpClient.request, 3);
  });

  /**
   * @test {DomainClient#getSettings}
   */
  it('should return domain settings', async () => {
    const settings = await domainClient.getSettings();
    _sinon2.default.assert.match(settings, {
      hostname: 'mt-client-api-v1',
      domain: 'agiliumtrade.ai'
    });
    _sinon2.default.assert.calledOnceWithExactly(httpClient.request, {
      url: 'https://mt-provisioning-api-v1.agiliumtrade.agiliumtrade.ai/users/current/servers/mt-client-api',
      method: 'GET',
      json: true,
      headers: {
        'auth-token': token
      }
    }, '_updateDomain');
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9jbGllbnRzL2RvbWFpbi5jbGllbnQuc3BlYy5lczYiXSwibmFtZXMiOlsiZGVzY3JpYmUiLCJ0b2tlbiIsImhvc3QiLCJyZWdpb24iLCJleHBlY3RlZCIsImhvc3REYXRhIiwiaHR0cENsaWVudCIsIkh0dHBDbGllbnQiLCJkb21haW5DbGllbnQiLCJzYW5kYm94IiwicmVxdWVzdFN0dWIiLCJjbG9jayIsImJlZm9yZSIsInNpbm9uIiwiY3JlYXRlU2FuZGJveCIsImJlZm9yZUVhY2giLCJEb21haW5DbGllbnQiLCJ1cmwiLCJob3N0bmFtZSIsImRvbWFpbiIsInN0dWIiLCJyZXNvbHZlcyIsInVzZUZha2VUaW1lcnMiLCJzaG91bGRBZHZhbmNlVGltZSIsIm5vdyIsIkRhdGUiLCJhZnRlckVhY2giLCJyZXN0b3JlIiwiaXQiLCJnZXRVcmwiLCJzaG91bGQiLCJlcXVhbCIsImFzc2VydCIsImNhbGxlZE9uY2VXaXRoRXhhY3RseSIsInJlcXVlc3QiLCJtZXRob2QiLCJqc29uIiwiaGVhZGVycyIsInVybDIiLCJ0aWNrQXN5bmMiLCJjYWxsZWRUd2ljZSIsImNhbGxzRmFrZSIsImFyZyIsInJlcyIsInNldFRpbWVvdXQiLCJ1cmxzIiwiYWxsIiwiY2FsbE51bWJlciIsIkVycm9yIiwicmVzcG9uc2VzIiwiY2FsbENvdW50Iiwic2V0dGluZ3MiLCJnZXRTZXR0aW5ncyIsIm1hdGNoIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUE7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7QUFFQTs7O0FBR0FBLFNBQVMsY0FBVCxFQUF5QixNQUFNOztBQUU3QixRQUFNQyxRQUFRLHFCQUFkO0FBQ0EsUUFBTUMsT0FBTywwQkFBYjtBQUNBLFFBQU1DLFNBQVMsV0FBZjtBQUNBLE1BQUlDLFFBQUo7QUFDQSxNQUFJQyxRQUFKO0FBQ0EsTUFBSUMsYUFBYSxJQUFJQyxvQkFBSixFQUFqQjtBQUNBLE1BQUlDLFlBQUo7QUFDQSxNQUFJQyxPQUFKO0FBQ0EsTUFB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VixDQUFQLEVBQXFCLE1BQU1BLFVBQVUsQ0FBVixDQUEzQixDQUFaO0FBQ0FBLGNBQVUsQ0FBVixFQUFhbkIsTUFBYixDQUFvQkMsS0FBcEIsQ0FBMEIzQixRQUExQjtBQUNBNkMsY0FBVSxDQUFWLEVBQWFuQixNQUFiLENBQW9CQyxLQUFwQixDQUEwQjNCLFFBQTFCO0FBQ0FTLG9CQUFNbUIsTUFBTixDQUFha0IsU0FBYixDQUF1QjVDLFdBQVc0QixPQUFsQyxFQUEyQyxDQUEzQztBQUNELEdBbkJEOztBQXFCQTs7O0FBR0FOLEtBQUcsK0JBQUgsRUFBb0MsWUFBWTtBQUM5QyxVQUFNdUIsV0FBVyxNQUFNM0MsYUFBYTRDLFdBQWIsRUFBdkI7QUFDQXZDLG9CQUFNbUIsTUFBTixDQUFhcUIsS0FBYixDQUFtQkYsUUFBbkIsRUFBNkI7QUFDM0JqQyxnQkFBVSxrQkFEaUI7QUFFM0JDLGNBQVE7QUFGbUIsS0FBN0I7QUFJQU4sb0JBQU1tQixNQUFOLENBQWFDLHFCQUFiLENBQW1DM0IsV0FBVzRCLE9BQTlDLEVBQXVEO0FBQ3JEakIsV0FBSyxpR0FEZ0Q7QUFFckRrQixjQUFRLEtBRjZDO0FBR3JEQyxZQUFNLElBSCtDO0FBSXJEQyxlQUFTO0FBQ1Asc0JBQWNwQztBQURQO0FBSjRDLEtBQXZELEVBT0csZUFQSDtBQVFELEdBZEQ7QUFnQkQsQ0FySkQiLCJmaWxlIjoiZG9tYWluLmNsaWVudC5zcGVjLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgSHR0cENsaWVudCBmcm9tICcuL2h0dHBDbGllbnQnO1xuaW1wb3J0IHNpbm9uIGZyb20gJ3Npbm9uJztcbmltcG9ydCBEb21haW5DbGllbnQgZnJvbSAnLi9kb21haW4uY2xpZW50JztcbiAgXG4vKipcbiAqIEB0ZXN0IHtEb21haW5DbGllbnR9XG4gKi9cbmRlc2NyaWJlKCdEb21haW5DbGllbnQnLCAoKSA9PiB7XG5cbiAgY29uc3QgdG9rZW4gPSAnaGVhZGVyLnBheWxvYWQuc2lnbic7XG4gIGNvbnN0IGhvc3QgPSAnaHR0cHM6Ly9tdC1jbGllbnQtYXBpLXYxJztcbiAgY29uc3QgcmVnaW9uID0gJ3ZpbnQtaGlsbCc7XG4gIGxldCBleHBlY3RlZDtcbiAgbGV0IGhvc3REYXRhO1xuICBsZXQgaHR0cENsaWVudCA9IG5ldyBIdHRwQ2xpZW50KCk7XG4gIGxldCBkb21haW5DbGllbnQ7XG4gIGxldCBzYW5kYm94O1xuICBsZXQgcmVxdWVzdFN0dWI7XG4gIGxldCBjbG9jaztcbiBcbiAgYmVmb3JlKCgpID0+IHtcbiAgICBzYW5kYm94ID0gc2lub24uY3JlYXRlU2FuZGJveCgpO1xuICB9KTtcbiBcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgZG9tYWluQ2xpZW50ID0gbmV3IERvbWFpbkNsaWVudChodHRwQ2xpZW50LCB0b2tlbik7XG4gICAgZXhwZWN0ZWQgPSAnaHR0cHM6Ly9tdC1jbGllbnQtYXBpLXYxLnZpbnQtaGlsbC5hZ2lsaXVtdHJhZGUuYWknO1xuICAgIGhvc3REYXRhID0ge1xuICAgICAgdXJsOiAnaHR0cHM6Ly9tdC1jbGllbnQtYXBpLXYxLmFnaWxpdW10cmFkZS5hZ2lsaXVtdHJhZGUuYWknLFxuICAgICAgaG9zdG5hbWU6ICdtdC1jbGllbnQtYXBpLXYxJyxcbiAgICAgIGRvbWFpbjogJ2FnaWxpdW10cmFkZS5haSdcbiAgICB9O1xuICAgIHJlcXVlc3RTdHViID0gc2FuZGJveC5zdHViKGh0dHBDbGllbnQsICdyZXF1ZXN0JykucmVzb2x2ZXMoaG9zdERhdGEpO1xuICAgIGNsb2NrID0gc2FuZGJveC51c2VGYWtlVGltZXJzKHtcbiAgICAgIHNob3VsZEFkdmFuY2VUaW1lOiB0cnVlLFxuICAgICAgbm93OiBuZXcgRGF0ZSgnMjAyMC0xMC0wNVQwNzowMDowMC4wMDBaJylcbiAgICB9KTtcbiAgfSk7XG4gXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgc2FuZGJveC5yZXN0b3JlKCk7XG4gICAgY2xvY2sucmVzdG9yZSgpO1xuICB9KTtcbiBcbiAgLyoqXG4gICAqIEB0ZXN0IHtEb21haW5DbGllbnQjZ2V0VXJsfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCByZXR1cm4gdXJsJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHVybCA9IGF3YWl0IGRvbWFpbkNsaWVudC5nZXRVcmwoaG9zdCwgcmVnaW9uKTtcbiAgICB1cmwuc2hvdWxkLmVxdWFsKGV4cGVjdGVkKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbGVkT25jZVdpdGhFeGFjdGx5KGh0dHBDbGllbnQucmVxdWVzdCwge1xuICAgICAgdXJsOiAnaHR0cHM6Ly9tdC1wcm92aXNpb25pbmctYXBpLXYxLmFnaWxpdW10cmFkZS5hZ2lsaXVtdHJhZGUuYWkvdXNlcnMvY3VycmVudC9zZXJ2ZXJzL210LWNsaWVudC1hcGknLFxuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIGpzb246IHRydWUsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdhdXRoLXRva2VuJzogdG9rZW5cbiAgICAgIH1cbiAgICB9LCAnX3VwZGF0ZURvbWFpbicpO1xuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge0RvbWFpbkNsaWVudCNnZXRVcmx9XG4gICAqL1xuICBpdCgnc2hvdWxkIHJldHVybiBjYWNoZWQgdXJsIGlmIHJlcXVlc3RlZCBhZ2FpbicsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCB1cmwgPSBhd2FpdCBkb21haW5DbGllbnQuZ2V0VXJsKGhvc3QsIHJlZ2lvbik7XG4gICAgdXJsLnNob3VsZC5lcXVhbChleHBlY3RlZCk7XG4gICAgY29uc3QgdXJsMiA9IGF3YWl0IGRvbWFpbkNsaWVudC5nZXRVcmwoaG9zdCwgcmVnaW9uKTtcbiAgICB1cmwyLnNob3VsZC5lcXVhbChleHBlY3RlZCk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZE9uY2VXaXRoRXhhY3RseShodHRwQ2xpZW50LnJlcXVlc3QsIHtcbiAgICAgIHVybDogJ2h0dHBzOi8vbXQtcHJvdmlzaW9uaW5nLWFwaS12MS5hZ2lsaXVtdHJhZGUuYWdpbGl1bXRyYWRlLmFpL3VzZXJzL2N1cnJlbnQvc2VydmVycy9tdC1jbGllbnQtYXBpJyxcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICBqc29uOiB0cnVlLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnYXV0aC10b2tlbic6IHRva2VuXG4gICAgICB9XG4gICAgfSwgJ191cGRhdGVEb21haW4nKTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtEb21haW5DbGllbnQjZ2V0VXJsfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCBtYWtlIGEgbmV3IHJlcXVlc3QgaWYgY2FjaGUgZXhwaXJlZCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCB1cmwgPSBhd2FpdCBkb21haW5DbGllbnQuZ2V0VXJsKGhvc3QsIHJlZ2lvbik7XG4gICAgdXJsLnNob3VsZC5lcXVhbChleHBlY3RlZCk7XG4gICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDExICogNjAgKiAxMDAwKTtcbiAgICBjb25zdCB1cmwyID0gYXdhaXQgZG9tYWluQ2xpZW50LmdldFVybChob3N0LCByZWdpb24pO1xuICAgIHVybDIuc2hvdWxkLmVxdWFsKGV4cGVjdGVkKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbGVkVHdpY2UoaHR0cENsaWVudC5yZXF1ZXN0KTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtEb21haW5DbGllbnQjZ2V0VXJsfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCB3YWl0IGZvciBwcm9taXNlIGlmIHVybCBpcyBiZWluZyByZXF1ZXN0ZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgcmVxdWVzdFN0dWIuY2FsbHNGYWtlKGFzeW5jIChhcmcpID0+IHtcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlcyA9PiBzZXRUaW1lb3V0KHJlcywgNTApKTtcbiAgICAgIHJldHVybiBob3N0RGF0YTtcbiAgICB9KTtcblxuICAgIGxldCB1cmxzID0gYXdhaXQgUHJvbWlzZS5hbGwoW2RvbWFpbkNsaWVudC5nZXRVcmwoaG9zdCwgcmVnaW9uKSxcbiAgICAgIGRvbWFpbkNsaWVudC5nZXRVcmwoaG9zdCwgcmVnaW9uKV0pO1xuICAgIHVybHNbMF0uc2hvdWxkLmVxdWFsKGV4cGVjdGVkKTtcbiAgICB1cmxzWzFdLnNob3VsZC5lcXVhbChleHBlY3RlZCk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZE9uY2VXaXRoRXhhY3RseShodHRwQ2xpZW50LnJlcXVlc3QsIHtcbiAgICAgIHVybDogJ2h0dHBzOi8vbXQtcHJvdmlzaW9uaW5nLWFwaS12MS5hZ2lsaXVtdHJhZGUuYWdpbGl1bXRyYWRlLmFpL3VzZXJzL2N1cnJlbnQvc2VydmVycy9tdC1jbGllbnQtYXBpJyxcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICBqc29uOiB0cnVlLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnYXV0aC10b2tlbic6IHRva2VuXG4gICAgICB9XG4gICAgfSwgJ191cGRhdGVEb21haW4nKTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtEb21haW5DbGllbnQjZ2V0VXJsfVxuICAgKi9cbiAgaXQoJ3Nob3VsZCByZXRyeSByZXF1ZXN0IGlmIHJlY2VpdmVkIGVycm9yJywgYXN5bmMgKCkgPT4ge1xuICAgIGxldCBjYWxsTnVtYmVyID0gMDtcbiAgICByZXF1ZXN0U3R1Yi5jYWxsc0Zha2UoYXN5bmMgKGFyZykgPT4ge1xuICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzID0+IHNldFRpbWVvdXQocmVzLCA1MCkpO1xuICAgICAgY2FsbE51bWJlcisrO1xuICAgICAgaWYoY2FsbE51bWJlciA8IDMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCd0ZXN0Jyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gaG9zdERhdGE7XG4gICAgICB9XG4gICAgfSk7XG4gICAgXG4gICAgbGV0IHJlc3BvbnNlcyA9IFtkb21haW5DbGllbnQuZ2V0VXJsKGhvc3QsIHJlZ2lvbiksXG4gICAgICBkb21haW5DbGllbnQuZ2V0VXJsKGhvc3QsIHJlZ2lvbildO1xuICAgIGF3YWl0IGNsb2NrLnRpY2tBc3luYyg2MDAwKTtcbiAgICByZXNwb25zZXMgPSBbYXdhaXQgcmVzcG9uc2VzWzBdLCBhd2FpdCByZXNwb25zZXNbMV1dO1xuICAgIHJlc3BvbnNlc1swXS5zaG91bGQuZXF1YWwoZXhwZWN0ZWQpO1xuICAgIHJlc3BvbnNlc1sxXS5zaG91bGQuZXF1YWwoZXhwZWN0ZWQpO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsQ291bnQoaHR0cENsaWVudC5yZXF1ZXN0LCAzKTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtEb21haW5DbGllbnQjZ2V0U2V0dGluZ3N9XG4gICAqL1xuICBpdCgnc2hvdWxkIHJldHVybiBkb21haW4gc2V0dGluZ3MnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3Qgc2V0dGluZ3MgPSBhd2FpdCBkb21haW5DbGllbnQuZ2V0U2V0dGluZ3MoKTtcbiAgICBzaW5vbi5hc3NlcnQubWF0Y2goc2V0dGluZ3MsIHtcbiAgICAgIGhvc3RuYW1lOiAnbXQtY2xpZW50LWFwaS12MScsXG4gICAgICBkb21haW46ICdhZ2lsaXVtdHJhZGUuYWknXG4gICAgfSk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZE9uY2VXaXRoRXhhY3RseShodHRwQ2xpZW50LnJlcXVlc3QsIHtcbiAgICAgIHVybDogJ2h0dHBzOi8vbXQtcHJvdmlzaW9uaW5nLWFwaS12MS5hZ2lsaXVtdHJhZGUuYWdpbGl1bXRyYWRlLmFpL3VzZXJzL2N1cnJlbnQvc2VydmVycy9tdC1jbGllbnQtYXBpJyxcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICBqc29uOiB0cnVlLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnYXV0aC10b2tlbic6IHRva2VuXG4gICAgICB9XG4gICAgfSwgJ191cGRhdGVEb21haW4nKTtcbiAgfSk7XG5cbn0pO1xuIl19