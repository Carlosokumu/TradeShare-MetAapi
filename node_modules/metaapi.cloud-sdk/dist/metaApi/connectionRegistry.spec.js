'use strict';

var _is = require('babel-runtime/core-js/object/is');

var _is2 = _interopRequireDefault(_is);

var _should = require('should');

var _should2 = _interopRequireDefault(_should);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _streamingMetaApiConnection = require('./streamingMetaApiConnection');

var _streamingMetaApiConnection2 = _interopRequireDefault(_streamingMetaApiConnection);

var _connectionRegistry = require('./connectionRegistry');

var _connectionRegistry2 = _interopRequireDefault(_connectionRegistry);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @test {ConnectionRegistry}
 */
describe('ConnectionRegistry', () => {

  let sandbox;
  let registry;
  let metaApiWebsocketClient = {
    addSynchronizationListener: () => {},
    addReconnectListener: () => {},
    subscribe: () => {},
    regionsByAccounts: {}
  };
  let storage = {
    lastHistoryOrderTime: () => new Date('2020-01-01T00:00:00.000Z'),
    lastDealTime: () => new Date('2020-01-02T00:00:00.000Z'),
    loadDataFromDisk: () => ({ deals: [], historyOrders: [] })
  };

  before(() => {
    sandbox = _sinon2.default.createSandbox();
  });

  beforeEach(() => {
    registry = new _connectionRegistry2.default(metaApiWebsocketClient);
    sandbox.stub(_streamingMetaApiConnection2.default.prototype, 'initialize').resolves();
    sandbox.stub(_streamingMetaApiConnection2.default.prototype, 'subscribe').resolves();
  });

  afterEach(() => {
    sandbox.restore();
  });

  /**
   * @test {ConnectionRegistry#connect}
   */
  it('should connect and add connection to registry', async () => {
    let account = { id: 'id', region: 'vint-hill', accountRegions: { 'vint-hill': 'id', 'new-york': 'idReplica' } };
    let connection = registry.connect(account, storage);
    await connection.connect();
    (connection instanceof _streamingMetaApiConnection2.default).should.be.true();
    connection.historyStorage.should.equal(storage);
    _sinon2.default.assert.calledOnce(connection.initialize);
    _sinon2.default.assert.calledOnce(connection.subscribe);
    _sinon2.default.assert.match(registry._connections, _sinon2.default.match.has('id', connection));
  });

  /**
   * @test {ConnectionRegistry#connect}
   */
  it('should return the same connection on second connect if same account id', async () => {
    let accounts = [{ id: 'id0', region: 'vint-hill', accountRegions: { 'vint-hill': 'id0', 'new-york': 'id0Replica' } }, { id: 'id1', region: 'vint-hill', accountRegions: { 'vint-hill': 'id1', 'new-york': 'id1Replica' } }];
    let connection0 = registry.connect(accounts[0], storage);
    let connection02 = registry.connect(accounts[0], storage);
    let connection1 = registry.connect(accounts[1], storage);
    await connection0.connect();
    await connection02.connect();
    await connection1.connect();
    _sinon2.default.assert.called(connection0.initialize);
    _sinon2.default.assert.called(connection0.subscribe);
    _sinon2.default.assert.called(connection1.initialize);
    _sinon2.default.assert.called(connection1.subscribe);
    _sinon2.default.assert.match(registry._connections, _sinon2.default.match.has('id0', connection0));
    _sinon2.default.assert.match(registry._connections, _sinon2.default.match.has('id1', connection1));
    _sinon2.default.assert.match((0, _is2.default)(connection0, connection02), true);
    _sinon2.default.assert.match((0, _is2.default)(connection0, connection1), false);
  });

  /**
   * @test {ConnectionRegistry#remove}
   */
  it('should remove the account from registry', async () => {
    let accounts = [{ id: 'id0', region: 'vint-hill', accountRegions: { 'vint-hill': 'id0', 'new-york': 'id0Replica' } }, { id: 'id1', region: 'vint-hill', accountRegions: { 'vint-hill': 'id1', 'new-york': 'id1Replica' } }];
    let connection0 = await registry.connect(accounts[0], storage);
    let connection1 = await registry.connect(accounts[1], storage);
    _sinon2.default.assert.match(registry._connections, _sinon2.default.match.has('id0', connection0));
    _sinon2.default.assert.match(registry._connections, _sinon2.default.match.has('id1', connection1));
    registry.remove(accounts[0].id);
    _sinon2.default.assert.match(registry._connections.id0, undefined);
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9tZXRhQXBpL2Nvbm5lY3Rpb25SZWdpc3RyeS5zcGVjLmVzNiJdLCJuYW1lcyI6WyJkZXNjcmliZSIsInNhbmRib3giLCJyZWdpc3RyeSIsIm1ldGFBcGlXZWJzb2NrZXRDbGllbnQiLCJhZGRTeW5jaHJvbml6YXRpb25MaXN0ZW5lciIsImFkZFJlY29ubmVjdExpc3RlbmVyIiwic3Vic2NyaWJlIiwicmVnaW9uc0J5QWNjb3VudHMiLCJzdG9yYWdlIiwibGFzdEhpc3RvcnlPcmRlclRpbWUiLCJEYXRlIiwibGFzdERlYWxUaW1lIiwibG9hZERhdGFGcm9tRGlzayIsImRlYWxzIiwiaGlzdG9yeU9yZGVycyIsImJlZm9yZSIsInNpbm9uIiwiY3JlYXRlU2FuZGJveCIsImJlZm9yZUVhY2giLCJDb25uZWN0aW9uUmVnaXN0cnkiLCJzdHViIiwiU3RyZWFtaW5nTWV0YUFwaUNvbm5lY3Rpb24iLCJwcm90b3R5cGUiLCJyZXNvbHZlcyIsImFmdGVyRWFjaCIsInJlc3RvcmUiLCJpdCIsImFjY291bnQiLCJpZCIsInJlZ2lvbiIsImFjY291bnRSZWdpb25zIiwiY29ubmVjdGlvbiIsImNvbm5lY3QiLCJzaG91bGQiLCJiZSIsInRydWUiLCJoaXN0b3J5U3RvcmFnZSIsImVxdWFsIiwiYXNzZXJ0IiwiY2FsbGVkT25jZSIsImluaXRpYWxpemUiLCJtYXRjaCIsIl9jb25uZWN0aW9ucyIsImhhcyIsImFjY291bnRzIiwiY29ubmVjdGlvbjAiLCJjb25uZWN0aW9uMDIiLCJjb25uZWN0aW9uMSIsImNhbGxlZCIsInJlbW92ZSIsImlkMCIsInVuZGVmaW5lZCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztBQUVBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7QUFFQTs7O0FBR0FBLFNBQVMsb0JBQVQsRUFBK0IsTUFBTTs7QUFFbkMsTUFBSUMsT0FBSjtBQUNBLE1BQUlDLFFBQUo7QUFDQSxNQUFJQyx5QkFBeUI7QUFDM0JDLGdDQUE0QixNQUFN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QixDQUF4QjtBQUNBUSxvQkFBTXNCLE1BQU4sQ0FBYUcsS0FBYixDQUFtQnZDLFNBQVN3QyxZQUE1QixFQUEwQzFCLGdCQUFNeUIsS0FBTixDQUFZRSxHQUFaLENBQWdCLEtBQWhCLEVBQXVCRSxXQUF2QixDQUExQztBQUNBN0Isb0JBQU1zQixNQUFOLENBQWFHLEtBQWIsQ0FBbUJ2QyxTQUFTd0MsWUFBNUIsRUFBMEMxQixnQkFBTXlCLEtBQU4sQ0FBWUUsR0FBWixDQUFnQixLQUFoQixFQUF1QkksV0FBdkIsQ0FBMUM7QUFDQTdDLGFBQVMrQyxNQUFULENBQWdCTCxTQUFTLENBQVQsRUFBWWhCLEVBQTVCO0FBQ0FaLG9CQUFNc0IsTUFBTixDQUFhRyxLQUFiLENBQW1CdkMsU0FBU3dDLFlBQVQsQ0FBc0JRLEdBQXpDLEVBQThDQyxTQUE5QztBQUNELEdBVEQ7QUFXRCxDQWhGRCIsImZpbGUiOiJjb25uZWN0aW9uUmVnaXN0cnkuc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IHNob3VsZCBmcm9tICdzaG91bGQnO1xuaW1wb3J0IHNpbm9uIGZyb20gJ3Npbm9uJztcbmltcG9ydCBTdHJlYW1pbmdNZXRhQXBpQ29ubmVjdGlvbiBmcm9tICcuL3N0cmVhbWluZ01ldGFBcGlDb25uZWN0aW9uJztcbmltcG9ydCBDb25uZWN0aW9uUmVnaXN0cnkgZnJvbSAnLi9jb25uZWN0aW9uUmVnaXN0cnknO1xuXG4vKipcbiAqIEB0ZXN0IHtDb25uZWN0aW9uUmVnaXN0cnl9XG4gKi9cbmRlc2NyaWJlKCdDb25uZWN0aW9uUmVnaXN0cnknLCAoKSA9PiB7XG5cbiAgbGV0IHNhbmRib3g7XG4gIGxldCByZWdpc3RyeTtcbiAgbGV0IG1ldGFBcGlXZWJzb2NrZXRDbGllbnQgPSB7XG4gICAgYWRkU3luY2hyb25pemF0aW9uTGlzdGVuZXI6ICgpID0+IHt9LFxuICAgIGFkZFJlY29ubmVjdExpc3RlbmVyOiAoKSA9PiB7fSxcbiAgICBzdWJzY3JpYmU6ICgpID0+IHt9LFxuICAgIHJlZ2lvbnNCeUFjY291bnRzOiB7fVxuICB9O1xuICBsZXQgc3RvcmFnZSA9IHtcbiAgICBsYXN0SGlzdG9yeU9yZGVyVGltZTogKCkgPT4gbmV3IERhdGUoJzIwMjAtMDEtMDFUMDA6MDA6MDAuMDAwWicpLFxuICAgIGxhc3REZWFsVGltZTogKCkgPT4gbmV3IERhdGUoJzIwMjAtMDEtMDJUMDA6MDA6MDAuMDAwWicpLFxuICAgIGxvYWREYXRhRnJvbURpc2s6ICgpID0+ICh7ZGVhbHM6IFtdLCBoaXN0b3J5T3JkZXJzOiBbXX0pXG4gIH07XG5cbiAgYmVmb3JlKCgpID0+IHtcbiAgICBzYW5kYm94ID0gc2lub24uY3JlYXRlU2FuZGJveCgpO1xuICB9KTtcbiAgXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHJlZ2lzdHJ5ID0gbmV3IENvbm5lY3Rpb25SZWdpc3RyeShtZXRhQXBpV2Vic29ja2V0Q2xpZW50KTtcbiAgICBzYW5kYm94LnN0dWIoU3RyZWFtaW5nTWV0YUFwaUNvbm5lY3Rpb24ucHJvdG90eXBlLCAnaW5pdGlhbGl6ZScpLnJlc29sdmVzKCk7XG4gICAgc2FuZGJveC5zdHViKFN0cmVhbWluZ01ldGFBcGlDb25uZWN0aW9uLnByb3RvdHlwZSwgJ3N1YnNjcmliZScpLnJlc29sdmVzKCk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgc2FuZGJveC5yZXN0b3JlKCk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7Q29ubmVjdGlvblJlZ2lzdHJ5I2Nvbm5lY3R9XG4gICAqL1xuICBpdCgnc2hvdWxkIGNvbm5lY3QgYW5kIGFkZCBjb25uZWN0aW9uIHRvIHJlZ2lzdHJ5JywgYXN5bmMgKCkgPT4ge1xuICAgIGxldCBhY2NvdW50ID0ge2lkOiAnaWQnLCByZWdpb246ICd2aW50LWhpbGwnLCBhY2NvdW50UmVnaW9uczogeyd2aW50LWhpbGwnOiAnaWQnLCAnbmV3LXlvcmsnOiAnaWRSZXBsaWNhJ319O1xuICAgIGxldCBjb25uZWN0aW9uID0gcmVnaXN0cnkuY29ubmVjdChhY2NvdW50LCBzdG9yYWdlKTtcbiAgICBhd2FpdCBjb25uZWN0aW9uLmNvbm5lY3QoKTtcbiAgICAoY29ubmVjdGlvbiBpbnN0YW5jZW9mIFN0cmVhbWluZ01ldGFBcGlDb25uZWN0aW9uKS5zaG91bGQuYmUudHJ1ZSgpO1xuICAgIGNvbm5lY3Rpb24uaGlzdG9yeVN0b3JhZ2Uuc2hvdWxkLmVxdWFsKHN0b3JhZ2UpO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRPbmNlKGNvbm5lY3Rpb24uaW5pdGlhbGl6ZSk7XG4gICAgc2lub24uYXNzZXJ0LmNhbGxlZE9uY2UoY29ubmVjdGlvbi5zdWJzY3JpYmUpO1xuICAgIHNpbm9uLmFzc2VydC5tYXRjaChyZWdpc3RyeS5fY29ubmVjdGlvbnMsIHNpbm9uLm1hdGNoLmhhcygnaWQnLCBjb25uZWN0aW9uKSk7XG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAdGVzdCB7Q29ubmVjdGlvblJlZ2lzdHJ5I2Nvbm5lY3R9XG4gICAqL1xuICBpdCgnc2hvdWxkIHJldHVybiB0aGUgc2FtZSBjb25uZWN0aW9uIG9uIHNlY29uZCBjb25uZWN0IGlmIHNhbWUgYWNjb3VudCBpZCcsIGFzeW5jICgpID0+IHtcbiAgICBsZXQgYWNjb3VudHMgPSBbe2lkOiAnaWQwJywgcmVnaW9uOiAndmludC1oaWxsJywgYWNjb3VudFJlZ2lvbnM6IHsndmludC1oaWxsJzogJ2lkMCcsICduZXcteW9yayc6ICdpZDBSZXBsaWNhJ319LCBcbiAgICAgIHtpZDogJ2lkMScsIHJlZ2lvbjogJ3ZpbnQtaGlsbCcsIGFjY291bnRSZWdpb25zOiB7J3ZpbnQtaGlsbCc6ICdpZDEnLCAnbmV3LXlvcmsnOiAnaWQxUmVwbGljYSd9fV07XG4gICAgbGV0IGNvbm5lY3Rpb24wID0gcmVnaXN0cnkuY29ubmVjdChhY2NvdW50c1swXSwgc3RvcmFnZSk7XG4gICAgbGV0IGNvbm5lY3Rpb24wMiA9IHJlZ2lzdHJ5LmNvbm5lY3QoYWNjb3VudHNbMF0sIHN0b3JhZ2UpO1xuICAgIGxldCBjb25uZWN0aW9uMSA9IHJlZ2lzdHJ5LmNvbm5lY3QoYWNjb3VudHNbMV0sIHN0b3JhZ2UpO1xuICAgIGF3YWl0IGNvbm5lY3Rpb24wLmNvbm5lY3QoKTtcbiAgICBhd2FpdCBjb25uZWN0aW9uMDIuY29ubmVjdCgpO1xuICAgIGF3YWl0IGNvbm5lY3Rpb24xLmNvbm5lY3QoKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbGVkKGNvbm5lY3Rpb24wLmluaXRpYWxpemUpO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWQoY29ubmVjdGlvbjAuc3Vic2NyaWJlKTtcbiAgICBzaW5vbi5hc3NlcnQuY2FsbGVkKGNvbm5lY3Rpb24xLmluaXRpYWxpemUpO1xuICAgIHNpbm9uLmFzc2VydC5jYWxsZWQoY29ubmVjdGlvbjEuc3Vic2NyaWJlKTtcbiAgICBzaW5vbi5hc3NlcnQubWF0Y2gocmVnaXN0cnkuX2Nvbm5lY3Rpb25zLCBzaW5vbi5tYXRjaC5oYXMoJ2lkMCcsIGNvbm5lY3Rpb24wKSk7XG4gICAgc2lub24uYXNzZXJ0Lm1hdGNoKHJlZ2lzdHJ5Ll9jb25uZWN0aW9ucywgc2lub24ubWF0Y2guaGFzKCdpZDEnLCBjb25uZWN0aW9uMSkpO1xuICAgIHNpbm9uLmFzc2VydC5tYXRjaChPYmplY3QuaXMoY29ubmVjdGlvbjAsIGNvbm5lY3Rpb24wMiksIHRydWUpO1xuICAgIHNpbm9uLmFzc2VydC5tYXRjaChPYmplY3QuaXMoY29ubmVjdGlvbjAsIGNvbm5lY3Rpb24xKSwgZmFsc2UpO1xuICB9KTtcblxuICAvKipcbiAgICogQHRlc3Qge0Nvbm5lY3Rpb25SZWdpc3RyeSNyZW1vdmV9XG4gICAqL1xuICBpdCgnc2hvdWxkIHJlbW92ZSB0aGUgYWNjb3VudCBmcm9tIHJlZ2lzdHJ5JywgYXN5bmMgKCkgPT4ge1xuICAgIGxldCBhY2NvdW50cyA9IFt7aWQ6ICdpZDAnLCByZWdpb246ICd2aW50LWhpbGwnLCBhY2NvdW50UmVnaW9uczogeyd2aW50LWhpbGwnOiAnaWQwJywgJ25ldy15b3JrJzogJ2lkMFJlcGxpY2EnfX0sIFxuICAgICAge2lkOiAnaWQxJywgcmVnaW9uOiAndmludC1oaWxsJywgYWNjb3VudFJlZ2lvbnM6IHsndmludC1oaWxsJzogJ2lkMScsICduZXcteW9yayc6ICdpZDFSZXBsaWNhJ319XTtcbiAgICBsZXQgY29ubmVjdGlvbjAgPSBhd2FpdCByZWdpc3RyeS5jb25uZWN0KGFjY291bnRzWzBdLCBzdG9yYWdlKTtcbiAgICBsZXQgY29ubmVjdGlvbjEgPSBhd2FpdCByZWdpc3RyeS5jb25uZWN0KGFjY291bnRzWzFdLCBzdG9yYWdlKTtcbiAgICBzaW5vbi5hc3NlcnQubWF0Y2gocmVnaXN0cnkuX2Nvbm5lY3Rpb25zLCBzaW5vbi5tYXRjaC5oYXMoJ2lkMCcsIGNvbm5lY3Rpb24wKSk7XG4gICAgc2lub24uYXNzZXJ0Lm1hdGNoKHJlZ2lzdHJ5Ll9jb25uZWN0aW9ucywgc2lub24ubWF0Y2guaGFzKCdpZDEnLCBjb25uZWN0aW9uMSkpO1xuICAgIHJlZ2lzdHJ5LnJlbW92ZShhY2NvdW50c1swXS5pZCk7XG4gICAgc2lub24uYXNzZXJ0Lm1hdGNoKHJlZ2lzdHJ5Ll9jb25uZWN0aW9ucy5pZDAsIHVuZGVmaW5lZCk7XG4gIH0pO1xuXG59KTtcbiJdfQ==