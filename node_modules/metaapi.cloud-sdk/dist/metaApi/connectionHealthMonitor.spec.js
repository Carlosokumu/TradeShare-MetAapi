'use strict';

var _create = require('babel-runtime/core-js/object/create');

var _create2 = _interopRequireDefault(_create);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _connectionHealthMonitor = require('./connectionHealthMonitor');

var _connectionHealthMonitor2 = _interopRequireDefault(_connectionHealthMonitor);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @test {ConnectionHealthMonitor}
 */
describe('ConnectionHealthMonitor', () => {
  let healthMonitor, sandbox, prices, connection;
  let brokerTimes = ['2020-10-05 09:00:00.000', '2020-10-10 10:00:00.000'];
  let clock, updateInterval;

  before(() => {
    sandbox = _sinon2.default.createSandbox();
    const mockMath = (0, _create2.default)(global.Math);
    mockMath.random = () => 0.4833333;
    global.Math = mockMath;
  });

  beforeEach(() => {
    clock = _sinon2.default.useFakeTimers({
      now: new Date('2020-10-05 10:00:00.000')
    });
    connection = {
      account: { id: 'id' },
      subscribedSymbols: ['EURUSD'],
      terminalState: {
        specification: () => {},
        connected: true,
        connectedToBroker: true
      },
      synchronized: true
    };
    sandbox.stub(connection.terminalState, 'specification').returns({ quoteSessions: { 'MONDAY': [{ from: '08:00:00.000', to: '17:00:00.000' }] } });
    healthMonitor = new _connectionHealthMonitor2.default(connection);
    prices = [{
      symbol: 'EURUSD',
      brokerTime: brokerTimes[0]
    }, {
      symbol: 'EURUSD',
      brokerTime: brokerTimes[1]
    }];
    updateInterval = setInterval(() => healthMonitor.onSymbolPriceUpdated('vint-hill:1:ps-mpa-1', prices[0]), 1000);
  });

  afterEach(() => {
    clock.restore();
    sandbox.restore();
  });

  /**
   * @test {ConnectionHealthMonitor#uptime}
   */
  describe('uptime', () => {

    /**
     * @test {ConnectionHealthMonitor#uptime}
     */
    it('should return 100 uptime', async () => {
      healthMonitor.onSymbolPriceUpdated('vint-hill:1:ps-mpa-1', prices[0]);
      await clock.tickAsync(60000);
      _sinon2.default.assert.match(healthMonitor.uptime, { '1h': 100, '1d': 100, '1w': 100 });
    });

    /**
     * @test {ConnectionHealthMonitor#uptime}
     */
    it('should return average uptime', async () => {
      healthMonitor.onSymbolPriceUpdated('vint-hill:1:ps-mpa-1', prices[0]);
      await clock.tickAsync(31000);
      clearInterval(updateInterval);
      await clock.tickAsync(120000);
      _sinon2.default.assert.match(healthMonitor.uptime, { '1h': 60, '1d': 60, '1w': 60 });
    });

    /**
     * @test {ConnectionHealthMonitor#uptime}
     */
    it('should check connection for downtime', async () => {
      healthMonitor.onSymbolPriceUpdated('vint-hill:1:ps-mpa-1', prices[0]);
      await clock.tickAsync(120000);
      _sinon2.default.assert.match(healthMonitor.uptime, { '1h': 100, '1d': 100, '1w': 100 });
      connection.terminalState.connected = false;
      await clock.tickAsync(120000);
      _sinon2.default.assert.match(healthMonitor.uptime, { '1h': 50, '1d': 50, '1w': 50 });
      connection.terminalState.connected = true;
      connection.terminalState.connectedToBroker = false;
      await clock.tickAsync(240000);
      _sinon2.default.assert.match(healthMonitor.uptime, { '1h': 25, '1d': 25, '1w': 25 });
      connection.terminalState.connectedToBroker = true;
      connection.synchronized = false;
      await clock.tickAsync(120000);
      _sinon2.default.assert.match(healthMonitor.uptime, { '1h': 20, '1d': 20, '1w': 20 });
      connection.synchronized = true;
      await clock.tickAsync(360000);
      _sinon2.default.assert.match(healthMonitor.uptime, { '1h': 50, '1d': 50, '1w': 50 });
    });
  });

  /**
   * @test {ConnectionHealthMonitor#healthStatus}
   */
  describe('healthStatus', () => {

    beforeEach(() => {
      healthMonitor._quotesHealthy = true;
    });

    /**
     * @test {ConnectionHealthMonitor#healthStatus}
     */
    it('should return ok status', async () => {
      _sinon2.default.assert.match(healthMonitor.healthStatus, {
        connected: true,
        connectedToBroker: true,
        healthy: true,
        message: 'Connection to broker is stable. No health issues detected.',
        quoteStreamingHealthy: true,
        synchronized: true
      });
    });

    /**
     * @test {ConnectionHealthMonitor#healthStatus}
     */
    it('should return error status with one message', async () => {
      connection.terminalState.connectedToBroker = false;
      _sinon2.default.assert.match(healthMonitor.healthStatus, {
        connected: true,
        connectedToBroker: false,
        healthy: false,
        message: 'Connection is not healthy because connection to broker is not established or lost.',
        quoteStreamingHealthy: true,
        synchronized: true
      });
    });

    /**
     * @test {ConnectionHealthMonitor#healthStatus}
     */
    it('should return error status with multiple messages', async () => {
      connection.terminalState.connected = false;
      connection.terminalState.connectedToBroker = false;
      connection.synchronized = false;
      _sinon2.default.assert.match(healthMonitor.healthStatus, {
        connected: false,
        connectedToBroker: false,
        healthy: false,
        message: 'Connection is not healthy because connection to API server is not established or lost and ' + 'connection to broker is not established or lost ' + 'and local terminal state is not synchronized to broker.',
        quoteStreamingHealthy: true,
        synchronized: false
      });
    });

    /**
     * @test {ConnectionHealthMonitor#healthStatus}
     */
    it('should show as healthy if recently updated and in session', async () => {
      healthMonitor.onSymbolPriceUpdated('vint-hill:1:ps-mpa-1', prices[0]);
      await clock.tickAsync(91000);
      _sinon2.default.assert.match(healthMonitor.healthStatus.quoteStreamingHealthy, true);
    });

    /**
     * @test {ConnectionHealthMonitor#healthStatus}
     */
    it('should show as not healthy if old update and in session', async () => {
      healthMonitor.onSymbolPriceUpdated('vint-hill:1:ps-mpa-1', prices[0]);
      clearInterval(updateInterval);
      await clock.tickAsync(91000);
      _sinon2.default.assert.match(healthMonitor.healthStatus.quoteStreamingHealthy, false);
    });

    /**
     * @test {ConnectionHealthMonitor#healthStatus}
     */
    it('should show as healthy if not in session', async () => {
      healthMonitor.onSymbolPriceUpdated('vint-hill:1:ps-mpa-1', prices[1]);
      clearInterval(updateInterval);
      await clock.tickAsync(91000);
      _sinon2.default.assert.match(healthMonitor.healthStatus.quoteStreamingHealthy, true);
    });

    /**
     * @test {ConnectionHealthMonitor#healthStatus}
     */
    it('should show as healthy if no symbols', async () => {
      healthMonitor._connection.subscribedSymbols = [];
      healthMonitor.onSymbolPriceUpdated('vint-hill:1:ps-mpa-1', prices[0]);
      clearInterval(updateInterval);
      await clock.tickAsync(91000);
      _sinon2.default.assert.match(healthMonitor.healthStatus.quoteStreamingHealthy, true);
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9tZXRhQXBpL2Nvbm5lY3Rpb25IZWFsdGhNb25pdG9yLnNwZWMuZXM2Il0sIm5hbWVzIjpbImRlc2NyaWJlIiwiaGVhbHRoTW9uaXRvciIsInNhbmRib3giLCJwcmljZXMiLCJjb25uZWN0aW9uIiwiYnJva2VyVGltZXMiLCJjbG9jayIsInVwZGF0ZUludGVydmFsIiwiYmVmb3JlIiwic2lub24iLCJjcmVhdGVTYW5kYm94IiwibW9ja01hdGgiLCJnbG9iYWwiLCJNYXRoIiwicmFuZG9tIiwiYmVmb3JlRWFjaCIsInVzZUZha2VUaW1lcnMiLCJub3ciLCJEYXRlIiwiYWNjb3VudCIsImlkIiwic3Vic2NyaWJlZFN5bWJvbHMiLCJ0ZXJtaW5hbFN0YXRlIiwic3BlY2lmaWNhdGlvbiIsImNvbm5lY3RlZCIsImNvbm5lY3RlZFRvQnJva2VyIiwic3luY2hyb25pemVkIiwic3R1YiIsInJldHVybnMiLCJxdW90ZVNlc3Npb25zIiwiZnJvbSIsInRvIiwiQ29ubmVjdGlvbkhlYWx0aE1vbml0b3IiLCJzeW1ib2wiLCJicm9rZXJUaW1lIiwic2V0SW50ZXJ2YWwiLCJvblN5bWJvbFByaWNlVXBkYXRlZCIsImFmdGVyRWFjaCIsInJlc3RvcmUiLCJpdCIsInRpY2tBc3luYyIsImFzc2VydCIsIm1hdGNoIiwidXB0aW1lIiwiY2xlYXJJbnRlcnZhbCIsIl9xdW90ZXNIZWFsdGh5IiwiaGVhbHRoU3RhdHVzIiwiaGVhbHRoeSIsIm1lc3NhZ2UiLCJxdW90ZVN0cmVhbWluZ0hlYWx0aHkiLCJfY29ubmVjdGlvbiJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztBQUVBOzs7O0FBQ0E7Ozs7OztBQUVBOzs7QUFHQUEsU0FBUyx5QkFBVCxFQUFvQyxNQUFNO0FBQ3hDLE1BQUlDLGFBQUosRUFBbUJDLE9BQW5CLEVBQTRCQyxNQUE1QixFQUFvQ0MsVUFBcEM7QUFDQSxNQUFJQyxjQUFjLENBQUMseUJBQUQsRUFBNEIseUJBQTVCLENBQWxCO0FBQ0EsTUFBSUMs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Q0FBUCxDQUEzRDtBQUNBeUMsb0JBQWNyQyxjQUFkO0FBQ0EsWUFBTUQsTUFBTWtDLFNBQU4sQ0FBZ0IsS0FBaEIsQ0FBTjtBQUNBL0Isc0JBQU1nQyxNQUFOLENBQWFDLEtBQWIsQ0FBbUJ6QyxjQUFjNkMsWUFBZCxDQUEyQkcscUJBQTlDLEVBQXFFLElBQXJFO0FBQ0QsS0FORDtBQVFELEdBOUZEO0FBZ0dELENBbE1EIiwiZmlsZSI6ImNvbm5lY3Rpb25IZWFsdGhNb25pdG9yLnNwZWMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCBzaW5vbiBmcm9tICdzaW5vbic7XG5pbXBvcnQgQ29ubmVjdGlvbkhlYWx0aE1vbml0b3IgZnJvbSAnLi9jb25uZWN0aW9uSGVhbHRoTW9uaXRvcic7XG5cbi8qKlxuICogQHRlc3Qge0Nvbm5lY3Rpb25IZWFsdGhNb25pdG9yfVxuICovXG5kZXNjcmliZSgnQ29ubmVjdGlvbkhlYWx0aE1vbml0b3InLCAoKSA9PiB7XG4gIGxldCBoZWFsdGhNb25pdG9yLCBzYW5kYm94LCBwcmljZXMsIGNvbm5lY3Rpb247XG4gIGxldCBicm9rZXJUaW1lcyA9IFsnMjAyMC0xMC0wNSAwOTowMDowMC4wMDAnLCAnMjAyMC0xMC0xMCAxMDowMDowMC4wMDAnXTsgXG4gIGxldCBjbG9jaywgdXBkYXRlSW50ZXJ2YWw7XG5cbiAgYmVmb3JlKCgpID0+IHtcbiAgICBzYW5kYm94ID0gc2lub24uY3JlYXRlU2FuZGJveCgpO1xuICAgIGNvbnN0IG1vY2tNYXRoID0gT2JqZWN0LmNyZWF0ZShnbG9iYWwuTWF0aCk7XG4gICAgbW9ja01hdGgucmFuZG9tID0gKCkgPT4gMC40ODMzMzMzO1xuICAgIGdsb2JhbC5NYXRoID0gbW9ja01hdGg7XG4gIH0pO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGNsb2NrID0gc2lub24udXNlRmFrZVRpbWVycyh7XG4gICAgICBub3c6IG5ldyBEYXRlKCcyMDIwLTEwLTA1IDEwOjAwOjAwLjAwMCcpXG4gICAgfSk7XG4gICAgY29ubmVjdGlvbiA9IHtcbiAgICAgIGFjY291bnQ6IHtpZDogJ2lkJ30sXG4gICAgICBzdWJzY3JpYmVkU3ltYm9sczogWydFVVJVU0QnXSxcbiAgICAgIHRlcm1pbmFsU3RhdGU6IHtcbiAgICAgICAgc3BlY2lmaWNhdGlvbjogKCkgPT4ge30sXG4gICAgICAgIGNvbm5lY3RlZDogdHJ1ZSxcbiAgICAgICAgY29ubmVjdGVkVG9Ccm9rZXI6IHRydWUsXG4gICAgICB9LFxuICAgICAgc3luY2hyb25pemVkOiB0cnVlXG4gICAgfTtcbiAgICBzYW5kYm94LnN0dWIoY29ubmVjdGlvbi50ZXJtaW5hbFN0YXRlLCAnc3BlY2lmaWNhdGlvbicpXG4gICAgICAucmV0dXJucyh7cXVvdGVTZXNzaW9uczogeydNT05EQVknOiBbe2Zyb206ICcwODowMDowMC4wMDAnLCB0bzogJzE3OjAwOjAwLjAwMCd9XX19KTtcbiAgICBoZWFsdGhNb25pdG9yID0gbmV3IENvbm5lY3Rpb25IZWFsdGhNb25pdG9yKGNvbm5lY3Rpb24pO1xuICAgIHByaWNlcyA9IFt7XG4gICAgICBzeW1ib2w6ICdFVVJVU0QnLFxuICAgICAgYnJva2VyVGltZTogYnJva2VyVGltZXNbMF0sXG4gICAgfSxcbiAgICB7XG4gICAgICBzeW1ib2w6ICdFVVJVU0QnLFxuICAgICAgYnJva2VyVGltZTogYnJva2VyVGltZXNbMV0sXG4gICAgfV07XG4gICAgdXBkYXRlSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiBoZWFsdGhNb25pdG9yLm9uU3ltYm9sUHJpY2VVcGRhdGVkKCd2aW50LWhpbGw6MTpwcy1tcGEtMScsIHByaWNlc1swXSksIDEwMDApO1xuICB9KTtcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIGNsb2NrLnJlc3RvcmUoKTtcbiAgICBzYW5kYm94LnJlc3RvcmUoKTtcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtDb25uZWN0aW9uSGVhbHRoTW9uaXRvciN1cHRpbWV9XG4gICAqL1xuICBkZXNjcmliZSgndXB0aW1lJywgKCkgPT4ge1xuXG4gICAgLyoqXG4gICAgICogQHRlc3Qge0Nvbm5lY3Rpb25IZWFsdGhNb25pdG9yI3VwdGltZX1cbiAgICAgKi9cbiAgICBpdCgnc2hvdWxkIHJldHVybiAxMDAgdXB0aW1lJywgYXN5bmMgKCkgPT4ge1xuICAgICAgaGVhbHRoTW9uaXRvci5vblN5bWJvbFByaWNlVXBkYXRlZCgndmludC1oaWxsOjE6cHMtbXBhLTEnLCBwcmljZXNbMF0pO1xuICAgICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDYwMDAwKTtcbiAgICAgIHNpbm9uLmFzc2VydC5tYXRjaChoZWFsdGhNb25pdG9yLnVwdGltZSwgeycxaCc6IDEwMCwgJzFkJzogMTAwLCAnMXcnOiAxMDB9KTtcbiAgICB9KTtcblxuICAgIC8qKlxuICAgICAqIEB0ZXN0IHtDb25uZWN0aW9uSGVhbHRoTW9uaXRvciN1cHRpbWV9XG4gICAgICovXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gYXZlcmFnZSB1cHRpbWUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBoZWFsdGhNb25pdG9yLm9uU3ltYm9sUHJpY2VVcGRhdGVkKCd2aW50LWhpbGw6MTpwcy1tcGEtMScsIHByaWNlc1swXSk7XG4gICAgICBhd2FpdCBjbG9jay50aWNrQXN5bmMoMzEwMDApO1xuICAgICAgY2xlYXJJbnRlcnZhbCh1cGRhdGVJbnRlcnZhbCk7XG4gICAgICBhd2FpdCBjbG9jay50aWNrQXN5bmMoMTIwMDAwKTtcbiAgICAgIHNpbm9uLmFzc2VydC5tYXRjaChoZWFsdGhNb25pdG9yLnVwdGltZSwgeycxaCc6IDYwLCAnMWQnOiA2MCwgJzF3JzogNjB9KTtcbiAgICB9KTtcblxuICAgIC8qKlxuICAgICAqIEB0ZXN0IHtDb25uZWN0aW9uSGVhbHRoTW9uaXRvciN1cHRpbWV9XG4gICAgICovXG4gICAgaXQoJ3Nob3VsZCBjaGVjayBjb25uZWN0aW9uIGZvciBkb3dudGltZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGhlYWx0aE1vbml0b3Iub25TeW1ib2xQcmljZVVwZGF0ZWQoJ3ZpbnQtaGlsbDoxOnBzLW1wYS0xJywgcHJpY2VzWzBdKTtcbiAgICAgIGF3YWl0IGNsb2NrLnRpY2tBc3luYygxMjAwMDApO1xuICAgICAgc2lub24uYXNzZXJ0Lm1hdGNoKGhlYWx0aE1vbml0b3IudXB0aW1lLCB7JzFoJzogMTAwLCAnMWQnOiAxMDAsICcxdyc6IDEwMH0pO1xuICAgICAgY29ubmVjdGlvbi50ZXJtaW5hbFN0YXRlLmNvbm5lY3RlZCA9IGZhbHNlO1xuICAgICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDEyMDAwMCk7XG4gICAgICBzaW5vbi5hc3NlcnQubWF0Y2goaGVhbHRoTW9uaXRvci51cHRpbWUsIHsnMWgnOiA1MCwgJzFkJzogNTAsICcxdyc6IDUwfSk7XG4gICAgICBjb25uZWN0aW9uLnRlcm1pbmFsU3RhdGUuY29ubmVjdGVkID0gdHJ1ZTtcbiAgICAgIGNvbm5lY3Rpb24udGVybWluYWxTdGF0ZS5jb25uZWN0ZWRUb0Jyb2tlciA9IGZhbHNlO1xuICAgICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDI0MDAwMCk7XG4gICAgICBzaW5vbi5hc3NlcnQubWF0Y2goaGVhbHRoTW9uaXRvci51cHRpbWUsIHsnMWgnOiAyNSwgJzFkJzogMjUsICcxdyc6IDI1fSk7XG4gICAgICBjb25uZWN0aW9uLnRlcm1pbmFsU3RhdGUuY29ubmVjdGVkVG9Ccm9rZXIgPSB0cnVlO1xuICAgICAgY29ubmVjdGlvbi5zeW5jaHJvbml6ZWQgPSBmYWxzZTtcbiAgICAgIGF3YWl0IGNsb2NrLnRpY2tBc3luYygxMjAwMDApO1xuICAgICAgc2lub24uYXNzZXJ0Lm1hdGNoKGhlYWx0aE1vbml0b3IudXB0aW1lLCB7JzFoJzogMjAsICcxZCc6IDIwLCAnMXcnOiAyMH0pO1xuICAgICAgY29ubmVjdGlvbi5zeW5jaHJvbml6ZWQgPSB0cnVlO1xuICAgICAgYXdhaXQgY2xvY2sudGlja0FzeW5jKDM2MDAwMCk7XG4gICAgICBzaW5vbi5hc3NlcnQubWF0Y2goaGVhbHRoTW9uaXRvci51cHRpbWUsIHsnMWgnOiA1MCwgJzFkJzogNTAsICcxdyc6IDUwfSk7XG4gICAgfSk7XG5cbiAgfSk7XG5cbiAgLyoqXG4gICAqIEB0ZXN0IHtDb25uZWN0aW9uSGVhbHRoTW9uaXRvciNoZWFsdGhTdGF0dXN9XG4gICAqL1xuICBkZXNjcmliZSgnaGVhbHRoU3RhdHVzJywgKCkgPT4ge1xuXG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICBoZWFsdGhNb25pdG9yLl9xdW90ZXNIZWFsdGh5ID0gdHJ1ZTtcbiAgICB9KTtcblxuICAgIC8qKlxuICAgICAqIEB0ZXN0IHtDb25uZWN0aW9uSGVhbHRoTW9uaXRvciNoZWFsdGhTdGF0dXN9XG4gICAgICovXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gb2sgc3RhdHVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgc2lub24uYXNzZXJ0Lm1hdGNoKGhlYWx0aE1vbml0b3IuaGVhbHRoU3RhdHVzLCB7XG4gICAgICAgIGNvbm5lY3RlZDogdHJ1ZSxcbiAgICAgICAgY29ubmVjdGVkVG9Ccm9rZXI6IHRydWUsXG4gICAgICAgIGhlYWx0aHk6IHRydWUsXG4gICAgICAgIG1lc3NhZ2U6ICdDb25uZWN0aW9uIHRvIGJyb2tlciBpcyBzdGFibGUuIE5vIGhlYWx0aCBpc3N1ZXMgZGV0ZWN0ZWQuJyxcbiAgICAgICAgcXVvdGVTdHJlYW1pbmdIZWFsdGh5OiB0cnVlLFxuICAgICAgICBzeW5jaHJvbml6ZWQ6IHRydWVcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgLyoqXG4gICAgICogQHRlc3Qge0Nvbm5lY3Rpb25IZWFsdGhNb25pdG9yI2hlYWx0aFN0YXR1c31cbiAgICAgKi9cbiAgICBpdCgnc2hvdWxkIHJldHVybiBlcnJvciBzdGF0dXMgd2l0aCBvbmUgbWVzc2FnZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbm5lY3Rpb24udGVybWluYWxTdGF0ZS5jb25uZWN0ZWRUb0Jyb2tlciA9IGZhbHNlO1xuICAgICAgc2lub24uYXNzZXJ0Lm1hdGNoKGhlYWx0aE1vbml0b3IuaGVhbHRoU3RhdHVzLCB7XG4gICAgICAgIGNvbm5lY3RlZDogdHJ1ZSxcbiAgICAgICAgY29ubmVjdGVkVG9Ccm9rZXI6IGZhbHNlLFxuICAgICAgICBoZWFsdGh5OiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogJ0Nvbm5lY3Rpb24gaXMgbm90IGhlYWx0aHkgYmVjYXVzZSBjb25uZWN0aW9uIHRvIGJyb2tlciBpcyBub3QgZXN0YWJsaXNoZWQgb3IgbG9zdC4nLFxuICAgICAgICBxdW90ZVN0cmVhbWluZ0hlYWx0aHk6IHRydWUsXG4gICAgICAgIHN5bmNocm9uaXplZDogdHJ1ZVxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICAvKipcbiAgICAgKiBAdGVzdCB7Q29ubmVjdGlvbkhlYWx0aE1vbml0b3IjaGVhbHRoU3RhdHVzfVxuICAgICAqL1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIGVycm9yIHN0YXR1cyB3aXRoIG11bHRpcGxlIG1lc3NhZ2VzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29ubmVjdGlvbi50ZXJtaW5hbFN0YXRlLmNvbm5lY3RlZCA9IGZhbHNlO1xuICAgICAgY29ubmVjdGlvbi50ZXJtaW5hbFN0YXRlLmNvbm5lY3RlZFRvQnJva2VyID0gZmFsc2U7XG4gICAgICBjb25uZWN0aW9uLnN5bmNocm9uaXplZCA9IGZhbHNlO1xuICAgICAgc2lub24uYXNzZXJ0Lm1hdGNoKGhlYWx0aE1vbml0b3IuaGVhbHRoU3RhdHVzLCB7XG4gICAgICAgIGNvbm5lY3RlZDogZmFsc2UsXG4gICAgICAgIGNvbm5lY3RlZFRvQnJva2VyOiBmYWxzZSxcbiAgICAgICAgaGVhbHRoeTogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2U6ICdDb25uZWN0aW9uIGlzIG5vdCBoZWFsdGh5IGJlY2F1c2UgY29ubmVjdGlvbiB0byBBUEkgc2VydmVyIGlzIG5vdCBlc3RhYmxpc2hlZCBvciBsb3N0IGFuZCAnICtcbiAgICAgICAgICAgICdjb25uZWN0aW9uIHRvIGJyb2tlciBpcyBub3QgZXN0YWJsaXNoZWQgb3IgbG9zdCAnICtcbiAgICAgICAgICAgICdhbmQgbG9jYWwgdGVybWluYWwgc3RhdGUgaXMgbm90IHN5bmNocm9uaXplZCB0byBicm9rZXIuJyxcbiAgICAgICAgcXVvdGVTdHJlYW1pbmdIZWFsdGh5OiB0cnVlLFxuICAgICAgICBzeW5jaHJvbml6ZWQ6IGZhbHNlXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIC8qKlxuICAgICAqIEB0ZXN0IHtDb25uZWN0aW9uSGVhbHRoTW9uaXRvciNoZWFsdGhTdGF0dXN9XG4gICAgICovXG4gICAgaXQoJ3Nob3VsZCBzaG93IGFzIGhlYWx0aHkgaWYgcmVjZW50bHkgdXBkYXRlZCBhbmQgaW4gc2Vzc2lvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGhlYWx0aE1vbml0b3Iub25TeW1ib2xQcmljZVVwZGF0ZWQoJ3ZpbnQtaGlsbDoxOnBzLW1wYS0xJywgcHJpY2VzWzBdKTtcbiAgICAgIGF3YWl0IGNsb2NrLnRpY2tBc3luYyg5MTAwMCk7XG4gICAgICBzaW5vbi5hc3NlcnQubWF0Y2goaGVhbHRoTW9uaXRvci5oZWFsdGhTdGF0dXMucXVvdGVTdHJlYW1pbmdIZWFsdGh5LCB0cnVlKTtcbiAgICB9KTtcbiAgICBcbiAgICAvKipcbiAgICAgKiBAdGVzdCB7Q29ubmVjdGlvbkhlYWx0aE1vbml0b3IjaGVhbHRoU3RhdHVzfVxuICAgICAqL1xuICAgIGl0KCdzaG91bGQgc2hvdyBhcyBub3QgaGVhbHRoeSBpZiBvbGQgdXBkYXRlIGFuZCBpbiBzZXNzaW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgaGVhbHRoTW9uaXRvci5vblN5bWJvbFByaWNlVXBkYXRlZCgndmludC1oaWxsOjE6cHMtbXBhLTEnLCBwcmljZXNbMF0pO1xuICAgICAgY2xlYXJJbnRlcnZhbCh1cGRhdGVJbnRlcnZhbCk7XG4gICAgICBhd2FpdCBjbG9jay50aWNrQXN5bmMoOTEwMDApO1xuICAgICAgc2lub24uYXNzZXJ0Lm1hdGNoKGhlYWx0aE1vbml0b3IuaGVhbHRoU3RhdHVzLnF1b3RlU3RyZWFtaW5nSGVhbHRoeSwgZmFsc2UpO1xuICAgIH0pO1xuICAgIFxuICAgIC8qKlxuICAgICAqIEB0ZXN0IHtDb25uZWN0aW9uSGVhbHRoTW9uaXRvciNoZWFsdGhTdGF0dXN9XG4gICAgICovXG4gICAgaXQoJ3Nob3VsZCBzaG93IGFzIGhlYWx0aHkgaWYgbm90IGluIHNlc3Npb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICBoZWFsdGhNb25pdG9yLm9uU3ltYm9sUHJpY2VVcGRhdGVkKCd2aW50LWhpbGw6MTpwcy1tcGEtMScsIHByaWNlc1sxXSk7XG4gICAgICBjbGVhckludGVydmFsKHVwZGF0ZUludGVydmFsKTtcbiAgICAgIGF3YWl0IGNsb2NrLnRpY2tBc3luYyg5MTAwMCk7XG4gICAgICBzaW5vbi5hc3NlcnQubWF0Y2goaGVhbHRoTW9uaXRvci5oZWFsdGhTdGF0dXMucXVvdGVTdHJlYW1pbmdIZWFsdGh5LCB0cnVlKTtcbiAgICB9KTtcbiAgICBcbiAgICAvKipcbiAgICAgKiBAdGVzdCB7Q29ubmVjdGlvbkhlYWx0aE1vbml0b3IjaGVhbHRoU3RhdHVzfVxuICAgICAqL1xuICAgIGl0KCdzaG91bGQgc2hvdyBhcyBoZWFsdGh5IGlmIG5vIHN5bWJvbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBoZWFsdGhNb25pdG9yLl9jb25uZWN0aW9uLnN1YnNjcmliZWRTeW1ib2xzID0gW107XG4gICAgICBoZWFsdGhNb25pdG9yLm9uU3ltYm9sUHJpY2VVcGRhdGVkKCd2aW50LWhpbGw6MTpwcy1tcGEtMScsIHByaWNlc1swXSk7XG4gICAgICBjbGVhckludGVydmFsKHVwZGF0ZUludGVydmFsKTtcbiAgICAgIGF3YWl0IGNsb2NrLnRpY2tBc3luYyg5MTAwMCk7XG4gICAgICBzaW5vbi5hc3NlcnQubWF0Y2goaGVhbHRoTW9uaXRvci5oZWFsdGhTdGF0dXMucXVvdGVTdHJlYW1pbmdIZWFsdGh5LCB0cnVlKTtcbiAgICB9KTtcblxuICB9KTtcbiAgXG59KTtcbiJdfQ==