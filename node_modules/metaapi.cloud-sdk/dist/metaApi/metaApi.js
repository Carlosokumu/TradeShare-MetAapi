'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _httpClient = require('../clients/httpClient');

var _httpClient2 = _interopRequireDefault(_httpClient);

var _provisioningProfile = require('../clients/metaApi/provisioningProfile.client');

var _provisioningProfile2 = _interopRequireDefault(_provisioningProfile);

var _provisioningProfileApi = require('./provisioningProfileApi');

var _provisioningProfileApi2 = _interopRequireDefault(_provisioningProfileApi);

var _metaApiWebsocket = require('../clients/metaApi/metaApiWebsocket.client');

var _metaApiWebsocket2 = _interopRequireDefault(_metaApiWebsocket);

var _metatraderAccountApi = require('./metatraderAccountApi');

var _metatraderAccountApi2 = _interopRequireDefault(_metatraderAccountApi);

var _metatraderAccount = require('../clients/metaApi/metatraderAccount.client');

var _metatraderAccount2 = _interopRequireDefault(_metatraderAccount);

var _metatraderAccountGeneratorApi = require('./metatraderAccountGeneratorApi');

var _metatraderAccountGeneratorApi2 = _interopRequireDefault(_metatraderAccountGeneratorApi);

var _metatraderAccountGenerator = require('../clients/metaApi/metatraderAccountGenerator.client');

var _metatraderAccountGenerator2 = _interopRequireDefault(_metatraderAccountGenerator);

var _historicalMarketData = require('../clients/metaApi/historicalMarketData.client');

var _historicalMarketData2 = _interopRequireDefault(_historicalMarketData);

var _clientApi = require('../clients/metaApi/clientApi.client');

var _clientApi2 = _interopRequireDefault(_clientApi);

var _connectionRegistry = require('./connectionRegistry');

var _connectionRegistry2 = _interopRequireDefault(_connectionRegistry);

var _errorHandler = require('../clients/errorHandler');

var _optionsValidator = require('../clients/optionsValidator');

var _optionsValidator2 = _interopRequireDefault(_optionsValidator);

var _latencyMonitor = require('./latencyMonitor');

var _latencyMonitor2 = _interopRequireDefault(_latencyMonitor);

var _expertAdvisor = require('../clients/metaApi/expertAdvisor.client');

var _expertAdvisor2 = _interopRequireDefault(_expertAdvisor);

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _domain = require('../clients/domain.client');

var _domain2 = _interopRequireDefault(_domain);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Request retry options
 * @typedef {Object} RetryOpts
 * @property {Number} [retries] maximum amount of request retries, default value is 5
 * @property {Number} [minDelayInSeconds] minimum delay in seconds until request retry, default value is 1
 * @property {Number} [maxDelayInSeconds] maximum delay in seconds until request retry, default value is 30
 */

/**
 * Subscriptions refresh options
 * @typedef {Object} RefreshSubscriptionsOpts
 * @property {Number} [minDelayInSeconds] minimum delay in seconds until subscriptions refresh request,
 * default value is 1
 * @property {Number} [maxDelayInSeconds] maximum delay in seconds until subscriptions refresh request,
 * default value is 600
 */

/**
 * MetaApi options
 * @typedef {Object} MetaApiOpts
 * @property {String} [application] application id
 * @property {String} [domain] domain to connect to, default is agiliumtrade.agiliumtrade.ai
 * @property {String} [region] region to connect to
 * @property {Number} [requestTimeout] timeout for socket requests in seconds
 * @property {Number} [connectTimeout] timeout for connecting to server in seconds
 * @property {Number} [packetOrderingTimeout] packet ordering timeout in seconds
 * @property {PacketLoggerOpts} [packetLogger] packet logger options
 * @property {Boolean} [enableLatencyMonitor] an option to enable latency tracking
 * @property {Boolean} [enableLatencyTracking] an option to enable latency tracking
 * @property {SynchronizationThrottlerOpts} [synchronizationThrottler] options for synchronization throttler
 * @property {RetryOpts} [retryOpts] options for request retries
 * @property {Boolean} [useSharedClientApi] option to use a shared server
 * @property {RefreshSubscriptionsOpts} [refreshSubscriptionsOpts] subscriptions refresh options
 * @property {Number} [unsubscribeThrottlingIntervalInSeconds] a timeout in seconds for throttling repeat unsubscribe
 * requests when synchronization packets still arrive after unsubscription, default is 10 seconds
 * @property {number} [accountGeneratorRequestTimeout] MT account generator API request timeout. Default is 4 minutes
 */

/**
 * MetaApi MetaTrader API SDK
 */
class MetaApi {

  /**
   * Enables using Log4js logger with extended log levels for debugging instead of
   * console.* functions. Note that log4js configuration performed by the user.
   */
  static enableLog4jsLogging() {
    _logger2.default.useLog4js();
  }

  /**
   * Constructs MetaApi class instance
   * @param {String} token authorization token
   * @param {MetaApiOpts} opts application options
   */
  // eslint-disable-next-line complexity
  constructor(token, opts) {
    const validator = new _optionsValidator2.default();
    opts = opts || {};
    const application = opts.application || 'MetaApi';
    const domain = opts.domain || 'agiliumtrade.agiliumtrade.ai';
    const requestTimeout = validator.validateNonZero(opts.requestTimeout, 60, 'requestTimeout');
    const historicalMarketDataRequestTimeout = validator.validateNonZero(opts.historicalMarketDataRequestTimeout, 240, 'historicalMarketDataRequestTimeout');
    const connectTimeout = validator.validateNonZero(opts.connectTimeout, 60, 'connectTimeout');
    const packetOrderingTimeout = validator.validateNonZero(opts.packetOrderingTimeout, 60, 'packetOrderingTimeout');
    const retryOpts = opts.retryOpts || {};
    const packetLogger = opts.packetLogger || {};
    const synchronizationThrottler = opts.synchronizationThrottler || {};
    const accountGeneratorRequestTimeout = validator.validateNonZero(opts.accountGeneratorRequestTimeout, 240, 'accountGeneratorRequestTimeout');
    if (!application.match(/[a-zA-Z0-9_]+/)) {
      throw new _errorHandler.ValidationError('Application name must be non-empty string consisting from letters, digits and _ only');
    }
    const useSharedClientApi = opts.useSharedClientApi || false;
    const refreshSubscriptionsOpts = opts.refreshSubscriptionsOpts || {};
    const httpClient = new _httpClient2.default(requestTimeout, retryOpts);
    const domainClient = new _domain2.default(httpClient, token, domain);
    const historicalMarketDataHttpClient = new _httpClient2.default(historicalMarketDataRequestTimeout, retryOpts);
    const accountGeneratorHttpClient = new _httpClient2.default(accountGeneratorRequestTimeout, retryOpts);
    const clientApiClient = new _clientApi2.default(httpClient, domainClient);
    this._metaApiWebsocketClient = new _metaApiWebsocket2.default(domainClient, token, { application, domain,
      requestTimeout, connectTimeout, packetLogger, packetOrderingTimeout, synchronizationThrottler, retryOpts,
      useSharedClientApi, region: opts.region,
      unsubscribeThrottlingIntervalInSeconds: opts.unsubscribeThrottlingIntervalInSeconds });
    this._provisioningProfileApi = new _provisioningProfileApi2.default(new _provisioningProfile2.default(httpClient, domainClient));
    this._connectionRegistry = new _connectionRegistry2.default(this._metaApiWebsocketClient, clientApiClient, application, refreshSubscriptionsOpts);
    let historicalMarketDataClient = new _historicalMarketData2.default(historicalMarketDataHttpClient, domainClient);
    this._metatraderAccountApi = new _metatraderAccountApi2.default(new _metatraderAccount2.default(httpClient, domainClient), this._metaApiWebsocketClient, this._connectionRegistry, new _expertAdvisor2.default(httpClient, domainClient), historicalMarketDataClient, application);
    this._metatraderAccountGeneratorApi = new _metatraderAccountGeneratorApi2.default(new _metatraderAccountGenerator2.default(accountGeneratorHttpClient, domainClient));
    if (opts.enableLatencyTracking || opts.enableLatencyMonitor) {
      this._latencyMonitor = new _latencyMonitor2.default();
      this._metaApiWebsocketClient.addLatencyListener(this._latencyMonitor);
    }
  }

  /**
   * Returns provisioning profile API
   * @returns {ProvisioningProfileApi} provisioning profile API
   */
  get provisioningProfileApi() {
    return this._provisioningProfileApi;
  }

  /**
   * Returns MetaTrader account API
   * @return {MetatraderAccountApi} MetaTrader account API
   */
  get metatraderAccountApi() {
    return this._metatraderAccountApi;
  }

  /**
   * Returns MetaTrader account generator API
   * @return {MetatraderDemoAccountApi} MetaTrader account generator API
   */
  get metatraderAccountGeneratorApi() {
    return this._metatraderAccountGeneratorApi;
  }

  /**
   * Returns MetaApi application latency monitor
   * @return {LatencyMonitor} latency monitor
   */
  get latencyMonitor() {
    return this._latencyMonitor;
  }

  /**
   * Closes all clients and connections
   */
  close() {
    this._metaApiWebsocketClient.removeLatencyListener(this._latencyMonitor);
    this._metaApiWebsocketClient.close();
  }

}
exports.default = MetaApi;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9tZXRhQXBpL21ldGFBcGkuZXM2Il0sIm5hbWVzIjpbIk1ldGFBcGkiLCJlbmFibGVMb2c0anNMb2dnaW5nIiwiTG9nZ2VyTWFuYWdlciIsInVzZUxvZzRqcyIsImNvbnN0cnVjdG9yIiwidG9rZW4iLCJvcHRzIiwidmFsaWRhdG9yIiwiT3B0aW9uc1ZhbGlkYXRvciIsImFwcGxpY2F0aW9uIiwiZG9tYWluIiwicmVxdWVzdFRpbWVvdXQiLCJ2YWxpZGF0ZU5vblplcm8iLCJoaXN0b3JpY2FsTWFya2V0RGF0YVJlcXVlc3RUaW1lb3V0IiwiY29ubmVjdFRpbWVvdXQiLCJwYWNrZXRPcmRlcmluZ1RpbWVvdXQiLCJyZXRyeU9wdHMiLCJwYWNrZXRMb2dnZXIiLCJzeW5jaHJvbml6YXRpb25UaHJvdHRsZXIiLCJhY2NvdW50R2VuZXJhdG9yUmVxdWVzdFRpbWVvdXQiLCJtYXRjaCIsIlZhbGlkYXRpb25FcnJvciIsInVzZVNoYXJlZENsaWVudEFwaSIsInJlZnJlc2hTdWJzY3JpcHRpb25zT3B0cyIsImh0dHBDbGllbnQiLCJIdHRwQ2xpZW50IiwiZG9tYWluQ2xpZW50IiwiRG9tYWluQ2xpZW50IiwiaGlzdG9yaWNhbE1hcmtldERhdGFIdHRwQ2xpZW50IiwiYWNjb3VudEdlbmVyYXRvckh0dHBDbGllbnQiLCJjbGllbnRBcGlDbGllbnQiLCJDbGllbnRBcGlDbGllbnQiLCJfbWV0YUFwaVdlYnNvY2tldENsaWVudCIsIk1ldGFBcGlXZWJzb2NrZXRDbGllbnQiLCJyZWdpb24iLCJ1bnN1YnNjcmliZVRocm90dGxpbmdJbnRlcnZhbEluU2Vjb25kcyIsIl9wcm92aXNpb25pbmdQcm9maWxlQXBpIiwiUHJvdmlzaW9uaW5nUHJvZmlsZUFwaSIsIlByb3Zpc2lvbmluZ1Byb2ZpbGVDbGllbnQiLCJfY29ubmVjdGlvblJlZ2lzdHJ5IiwiQ29ubmVjdGlvblJlZ2lzdHJ5IiwiaGlzdG9yaWNhbE1hcmtldERhdGFDbGllbnQiLCJIaXN0b3JpY2FsTWFya2V0RGF0YUNsaWVudCIsIl9tZXRhdHJhZGVyQWNjb3VudEFwaSIsIk1ldGF0cmFkZXJBY2NvdW50QXBpIiwiTWV0YXRyYWRlckFjY291bnRDbGllbnQiLCJFeHBlcnRBZHZpc29yQ2xpZW50IiwiX21ldGF0cmFkZXJBY2NvdW50R2VuZXJhdG9yQXBpIiwiTWV0YXRyYWRlckFjY291bnRHZW5lcmF0b3JBcGkiLCJNZXRhdHJhZGVyQWNjb3VudEdlbmVyYXRvckNsaWVudCIsImVuYWJsZUxhdGVuY3lUcmFja2luZyIsImVuYWJsZUxhdGVuY3lNb25pdG9yIiwiX2xhdGVuY3lNb25pdG9yIiwiTGF0ZW5jeU1vbml0b3IiLCJhZGRMYXRlbmN5TGlzdGVuZXIiLCJwcm92aXNpb25pbmdQcm9maWxlQXBpIiwibWV0YXRyYWRlckFjY291bnRBcGkiLCJtZXRhdHJhZGVyQWNjb3VudEdlbmVyYXRvckFwaSIsImxhdGVuY3lNb25pdG9yIiwiY2xvc2UiLCJyZW1vdmVMYXRlbmN5TGlzdGVuZXIiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7QUFFQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBRUE7Ozs7Ozs7O0FBUUE7Ozs7Ozs7OztBQVNBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFxQkE7OztBQUdlLE1BQU1BLE9BQU4sQ0FBYzs7QUFFM0I7Ozs7QUFJQSxTQUFPQyxtQkFBUCxHQUE2QjtBQUMzQkMscUJBQWNDLFNBQWQ7QUFDRDs7QUFFRDs7Ozs7QUFLQTtBQUNBQyxjQUFZQyxLQUFaLEVBQW1CQyxJQUFuQixFQUF5QjtBQUN2QixVQUFNQyxZQUFZLElBQUlDLDBCQUFKLEVBQWxCO0FBQ0FGLFdBQU9BLFFBQVEsRUFBZjtBQUNBLFVBQU1HLGNBQWNILEtBQUtHLFdBQUwsSUFBb0IsU0FBeEM7QUFDQSxVQUFNQyxT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Q0FBSixDQUNwQyxJQUFJQyxvQ0FBSixDQUFxQ3BCLDBCQUFyQyxFQUFpRUgsWUFBakUsQ0FEb0MsQ0FBdEM7QUFFQSxRQUFJcEIsS0FBSzRDLHFCQUFMLElBQThCNUMsS0FBSzZDLG9CQUF2QyxFQUE2RDtBQUMzRCxXQUFLQyxlQUFMLEdBQXVCLElBQUlDLHdCQUFKLEVBQXZCO0FBQ0EsV0FBS3JCLHVCQUFMLENBQTZCc0Isa0JBQTdCLENBQWdELEtBQUtGLGVBQXJEO0FBQ0Q7QUFDRjs7QUFFRDs7OztBQUlBLE1BQUlHLHNCQUFKLEdBQTZCO0FBQzNCLFdBQU8sS0FBS25CLHVCQUFaO0FBQ0Q7O0FBRUQ7Ozs7QUFJQSxNQUFJb0Isb0JBQUosR0FBMkI7QUFDekIsV0FBTyxLQUFLYixxQkFBWjtBQUNEOztBQUVEOzs7O0FBSUEsTUFBSWMsNkJBQUosR0FBb0M7QUFDbEMsV0FBTyxLQUFLViw4QkFBWjtBQUNEOztBQUVEOzs7O0FBSUEsTUFBSVcsY0FBSixHQUFxQjtBQUNuQixXQUFPLEtBQUtOLGVBQVo7QUFDRDs7QUFFRDs7O0FBR0FPLFVBQVE7QUFDTixTQUFLM0IsdUJBQUwsQ0FBNkI0QixxQkFBN0IsQ0FBbUQsS0FBS1IsZUFBeEQ7QUFDQSxTQUFLcEIsdUJBQUwsQ0FBNkIyQixLQUE3QjtBQUNEOztBQWxHMEI7a0JBQVIzRCxPIiwiZmlsZSI6Im1ldGFBcGkuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCBIdHRwQ2xpZW50IGZyb20gJy4uL2NsaWVudHMvaHR0cENsaWVudCc7XG5pbXBvcnQgUHJvdmlzaW9uaW5nUHJvZmlsZUNsaWVudCBmcm9tICcuLi9jbGllbnRzL21ldGFBcGkvcHJvdmlzaW9uaW5nUHJvZmlsZS5jbGllbnQnO1xuaW1wb3J0IFByb3Zpc2lvbmluZ1Byb2ZpbGVBcGkgZnJvbSAnLi9wcm92aXNpb25pbmdQcm9maWxlQXBpJztcbmltcG9ydCBNZXRhQXBpV2Vic29ja2V0Q2xpZW50IGZyb20gJy4uL2NsaWVudHMvbWV0YUFwaS9tZXRhQXBpV2Vic29ja2V0LmNsaWVudCc7XG5pbXBvcnQgTWV0YXRyYWRlckFjY291bnRBcGkgZnJvbSAnLi9tZXRhdHJhZGVyQWNjb3VudEFwaSc7XG5pbXBvcnQgTWV0YXRyYWRlckFjY291bnRDbGllbnQgZnJvbSAnLi4vY2xpZW50cy9tZXRhQXBpL21ldGF0cmFkZXJBY2NvdW50LmNsaWVudCc7XG5pbXBvcnQgTWV0YXRyYWRlckFjY291bnRHZW5lcmF0b3JBcGkgZnJvbSAnLi9tZXRhdHJhZGVyQWNjb3VudEdlbmVyYXRvckFwaSc7XG5pbXBvcnQgTWV0YXRyYWRlckFjY291bnRHZW5lcmF0b3JDbGllbnQgZnJvbSAnLi4vY2xpZW50cy9tZXRhQXBpL21ldGF0cmFkZXJBY2NvdW50R2VuZXJhdG9yLmNsaWVudCc7XG5pbXBvcnQgSGlzdG9yaWNhbE1hcmtldERhdGFDbGllbnQgZnJvbSAnLi4vY2xpZW50cy9tZXRhQXBpL2hpc3RvcmljYWxNYXJrZXREYXRhLmNsaWVudCc7XG5pbXBvcnQgQ2xpZW50QXBpQ2xpZW50IGZyb20gJy4uL2NsaWVudHMvbWV0YUFwaS9jbGllbnRBcGkuY2xpZW50JztcbmltcG9ydCBDb25uZWN0aW9uUmVnaXN0cnkgZnJvbSAnLi9jb25uZWN0aW9uUmVnaXN0cnknO1xuaW1wb3J0IHtWYWxpZGF0aW9uRXJyb3J9IGZyb20gJy4uL2NsaWVudHMvZXJyb3JIYW5kbGVyJztcbmltcG9ydCBPcHRpb25zVmFsaWRhdG9yIGZyb20gJy4uL2NsaWVudHMvb3B0aW9uc1ZhbGlkYXRvcic7XG5pbXBvcnQgTGF0ZW5jeU1vbml0b3IgZnJvbSAnLi9sYXRlbmN5TW9uaXRvcic7XG5pbXBvcnQgRXhwZXJ0QWR2aXNvckNsaWVudCBmcm9tICcuLi9jbGllbnRzL21ldGFBcGkvZXhwZXJ0QWR2aXNvci5jbGllbnQnO1xuaW1wb3J0IExvZ2dlck1hbmFnZXIgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCBEb21haW5DbGllbnQgZnJvbSAnLi4vY2xpZW50cy9kb21haW4uY2xpZW50JztcblxuLyoqXG4gKiBSZXF1ZXN0IHJldHJ5IG9wdGlvbnNcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFJldHJ5T3B0c1xuICogQHByb3BlcnR5IHtOdW1iZXJ9IFtyZXRyaWVzXSBtYXhpbXVtIGFtb3VudCBvZiByZXF1ZXN0IHJldHJpZXMsIGRlZmF1bHQgdmFsdWUgaXMgNVxuICogQHByb3BlcnR5IHtOdW1iZXJ9IFttaW5EZWxheUluU2Vjb25kc10gbWluaW11bSBkZWxheSBpbiBzZWNvbmRzIHVudGlsIHJlcXVlc3QgcmV0cnksIGRlZmF1bHQgdmFsdWUgaXMgMVxuICogQHByb3BlcnR5IHtOdW1iZXJ9IFttYXhEZWxheUluU2Vjb25kc10gbWF4aW11bSBkZWxheSBpbiBzZWNvbmRzIHVudGlsIHJlcXVlc3QgcmV0cnksIGRlZmF1bHQgdmFsdWUgaXMgMzBcbiAqL1xuXG4vKipcbiAqIFN1YnNjcmlwdGlvbnMgcmVmcmVzaCBvcHRpb25zXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBSZWZyZXNoU3Vic2NyaXB0aW9uc09wdHNcbiAqIEBwcm9wZXJ0eSB7TnVtYmVyfSBbbWluRGVsYXlJblNlY29uZHNdIG1pbmltdW0gZGVsYXkgaW4gc2Vjb25kcyB1bnRpbCBzdWJzY3JpcHRpb25zIHJlZnJlc2ggcmVxdWVzdCxcbiAqIGRlZmF1bHQgdmFsdWUgaXMgMVxuICogQHByb3BlcnR5IHtOdW1iZXJ9IFttYXhEZWxheUluU2Vjb25kc10gbWF4aW11bSBkZWxheSBpbiBzZWNvbmRzIHVudGlsIHN1YnNjcmlwdGlvbnMgcmVmcmVzaCByZXF1ZXN0LFxuICogZGVmYXVsdCB2YWx1ZSBpcyA2MDBcbiAqL1xuXG4vKipcbiAqIE1ldGFBcGkgb3B0aW9uc1xuICogQHR5cGVkZWYge09iamVjdH0gTWV0YUFwaU9wdHNcbiAqIEBwcm9wZXJ0eSB7U3RyaW5nfSBbYXBwbGljYXRpb25dIGFwcGxpY2F0aW9uIGlkXG4gKiBAcHJvcGVydHkge1N0cmluZ30gW2RvbWFpbl0gZG9tYWluIHRvIGNvbm5lY3QgdG8sIGRlZmF1bHQgaXMgYWdpbGl1bXRyYWRlLmFnaWxpdW10cmFkZS5haVxuICogQHByb3BlcnR5IHtTdHJpbmd9IFtyZWdpb25dIHJlZ2lvbiB0byBjb25uZWN0IHRvXG4gKiBAcHJvcGVydHkge051bWJlcn0gW3JlcXVlc3RUaW1lb3V0XSB0aW1lb3V0IGZvciBzb2NrZXQgcmVxdWVzdHMgaW4gc2Vjb25kc1xuICogQHByb3BlcnR5IHtOdW1iZXJ9IFtjb25uZWN0VGltZW91dF0gdGltZW91dCBmb3IgY29ubmVjdGluZyB0byBzZXJ2ZXIgaW4gc2Vjb25kc1xuICogQHByb3BlcnR5IHtOdW1iZXJ9IFtwYWNrZXRPcmRlcmluZ1RpbWVvdXRdIHBhY2tldCBvcmRlcmluZyB0aW1lb3V0IGluIHNlY29uZHNcbiAqIEBwcm9wZXJ0eSB7UGFja2V0TG9nZ2VyT3B0c30gW3BhY2tldExvZ2dlcl0gcGFja2V0IGxvZ2dlciBvcHRpb25zXG4gKiBAcHJvcGVydHkge0Jvb2xlYW59IFtlbmFibGVMYXRlbmN5TW9uaXRvcl0gYW4gb3B0aW9uIHRvIGVuYWJsZSBsYXRlbmN5IHRyYWNraW5nXG4gKiBAcHJvcGVydHkge0Jvb2xlYW59IFtlbmFibGVMYXRlbmN5VHJhY2tpbmddIGFuIG9wdGlvbiB0byBlbmFibGUgbGF0ZW5jeSB0cmFja2luZ1xuICogQHByb3BlcnR5IHtTeW5jaHJvbml6YXRpb25UaHJvdHRsZXJPcHRzfSBbc3luY2hyb25pemF0aW9uVGhyb3R0bGVyXSBvcHRpb25zIGZvciBzeW5jaHJvbml6YXRpb24gdGhyb3R0bGVyXG4gKiBAcHJvcGVydHkge1JldHJ5T3B0c30gW3JldHJ5T3B0c10gb3B0aW9ucyBmb3IgcmVxdWVzdCByZXRyaWVzXG4gKiBAcHJvcGVydHkge0Jvb2xlYW59IFt1c2VTaGFyZWRDbGllbnRBcGldIG9wdGlvbiB0byB1c2UgYSBzaGFyZWQgc2VydmVyXG4gKiBAcHJvcGVydHkge1JlZnJlc2hTdWJzY3JpcHRpb25zT3B0c30gW3JlZnJlc2hTdWJzY3JpcHRpb25zT3B0c10gc3Vic2NyaXB0aW9ucyByZWZyZXNoIG9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7TnVtYmVyfSBbdW5zdWJzY3JpYmVUaHJvdHRsaW5nSW50ZXJ2YWxJblNlY29uZHNdIGEgdGltZW91dCBpbiBzZWNvbmRzIGZvciB0aHJvdHRsaW5nIHJlcGVhdCB1bnN1YnNjcmliZVxuICogcmVxdWVzdHMgd2hlbiBzeW5jaHJvbml6YXRpb24gcGFja2V0cyBzdGlsbCBhcnJpdmUgYWZ0ZXIgdW5zdWJzY3JpcHRpb24sIGRlZmF1bHQgaXMgMTAgc2Vjb25kc1xuICogQHByb3BlcnR5IHtudW1iZXJ9IFthY2NvdW50R2VuZXJhdG9yUmVxdWVzdFRpbWVvdXRdIE1UIGFjY291bnQgZ2VuZXJhdG9yIEFQSSByZXF1ZXN0IHRpbWVvdXQuIERlZmF1bHQgaXMgNCBtaW51dGVzXG4gKi9cblxuLyoqXG4gKiBNZXRhQXBpIE1ldGFUcmFkZXIgQVBJIFNES1xuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNZXRhQXBpIHtcblxuICAvKipcbiAgICogRW5hYmxlcyB1c2luZyBMb2c0anMgbG9nZ2VyIHdpdGggZXh0ZW5kZWQgbG9nIGxldmVscyBmb3IgZGVidWdnaW5nIGluc3RlYWQgb2ZcbiAgICogY29uc29sZS4qIGZ1bmN0aW9ucy4gTm90ZSB0aGF0IGxvZzRqcyBjb25maWd1cmF0aW9uIHBlcmZvcm1lZCBieSB0aGUgdXNlci5cbiAgICovXG4gIHN0YXRpYyBlbmFibGVMb2c0anNMb2dnaW5nKCkge1xuICAgIExvZ2dlck1hbmFnZXIudXNlTG9nNGpzKCk7XG4gIH1cblxuICAvKipcbiAgICogQ29uc3RydWN0cyBNZXRhQXBpIGNsYXNzIGluc3RhbmNlXG4gICAqIEBwYXJhbSB7U3RyaW5nfSB0b2tlbiBhdXRob3JpemF0aW9uIHRva2VuXG4gICAqIEBwYXJhbSB7TWV0YUFwaU9wdHN9IG9wdHMgYXBwbGljYXRpb24gb3B0aW9uc1xuICAgKi9cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNvbXBsZXhpdHlcbiAgY29uc3RydWN0b3IodG9rZW4sIG9wdHMpIHtcbiAgICBjb25zdCB2YWxpZGF0b3IgPSBuZXcgT3B0aW9uc1ZhbGlkYXRvcigpO1xuICAgIG9wdHMgPSBvcHRzIHx8IHt9O1xuICAgIGNvbnN0IGFwcGxpY2F0aW9uID0gb3B0cy5hcHBsaWNhdGlvbiB8fCAnTWV0YUFwaSc7XG4gICAgY29uc3QgZG9tYWluID0gb3B0cy5kb21haW4gfHwgJ2FnaWxpdW10cmFkZS5hZ2lsaXVtdHJhZGUuYWknO1xuICAgIGNvbnN0IHJlcXVlc3RUaW1lb3V0ID0gdmFsaWRhdG9yLnZhbGlkYXRlTm9uWmVybyhvcHRzLnJlcXVlc3RUaW1lb3V0LCA2MCwgJ3JlcXVlc3RUaW1lb3V0Jyk7XG4gICAgY29uc3QgaGlzdG9yaWNhbE1hcmtldERhdGFSZXF1ZXN0VGltZW91dCA9IHZhbGlkYXRvci52YWxpZGF0ZU5vblplcm8oXG4gICAgICBvcHRzLmhpc3RvcmljYWxNYXJrZXREYXRhUmVxdWVzdFRpbWVvdXQsIDI0MCwgJ2hpc3RvcmljYWxNYXJrZXREYXRhUmVxdWVzdFRpbWVvdXQnKTtcbiAgICBjb25zdCBjb25uZWN0VGltZW91dCA9IHZhbGlkYXRvci52YWxpZGF0ZU5vblplcm8ob3B0cy5jb25uZWN0VGltZW91dCwgNjAsICdjb25uZWN0VGltZW91dCcpO1xuICAgIGNvbnN0IHBhY2tldE9yZGVyaW5nVGltZW91dCA9IHZhbGlkYXRvci52YWxpZGF0ZU5vblplcm8ob3B0cy5wYWNrZXRPcmRlcmluZ1RpbWVvdXQsIDYwLCAncGFja2V0T3JkZXJpbmdUaW1lb3V0Jyk7XG4gICAgY29uc3QgcmV0cnlPcHRzID0gb3B0cy5yZXRyeU9wdHMgfHwge307XG4gICAgY29uc3QgcGFja2V0TG9nZ2VyID0gb3B0cy5wYWNrZXRMb2dnZXIgfHwge307XG4gICAgY29uc3Qgc3luY2hyb25pemF0aW9uVGhyb3R0bGVyID0gb3B0cy5zeW5jaHJvbml6YXRpb25UaHJvdHRsZXIgfHwge307XG4gICAgY29uc3QgYWNjb3VudEdlbmVyYXRvclJlcXVlc3RUaW1lb3V0ID0gdmFsaWRhdG9yLnZhbGlkYXRlTm9uWmVybyhvcHRzLmFjY291bnRHZW5lcmF0b3JSZXF1ZXN0VGltZW91dCwgMjQwLFxuICAgICAgJ2FjY291bnRHZW5lcmF0b3JSZXF1ZXN0VGltZW91dCcpO1xuICAgIGlmICghYXBwbGljYXRpb24ubWF0Y2goL1thLXpBLVowLTlfXSsvKSkge1xuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignQXBwbGljYXRpb24gbmFtZSBtdXN0IGJlIG5vbi1lbXB0eSBzdHJpbmcgY29uc2lzdGluZyBmcm9tIGxldHRlcnMsIGRpZ2l0cyBhbmQgXyBvbmx5Jyk7XG4gICAgfVxuICAgIGNvbnN0IHVzZVNoYXJlZENsaWVudEFwaSA9IG9wdHMudXNlU2hhcmVkQ2xpZW50QXBpIHx8IGZhbHNlO1xuICAgIGNvbnN0IHJlZnJlc2hTdWJzY3JpcHRpb25zT3B0cyA9IG9wdHMucmVmcmVzaFN1YnNjcmlwdGlvbnNPcHRzIHx8IHt9O1xuICAgIGNvbnN0IGh0dHBDbGllbnQgPSBuZXcgSHR0cENsaWVudChyZXF1ZXN0VGltZW91dCwgcmV0cnlPcHRzKTtcbiAgICBjb25zdCBkb21haW5DbGllbnQgPSBuZXcgRG9tYWluQ2xpZW50KGh0dHBDbGllbnQsIHRva2VuLCBkb21haW4pO1xuICAgIGNvbnN0IGhpc3RvcmljYWxNYXJrZXREYXRhSHR0cENsaWVudCA9IG5ldyBIdHRwQ2xpZW50KGhpc3RvcmljYWxNYXJrZXREYXRhUmVxdWVzdFRpbWVvdXQsIHJldHJ5T3B0cyk7XG4gICAgY29uc3QgYWNjb3VudEdlbmVyYXRvckh0dHBDbGllbnQgPSBuZXcgSHR0cENsaWVudChhY2NvdW50R2VuZXJhdG9yUmVxdWVzdFRpbWVvdXQsIHJldHJ5T3B0cyk7XG4gICAgY29uc3QgY2xpZW50QXBpQ2xpZW50ID0gbmV3IENsaWVudEFwaUNsaWVudChodHRwQ2xpZW50LCBkb21haW5DbGllbnQpOyBcbiAgICB0aGlzLl9tZXRhQXBpV2Vic29ja2V0Q2xpZW50ID0gbmV3IE1ldGFBcGlXZWJzb2NrZXRDbGllbnQoZG9tYWluQ2xpZW50LCB0b2tlbiwge2FwcGxpY2F0aW9uLCBkb21haW4sXG4gICAgICByZXF1ZXN0VGltZW91dCwgY29ubmVjdFRpbWVvdXQsIHBhY2tldExvZ2dlciwgcGFja2V0T3JkZXJpbmdUaW1lb3V0LCBzeW5jaHJvbml6YXRpb25UaHJvdHRsZXIsIHJldHJ5T3B0cyxcbiAgICAgIHVzZVNoYXJlZENsaWVudEFwaSwgcmVnaW9uOiBvcHRzLnJlZ2lvbixcbiAgICAgIHVuc3Vic2NyaWJlVGhyb3R0bGluZ0ludGVydmFsSW5TZWNvbmRzOiBvcHRzLnVuc3Vic2NyaWJlVGhyb3R0bGluZ0ludGVydmFsSW5TZWNvbmRzfSk7XG4gICAgdGhpcy5fcHJvdmlzaW9uaW5nUHJvZmlsZUFwaSA9IG5ldyBQcm92aXNpb25pbmdQcm9maWxlQXBpKG5ldyBQcm92aXNpb25pbmdQcm9maWxlQ2xpZW50KGh0dHBDbGllbnQsIGRvbWFpbkNsaWVudCkpO1xuICAgIHRoaXMuX2Nvbm5lY3Rpb25SZWdpc3RyeSA9IG5ldyBDb25uZWN0aW9uUmVnaXN0cnkodGhpcy5fbWV0YUFwaVdlYnNvY2tldENsaWVudCwgY2xpZW50QXBpQ2xpZW50LCBhcHBsaWNhdGlvbixcbiAgICAgIHJlZnJlc2hTdWJzY3JpcHRpb25zT3B0cyk7XG4gICAgbGV0IGhpc3RvcmljYWxNYXJrZXREYXRhQ2xpZW50ID0gbmV3IEhpc3RvcmljYWxNYXJrZXREYXRhQ2xpZW50KGhpc3RvcmljYWxNYXJrZXREYXRhSHR0cENsaWVudCwgZG9tYWluQ2xpZW50KTtcbiAgICB0aGlzLl9tZXRhdHJhZGVyQWNjb3VudEFwaSA9IG5ldyBNZXRhdHJhZGVyQWNjb3VudEFwaShuZXcgTWV0YXRyYWRlckFjY291bnRDbGllbnQoaHR0cENsaWVudCwgZG9tYWluQ2xpZW50KSxcbiAgICAgIHRoaXMuX21ldGFBcGlXZWJzb2NrZXRDbGllbnQsIHRoaXMuX2Nvbm5lY3Rpb25SZWdpc3RyeSwgXG4gICAgICBuZXcgRXhwZXJ0QWR2aXNvckNsaWVudChodHRwQ2xpZW50LCBkb21haW5DbGllbnQpLCBoaXN0b3JpY2FsTWFya2V0RGF0YUNsaWVudCwgYXBwbGljYXRpb24pO1xuICAgIHRoaXMuX21ldGF0cmFkZXJBY2NvdW50R2VuZXJhdG9yQXBpID0gbmV3IE1ldGF0cmFkZXJBY2NvdW50R2VuZXJhdG9yQXBpKFxuICAgICAgbmV3IE1ldGF0cmFkZXJBY2NvdW50R2VuZXJhdG9yQ2xpZW50KGFjY291bnRHZW5lcmF0b3JIdHRwQ2xpZW50LCBkb21haW5DbGllbnQpKTtcbiAgICBpZiAob3B0cy5lbmFibGVMYXRlbmN5VHJhY2tpbmcgfHwgb3B0cy5lbmFibGVMYXRlbmN5TW9uaXRvcikge1xuICAgICAgdGhpcy5fbGF0ZW5jeU1vbml0b3IgPSBuZXcgTGF0ZW5jeU1vbml0b3IoKTtcbiAgICAgIHRoaXMuX21ldGFBcGlXZWJzb2NrZXRDbGllbnQuYWRkTGF0ZW5jeUxpc3RlbmVyKHRoaXMuX2xhdGVuY3lNb25pdG9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBwcm92aXNpb25pbmcgcHJvZmlsZSBBUElcbiAgICogQHJldHVybnMge1Byb3Zpc2lvbmluZ1Byb2ZpbGVBcGl9IHByb3Zpc2lvbmluZyBwcm9maWxlIEFQSVxuICAgKi9cbiAgZ2V0IHByb3Zpc2lvbmluZ1Byb2ZpbGVBcGkoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3Byb3Zpc2lvbmluZ1Byb2ZpbGVBcGk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBNZXRhVHJhZGVyIGFjY291bnQgQVBJXG4gICAqIEByZXR1cm4ge01ldGF0cmFkZXJBY2NvdW50QXBpfSBNZXRhVHJhZGVyIGFjY291bnQgQVBJXG4gICAqL1xuICBnZXQgbWV0YXRyYWRlckFjY291bnRBcGkoKSB7XG4gICAgcmV0dXJuIHRoaXMuX21ldGF0cmFkZXJBY2NvdW50QXBpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgTWV0YVRyYWRlciBhY2NvdW50IGdlbmVyYXRvciBBUElcbiAgICogQHJldHVybiB7TWV0YXRyYWRlckRlbW9BY2NvdW50QXBpfSBNZXRhVHJhZGVyIGFjY291bnQgZ2VuZXJhdG9yIEFQSVxuICAgKi9cbiAgZ2V0IG1ldGF0cmFkZXJBY2NvdW50R2VuZXJhdG9yQXBpKCkge1xuICAgIHJldHVybiB0aGlzLl9tZXRhdHJhZGVyQWNjb3VudEdlbmVyYXRvckFwaTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIE1ldGFBcGkgYXBwbGljYXRpb24gbGF0ZW5jeSBtb25pdG9yXG4gICAqIEByZXR1cm4ge0xhdGVuY3lNb25pdG9yfSBsYXRlbmN5IG1vbml0b3JcbiAgICovXG4gIGdldCBsYXRlbmN5TW9uaXRvcigpIHtcbiAgICByZXR1cm4gdGhpcy5fbGF0ZW5jeU1vbml0b3I7XG4gIH1cblxuICAvKipcbiAgICogQ2xvc2VzIGFsbCBjbGllbnRzIGFuZCBjb25uZWN0aW9uc1xuICAgKi9cbiAgY2xvc2UoKSB7XG4gICAgdGhpcy5fbWV0YUFwaVdlYnNvY2tldENsaWVudC5yZW1vdmVMYXRlbmN5TGlzdGVuZXIodGhpcy5fbGF0ZW5jeU1vbml0b3IpO1xuICAgIHRoaXMuX21ldGFBcGlXZWJzb2NrZXRDbGllbnQuY2xvc2UoKTtcbiAgfVxuXG59XG4iXX0=