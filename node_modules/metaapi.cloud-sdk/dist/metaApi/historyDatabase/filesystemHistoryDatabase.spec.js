'use strict';

var _should = require('should');

var _should2 = _interopRequireDefault(_should);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _filesystemHistoryDatabase = require('./filesystemHistoryDatabase');

var _filesystemHistoryDatabase2 = _interopRequireDefault(_filesystemHistoryDatabase);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

describe('FilesystemHistoryDatabase', () => {

  let db;

  before(async () => {
    db = _filesystemHistoryDatabase2.default.getInstance();
  });

  beforeEach(async () => {
    await removeDataFolder();
  });

  async function removeDataFolder() {
    if (!_fs2.default.existsSync('.metaapi')) {
      return;
    }
    let files = await _fs2.default.promises.readdir('.metaapi');
    for (let file of files) {
      if (file === 'logs') {
        let logFiles = await _fs2.default.promises.readdir(_path2.default.join('.metaapi', 'logs'));
        for (let f of logFiles) {
          await _fs2.default.promises.unlink(_path2.default.join('.metaapi', 'logs', f));
        }
        await _fs2.default.promises.rmdir(_path2.default.join('.metaapi', 'logs'));
      } else {
        await _fs2.default.promises.unlink(_path2.default.join('.metaapi', file));
      }
    }
    await _fs2.default.promises.rmdir('.metaapi');
  }

  afterEach(async () => {
    await removeDataFolder();
  });

  it('should read db contents', async () => {
    let dealsData = '{"id":"1"}\n{"id":"2"}\n';
    let historyOrdersData = '{"id":"2"}\n{"id":"3"}\n';
    await _fs2.default.promises.mkdir('.metaapi', { recursive: true });
    await _fs2.default.promises.writeFile(_path2.default.join('.metaapi', 'accountId-MetaApi-deals.bin'), dealsData, 'utf-8');
    await _fs2.default.promises.writeFile(_path2.default.join('.metaapi', 'accountId-MetaApi-historyOrders.bin'), historyOrdersData, 'utf-8');
    let { deals, historyOrders } = await db.loadHistory('accountId', 'MetaApi');
    deals.should.match([{ id: '1' }, { id: '2' }]);
    historyOrders.should.match([{ id: '2' }, { id: '3' }]);
  });

  it('should clear db', async () => {
    let dealsData = '{"id":"1"}\n{"id":"2"}\n';
    let historyOrdersData = '{"id":"2"}\n{"id":"3"}\n';
    await _fs2.default.promises.mkdir('.metaapi', { recursive: true });
    await _fs2.default.promises.writeFile(_path2.default.join('.metaapi', 'accountId-MetaApi-deals.bin'), dealsData, 'utf-8');
    await _fs2.default.promises.writeFile(_path2.default.join('.metaapi', 'accountId-MetaApi-historyOrders.bin'), historyOrdersData, 'utf-8');
    await db.clear('accountId', 'MetaApi');
    let { deals, historyOrders } = await db.loadHistory('accountId', 'MetaApi');
    deals.should.match([]);
    historyOrders.should.match([]);
  });

  it('should flush to db', async () => {
    await db.flush('accountId', 'MetaApi', [{ id: '2' }], [{ id: '1' }]);
    await db.flush('accountId', 'MetaApi', [{ id: '3' }], [{ id: '2' }]);
    let { deals, historyOrders } = await db.loadHistory('accountId', 'MetaApi');
    deals.should.match([{ id: '1' }, { id: '2' }]);
    historyOrders.should.match([{ id: '2' }, { id: '3' }]);
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9tZXRhQXBpL2hpc3RvcnlEYXRhYmFzZS9maWxlc3lzdGVtSGlzdG9yeURhdGFiYXNlLnNwZWMuZXM2Il0sIm5hbWVzIjpbImRlc2NyaWJlIiwiZGIiLCJiZWZvcmUiLCJGaWxlc3lzdGVtSGlzdG9yeURhdGFiYXNlIiwiZ2V0SW5zdGFuY2UiLCJiZWZvcmVFYWNoIiwicmVtb3ZlRGF0YUZvbGRlciIsImZzIiwiZXhpc3RzU3luYyIsImZpbGVzIiwicHJvbWlzZXMiLCJyZWFkZGlyIiwiZmlsZSIsImxvZ0ZpbGVzIiwicGF0aCIsImpvaW4iLCJmIiwidW5saW5rIiwicm1kaXIiLCJhZnRlckVhY2giLCJpdCIsImRlYWxzRGF0YSIsImhpc3RvcnlPcmRlcnNEYXRhIiwibWtkaXIiLCJyZWN1cnNpdmUiLCJ3cml0ZUZpbGUiLCJkZWFscyIsImhpc3RvcnlPcmRlcnMiLCJsb2FkSGlzdG9yeSIsInNob3VsZCIsIm1hdGNoIiwiaWQiLCJjbGVhciIsImZsdXNoIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBRUFBLFNBQVMsMkJBQVQsRUFBc0MsTUFBTTs7QUFFMUMsTUFBSUMsRUFBSjs7QUFFQUMsU0FBTyxZQUFZO0FBQ2pCRCxTQUFLRSxvQ0FBMEJDLFdBQTFCLEVBQUw7QUFDRCxHQUZEOztBQUlBQyxhQUFXLFlBQVk7QUFDckIsVUFBTUMsa0JBQU47QUFDRCxHQUZEOztBQUlBLGlCQUFlQSxnQkFBZixHQUFrQztBQUNoQyxRQUFJLENBQUNDLGFBQUdDLFVBQUgsQ0FBYyxVQUFkLENBQUwsRUFBZ0M7QUFDOUI7QUFDRDtBQUNELFFBQUlDLFFBQVEsTUFBTUYsYUFBR0csUUFBSCxDQUFZQyxPQUFaLENBQW9CLFVBQXBCLENBQWxCO0FBQ0EsU0FBSyxJQUFJQyxJQUFULElBQWlCSCxLQUFqQixFQUF3QjtBQUN0QixVQUFJRyxTQUFTLE1BQWIsRUFBcUI7QUFDbkIsWUFBSUMsV0FBVyxN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QixZQUFZO0FBQ25DLFVBQU1uQixHQUFHZ0MsS0FBSCxDQUFTLFdBQVQsRUFBc0IsU0FBdEIsRUFBaUMsQ0FBQyxFQUFDRixJQUFJLEdBQUwsRUFBRCxDQUFqQyxFQUE4QyxDQUFDLEVBQUNBLElBQUksR0FBTCxFQUFELENBQTlDLENBQU47QUFDQSxVQUFNOUIsR0FBR2dDLEtBQUgsQ0FBUyxXQUFULEVBQXNCLFNBQXRCLEVBQWlDLENBQUMsRUFBQ0YsSUFBSSxHQUFMLEVBQUQsQ0FBakMsRUFBOEMsQ0FBQyxFQUFDQSxJQUFJLEdBQUwsRUFBRCxDQUE5QyxDQUFOO0FBQ0EsUUFBSSxFQUFDTCxLQUFELEVBQVFDLGFBQVIsS0FBeUIsTUFBTTFCLEdBQUcyQixXQUFILENBQWUsV0FBZixFQUE0QixTQUE1QixDQUFuQztBQUNBRixVQUFNRyxNQUFOLENBQWFDLEtBQWIsQ0FBbUIsQ0FBQyxFQUFDQyxJQUFJLEdBQUwsRUFBRCxFQUFZLEVBQUNBLElBQUksR0FBTCxFQUFaLENBQW5CO0FBQ0FKLGtCQUFjRSxNQUFkLENBQXFCQyxLQUFyQixDQUEyQixDQUFDLEVBQUNDLElBQUksR0FBTCxFQUFELEVBQVksRUFBQ0EsSUFBSSxHQUFMLEVBQVosQ0FBM0I7QUFDRCxHQU5EO0FBUUQsQ0FwRUQiLCJmaWxlIjoiZmlsZXN5c3RlbUhpc3RvcnlEYXRhYmFzZS5zcGVjLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgc2hvdWxkIGZyb20gJ3Nob3VsZCc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgRmlsZXN5c3RlbUhpc3RvcnlEYXRhYmFzZSBmcm9tICcuL2ZpbGVzeXN0ZW1IaXN0b3J5RGF0YWJhc2UnO1xuXG5kZXNjcmliZSgnRmlsZXN5c3RlbUhpc3RvcnlEYXRhYmFzZScsICgpID0+IHtcblxuICBsZXQgZGI7XG5cbiAgYmVmb3JlKGFzeW5jICgpID0+IHtcbiAgICBkYiA9IEZpbGVzeXN0ZW1IaXN0b3J5RGF0YWJhc2UuZ2V0SW5zdGFuY2UoKTtcbiAgfSk7XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgcmVtb3ZlRGF0YUZvbGRlcigpO1xuICB9KTtcblxuICBhc3luYyBmdW5jdGlvbiByZW1vdmVEYXRhRm9sZGVyKCkge1xuICAgIGlmICghZnMuZXhpc3RzU3luYygnLm1ldGFhcGknKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsZXQgZmlsZXMgPSBhd2FpdCBmcy5wcm9taXNlcy5yZWFkZGlyKCcubWV0YWFwaScpO1xuICAgIGZvciAobGV0IGZpbGUgb2YgZmlsZXMpIHtcbiAgICAgIGlmIChmaWxlID09PSAnbG9ncycpIHtcbiAgICAgICAgbGV0IGxvZ0ZpbGVzID0gYXdhaXQgZnMucHJvbWlzZXMucmVhZGRpcihwYXRoLmpvaW4oJy5tZXRhYXBpJywgJ2xvZ3MnKSk7XG4gICAgICAgIGZvciAobGV0IGYgb2YgbG9nRmlsZXMpIHtcbiAgICAgICAgICBhd2FpdCBmcy5wcm9taXNlcy51bmxpbmsocGF0aC5qb2luKCcubWV0YWFwaScsICdsb2dzJywgZikpO1xuICAgICAgICB9XG4gICAgICAgIGF3YWl0IGZzLnByb21pc2VzLnJtZGlyKHBhdGguam9pbignLm1ldGFhcGknLCAnbG9ncycpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGF3YWl0IGZzLnByb21pc2VzLnVubGluayhwYXRoLmpvaW4oJy5tZXRhYXBpJywgZmlsZSkpO1xuICAgICAgfVxuICAgIH1cbiAgICBhd2FpdCBmcy5wcm9taXNlcy5ybWRpcignLm1ldGFhcGknKTtcbiAgfVxuXG4gIGFmdGVyRWFjaChhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgcmVtb3ZlRGF0YUZvbGRlcigpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHJlYWQgZGIgY29udGVudHMnLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IGRlYWxzRGF0YSA9ICd7XCJpZFwiOlwiMVwifVxcbntcImlkXCI6XCIyXCJ9XFxuJztcbiAgICBsZXQgaGlzdG9yeU9yZGVyc0RhdGEgPSAne1wiaWRcIjpcIjJcIn1cXG57XCJpZFwiOlwiM1wifVxcbic7XG4gICAgYXdhaXQgZnMucHJvbWlzZXMubWtkaXIoJy5tZXRhYXBpJywge3JlY3Vyc2l2ZTogdHJ1ZX0pO1xuICAgIGF3YWl0IGZzLnByb21pc2VzLndyaXRlRmlsZShwYXRoLmpvaW4oJy5tZXRhYXBpJywgJ2FjY291bnRJZC1NZXRhQXBpLWRlYWxzLmJpbicpLCBkZWFsc0RhdGEsICd1dGYtOCcpO1xuICAgIGF3YWl0IGZzLnByb21pc2VzLndyaXRlRmlsZShwYXRoLmpvaW4oJy5tZXRhYXBpJywgJ2FjY291bnRJZC1NZXRhQXBpLWhpc3RvcnlPcmRlcnMuYmluJyksIGhpc3RvcnlPcmRlcnNEYXRhLFxuICAgICAgJ3V0Zi04Jyk7XG4gICAgbGV0IHtkZWFscywgaGlzdG9yeU9yZGVyc30gPSBhd2FpdCBkYi5sb2FkSGlzdG9yeSgnYWNjb3VudElkJywgJ01ldGFBcGknKTtcbiAgICBkZWFscy5zaG91bGQubWF0Y2goW3tpZDogJzEnfSwge2lkOiAnMid9XSk7XG4gICAgaGlzdG9yeU9yZGVycy5zaG91bGQubWF0Y2goW3tpZDogJzInfSwge2lkOiAnMyd9XSk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgY2xlYXIgZGInLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IGRlYWxzRGF0YSA9ICd7XCJpZFwiOlwiMVwifVxcbntcImlkXCI6XCIyXCJ9XFxuJztcbiAgICBsZXQgaGlzdG9yeU9yZGVyc0RhdGEgPSAne1wiaWRcIjpcIjJcIn1cXG57XCJpZFwiOlwiM1wifVxcbic7XG4gICAgYXdhaXQgZnMucHJvbWlzZXMubWtkaXIoJy5tZXRhYXBpJywge3JlY3Vyc2l2ZTogdHJ1ZX0pO1xuICAgIGF3YWl0IGZzLnByb21pc2VzLndyaXRlRmlsZShwYXRoLmpvaW4oJy5tZXRhYXBpJywgJ2FjY291bnRJZC1NZXRhQXBpLWRlYWxzLmJpbicpLCBkZWFsc0RhdGEsICd1dGYtOCcpO1xuICAgIGF3YWl0IGZzLnByb21pc2VzLndyaXRlRmlsZShwYXRoLmpvaW4oJy5tZXRhYXBpJywgJ2FjY291bnRJZC1NZXRhQXBpLWhpc3RvcnlPcmRlcnMuYmluJyksIGhpc3RvcnlPcmRlcnNEYXRhLFxuICAgICAgJ3V0Zi04Jyk7XG4gICAgYXdhaXQgZGIuY2xlYXIoJ2FjY291bnRJZCcsICdNZXRhQXBpJyk7XG4gICAgbGV0IHtkZWFscywgaGlzdG9yeU9yZGVyc30gPSBhd2FpdCBkYi5sb2FkSGlzdG9yeSgnYWNjb3VudElkJywgJ01ldGFBcGknKTtcbiAgICBkZWFscy5zaG91bGQubWF0Y2goW10pO1xuICAgIGhpc3RvcnlPcmRlcnMuc2hvdWxkLm1hdGNoKFtdKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBmbHVzaCB0byBkYicsIGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBkYi5mbHVzaCgnYWNjb3VudElkJywgJ01ldGFBcGknLCBbe2lkOiAnMid9XSwgW3tpZDogJzEnfV0pO1xuICAgIGF3YWl0IGRiLmZsdXNoKCdhY2NvdW50SWQnLCAnTWV0YUFwaScsIFt7aWQ6ICczJ31dLCBbe2lkOiAnMid9XSk7XG4gICAgbGV0IHtkZWFscywgaGlzdG9yeU9yZGVyc30gPSBhd2FpdCBkYi5sb2FkSGlzdG9yeSgnYWNjb3VudElkJywgJ01ldGFBcGknKTtcbiAgICBkZWFscy5zaG91bGQubWF0Y2goW3tpZDogJzEnfSwge2lkOiAnMid9XSk7XG4gICAgaGlzdG9yeU9yZGVycy5zaG91bGQubWF0Y2goW3tpZDogJzInfSwge2lkOiAnMyd9XSk7XG4gIH0pO1xuXG59KTtcbiJdfQ==