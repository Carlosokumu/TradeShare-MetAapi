'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _historyDatabase = require('./historyDatabase');

var _historyDatabase2 = _interopRequireDefault(_historyDatabase);

var _logger = require('../../logger');

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Provides access to history database stored on filesystem
 */
class FilesystemHistoryDatabase extends _historyDatabase2.default {

  /**
   * Constructs the class instance
   */
  constructor() {
    super();
    this._logger = (0, _logger.getLogger)('FilesystemHistoryDatabase');
  }

  /**
   * Returns history database instance
   * @returns {HistoryDatabase} history database instance
   */
  static getInstance() {
    if (!FilesystemHistoryDatabase.instance) {
      FilesystemHistoryDatabase.instance = new FilesystemHistoryDatabase();
    }
    return FilesystemHistoryDatabase.instance;
  }

  /**
   * Loads history from database
   * @param {string} accountId account id
   * @param {string} application application name
   * @return {Promise<{deals: Array<MetatraderDeal>, historyOrders: Array<MetatraderOrder>}>} full account history
   */
  async loadHistory(accountId, application) {
    let { dealsFile, historyOrdersFile } = await this._getDbLocation(accountId, application);
    let deals = await this._readDb(accountId, dealsFile);
    if (deals.length && Array.isArray(deals[0])) {
      this.clear(accountId, application);
      deals = [];
    }
    deals.forEach(deal => deal.time = new Date(deal.time));
    let historyOrders = await this._readDb(accountId, historyOrdersFile);
    if (historyOrders.length && Array.isArray(historyOrders[0])) {
      this.clear(accountId, application);
      historyOrders = [];
    }
    historyOrders.forEach(historyOrder => {
      historyOrder.time = new Date(historyOrder.time);
      historyOrder.doneTime = new Date(historyOrder.doneTime);
    });
    return { deals, historyOrders };
  }

  /**
   * Removes history from database
   * @param {string} accountId account id
   * @param {string} application application name
   * @return {Promise} promise resolving when the history is removed
   */
  async clear(accountId, application) {
    let { dealsFile, historyOrdersFile } = await this._getDbLocation(accountId, application);
    if (_fs2.default.existsSync(dealsFile)) {
      await _fs2.default.promises.unlink(dealsFile);
    }
    if (_fs2.default.existsSync(historyOrdersFile)) {
      await _fs2.default.promises.unlink(historyOrdersFile);
    }
  }

  /**
   * Flushes the new history to db
   * @param {string} accountId account id
   * @param {string} application application name
   * @param {Array<MetatraderOrder>} newHistoryOrders history orders to save to db
   * @param {Array<MetatraderDeal>} newDeals deals to save to db
   * @return {Promise} promise resolving when the history is flushed
   */
  async flush(accountId, application, newHistoryOrders, newDeals) {
    let { dealsFile, historyOrdersFile } = await this._getDbLocation(accountId, application);
    await this._appendDb(historyOrdersFile, newHistoryOrders);
    await this._appendDb(dealsFile, newDeals);
  }

  async _getDbLocation(accountId, application) {
    let dir = _path2.default.join(process.cwd(), '.metaapi');
    await _fs2.default.promises.mkdir(dir, { recursive: true });
    return {
      dealsFile: _path2.default.join(dir, `${accountId}-${application}-deals.bin`),
      historyOrdersFile: _path2.default.join(dir, `${accountId}-${application}-historyOrders.bin`)
    };
  }

  async _readDb(accountId, file) {
    if (!_fs2.default.existsSync(file)) {
      return [];
    }
    try {
      let data = await _fs2.default.promises.readFile(file, 'utf-8');
      let lines = data.split('\n');
      let result = [];
      for (let line of lines) {
        if (line.length) {
          result.push(JSON.parse(line));
        }
      }
      return result;
    } catch (err) {
      this._logger.warn(`${accountId}: failed to read history db, will remove ${file} now`, err);
      await _fs2.default.promises.unlink(file);
      return [];
    }
  }

  async _appendDb(file, records) {
    if (records && records.length) {
      await _fs2.default.promises.appendFile(file, records.map(r => (0, _stringify2.default)(r) + '\n').join(''), 'utf-8');
    }
  }

}
exports.default = FilesystemHistoryDatabase;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9tZXRhQXBpL2hpc3RvcnlEYXRhYmFzZS9maWxlc3lzdGVtSGlzdG9yeURhdGFiYXNlLmVzNiJdLCJuYW1lcyI6WyJGaWxlc3lzdGVtSGlzdG9yeURhdGFiYXNlIiwiSGlzdG9yeURhdGFiYXNlIiwiY29uc3RydWN0b3IiLCJfbG9nZ2VyIiwiZ2V0SW5zdGFuY2UiLCJpbnN0YW5jZSIsImxvYWRIaXN0b3J5IiwiYWNjb3VudElkIiwiYXBwbGljYXRpb24iLCJkZWFsc0ZpbGUiLCJoaXN0b3J5T3JkZXJzRmlsZSIsIl9nZXREYkxvY2F0aW9uIiwiZGVhbHMiLCJfcmVhZERiIiwibGVuZ3RoIiwiQXJyYXkiLCJpc0FycmF5IiwiY2xlYXIiLCJmb3JFYWNoIiwiZGVhbCIsInRpbWUiLCJEYXRlIiwiaGlzdG9yeU9yZGVycyIsImhpc3RvcnlPcmRlciIsImRvbmVUaW1lIiwiZnMiLCJleGlzdHNTeW5jIiwicHJvbWlzZXMiLCJ1bmxpbmsiLCJmbHVzaCIsIm5ld0hpc3RvcnlPcmRlcnMiLCJuZXdEZWFscyIsIl9hcHBlbmREYiIsImRpciIsInBhdGgiLCJqb2luIiwicHJvY2VzcyIsImN3ZCIsIm1rZGlyIiwicmVjdXJzaXZlIiwiZmlsZSIsImRhdGEiLCJyZWFkRmlsZSIsImxpbmVzIiwic3BsaXQiLCJyZXN1bHQiLCJsaW5lIiwicHVzaCIsIkpTT04iLCJwYXJzZSIsImVyciIsIndhcm4iLCJyZWNvcmRzIiwiYXBwZW5kRmlsZSIsIm1hcCIsInIiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7O0FBRUE7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOzs7Ozs7QUFFQTs7O0FBR2UsTUFBTUEseUJBQU4sU0FBd0NDLHlCQUF4QyxDQUF3RDs7QUFFckU7OztBQUdBQyxnQkFBYztBQUNaO0FBQ0EsU0FBS0MsT0FBTCxHQUFlLHVCQUFVLDJCQUFWLENBQWY7QUFDRDs7QUFFRDs7OztBQUlBLFNBQU9DLFdBQVAsR0FBcUI7QUFDbkIsUUFBSSxDQUFD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LFFBQVFFLEdBQVIsQ0FBWUMsS0FBSyx5QkFBZUEsQ0FBZixJQUFvQixJQUFyQyxFQUEyQ3BCLElBQTNDLENBQWdELEVBQWhELENBQTdCLEVBQWtGLE9BQWxGLENBQU47QUFDRDtBQUNGOztBQS9Hb0U7a0JBQWxEbkMseUIiLCJmaWxlIjoiZmlsZXN5c3RlbUhpc3RvcnlEYXRhYmFzZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IEhpc3RvcnlEYXRhYmFzZSBmcm9tICcuL2hpc3RvcnlEYXRhYmFzZSc7XG5pbXBvcnQge2dldExvZ2dlcn0gZnJvbSAnLi4vLi4vbG9nZ2VyJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuLyoqXG4gKiBQcm92aWRlcyBhY2Nlc3MgdG8gaGlzdG9yeSBkYXRhYmFzZSBzdG9yZWQgb24gZmlsZXN5c3RlbVxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBGaWxlc3lzdGVtSGlzdG9yeURhdGFiYXNlIGV4dGVuZHMgSGlzdG9yeURhdGFiYXNlIHtcblxuICAvKipcbiAgICogQ29uc3RydWN0cyB0aGUgY2xhc3MgaW5zdGFuY2VcbiAgICovXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5fbG9nZ2VyID0gZ2V0TG9nZ2VyKCdGaWxlc3lzdGVtSGlzdG9yeURhdGFiYXNlJyk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBoaXN0b3J5IGRhdGFiYXNlIGluc3RhbmNlXG4gICAqIEByZXR1cm5zIHtIaXN0b3J5RGF0YWJhc2V9IGhpc3RvcnkgZGF0YWJhc2UgaW5zdGFuY2VcbiAgICovXG4gIHN0YXRpYyBnZXRJbnN0YW5jZSgpIHtcbiAgICBpZiAoIUZpbGVzeXN0ZW1IaXN0b3J5RGF0YWJhc2UuaW5zdGFuY2UpIHtcbiAgICAgIEZpbGVzeXN0ZW1IaXN0b3J5RGF0YWJhc2UuaW5zdGFuY2UgPSBuZXcgRmlsZXN5c3RlbUhpc3RvcnlEYXRhYmFzZSgpO1xuICAgIH1cbiAgICByZXR1cm4gRmlsZXN5c3RlbUhpc3RvcnlEYXRhYmFzZS5pbnN0YW5jZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMb2FkcyBoaXN0b3J5IGZyb20gZGF0YWJhc2VcbiAgICogQHBhcmFtIHtzdHJpbmd9IGFjY291bnRJZCBhY2NvdW50IGlkXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBhcHBsaWNhdGlvbiBhcHBsaWNhdGlvbiBuYW1lXG4gICAqIEByZXR1cm4ge1Byb21pc2U8e2RlYWxzOiBBcnJheTxNZXRhdHJhZGVyRGVhbD4sIGhpc3RvcnlPcmRlcnM6IEFycmF5PE1ldGF0cmFkZXJPcmRlcj59Pn0gZnVsbCBhY2NvdW50IGhpc3RvcnlcbiAgICovXG4gIGFzeW5jIGxvYWRIaXN0b3J5KGFjY291bnRJZCwgYXBwbGljYXRpb24pIHtcbiAgICBsZXQge2RlYWxzRmlsZSwgaGlzdG9yeU9yZGVyc0ZpbGV9ID0gYXdhaXQgdGhpcy5fZ2V0RGJMb2NhdGlvbihhY2NvdW50SWQsIGFwcGxpY2F0aW9uKTtcbiAgICBsZXQgZGVhbHMgPSBhd2FpdCB0aGlzLl9yZWFkRGIoYWNjb3VudElkLCBkZWFsc0ZpbGUpO1xuICAgIGlmKGRlYWxzLmxlbmd0aCAmJiBBcnJheS5pc0FycmF5KGRlYWxzWzBdKSkge1xuICAgICAgdGhpcy5jbGVhcihhY2NvdW50SWQsIGFwcGxpY2F0aW9uKTtcbiAgICAgIGRlYWxzID0gW107XG4gICAgfVxuICAgIGRlYWxzLmZvckVhY2goZGVhbCA9PiBkZWFsLnRpbWUgPSBuZXcgRGF0ZShkZWFsLnRpbWUpKTtcbiAgICBsZXQgaGlzdG9yeU9yZGVycyA9IGF3YWl0IHRoaXMuX3JlYWREYihhY2NvdW50SWQsIGhpc3RvcnlPcmRlcnNGaWxlKTtcbiAgICBpZihoaXN0b3J5T3JkZXJzLmxlbmd0aCAmJiBBcnJheS5pc0FycmF5KGhpc3RvcnlPcmRlcnNbMF0pKSB7XG4gICAgICB0aGlzLmNsZWFyKGFjY291bnRJZCwgYXBwbGljYXRpb24pO1xuICAgICAgaGlzdG9yeU9yZGVycyA9IFtdO1xuICAgIH1cbiAgICBoaXN0b3J5T3JkZXJzLmZvckVhY2goaGlzdG9yeU9yZGVyID0+IHtcbiAgICAgIGhpc3RvcnlPcmRlci50aW1lID0gbmV3IERhdGUoaGlzdG9yeU9yZGVyLnRpbWUpO1xuICAgICAgaGlzdG9yeU9yZGVyLmRvbmVUaW1lID0gbmV3IERhdGUoaGlzdG9yeU9yZGVyLmRvbmVUaW1lKTtcbiAgICB9KTtcbiAgICByZXR1cm4ge2RlYWxzLCBoaXN0b3J5T3JkZXJzfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmVzIGhpc3RvcnkgZnJvbSBkYXRhYmFzZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gYWNjb3VudElkIGFjY291bnQgaWRcbiAgICogQHBhcmFtIHtzdHJpbmd9IGFwcGxpY2F0aW9uIGFwcGxpY2F0aW9uIG5hbWVcbiAgICogQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZSByZXNvbHZpbmcgd2hlbiB0aGUgaGlzdG9yeSBpcyByZW1vdmVkXG4gICAqL1xuICBhc3luYyBjbGVhcihhY2NvdW50SWQsIGFwcGxpY2F0aW9uKSB7XG4gICAgbGV0IHtkZWFsc0ZpbGUsIGhpc3RvcnlPcmRlcnNGaWxlfSA9IGF3YWl0IHRoaXMuX2dldERiTG9jYXRpb24oYWNjb3VudElkLCBhcHBsaWNhdGlvbik7XG4gICAgaWYoZnMuZXhpc3RzU3luYyhkZWFsc0ZpbGUpKSB7XG4gICAgICBhd2FpdCBmcy5wcm9taXNlcy51bmxpbmsoZGVhbHNGaWxlKTtcbiAgICB9XG4gICAgaWYoZnMuZXhpc3RzU3luYyhoaXN0b3J5T3JkZXJzRmlsZSkpIHtcbiAgICAgIGF3YWl0IGZzLnByb21pc2VzLnVubGluayhoaXN0b3J5T3JkZXJzRmlsZSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEZsdXNoZXMgdGhlIG5ldyBoaXN0b3J5IHRvIGRiXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBhY2NvdW50SWQgYWNjb3VudCBpZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gYXBwbGljYXRpb24gYXBwbGljYXRpb24gbmFtZVxuICAgKiBAcGFyYW0ge0FycmF5PE1ldGF0cmFkZXJPcmRlcj59IG5ld0hpc3RvcnlPcmRlcnMgaGlzdG9yeSBvcmRlcnMgdG8gc2F2ZSB0byBkYlxuICAgKiBAcGFyYW0ge0FycmF5PE1ldGF0cmFkZXJEZWFsPn0gbmV3RGVhbHMgZGVhbHMgdG8gc2F2ZSB0byBkYlxuICAgKiBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlIHJlc29sdmluZyB3aGVuIHRoZSBoaXN0b3J5IGlzIGZsdXNoZWRcbiAgICovXG4gIGFzeW5jIGZsdXNoKGFjY291bnRJZCwgYXBwbGljYXRpb24sIG5ld0hpc3RvcnlPcmRlcnMsIG5ld0RlYWxzKSB7XG4gICAgbGV0IHtkZWFsc0ZpbGUsIGhpc3RvcnlPcmRlcnNGaWxlfSA9IGF3YWl0IHRoaXMuX2dldERiTG9jYXRpb24oYWNjb3VudElkLCBhcHBsaWNhdGlvbik7XG4gICAgYXdhaXQgdGhpcy5fYXBwZW5kRGIoaGlzdG9yeU9yZGVyc0ZpbGUsIG5ld0hpc3RvcnlPcmRlcnMpO1xuICAgIGF3YWl0IHRoaXMuX2FwcGVuZERiKGRlYWxzRmlsZSwgbmV3RGVhbHMpO1xuICB9XG5cbiAgYXN5bmMgX2dldERiTG9jYXRpb24oYWNjb3VudElkLCBhcHBsaWNhdGlvbikge1xuICAgIGxldCBkaXIgPSBwYXRoLmpvaW4ocHJvY2Vzcy5jd2QoKSwgJy5tZXRhYXBpJyk7XG4gICAgYXdhaXQgZnMucHJvbWlzZXMubWtkaXIoZGlyLCB7cmVjdXJzaXZlOiB0cnVlfSk7XG4gICAgcmV0dXJuIHtcbiAgICAgIGRlYWxzRmlsZTogcGF0aC5qb2luKGRpciwgYCR7YWNjb3VudElkfS0ke2FwcGxpY2F0aW9ufS1kZWFscy5iaW5gKSxcbiAgICAgIGhpc3RvcnlPcmRlcnNGaWxlOiBwYXRoLmpvaW4oZGlyLCBgJHthY2NvdW50SWR9LSR7YXBwbGljYXRpb259LWhpc3RvcnlPcmRlcnMuYmluYClcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgX3JlYWREYihhY2NvdW50SWQsIGZpbGUpIHtcbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoZmlsZSkpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIGxldCBkYXRhID0gYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUoZmlsZSwgJ3V0Zi04Jyk7XG4gICAgICBsZXQgbGluZXMgPSBkYXRhLnNwbGl0KCdcXG4nKTtcbiAgICAgIGxldCByZXN1bHQgPSBbXTtcbiAgICAgIGZvciAobGV0IGxpbmUgb2YgbGluZXMpIHtcbiAgICAgICAgaWYgKGxpbmUubGVuZ3RoKSB7XG4gICAgICAgICAgcmVzdWx0LnB1c2goSlNPTi5wYXJzZShsaW5lKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aGlzLl9sb2dnZXIud2FybihgJHthY2NvdW50SWR9OiBmYWlsZWQgdG8gcmVhZCBoaXN0b3J5IGRiLCB3aWxsIHJlbW92ZSAke2ZpbGV9IG5vd2AsIGVycik7XG4gICAgICBhd2FpdCBmcy5wcm9taXNlcy51bmxpbmsoZmlsZSk7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgX2FwcGVuZERiKGZpbGUsIHJlY29yZHMpIHtcbiAgICBpZiAocmVjb3JkcyAmJiByZWNvcmRzLmxlbmd0aCkge1xuICAgICAgYXdhaXQgZnMucHJvbWlzZXMuYXBwZW5kRmlsZShmaWxlLCByZWNvcmRzLm1hcChyID0+IEpTT04uc3RyaW5naWZ5KHIpICsgJ1xcbicpLmpvaW4oJycpLCAndXRmLTgnKTtcbiAgICB9XG4gIH1cblxufVxuIl19