'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _timeoutError = require('../clients/timeoutError');

var _timeoutError2 = _interopRequireDefault(_timeoutError);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Implements a MetaTrader account replica entity
 */
class MetatraderAccountReplica {

  /**
   * Constructs a MetaTrader account entity
   * @param {MetatraderAccountReplicaDto} data MetaTrader account replica data
   * @param {MetatraderAccount} primaryAccount primary MetaTrader account
   * @param {MetatraderAccountClient} metatraderAccountClient MetaTrader account REST API client
   */
  constructor(data, primaryAccount, metatraderAccountClient) {
    this._data = data;
    this._primaryAccount = primaryAccount;
    this._metatraderAccountClient = metatraderAccountClient;
  }

  /**
   * Returns account replica id
   * @return {String} account replica id
   */
  get id() {
    return this._data._id;
  }

  /**
   * Returns MetaTrader magic to place trades using
   * @return {Number} MetaTrader magic to place trades using
   */
  get magic() {
    return this._data.magic;
  }

  /**
   * Returns account replica deployment state. One of CREATED, DEPLOYING, DEPLOYED, UNDEPLOYING, UNDEPLOYED, DELETING
   * @return {String} account replica deployment state
   */
  get state() {
    return this._data.state;
  }

  /**
   * Returns terminal & broker connection status, one of CONNECTED, DISCONNECTED, DISCONNECTED_FROM_BROKER
   * @return {String} terminal & broker connection status
   */
  get connectionStatus() {
    return this._data.connectionStatus;
  }

  /**
   * Returns extra information which can be stored together with your account replica
   * @return {Object} extra information which can be stored together with your account replica
   */
  get metadata() {
    return this._data.metadata;
  }

  /**
   * Returns user-defined account replica tags
   * @return {Array<string>} user-defined account replica tags
   */
  get tags() {
    return this._data.tags;
  }

  /**
   * Returns number of resource slots to allocate to account replica. Allocating extra resource slots
   * results in better account performance under load which is useful for some applications. E.g. if you have many
   * accounts copying the same strategy via CopyFactory API, then you can increase resourceSlots to get a lower trade
   * copying latency. Please note that allocating extra resource slots is a paid option. Please note that high
   * reliability accounts use redundant infrastructure, so that each resource slot for a high reliability account
   * is billed as 2 standard resource slots.  Default is 1.
   * @return {number} number of resource slots to allocate to account replica
   */
  get resourceSlots() {
    return this._data.resourceSlots;
  }

  /**
   * Returns the number of CopyFactory 2 resource slots to allocate to account replica.
   * Allocating extra resource slots results in lower trade copying latency. Please note that allocating extra resource
   * slots is a paid option. Please also note that CopyFactory 2 uses redundant infrastructure so that
   * each CopyFactory resource slot is billed as 2 standard resource slots. You will be billed for CopyFactory 2
   * resource slots only if you have added your account replica to CopyFactory 2 by specifying copyFactoryRoles field.
   * Default is 1.
   * @return {number} number of CopyFactory 2 resource slots to allocate to account replica
   */
  get copyFactoryResourceSlots() {
    return this._data.copyFactoryResourceSlots;
  }

  /**
   * Returns reliability value. Possible values are regular and high
   * @return {string} account replica reliability value
   */
  get reliability() {
    return this._data.reliability;
  }

  /**
     * Returns account replica region
     * @return {string} account replica region value
     */
  get region() {
    return this._data.region;
  }

  /**
   * Returns primary MetaTrader account of the replica
   * @return {MetatraderAccount} primary MetaTrader account of the replica
   */
  get primaryAccount() {
    return this._primaryAccount;
  }

  /**
   * Updates replica data
   * @param {MetatraderAccountReplicaDto} data MetaTrader account replica data 
   */
  updateData(data) {
    this._data = data;
  }

  /**
   * Removes MetaTrader account replica. Cloud account transitions to DELETING state. 
   * It takes some time for an account to be eventually deleted. Self-hosted 
   * account is deleted immediately.
   * @return {Promise} promise resolving when account replica is scheduled for deletion
   */
  async remove() {
    await this._metatraderAccountClient.deleteAccountReplica(this.primaryAccount.id, this.id);
    try {
      await this._primaryAccount.reload();
    } catch (err) {
      if (err.name !== 'NotFoundError') {
        throw err;
      }
    }
  }

  /**
   * Schedules account replica for deployment. It takes some time for API server to be started and account replica to reach the DEPLOYED
   * state
   * @returns {Promise} promise resolving when account replica is scheduled for deployment
   */
  async deploy() {
    await this._metatraderAccountClient.deployAccountReplica(this.primaryAccount.id, this.id);
    await this._primaryAccount.reload();
  }

  /**
   * Schedules account replica for undeployment. It takes some time for API server to be stopped and account replica to reach the
   * UNDEPLOYED state
   * @returns {Promise} promise resolving when account replica is scheduled for undeployment
   */
  async undeploy() {
    await this._metatraderAccountClient.undeployAccountReplica(this.primaryAccount.id, this.id);
    await this._primaryAccount.reload();
  }

  /**
   * Schedules account replica for redeployment. It takes some time for API server to be restarted and account replica to reach the
   * DEPLOYED state
   * @returns {Promise} promise resolving when account replica is scheduled for redeployment
   */
  async redeploy() {
    await this._metatraderAccountClient.redeployAccountReplica(this.primaryAccount.id, this.id);
    await this._primaryAccount.reload();
  }

  /**
   * Increases MetaTrader account replica reliability. The account replica will be temporary stopped to perform this action
   * @returns {Promise} promise resolving when account replica reliability is increased
   */
  async increaseReliability() {
    await this._metatraderAccountClient.increaseReliability(this.id);
    await this._primaryAccount.reload();
  }

  /**
   * Waits until API server has finished deployment and account replica reached the DEPLOYED state
   * @param {Number} timeoutInSeconds wait timeout in seconds, default is 5m
   * @param {Number} intervalInMilliseconds interval between account replica reloads while waiting for a change, default is 1s
   * @return {Promise} promise which resolves when account replica is deployed
   * @throws {TimeoutError} if account replica has not reached the DEPLOYED state within timeout allowed
   */
  async waitDeployed(timeoutInSeconds = 300, intervalInMilliseconds = 1000) {
    let startTime = Date.now();
    await this._primaryAccount.reload();
    while (this.state !== 'DEPLOYED' && startTime + timeoutInSeconds * 1000 > Date.now()) {
      await this._delay(intervalInMilliseconds);
      await this._primaryAccount.reload();
    }
    if (this.state !== 'DEPLOYED') {
      throw new _timeoutError2.default('Timed out waiting for account replica ' + this.id + ' to be deployed');
    }
  }

  /**
   * Waits until API server has finished undeployment and account replica reached the UNDEPLOYED state
   * @param {Number} timeoutInSeconds wait timeout in seconds, default is 5m
   * @param {Number} intervalInMilliseconds interval between account replica reloads while waiting for a change, default is 1s
   * @return {Promise} promise which resolves when account replica is deployed
   * @throws {TimeoutError} if account replica has not reached the UNDEPLOYED state within timeout allowed
   */
  async waitUndeployed(timeoutInSeconds = 300, intervalInMilliseconds = 1000) {
    let startTime = Date.now();
    await this._primaryAccount.reload();
    while (this.state !== 'UNDEPLOYED' && startTime + timeoutInSeconds * 1000 > Date.now()) {
      await this._delay(intervalInMilliseconds);
      await this._primaryAccount.reload();
    }
    if (this.state !== 'UNDEPLOYED') {
      throw new _timeoutError2.default('Timed out waiting for account replica ' + this.id + ' to be undeployed');
    }
  }

  /**
   * Waits until account replica has been deleted
   * @param {Number} timeoutInSeconds wait timeout in seconds, default is 5m
   * @param {Number} intervalInMilliseconds interval between account replica reloads while waiting for a change, default is 1s
   * @return {Promise} promise which resolves when account replica is deleted
   * @throws {TimeoutError} if account replica was not deleted within timeout allowed
   */
  async waitRemoved(timeoutInSeconds = 300, intervalInMilliseconds = 1000) {
    let startTime = Date.now();
    await this._primaryAccount.reload();
    while (startTime + timeoutInSeconds * 1000 > Date.now() && this._primaryAccount.accountRegions[this.region] === this.id) {
      await this._delay(intervalInMilliseconds);
      await this._primaryAccount.reload();
    }
    if (this._primaryAccount.accountRegions[this.region] === this.id) {
      throw new _timeoutError2.default('Timed out waiting for account ' + this.id + ' to be deleted');
    }
  }

  /**
   * Waits until API server has connected to the terminal and terminal has connected to the broker
   * @param {Number} timeoutInSeconds wait timeout in seconds, default is 5m
   * @param {Number} intervalInMilliseconds interval between account replica reloads while waiting for a change, default is 1s
   * @return {Promise} promise which resolves when API server is connected to the broker
   * @throws {TimeoutError} if account replica has not connected to the broker within timeout allowed
   */
  async waitConnected(timeoutInSeconds = 300, intervalInMilliseconds = 1000) {
    let startTime = Date.now();
    await this._primaryAccount.reload();
    while (this.connectionStatus !== 'CONNECTED' && startTime + timeoutInSeconds * 1000 > Date.now()) {
      await this._delay(intervalInMilliseconds);
      await this._primaryAccount.reload();
    }
    if (this.connectionStatus !== 'CONNECTED') {
      throw new _timeoutError2.default('Timed out waiting for account ' + this.id + ' to connect to the broker');
    }
  }

  /**
   * Updates MetaTrader account replica data
   * @param {UpdatedMetatraderAccountReplicaDto} account MetaTrader account replica update
   * @return {Promise} promise resolving when account replica is updated
   */
  async update(account) {
    await this._metatraderAccountClient.updateAccountReplica(this._primaryAccount.id, this.id, account);
    await this._primaryAccount.reload();
  }

  _delay(timeoutInMilliseconds) {
    return new _promise2.default(res => setTimeout(res, timeoutInMilliseconds));
  }

}
exports.default = MetatraderAccountReplica;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9tZXRhQXBpL21ldGF0cmFkZXJBY2NvdW50UmVwbGljYS5lczYiXSwibmFtZXMiOlsiTWV0YXRyYWRlckFjY291bnRSZXBsaWNhIiwiY29uc3RydWN0b3IiLCJkYXRhIiwicHJpbWFyeUFjY291bnQiLCJtZXRhdHJhZGVyQWNjb3VudENsaWVudCIsIl9kYXRhIiwiX3ByaW1hcnlBY2NvdW50IiwiX21ldGF0cmFkZXJBY2NvdW50Q2xpZW50IiwiaWQiLCJfaWQiLCJtYWdpYyIsInN0YXRlIiwiY29ubmVjdGlvblN0YXR1cyIsIm1ldGFkYXRhIiwidGFncyIsInJlc291cmNlU2xvdHMiLCJjb3B5RmFjdG9yeVJlc291cmNlU2xvdHMiLCJyZWxpYWJpbGl0eSIsInJlZ2lvbiIsInVwZGF0ZURhdGEiLCJyZW1vdmUiLCJkZWxldGVBY2NvdW50UmVwbGljYSIsInJlbG9hZCIsImVyciIsIm5hbWUiLCJkZXBsb3kiLCJkZXBsb3lBY2NvdW50UmVwbGljYSIsInVuZGVwbG95IiwidW5kZXBsb3lBY2NvdW50UmVwbGljYSIsInJlZGVwbG95IiwicmVkZXBsb3lBY2NvdW50UmVwbGljYSIsImluY3JlYXNlUmVsaWFiaWxpdHkiLCJ3YWl0RGVwbG95ZWQiLCJ0aW1lb3V0SW5TZWNvbmRzIiwiaW50ZXJ2YWxJbk1pbGxpc2Vjb25kcyIsInN0YXJ0VGltZSIsIkRhdGUiLCJub3ciLCJfZGVsYXkiLCJUaW1lb3V0RXJyb3IiLCJ3YWl0VW5kZXBsb3llZCIsIndhaXRSZW1vdmVkIiwiYWNjb3VudFJlZ2lvbnMiLCJ3YWl0Q29ubmVjdGVkIiwidXBkYXRlIiwiYWNjb3VudCIsInVwZGF0ZUFjY291bnRSZXBsaWNhIiwidGltZW91dEluTWlsbGlzZWNvbmRzIiwicmVzIiwic2V0VGltZW91dCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBOzs7Ozs7QUFFQTs7O0FBR2UsTUFBTUEsd0JBQU4sQ0FBK0I7O0FBRTVDOzs7Ozs7QUFNQUMsY0FBWUMsSUFBWixF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QUNELFFBQUksS0FBS1YsZ0JBQUwsS0FBMEIsV0FBOUIsRUFBMkM7QUFDekMsWUFBTSxJQUFJMkIsc0JBQUosQ0FBaUIsbUNBQW1DLEtBQUsvQixFQUF4QyxHQUE2QywyQkFBOUQsQ0FBTjtBQUNEO0FBQ0Y7O0FBRUQ7Ozs7O0FBS0EsUUFBTW9DLE1BQU4sQ0FBYUMsT0FBYixFQUFzQjtBQUNwQixVQUFNLEtBQUt0Qyx3QkFBTCxDQUE4QnVDLG9CQUE5QixDQUFtRCxLQUFLeEMsZUFBTCxDQUFxQkUsRUFBeEUsRUFBNEUsS0FBS0EsRUFBakYsRUFBcUZxQyxPQUFyRixDQUFOO0FBQ0EsVUFBTSxLQUFLdkMsZUFBTCxDQUFxQmdCLE1BQXJCLEVBQU47QUFDRDs7QUFFRGdCLFNBQU9TLHFCQUFQLEVBQThCO0FBQzVCLFdBQU8sc0JBQVlDLE9BQU9DLFdBQVdELEdBQVgsRUFBZ0JELHFCQUFoQixDQUFuQixDQUFQO0FBQ0Q7O0FBelEyQztrQkFBekIvQyx3QiIsImZpbGUiOiJtZXRhdHJhZGVyQWNjb3VudFJlcGxpY2EuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgVGltZW91dEVycm9yIGZyb20gJy4uL2NsaWVudHMvdGltZW91dEVycm9yJztcblxuLyoqXG4gKiBJbXBsZW1lbnRzIGEgTWV0YVRyYWRlciBhY2NvdW50IHJlcGxpY2EgZW50aXR5XG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE1ldGF0cmFkZXJBY2NvdW50UmVwbGljYSB7XG5cbiAgLyoqXG4gICAqIENvbnN0cnVjdHMgYSBNZXRhVHJhZGVyIGFjY291bnQgZW50aXR5XG4gICAqIEBwYXJhbSB7TWV0YXRyYWRlckFjY291bnRSZXBsaWNhRHRvfSBkYXRhIE1ldGFUcmFkZXIgYWNjb3VudCByZXBsaWNhIGRhdGFcbiAgICogQHBhcmFtIHtNZXRhdHJhZGVyQWNjb3VudH0gcHJpbWFyeUFjY291bnQgcHJpbWFyeSBNZXRhVHJhZGVyIGFjY291bnRcbiAgICogQHBhcmFtIHtNZXRhdHJhZGVyQWNjb3VudENsaWVudH0gbWV0YXRyYWRlckFjY291bnRDbGllbnQgTWV0YVRyYWRlciBhY2NvdW50IFJFU1QgQVBJIGNsaWVudFxuICAgKi9cbiAgY29uc3RydWN0b3IoZGF0YSwgcHJpbWFyeUFjY291bnQsIG1ldGF0cmFkZXJBY2NvdW50Q2xpZW50KSB7XG4gICAgdGhpcy5fZGF0YSA9IGRhdGE7XG4gICAgdGhpcy5fcHJpbWFyeUFjY291bnQgPSBwcmltYXJ5QWNjb3VudDtcbiAgICB0aGlzLl9tZXRhdHJhZGVyQWNjb3VudENsaWVudCA9IG1ldGF0cmFkZXJBY2NvdW50Q2xpZW50O1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYWNjb3VudCByZXBsaWNhIGlkXG4gICAqIEByZXR1cm4ge1N0cmluZ30gYWNjb3VudCByZXBsaWNhIGlkXG4gICAqL1xuICBnZXQgaWQoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2RhdGEuX2lkO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgTWV0YVRyYWRlciBtYWdpYyB0byBwbGFjZSB0cmFkZXMgdXNpbmdcbiAgICogQHJldHVybiB7TnVtYmVyfSBNZXRhVHJhZGVyIG1hZ2ljIHRvIHBsYWNlIHRyYWRlcyB1c2luZ1xuICAgKi9cbiAgZ2V0IG1hZ2ljKCkge1xuICAgIHJldHVybiB0aGlzLl9kYXRhLm1hZ2ljO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYWNjb3VudCByZXBsaWNhIGRlcGxveW1lbnQgc3RhdGUuIE9uZSBvZiBDUkVBVEVELCBERVBMT1lJTkcsIERFUExPWUVELCBVTkRFUExPWUlORywgVU5ERVBMT1lFRCwgREVMRVRJTkdcbiAgICogQHJldHVybiB7U3RyaW5nfSBhY2NvdW50IHJlcGxpY2EgZGVwbG95bWVudCBzdGF0ZVxuICAgKi9cbiAgZ2V0IHN0YXRlKCkge1xuICAgIHJldHVybiB0aGlzLl9kYXRhLnN0YXRlO1xuICB9XG4gIFxuICAvKipcbiAgICogUmV0dXJucyB0ZXJtaW5hbCAmIGJyb2tlciBjb25uZWN0aW9uIHN0YXR1cywgb25lIG9mIENPTk5FQ1RFRCwgRElTQ09OTkVDVEVELCBESVNDT05ORUNURURfRlJPTV9CUk9LRVJcbiAgICogQHJldHVybiB7U3RyaW5nfSB0ZXJtaW5hbCAmIGJyb2tlciBjb25uZWN0aW9uIHN0YXR1c1xuICAgKi9cbiAgZ2V0IGNvbm5lY3Rpb25TdGF0dXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2RhdGEuY29ubmVjdGlvblN0YXR1cztcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGV4dHJhIGluZm9ybWF0aW9uIHdoaWNoIGNhbiBiZSBzdG9yZWQgdG9nZXRoZXIgd2l0aCB5b3VyIGFjY291bnQgcmVwbGljYVxuICAgKiBAcmV0dXJuIHtPYmplY3R9IGV4dHJhIGluZm9ybWF0aW9uIHdoaWNoIGNhbiBiZSBzdG9yZWQgdG9nZXRoZXIgd2l0aCB5b3VyIGFjY291bnQgcmVwbGljYVxuICAgKi9cbiAgZ2V0IG1ldGFkYXRhKCkge1xuICAgIHJldHVybiB0aGlzLl9kYXRhLm1ldGFkYXRhO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdXNlci1kZWZpbmVkIGFjY291bnQgcmVwbGljYSB0YWdzXG4gICAqIEByZXR1cm4ge0FycmF5PHN0cmluZz59IHVzZXItZGVmaW5lZCBhY2NvdW50IHJlcGxpY2EgdGFnc1xuICAgKi9cbiAgZ2V0IHRhZ3MoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2RhdGEudGFncztcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIG51bWJlciBvZiByZXNvdXJjZSBzbG90cyB0byBhbGxvY2F0ZSB0byBhY2NvdW50IHJlcGxpY2EuIEFsbG9jYXRpbmcgZXh0cmEgcmVzb3VyY2Ugc2xvdHNcbiAgICogcmVzdWx0cyBpbiBiZXR0ZXIgYWNjb3VudCBwZXJmb3JtYW5jZSB1bmRlciBsb2FkIHdoaWNoIGlzIHVzZWZ1bCBmb3Igc29tZSBhcHBsaWNhdGlvbnMuIEUuZy4gaWYgeW91IGhhdmUgbWFueVxuICAgKiBhY2NvdW50cyBjb3B5aW5nIHRoZSBzYW1lIHN0cmF0ZWd5IHZpYSBDb3B5RmFjdG9yeSBBUEksIHRoZW4geW91IGNhbiBpbmNyZWFzZSByZXNvdXJjZVNsb3RzIHRvIGdldCBhIGxvd2VyIHRyYWRlXG4gICAqIGNvcHlpbmcgbGF0ZW5jeS4gUGxlYXNlIG5vdGUgdGhhdCBhbGxvY2F0aW5nIGV4dHJhIHJlc291cmNlIHNsb3RzIGlzIGEgcGFpZCBvcHRpb24uIFBsZWFzZSBub3RlIHRoYXQgaGlnaFxuICAgKiByZWxpYWJpbGl0eSBhY2NvdW50cyB1c2UgcmVkdW5kYW50IGluZnJhc3RydWN0dXJlLCBzbyB0aGF0IGVhY2ggcmVzb3VyY2Ugc2xvdCBmb3IgYSBoaWdoIHJlbGlhYmlsaXR5IGFjY291bnRcbiAgICogaXMgYmlsbGVkIGFzIDIgc3RhbmRhcmQgcmVzb3VyY2Ugc2xvdHMuICBEZWZhdWx0IGlzIDEuXG4gICAqIEByZXR1cm4ge251bWJlcn0gbnVtYmVyIG9mIHJlc291cmNlIHNsb3RzIHRvIGFsbG9jYXRlIHRvIGFjY291bnQgcmVwbGljYVxuICAgKi9cbiAgZ2V0IHJlc291cmNlU2xvdHMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2RhdGEucmVzb3VyY2VTbG90cztcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBudW1iZXIgb2YgQ29weUZhY3RvcnkgMiByZXNvdXJjZSBzbG90cyB0byBhbGxvY2F0ZSB0byBhY2NvdW50IHJlcGxpY2EuXG4gICAqIEFsbG9jYXRpbmcgZXh0cmEgcmVzb3VyY2Ugc2xvdHMgcmVzdWx0cyBpbiBsb3dlciB0cmFkZSBjb3B5aW5nIGxhdGVuY3kuIFBsZWFzZSBub3RlIHRoYXQgYWxsb2NhdGluZyBleHRyYSByZXNvdXJjZVxuICAgKiBzbG90cyBpcyBhIHBhaWQgb3B0aW9uLiBQbGVhc2UgYWxzbyBub3RlIHRoYXQgQ29weUZhY3RvcnkgMiB1c2VzIHJlZHVuZGFudCBpbmZyYXN0cnVjdHVyZSBzbyB0aGF0XG4gICAqIGVhY2ggQ29weUZhY3RvcnkgcmVzb3VyY2Ugc2xvdCBpcyBiaWxsZWQgYXMgMiBzdGFuZGFyZCByZXNvdXJjZSBzbG90cy4gWW91IHdpbGwgYmUgYmlsbGVkIGZvciBDb3B5RmFjdG9yeSAyXG4gICAqIHJlc291cmNlIHNsb3RzIG9ubHkgaWYgeW91IGhhdmUgYWRkZWQgeW91ciBhY2NvdW50IHJlcGxpY2EgdG8gQ29weUZhY3RvcnkgMiBieSBzcGVjaWZ5aW5nIGNvcHlGYWN0b3J5Um9sZXMgZmllbGQuXG4gICAqIERlZmF1bHQgaXMgMS5cbiAgICogQHJldHVybiB7bnVtYmVyfSBudW1iZXIgb2YgQ29weUZhY3RvcnkgMiByZXNvdXJjZSBzbG90cyB0byBhbGxvY2F0ZSB0byBhY2NvdW50IHJlcGxpY2FcbiAgICovXG4gIGdldCBjb3B5RmFjdG9yeVJlc291cmNlU2xvdHMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2RhdGEuY29weUZhY3RvcnlSZXNvdXJjZVNsb3RzO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgcmVsaWFiaWxpdHkgdmFsdWUuIFBvc3NpYmxlIHZhbHVlcyBhcmUgcmVndWxhciBhbmQgaGlnaFxuICAgKiBAcmV0dXJuIHtzdHJpbmd9IGFjY291bnQgcmVwbGljYSByZWxpYWJpbGl0eSB2YWx1ZVxuICAgKi9cbiAgZ2V0IHJlbGlhYmlsaXR5KCkge1xuICAgIHJldHVybiB0aGlzLl9kYXRhLnJlbGlhYmlsaXR5O1xuICB9XG5cbiAgLyoqXG4gICAgICogUmV0dXJucyBhY2NvdW50IHJlcGxpY2EgcmVnaW9uXG4gICAgICogQHJldHVybiB7c3RyaW5nfSBhY2NvdW50IHJlcGxpY2EgcmVnaW9uIHZhbHVlXG4gICAgICovXG4gIGdldCByZWdpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2RhdGEucmVnaW9uO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgcHJpbWFyeSBNZXRhVHJhZGVyIGFjY291bnQgb2YgdGhlIHJlcGxpY2FcbiAgICogQHJldHVybiB7TWV0YXRyYWRlckFjY291bnR9IHByaW1hcnkgTWV0YVRyYWRlciBhY2NvdW50IG9mIHRoZSByZXBsaWNhXG4gICAqL1xuICBnZXQgcHJpbWFyeUFjY291bnQoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3ByaW1hcnlBY2NvdW50O1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgcmVwbGljYSBkYXRhXG4gICAqIEBwYXJhbSB7TWV0YXRyYWRlckFjY291bnRSZXBsaWNhRHRvfSBkYXRhIE1ldGFUcmFkZXIgYWNjb3VudCByZXBsaWNhIGRhdGEgXG4gICAqL1xuICB1cGRhdGVEYXRhKGRhdGEpIHtcbiAgICB0aGlzLl9kYXRhID0gZGF0YTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmVzIE1ldGFUcmFkZXIgYWNjb3VudCByZXBsaWNhLiBDbG91ZCBhY2NvdW50IHRyYW5zaXRpb25zIHRvIERFTEVUSU5HIHN0YXRlLiBcbiAgICogSXQgdGFrZXMgc29tZSB0aW1lIGZvciBhbiBhY2NvdW50IHRvIGJlIGV2ZW50dWFsbHkgZGVsZXRlZC4gU2VsZi1ob3N0ZWQgXG4gICAqIGFjY291bnQgaXMgZGVsZXRlZCBpbW1lZGlhdGVseS5cbiAgICogQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZSByZXNvbHZpbmcgd2hlbiBhY2NvdW50IHJlcGxpY2EgaXMgc2NoZWR1bGVkIGZvciBkZWxldGlvblxuICAgKi9cbiAgYXN5bmMgcmVtb3ZlKCkge1xuICAgIGF3YWl0IHRoaXMuX21ldGF0cmFkZXJBY2NvdW50Q2xpZW50LmRlbGV0ZUFjY291bnRSZXBsaWNhKHRoaXMucHJpbWFyeUFjY291bnQuaWQsIHRoaXMuaWQpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLl9wcmltYXJ5QWNjb3VudC5yZWxvYWQoKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmIChlcnIubmFtZSAhPT0gJ05vdEZvdW5kRXJyb3InKSB7XG4gICAgICAgIHRocm93IGVycjtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2NoZWR1bGVzIGFjY291bnQgcmVwbGljYSBmb3IgZGVwbG95bWVudC4gSXQgdGFrZXMgc29tZSB0aW1lIGZvciBBUEkgc2VydmVyIHRvIGJlIHN0YXJ0ZWQgYW5kIGFjY291bnQgcmVwbGljYSB0byByZWFjaCB0aGUgREVQTE9ZRURcbiAgICogc3RhdGVcbiAgICogQHJldHVybnMge1Byb21pc2V9IHByb21pc2UgcmVzb2x2aW5nIHdoZW4gYWNjb3VudCByZXBsaWNhIGlzIHNjaGVkdWxlZCBmb3IgZGVwbG95bWVudFxuICAgKi9cbiAgYXN5bmMgZGVwbG95KCkge1xuICAgIGF3YWl0IHRoaXMuX21ldGF0cmFkZXJBY2NvdW50Q2xpZW50LmRlcGxveUFjY291bnRSZXBsaWNhKHRoaXMucHJpbWFyeUFjY291bnQuaWQsIHRoaXMuaWQpO1xuICAgIGF3YWl0IHRoaXMuX3ByaW1hcnlBY2NvdW50LnJlbG9hZCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNjaGVkdWxlcyBhY2NvdW50IHJlcGxpY2EgZm9yIHVuZGVwbG95bWVudC4gSXQgdGFrZXMgc29tZSB0aW1lIGZvciBBUEkgc2VydmVyIHRvIGJlIHN0b3BwZWQgYW5kIGFjY291bnQgcmVwbGljYSB0byByZWFjaCB0aGVcbiAgICogVU5ERVBMT1lFRCBzdGF0ZVxuICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gcHJvbWlzZSByZXNvbHZpbmcgd2hlbiBhY2NvdW50IHJlcGxpY2EgaXMgc2NoZWR1bGVkIGZvciB1bmRlcGxveW1lbnRcbiAgICovXG4gIGFzeW5jIHVuZGVwbG95KCkge1xuICAgIGF3YWl0IHRoaXMuX21ldGF0cmFkZXJBY2NvdW50Q2xpZW50LnVuZGVwbG95QWNjb3VudFJlcGxpY2EodGhpcy5wcmltYXJ5QWNjb3VudC5pZCwgdGhpcy5pZCk7XG4gICAgYXdhaXQgdGhpcy5fcHJpbWFyeUFjY291bnQucmVsb2FkKCk7XG4gIH1cblxuICAvKipcbiAgICogU2NoZWR1bGVzIGFjY291bnQgcmVwbGljYSBmb3IgcmVkZXBsb3ltZW50LiBJdCB0YWtlcyBzb21lIHRpbWUgZm9yIEFQSSBzZXJ2ZXIgdG8gYmUgcmVzdGFydGVkIGFuZCBhY2NvdW50IHJlcGxpY2EgdG8gcmVhY2ggdGhlXG4gICAqIERFUExPWUVEIHN0YXRlXG4gICAqIEByZXR1cm5zIHtQcm9taXNlfSBwcm9taXNlIHJlc29sdmluZyB3aGVuIGFjY291bnQgcmVwbGljYSBpcyBzY2hlZHVsZWQgZm9yIHJlZGVwbG95bWVudFxuICAgKi9cbiAgYXN5bmMgcmVkZXBsb3koKSB7XG4gICAgYXdhaXQgdGhpcy5fbWV0YXRyYWRlckFjY291bnRDbGllbnQucmVkZXBsb3lBY2NvdW50UmVwbGljYSh0aGlzLnByaW1hcnlBY2NvdW50LmlkLCB0aGlzLmlkKTtcbiAgICBhd2FpdCB0aGlzLl9wcmltYXJ5QWNjb3VudC5yZWxvYWQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbmNyZWFzZXMgTWV0YVRyYWRlciBhY2NvdW50IHJlcGxpY2EgcmVsaWFiaWxpdHkuIFRoZSBhY2NvdW50IHJlcGxpY2Egd2lsbCBiZSB0ZW1wb3Jhcnkgc3RvcHBlZCB0byBwZXJmb3JtIHRoaXMgYWN0aW9uXG4gICAqIEByZXR1cm5zIHtQcm9taXNlfSBwcm9taXNlIHJlc29sdmluZyB3aGVuIGFjY291bnQgcmVwbGljYSByZWxpYWJpbGl0eSBpcyBpbmNyZWFzZWRcbiAgICovXG4gIGFzeW5jIGluY3JlYXNlUmVsaWFiaWxpdHkoKSB7XG4gICAgYXdhaXQgdGhpcy5fbWV0YXRyYWRlckFjY291bnRDbGllbnQuaW5jcmVhc2VSZWxpYWJpbGl0eSh0aGlzLmlkKTtcbiAgICBhd2FpdCB0aGlzLl9wcmltYXJ5QWNjb3VudC5yZWxvYWQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBXYWl0cyB1bnRpbCBBUEkgc2VydmVyIGhhcyBmaW5pc2hlZCBkZXBsb3ltZW50IGFuZCBhY2NvdW50IHJlcGxpY2EgcmVhY2hlZCB0aGUgREVQTE9ZRUQgc3RhdGVcbiAgICogQHBhcmFtIHtOdW1iZXJ9IHRpbWVvdXRJblNlY29uZHMgd2FpdCB0aW1lb3V0IGluIHNlY29uZHMsIGRlZmF1bHQgaXMgNW1cbiAgICogQHBhcmFtIHtOdW1iZXJ9IGludGVydmFsSW5NaWxsaXNlY29uZHMgaW50ZXJ2YWwgYmV0d2VlbiBhY2NvdW50IHJlcGxpY2EgcmVsb2FkcyB3aGlsZSB3YWl0aW5nIGZvciBhIGNoYW5nZSwgZGVmYXVsdCBpcyAxc1xuICAgKiBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlIHdoaWNoIHJlc29sdmVzIHdoZW4gYWNjb3VudCByZXBsaWNhIGlzIGRlcGxveWVkXG4gICAqIEB0aHJvd3Mge1RpbWVvdXRFcnJvcn0gaWYgYWNjb3VudCByZXBsaWNhIGhhcyBub3QgcmVhY2hlZCB0aGUgREVQTE9ZRUQgc3RhdGUgd2l0aGluIHRpbWVvdXQgYWxsb3dlZFxuICAgKi9cbiAgYXN5bmMgd2FpdERlcGxveWVkKHRpbWVvdXRJblNlY29uZHMgPSAzMDAsIGludGVydmFsSW5NaWxsaXNlY29uZHMgPSAxMDAwKSB7XG4gICAgbGV0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgYXdhaXQgdGhpcy5fcHJpbWFyeUFjY291bnQucmVsb2FkKCk7XG4gICAgd2hpbGUgKHRoaXMuc3RhdGUgIT09ICdERVBMT1lFRCcgJiYgKHN0YXJ0VGltZSArIHRpbWVvdXRJblNlY29uZHMgKiAxMDAwKSA+IERhdGUubm93KCkpIHtcbiAgICAgIGF3YWl0IHRoaXMuX2RlbGF5KGludGVydmFsSW5NaWxsaXNlY29uZHMpO1xuICAgICAgYXdhaXQgdGhpcy5fcHJpbWFyeUFjY291bnQucmVsb2FkKCk7XG4gICAgfVxuICAgIGlmICh0aGlzLnN0YXRlICE9PSAnREVQTE9ZRUQnKSB7XG4gICAgICB0aHJvdyBuZXcgVGltZW91dEVycm9yKCdUaW1lZCBvdXQgd2FpdGluZyBmb3IgYWNjb3VudCByZXBsaWNhICcgKyB0aGlzLmlkICsgJyB0byBiZSBkZXBsb3llZCcpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBXYWl0cyB1bnRpbCBBUEkgc2VydmVyIGhhcyBmaW5pc2hlZCB1bmRlcGxveW1lbnQgYW5kIGFjY291bnQgcmVwbGljYSByZWFjaGVkIHRoZSBVTkRFUExPWUVEIHN0YXRlXG4gICAqIEBwYXJhbSB7TnVtYmVyfSB0aW1lb3V0SW5TZWNvbmRzIHdhaXQgdGltZW91dCBpbiBzZWNvbmRzLCBkZWZhdWx0IGlzIDVtXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBpbnRlcnZhbEluTWlsbGlzZWNvbmRzIGludGVydmFsIGJldHdlZW4gYWNjb3VudCByZXBsaWNhIHJlbG9hZHMgd2hpbGUgd2FpdGluZyBmb3IgYSBjaGFuZ2UsIGRlZmF1bHQgaXMgMXNcbiAgICogQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZSB3aGljaCByZXNvbHZlcyB3aGVuIGFjY291bnQgcmVwbGljYSBpcyBkZXBsb3llZFxuICAgKiBAdGhyb3dzIHtUaW1lb3V0RXJyb3J9IGlmIGFjY291bnQgcmVwbGljYSBoYXMgbm90IHJlYWNoZWQgdGhlIFVOREVQTE9ZRUQgc3RhdGUgd2l0aGluIHRpbWVvdXQgYWxsb3dlZFxuICAgKi9cbiAgYXN5bmMgd2FpdFVuZGVwbG95ZWQodGltZW91dEluU2Vjb25kcyA9IDMwMCwgaW50ZXJ2YWxJbk1pbGxpc2Vjb25kcyA9IDEwMDApIHtcbiAgICBsZXQgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBhd2FpdCB0aGlzLl9wcmltYXJ5QWNjb3VudC5yZWxvYWQoKTtcbiAgICB3aGlsZSAodGhpcy5zdGF0ZSAhPT0gJ1VOREVQTE9ZRUQnICYmIChzdGFydFRpbWUgKyB0aW1lb3V0SW5TZWNvbmRzICogMTAwMCkgPiBEYXRlLm5vdygpKSB7XG4gICAgICBhd2FpdCB0aGlzLl9kZWxheShpbnRlcnZhbEluTWlsbGlzZWNvbmRzKTtcbiAgICAgIGF3YWl0IHRoaXMuX3ByaW1hcnlBY2NvdW50LnJlbG9hZCgpO1xuICAgIH1cbiAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ1VOREVQTE9ZRUQnKSB7XG4gICAgICB0aHJvdyBuZXcgVGltZW91dEVycm9yKCdUaW1lZCBvdXQgd2FpdGluZyBmb3IgYWNjb3VudCByZXBsaWNhICcgKyB0aGlzLmlkICsgJyB0byBiZSB1bmRlcGxveWVkJyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFdhaXRzIHVudGlsIGFjY291bnQgcmVwbGljYSBoYXMgYmVlbiBkZWxldGVkXG4gICAqIEBwYXJhbSB7TnVtYmVyfSB0aW1lb3V0SW5TZWNvbmRzIHdhaXQgdGltZW91dCBpbiBzZWNvbmRzLCBkZWZhdWx0IGlzIDVtXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBpbnRlcnZhbEluTWlsbGlzZWNvbmRzIGludGVydmFsIGJldHdlZW4gYWNjb3VudCByZXBsaWNhIHJlbG9hZHMgd2hpbGUgd2FpdGluZyBmb3IgYSBjaGFuZ2UsIGRlZmF1bHQgaXMgMXNcbiAgICogQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZSB3aGljaCByZXNvbHZlcyB3aGVuIGFjY291bnQgcmVwbGljYSBpcyBkZWxldGVkXG4gICAqIEB0aHJvd3Mge1RpbWVvdXRFcnJvcn0gaWYgYWNjb3VudCByZXBsaWNhIHdhcyBub3QgZGVsZXRlZCB3aXRoaW4gdGltZW91dCBhbGxvd2VkXG4gICAqL1xuICBhc3luYyB3YWl0UmVtb3ZlZCh0aW1lb3V0SW5TZWNvbmRzID0gMzAwLCBpbnRlcnZhbEluTWlsbGlzZWNvbmRzID0gMTAwMCkge1xuICAgIGxldCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIGF3YWl0IHRoaXMuX3ByaW1hcnlBY2NvdW50LnJlbG9hZCgpO1xuICAgIHdoaWxlIChzdGFydFRpbWUgKyB0aW1lb3V0SW5TZWNvbmRzICogMTAwMCA+IERhdGUubm93KCkgJiYgXG4gICAgICAgIHRoaXMuX3ByaW1hcnlBY2NvdW50LmFjY291bnRSZWdpb25zW3RoaXMucmVnaW9uXSA9PT0gdGhpcy5pZCkge1xuICAgICAgYXdhaXQgdGhpcy5fZGVsYXkoaW50ZXJ2YWxJbk1pbGxpc2Vjb25kcyk7XG4gICAgICBhd2FpdCB0aGlzLl9wcmltYXJ5QWNjb3VudC5yZWxvYWQoKTtcbiAgICB9XG4gICAgaWYodGhpcy5fcHJpbWFyeUFjY291bnQuYWNjb3VudFJlZ2lvbnNbdGhpcy5yZWdpb25dID09PSB0aGlzLmlkKSB7XG4gICAgICB0aHJvdyBuZXcgVGltZW91dEVycm9yKCdUaW1lZCBvdXQgd2FpdGluZyBmb3IgYWNjb3VudCAnICsgdGhpcy5pZCArICcgdG8gYmUgZGVsZXRlZCcpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBXYWl0cyB1bnRpbCBBUEkgc2VydmVyIGhhcyBjb25uZWN0ZWQgdG8gdGhlIHRlcm1pbmFsIGFuZCB0ZXJtaW5hbCBoYXMgY29ubmVjdGVkIHRvIHRoZSBicm9rZXJcbiAgICogQHBhcmFtIHtOdW1iZXJ9IHRpbWVvdXRJblNlY29uZHMgd2FpdCB0aW1lb3V0IGluIHNlY29uZHMsIGRlZmF1bHQgaXMgNW1cbiAgICogQHBhcmFtIHtOdW1iZXJ9IGludGVydmFsSW5NaWxsaXNlY29uZHMgaW50ZXJ2YWwgYmV0d2VlbiBhY2NvdW50IHJlcGxpY2EgcmVsb2FkcyB3aGlsZSB3YWl0aW5nIGZvciBhIGNoYW5nZSwgZGVmYXVsdCBpcyAxc1xuICAgKiBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlIHdoaWNoIHJlc29sdmVzIHdoZW4gQVBJIHNlcnZlciBpcyBjb25uZWN0ZWQgdG8gdGhlIGJyb2tlclxuICAgKiBAdGhyb3dzIHtUaW1lb3V0RXJyb3J9IGlmIGFjY291bnQgcmVwbGljYSBoYXMgbm90IGNvbm5lY3RlZCB0byB0aGUgYnJva2VyIHdpdGhpbiB0aW1lb3V0IGFsbG93ZWRcbiAgICovXG4gIGFzeW5jIHdhaXRDb25uZWN0ZWQodGltZW91dEluU2Vjb25kcyA9IDMwMCwgaW50ZXJ2YWxJbk1pbGxpc2Vjb25kcyA9IDEwMDApIHtcbiAgICBsZXQgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBhd2FpdCB0aGlzLl9wcmltYXJ5QWNjb3VudC5yZWxvYWQoKTtcbiAgICB3aGlsZSAodGhpcy5jb25uZWN0aW9uU3RhdHVzICE9PSAnQ09OTkVDVEVEJyAmJiAoc3RhcnRUaW1lICsgdGltZW91dEluU2Vjb25kcyAqIDEwMDApID4gRGF0ZS5ub3coKSkge1xuICAgICAgYXdhaXQgdGhpcy5fZGVsYXkoaW50ZXJ2YWxJbk1pbGxpc2Vjb25kcyk7XG4gICAgICBhd2FpdCB0aGlzLl9wcmltYXJ5QWNjb3VudC5yZWxvYWQoKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuY29ubmVjdGlvblN0YXR1cyAhPT0gJ0NPTk5FQ1RFRCcpIHtcbiAgICAgIHRocm93IG5ldyBUaW1lb3V0RXJyb3IoJ1RpbWVkIG91dCB3YWl0aW5nIGZvciBhY2NvdW50ICcgKyB0aGlzLmlkICsgJyB0byBjb25uZWN0IHRvIHRoZSBicm9rZXInKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlcyBNZXRhVHJhZGVyIGFjY291bnQgcmVwbGljYSBkYXRhXG4gICAqIEBwYXJhbSB7VXBkYXRlZE1ldGF0cmFkZXJBY2NvdW50UmVwbGljYUR0b30gYWNjb3VudCBNZXRhVHJhZGVyIGFjY291bnQgcmVwbGljYSB1cGRhdGVcbiAgICogQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZSByZXNvbHZpbmcgd2hlbiBhY2NvdW50IHJlcGxpY2EgaXMgdXBkYXRlZFxuICAgKi9cbiAgYXN5bmMgdXBkYXRlKGFjY291bnQpIHtcbiAgICBhd2FpdCB0aGlzLl9tZXRhdHJhZGVyQWNjb3VudENsaWVudC51cGRhdGVBY2NvdW50UmVwbGljYSh0aGlzLl9wcmltYXJ5QWNjb3VudC5pZCwgdGhpcy5pZCwgYWNjb3VudCk7XG4gICAgYXdhaXQgdGhpcy5fcHJpbWFyeUFjY291bnQucmVsb2FkKCk7XG4gIH1cblxuICBfZGVsYXkodGltZW91dEluTWlsbGlzZWNvbmRzKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlcyA9PiBzZXRUaW1lb3V0KHJlcywgdGltZW91dEluTWlsbGlzZWNvbmRzKSk7XG4gIH1cblxufVxuIl19