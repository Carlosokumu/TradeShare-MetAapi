'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _values = require('babel-runtime/core-js/object/values');

var _values2 = _interopRequireDefault(_values);

var _historyStorage = require('./historyStorage');

var _historyStorage2 = _interopRequireDefault(_historyStorage);

var _index = require('./historyDatabase/index');

var _index2 = _interopRequireDefault(_index);

var _binarySearchTree = require('binary-search-tree');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * History storage which stores MetaTrader history in RAM
 */
class MemoryHistoryStorage extends _historyStorage2.default {

  /**
   * Constructs the in-memory history store instance
   */
  constructor() {
    super();
    this._historyDatabase = _index2.default.getInstance();
    this._reset();
    this._logger = _logger2.default.getLogger('MemoryHistoryStorage');
  }

  /**
   * Initializes the storage and loads required data from a persistent storage
   * @param {string} accountId account id
   * @param {string} [application] application. Default is MetaApi
   */
  async initialize(accountId, application = 'MetaApi') {
    await super.initialize(accountId, application);
    let { deals, historyOrders } = await this._historyDatabase.loadHistory(accountId, application);
    for (let deal of deals) {
      await this._addDeal(deal, true);
    }
    for (let historyOrder of historyOrders) {
      await this._addHistoryOrder(historyOrder, true);
    }
  }

  /**
   * Resets the storage. Intended for use in tests
   * @returns {Promise} promise when the history is removed
   */
  async clear() {
    this._reset();
    await this._historyDatabase.clear(this._accountId, this._application);
  }

  /**
   * Returns the time of the last history order record stored in the history storage
   * @param {Number} [instanceNumber] index of an account instance connected
   * @returns {Date} the time of the last history order record stored in the history storage
   */
  lastHistoryOrderTime(instanceNumber) {
    return this._maxHistoryOrderTime;
  }

  /**
   * Returns the time of the last history deal record stored in the history storage
   * @param {Number} [instanceNumber] index of an account instance connected
   * @returns {Date} the time of the last history deal record stored in the history storage
   */
  lastDealTime(instanceNumber) {
    return this._maxDealTime;
  }

  /**
   * Invoked when a new MetaTrader history order is added
   * @param {String} instanceIndex index of an account instance connected
   * @param {MetatraderOrder} historyOrder new MetaTrader history order
   */
  async onHistoryOrderAdded(instanceIndex, historyOrder) {
    await this._addHistoryOrder(historyOrder);
  }

  /**
   * Invoked when a new MetaTrader history deal is added
   * @param {String} instanceIndex index of an account instance connected
   * @param {MetatraderDeal} deal new MetaTrader history deal
   */
  async onDealAdded(instanceIndex, deal) {
    await this._addDeal(deal);
  }

  /**
   * Returns all deals
   * @returns {Array<MetatraderDeal>} all deals
   */
  get deals() {
    return this.getDealsByTimeRange(new Date(0), new Date(8640000000000000));
  }

  /**
   * Returns deals by ticket id
   * @param {string} id ticket id
   * @returns {Array<MetatraderDeal>} deals found
   */
  getDealsByTicket(id) {
    let deals = (0, _values2.default)(this._dealsByTicket[id] || {});
    deals.sort(this._dealsComparator);
    return deals;
  }

  /**
   * Returns deals by position id
   * @param {string} positionId position id
   * @returns {Array<MetatraderDeal>} deals found
   */
  getDealsByPosition(positionId) {
    let deals = (0, _values2.default)(this._dealsByPosition[positionId] || {});
    deals.sort(this._dealsComparator);
    return deals;
  }

  /**
   * Returns deals by time range
   * @param startTime start time, inclusive
   * @param endTime end time, inclusive
   * @returns {Array<MetatraderDeal>} deals found
   */
  getDealsByTimeRange(startTime, endTime) {
    let deals = this._dealsByTime.betweenBounds({
      $gte: { time: startTime, id: 0, entryType: '' },
      $lte: { time: endTime, id: Number.MAX_VALUE, entryType: '' }
    });
    return deals;
  }

  /**
   * Returns all history orders
   * @returns {Array<MetatraderOrder>} all history orders
   */
  get historyOrders() {
    return this.getHistoryOrdersByTimeRange(new Date(0), new Date(8640000000000000));
  }

  /**
   * Returns history orders by ticket id
   * @param {string} id ticket id
   * @returns {Array<MetatraderOrder>} history orders found
   */
  getHistoryOrdersByTicket(id) {
    let historyOrders = (0, _values2.default)(this._historyOrdersByTicket[id] || {});
    historyOrders.sort(this._historyOrdersComparator);
    return historyOrders;
  }

  /**
   * Returns history orders by position id
   * @param {string} positionId position id
   * @returns {Array<MetatraderOrder>} history orders found
   */
  getHistoryOrdersByPosition(positionId) {
    let historyOrders = (0, _values2.default)(this._historyOrdersByPosition[positionId] || {});
    historyOrders.sort(this._historyOrdersComparator);
    return historyOrders;
  }

  /**
   * Returns history orders by time range
   * @param startTime start time, inclusive
   * @param endTime end time, inclusive
   * @returns {Array<MetatraderOrder>} hisotry orders found
   */
  getHistoryOrdersByTimeRange(startTime, endTime) {
    let historyOrders = this._historyOrdersByTime.betweenBounds({
      $gte: { doneTime: startTime, id: 0, type: '', state: '' },
      $lte: { doneTime: endTime, id: Number.MAX_VALUE, type: '', state: '' }
    });
    return historyOrders;
  }

  /**
   * Invoked when a synchronization of history deals on a MetaTrader account have finished to indicate progress of an
   * initial terminal state synchronization
   * @param {String} instanceIndex index of an account instance connected
   * @param {String} synchronizationId synchronization request id
   * @return {Promise} promise which resolves when the asynchronous event is processed
   */
  async onDealsSynchronized(instanceIndex, synchronizationId) {
    await this._flushDatabase();
    await super.onDealsSynchronized(instanceIndex, synchronizationId);
  }

  _reset() {
    this._orderSynchronizationFinished = {};
    this._dealSynchronizationFinished = {};
    this._dealsByTicket = {};
    this._dealsByPosition = {};
    this._historyOrdersByTicket = {};
    this._historyOrdersByPosition = {};
    // eslint-disable-next-line complexity
    this._historyOrdersComparator = (o1, o2) => {
      let timeDiff = (o1.doneTime || new Date(0)).getTime() - (o2.doneTime || new Date(0)).getTime();
      if (timeDiff === 0) {
        let idDiff = o1.id - o2.id;
        if (idDiff === 0) {
          if (o1.type > o2.type) {
            return 1;
          } else if (o1.type < o2.type) {
            return -1;
          } else {
            if (o1.state > o2.state) {
              return 1;
            } else if (o1.state < o2.state) {
              return -1;
            } else {
              return 0;
            }
          }
        } else {
          return idDiff;
        }
      } else {
        return timeDiff;
      }
    };
    this._historyOrdersByTime = new _binarySearchTree.AVLTree({ compareKeys: this._historyOrdersComparator });
    this._dealsComparator = (d1, d2) => {
      let timeDiff = (d1.time || new Date(0)).getTime() - (d2.time || new Date(0)).getTime();
      if (timeDiff === 0) {
        let idDiff = d1.id - d2.id;
        if (idDiff === 0) {
          if (d1.entryType > d2.entryType) {
            return 1;
          } else if (d1.entryType < d2.entryType) {
            return -1;
          } else {
            return 0;
          }
        } else {
          return idDiff;
        }
      } else {
        return timeDiff;
      }
    };
    this._dealsByTime = new _binarySearchTree.AVLTree({ compareKeys: this._dealsComparator });
    this._maxHistoryOrderTime = new Date(0);
    this._maxDealTime = new Date(0);
    this._newHistoryOrders = [];
    this._newDeals = [];
    clearTimeout(this._flushTimeout);
    delete this._flushTimeout;
  }

  // eslint-disable-next-line complexity
  async _addDeal(deal, existing) {
    let key = this._getDealKey(deal);
    this._dealsByTicket[deal.id] = this._dealsByTicket[deal.id] || {};
    let newDeal = !existing && !this._dealsByTicket[deal.id][key];
    this._dealsByTicket[deal.id][key] = deal;
    if (deal.positionId) {
      this._dealsByPosition[deal.positionId] = this._dealsByPosition[deal.positionId] || {};
      this._dealsByPosition[deal.positionId][key] = deal;
    }
    this._dealsByTime.delete(deal);
    this._dealsByTime.insert(deal, deal);
    if (deal.time && (!this._maxDealTime || this._maxDealTime.getTime() < deal.time.getTime())) {
      this._maxDealTime = deal.time;
    }
    if (newDeal) {
      this._newDeals.push(deal);
      clearTimeout(this._flushTimeout);
      this._flushTimeout = setTimeout(this._flushDatabase.bind(this), 5000);
    }
  }

  _getDealKey(deal) {
    return (deal.time || new Date(0)).toISOString() + ':' + deal.id + ':' + deal.entryType;
  }

  // eslint-disable-next-line complexity
  async _addHistoryOrder(historyOrder, existing) {
    let key = this._getHistoryOrderKey(historyOrder);
    this._historyOrdersByTicket[historyOrder.id] = this._historyOrdersByTicket[historyOrder.id] || {};
    let newHistoryOrder = !existing && !this._historyOrdersByTicket[historyOrder.id][key];
    this._historyOrdersByTicket[historyOrder.id][key] = historyOrder;
    if (historyOrder.positionId) {
      this._historyOrdersByPosition[historyOrder.positionId] = this._historyOrdersByPosition[historyOrder.positionId] || {};
      this._historyOrdersByPosition[historyOrder.positionId][key] = historyOrder;
    }
    this._historyOrdersByTime.delete(historyOrder);
    this._historyOrdersByTime.insert(historyOrder, historyOrder);
    if (historyOrder.doneTime && (!this._maxHistoryOrderTime || this._maxHistoryOrderTime.getTime() < historyOrder.doneTime.getTime())) {
      this._maxHistoryOrderTime = historyOrder.doneTime;
    }
    if (newHistoryOrder) {
      this._newHistoryOrders.push(historyOrder);
      clearTimeout(this._flushTimeout);
      this._flushTimeout = setTimeout(this._flushDatabase.bind(this), 5000);
    }
  }

  _getHistoryOrderKey(historyOrder) {
    return (historyOrder.doneTime || new Date(0)).toISOString() + ':' + historyOrder.id + ':' + historyOrder.type + ':' + historyOrder.status;
  }

  async _flushDatabase() {
    if (this._flushPromise) {
      await this._flushPromise;
    }
    if (this._flushRunning) {
      return;
    }
    this._flushRunning = true;
    let resolve;
    this._flushPromise = new _promise2.default(res => resolve = res);
    try {
      await this._historyDatabase.flush(this._accountId, this._application, this._newHistoryOrders, this._newDeals);
      this._newHistoryOrders = [];
      this._newDeals = [];
      this._logger.debug(`${this._accountId}: flushed history db`);
    } catch (err) {
      this._logger.warn(`${this._accountId}: error flushing history db`, err);
      this._flushTimeout = setTimeout(this._flushDatabase.bind(this), 15000);
    } finally {
      resolve();
      this._flushRunning = false;
    }
  }

}
exports.default = MemoryHistoryStorage;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9tZXRhQXBpL21lbW9yeUhpc3RvcnlTdG9yYWdlLmVzNiJdLCJuYW1lcyI6WyJNZW1vcnlIaXN0b3J5U3RvcmFnZSIsIkhpc3RvcnlTdG9yYWdlIiwiY29uc3RydWN0b3IiLCJfaGlzdG9yeURhdGFiYXNlIiwiSGlzdG9yeURhdGFiYXNlIiwiZ2V0SW5zdGFuY2UiLCJfcmVzZXQiLCJfbG9nZ2VyIiwiTG9nZ2VyTWFuYWdlciIsImdldExvZ2dlciIsImluaXRpYWxpemUiLCJhY2NvdW50SWQiLCJhcHBsaWNhdGlvbiIsImRlYWxzIiwiaGlzdG9yeU9yZGVycyIsImxvYWRIaXN0b3J5IiwiZGVhbCIsIl9hZGREZWFsIiwiaGlzdG9yeU9yZGVyIiwiX2FkZEhpc3RvcnlPcmRlciIsImNsZWFyIiwiX2FjY291bnRJZCIsIl9hcHBsaWNhdGlvbiIsImxhc3RIaXN0b3J5T3JkZXJUaW1lIiwiaW5zdGFuY2VOdW1iZXIiLCJfbWF4SGlzdG9yeU9yZGVyVGltZSIsImxhc3REZWFsVGltZSIsIl9tYXhEZWFsVGltZSIsIm9uSGlzdG9yeU9yZGVyQWRkZWQiLCJpbnN0YW5jZUluZGV4Iiwib25EZWFsQWRkZWQiLCJnZXREZWFsc0J5VGltZVJhbmdlIiwiRGF0ZSIsImdldERlYWxzQnlUaWNrZXQiLCJpZCIsIl9kZWFsc0J5VGlja2V0Iiwic29ydCIsIl9kZWFsc0NvbXBhcmF0b3IiLCJnZXREZWFsc0J5UG9zaXRpb24iLCJwb3NpdGlvbklkIiwiX2RlYWxzQnlQb3NpdGlvbiIsInN0YXJ0VGltZSIsImVuZFRpbWUiLCJfZGVhbHNCeVRpbWUiLCJiZXR3ZWVuQm91bmRzIiwiJGd0ZSIsInRpbWUiLCJlbnRyeVR5cGUiLCIkbHRlIiwiTnVtYmVyIiwiTUFYX1ZBTFVFIiwiZ2V0SGlzdG9yeU9yZGVyc0J5VGltZVJhbmdlIiwiZ2V0SGlzdG9yeU9yZGVyc0J5VGlja2V0IiwiX2hpc3RvcnlPcmRlcnNCeVRpY2tldCIsIl9oaXN0b3J5T3JkZXJzQ29tcGFyYXRvciIsImdldEhpc3RvcnlPcmRlcnNCeVBvc2l0aW9uIiwiX2hpc3RvcnlPcmRlcnNCeVBvc2l0aW9uIiwiX2hpc3RvcnlPcmRlcnNCeVRpbWUiLCJkb25lVGltZSIsInR5cGUiLCJzdGF0ZSIsIm9uRGVhbHNTeW5jaHJvbml6ZWQiLCJzeW5jaHJvbml6YXRpb25JZCIsIl9mbHVzaERhdGFiYXNlIiwiX29yZGVyU3luY2hyb25pemF0aW9uRmluaXNoZWQiLCJfZGVhbFN5bmNocm9uaXphdGlvbkZpbmlzaGVkIiwibzEiLCJvMiIsInRpbWVEaWZmIiwiZ2V0VGltZSIsImlkRGlmZiIsIkFWTFRyZWUiLCJjb21wYXJlS2V5cyIsImQxIiwiZDIiLCJfbmV3SGlzdG9yeU9yZGVycyIsIl9uZXdEZWFscyIsImNsZWFyVGltZW91dCIsIl9mbHVzaFRpbWVvdXQiLCJleGlzdGluZyIsImtleSIsIl9nZXREZWFsS2V5IiwibmV3RGVhbCIsImRlbGV0ZSIsImluc2VydCIsInB1c2giLCJzZXRUaW1lb3V0IiwiYmluZCIsInRvSVNPU3RyaW5nIiwiX2dldEhpc3RvcnlPcmRlcktleSIsIm5ld0hpc3RvcnlPcmRlciIsInN0YXR1cyIsIl9mbHVzaFByb21pc2UiLCJfZmx1c2hSdW5uaW5nIiwicmVzb2x2ZSIsInJlcyIsImZsdXNoIiwiZGVidWciLCJlcnIiLCJ3YXJuIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7QUFFQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7OztBQUVBOzs7QUFHZSxNQUFNQSxvQkFBTixTQUFtQ0Msd0JBQW5DLENBQWtEOztBQUUvRDs7O0FBR0FDLGdCQUFjO0FBQ1o7QUFDQSxTQUFLQyxnQkFBTCxHQUF3QkMsZ0JBQWdCQyxXQUFoQixFQUF4QjtBQUNBLFNBQUtDLE1BQUw7QUFDQSxTQUFLQyxPQUFMLEdBQWVDLGlCQUFjQyxTQUFkLENBQXdCLHNCQUF4QixDQUFmO0FBQ0Q7O0FBRUQ7Ozs7O0FBS0EsUUFBTUMsVUFBTixDQUFpQkMsU0FBakIsRUFBNEJDLGNBQWMsU0FB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LENBQW9CLEdBQUUsS0FBSzVFLFVBQVcsc0JBQXRDO0FBQ0QsS0FMRCxDQUtFLE9BQU82RSxHQUFQLEVBQVk7QUFDWixXQUFLM0YsT0FBTCxDQUFhNEYsSUFBYixDQUFtQixHQUFFLEtBQUs5RSxVQUFXLDZCQUFyQyxFQUFtRTZFLEdBQW5FO0FBQ0EsV0FBS3BCLGFBQUwsR0FBcUJRLFdBQVcsS0FBS3ZCLGNBQUwsQ0FBb0J3QixJQUFwQixDQUF5QixJQUF6QixDQUFYLEVBQTJDLEtBQTNDLENBQXJCO0FBQ0QsS0FSRCxTQVFVO0FBQ1JPO0FBQ0EsV0FBS0QsYUFBTCxHQUFxQixLQUFyQjtBQUNEO0FBQ0Y7O0FBeFQ4RDtrQkFBNUM3RixvQiIsImZpbGUiOiJtZW1vcnlIaXN0b3J5U3RvcmFnZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IEhpc3RvcnlTdG9yYWdlIGZyb20gJy4vaGlzdG9yeVN0b3JhZ2UnO1xuaW1wb3J0IEhpc3RvcnlEYXRhYmFzZSBmcm9tICcuL2hpc3RvcnlEYXRhYmFzZS9pbmRleCc7XG5pbXBvcnQge0FWTFRyZWV9IGZyb20gJ2JpbmFyeS1zZWFyY2gtdHJlZSc7XG5pbXBvcnQgTG9nZ2VyTWFuYWdlciBmcm9tICcuLi9sb2dnZXInO1xuXG4vKipcbiAqIEhpc3Rvcnkgc3RvcmFnZSB3aGljaCBzdG9yZXMgTWV0YVRyYWRlciBoaXN0b3J5IGluIFJBTVxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNZW1vcnlIaXN0b3J5U3RvcmFnZSBleHRlbmRzIEhpc3RvcnlTdG9yYWdlIHtcblxuICAvKipcbiAgICogQ29uc3RydWN0cyB0aGUgaW4tbWVtb3J5IGhpc3Rvcnkgc3RvcmUgaW5zdGFuY2VcbiAgICovXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5faGlzdG9yeURhdGFiYXNlID0gSGlzdG9yeURhdGFiYXNlLmdldEluc3RhbmNlKCk7XG4gICAgdGhpcy5fcmVzZXQoKTtcbiAgICB0aGlzLl9sb2dnZXIgPSBMb2dnZXJNYW5hZ2VyLmdldExvZ2dlcignTWVtb3J5SGlzdG9yeVN0b3JhZ2UnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplcyB0aGUgc3RvcmFnZSBhbmQgbG9hZHMgcmVxdWlyZWQgZGF0YSBmcm9tIGEgcGVyc2lzdGVudCBzdG9yYWdlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBhY2NvdW50SWQgYWNjb3VudCBpZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gW2FwcGxpY2F0aW9uXSBhcHBsaWNhdGlvbi4gRGVmYXVsdCBpcyBNZXRhQXBpXG4gICAqL1xuICBhc3luYyBpbml0aWFsaXplKGFjY291bnRJZCwgYXBwbGljYXRpb24gPSAnTWV0YUFwaScpIHtcbiAgICBhd2FpdCBzdXBlci5pbml0aWFsaXplKGFjY291bnRJZCwgYXBwbGljYXRpb24pO1xuICAgIGxldCB7ZGVhbHMsIGhpc3RvcnlPcmRlcnN9ID0gYXdhaXQgdGhpcy5faGlzdG9yeURhdGFiYXNlLmxvYWRIaXN0b3J5KGFjY291bnRJZCwgYXBwbGljYXRpb24pO1xuICAgIGZvciAobGV0IGRlYWwgb2YgZGVhbHMpIHtcbiAgICAgIGF3YWl0IHRoaXMuX2FkZERlYWwoZGVhbCwgdHJ1ZSk7XG4gICAgfVxuICAgIGZvciAobGV0IGhpc3RvcnlPcmRlciBvZiBoaXN0b3J5T3JkZXJzKSB7XG4gICAgICBhd2FpdCB0aGlzLl9hZGRIaXN0b3J5T3JkZXIoaGlzdG9yeU9yZGVyLCB0cnVlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVzZXRzIHRoZSBzdG9yYWdlLiBJbnRlbmRlZCBmb3IgdXNlIGluIHRlc3RzXG4gICAqIEByZXR1cm5zIHtQcm9taXNlfSBwcm9taXNlIHdoZW4gdGhlIGhpc3RvcnkgaXMgcmVtb3ZlZFxuICAgKi9cbiAgYXN5bmMgY2xlYXIoKSB7XG4gICAgdGhpcy5fcmVzZXQoKTtcbiAgICBhd2FpdCB0aGlzLl9oaXN0b3J5RGF0YWJhc2UuY2xlYXIodGhpcy5fYWNjb3VudElkLCB0aGlzLl9hcHBsaWNhdGlvbik7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgdGltZSBvZiB0aGUgbGFzdCBoaXN0b3J5IG9yZGVyIHJlY29yZCBzdG9yZWQgaW4gdGhlIGhpc3Rvcnkgc3RvcmFnZVxuICAgKiBAcGFyYW0ge051bWJlcn0gW2luc3RhbmNlTnVtYmVyXSBpbmRleCBvZiBhbiBhY2NvdW50IGluc3RhbmNlIGNvbm5lY3RlZFxuICAgKiBAcmV0dXJucyB7RGF0ZX0gdGhlIHRpbWUgb2YgdGhlIGxhc3QgaGlzdG9yeSBvcmRlciByZWNvcmQgc3RvcmVkIGluIHRoZSBoaXN0b3J5IHN0b3JhZ2VcbiAgICovXG4gIGxhc3RIaXN0b3J5T3JkZXJUaW1lKGluc3RhbmNlTnVtYmVyKSB7XG4gICAgcmV0dXJuIHRoaXMuX21heEhpc3RvcnlPcmRlclRpbWU7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgdGltZSBvZiB0aGUgbGFzdCBoaXN0b3J5IGRlYWwgcmVjb3JkIHN0b3JlZCBpbiB0aGUgaGlzdG9yeSBzdG9yYWdlXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBbaW5zdGFuY2VOdW1iZXJdIGluZGV4IG9mIGFuIGFjY291bnQgaW5zdGFuY2UgY29ubmVjdGVkXG4gICAqIEByZXR1cm5zIHtEYXRlfSB0aGUgdGltZSBvZiB0aGUgbGFzdCBoaXN0b3J5IGRlYWwgcmVjb3JkIHN0b3JlZCBpbiB0aGUgaGlzdG9yeSBzdG9yYWdlXG4gICAqL1xuICBsYXN0RGVhbFRpbWUoaW5zdGFuY2VOdW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5fbWF4RGVhbFRpbWU7XG4gIH1cblxuICAvKipcbiAgICogSW52b2tlZCB3aGVuIGEgbmV3IE1ldGFUcmFkZXIgaGlzdG9yeSBvcmRlciBpcyBhZGRlZFxuICAgKiBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VJbmRleCBpbmRleCBvZiBhbiBhY2NvdW50IGluc3RhbmNlIGNvbm5lY3RlZFxuICAgKiBAcGFyYW0ge01ldGF0cmFkZXJPcmRlcn0gaGlzdG9yeU9yZGVyIG5ldyBNZXRhVHJhZGVyIGhpc3Rvcnkgb3JkZXJcbiAgICovXG4gIGFzeW5jIG9uSGlzdG9yeU9yZGVyQWRkZWQoaW5zdGFuY2VJbmRleCwgaGlzdG9yeU9yZGVyKSB7XG4gICAgYXdhaXQgdGhpcy5fYWRkSGlzdG9yeU9yZGVyKGhpc3RvcnlPcmRlcik7XG4gIH1cblxuICAvKipcbiAgICogSW52b2tlZCB3aGVuIGEgbmV3IE1ldGFUcmFkZXIgaGlzdG9yeSBkZWFsIGlzIGFkZGVkXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBpbnN0YW5jZUluZGV4IGluZGV4IG9mIGFuIGFjY291bnQgaW5zdGFuY2UgY29ubmVjdGVkXG4gICAqIEBwYXJhbSB7TWV0YXRyYWRlckRlYWx9IGRlYWwgbmV3IE1ldGFUcmFkZXIgaGlzdG9yeSBkZWFsXG4gICAqL1xuICBhc3luYyBvbkRlYWxBZGRlZChpbnN0YW5jZUluZGV4LCBkZWFsKSB7XG4gICAgYXdhaXQgdGhpcy5fYWRkRGVhbChkZWFsKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFsbCBkZWFsc1xuICAgKiBAcmV0dXJucyB7QXJyYXk8TWV0YXRyYWRlckRlYWw+fSBhbGwgZGVhbHNcbiAgICovXG4gIGdldCBkZWFscygpIHtcbiAgICByZXR1cm4gdGhpcy5nZXREZWFsc0J5VGltZVJhbmdlKG5ldyBEYXRlKDApLCBuZXcgRGF0ZSg4NjQwMDAwMDAwMDAwMDAwKSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBkZWFscyBieSB0aWNrZXQgaWRcbiAgICogQHBhcmFtIHtzdHJpbmd9IGlkIHRpY2tldCBpZFxuICAgKiBAcmV0dXJucyB7QXJyYXk8TWV0YXRyYWRlckRlYWw+fSBkZWFscyBmb3VuZFxuICAgKi9cbiAgZ2V0RGVhbHNCeVRpY2tldChpZCkge1xuICAgIGxldCBkZWFscyA9IE9iamVjdC52YWx1ZXModGhpcy5fZGVhbHNCeVRpY2tldFtpZF0gfHwge30pO1xuICAgIGRlYWxzLnNvcnQodGhpcy5fZGVhbHNDb21wYXJhdG9yKTtcbiAgICByZXR1cm4gZGVhbHM7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBkZWFscyBieSBwb3NpdGlvbiBpZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gcG9zaXRpb25JZCBwb3NpdGlvbiBpZFxuICAgKiBAcmV0dXJucyB7QXJyYXk8TWV0YXRyYWRlckRlYWw+fSBkZWFscyBmb3VuZFxuICAgKi9cbiAgZ2V0RGVhbHNCeVBvc2l0aW9uKHBvc2l0aW9uSWQpIHtcbiAgICBsZXQgZGVhbHMgPSBPYmplY3QudmFsdWVzKHRoaXMuX2RlYWxzQnlQb3NpdGlvbltwb3NpdGlvbklkXSB8fCB7fSk7XG4gICAgZGVhbHMuc29ydCh0aGlzLl9kZWFsc0NvbXBhcmF0b3IpO1xuICAgIHJldHVybiBkZWFscztcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGRlYWxzIGJ5IHRpbWUgcmFuZ2VcbiAgICogQHBhcmFtIHN0YXJ0VGltZSBzdGFydCB0aW1lLCBpbmNsdXNpdmVcbiAgICogQHBhcmFtIGVuZFRpbWUgZW5kIHRpbWUsIGluY2x1c2l2ZVxuICAgKiBAcmV0dXJucyB7QXJyYXk8TWV0YXRyYWRlckRlYWw+fSBkZWFscyBmb3VuZFxuICAgKi9cbiAgZ2V0RGVhbHNCeVRpbWVSYW5nZShzdGFydFRpbWUsIGVuZFRpbWUpIHtcbiAgICBsZXQgZGVhbHMgPSB0aGlzLl9kZWFsc0J5VGltZS5iZXR3ZWVuQm91bmRzKHtcbiAgICAgICRndGU6IHt0aW1lOiBzdGFydFRpbWUsIGlkOiAwLCBlbnRyeVR5cGU6ICcnfSxcbiAgICAgICRsdGU6IHt0aW1lOiBlbmRUaW1lLCBpZDogTnVtYmVyLk1BWF9WQUxVRSwgZW50cnlUeXBlOiAnJ31cbiAgICB9KTtcbiAgICByZXR1cm4gZGVhbHM7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhbGwgaGlzdG9yeSBvcmRlcnNcbiAgICogQHJldHVybnMge0FycmF5PE1ldGF0cmFkZXJPcmRlcj59IGFsbCBoaXN0b3J5IG9yZGVyc1xuICAgKi9cbiAgZ2V0IGhpc3RvcnlPcmRlcnMoKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0SGlzdG9yeU9yZGVyc0J5VGltZVJhbmdlKG5ldyBEYXRlKDApLCBuZXcgRGF0ZSg4NjQwMDAwMDAwMDAwMDAwKSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBoaXN0b3J5IG9yZGVycyBieSB0aWNrZXQgaWRcbiAgICogQHBhcmFtIHtzdHJpbmd9IGlkIHRpY2tldCBpZFxuICAgKiBAcmV0dXJucyB7QXJyYXk8TWV0YXRyYWRlck9yZGVyPn0gaGlzdG9yeSBvcmRlcnMgZm91bmRcbiAgICovXG4gIGdldEhpc3RvcnlPcmRlcnNCeVRpY2tldChpZCkge1xuICAgIGxldCBoaXN0b3J5T3JkZXJzID0gT2JqZWN0LnZhbHVlcyh0aGlzLl9oaXN0b3J5T3JkZXJzQnlUaWNrZXRbaWRdIHx8IHt9KTtcbiAgICBoaXN0b3J5T3JkZXJzLnNvcnQodGhpcy5faGlzdG9yeU9yZGVyc0NvbXBhcmF0b3IpO1xuICAgIHJldHVybiBoaXN0b3J5T3JkZXJzO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgaGlzdG9yeSBvcmRlcnMgYnkgcG9zaXRpb24gaWRcbiAgICogQHBhcmFtIHtzdHJpbmd9IHBvc2l0aW9uSWQgcG9zaXRpb24gaWRcbiAgICogQHJldHVybnMge0FycmF5PE1ldGF0cmFkZXJPcmRlcj59IGhpc3Rvcnkgb3JkZXJzIGZvdW5kXG4gICAqL1xuICBnZXRIaXN0b3J5T3JkZXJzQnlQb3NpdGlvbihwb3NpdGlvbklkKSB7XG4gICAgbGV0IGhpc3RvcnlPcmRlcnMgPSBPYmplY3QudmFsdWVzKHRoaXMuX2hpc3RvcnlPcmRlcnNCeVBvc2l0aW9uW3Bvc2l0aW9uSWRdIHx8IHt9KTtcbiAgICBoaXN0b3J5T3JkZXJzLnNvcnQodGhpcy5faGlzdG9yeU9yZGVyc0NvbXBhcmF0b3IpO1xuICAgIHJldHVybiBoaXN0b3J5T3JkZXJzO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgaGlzdG9yeSBvcmRlcnMgYnkgdGltZSByYW5nZVxuICAgKiBAcGFyYW0gc3RhcnRUaW1lIHN0YXJ0IHRpbWUsIGluY2x1c2l2ZVxuICAgKiBAcGFyYW0gZW5kVGltZSBlbmQgdGltZSwgaW5jbHVzaXZlXG4gICAqIEByZXR1cm5zIHtBcnJheTxNZXRhdHJhZGVyT3JkZXI+fSBoaXNvdHJ5IG9yZGVycyBmb3VuZFxuICAgKi9cbiAgZ2V0SGlzdG9yeU9yZGVyc0J5VGltZVJhbmdlKHN0YXJ0VGltZSwgZW5kVGltZSkge1xuICAgIGxldCBoaXN0b3J5T3JkZXJzID0gdGhpcy5faGlzdG9yeU9yZGVyc0J5VGltZS5iZXR3ZWVuQm91bmRzKHtcbiAgICAgICRndGU6IHtkb25lVGltZTogc3RhcnRUaW1lLCBpZDogMCwgdHlwZTogJycsIHN0YXRlOiAnJ30sXG4gICAgICAkbHRlOiB7ZG9uZVRpbWU6IGVuZFRpbWUsIGlkOiBOdW1iZXIuTUFYX1ZBTFVFLCB0eXBlOiAnJywgc3RhdGU6ICcnfVxuICAgIH0pO1xuICAgIHJldHVybiBoaXN0b3J5T3JkZXJzO1xuICB9XG5cbiAgLyoqXG4gICAqIEludm9rZWQgd2hlbiBhIHN5bmNocm9uaXphdGlvbiBvZiBoaXN0b3J5IGRlYWxzIG9uIGEgTWV0YVRyYWRlciBhY2NvdW50IGhhdmUgZmluaXNoZWQgdG8gaW5kaWNhdGUgcHJvZ3Jlc3Mgb2YgYW5cbiAgICogaW5pdGlhbCB0ZXJtaW5hbCBzdGF0ZSBzeW5jaHJvbml6YXRpb25cbiAgICogQHBhcmFtIHtTdHJpbmd9IGluc3RhbmNlSW5kZXggaW5kZXggb2YgYW4gYWNjb3VudCBpbnN0YW5jZSBjb25uZWN0ZWRcbiAgICogQHBhcmFtIHtTdHJpbmd9IHN5bmNocm9uaXphdGlvbklkIHN5bmNocm9uaXphdGlvbiByZXF1ZXN0IGlkXG4gICAqIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2Ugd2hpY2ggcmVzb2x2ZXMgd2hlbiB0aGUgYXN5bmNocm9ub3VzIGV2ZW50IGlzIHByb2Nlc3NlZFxuICAgKi9cbiAgYXN5bmMgb25EZWFsc1N5bmNocm9uaXplZChpbnN0YW5jZUluZGV4LCBzeW5jaHJvbml6YXRpb25JZCkge1xuICAgIGF3YWl0IHRoaXMuX2ZsdXNoRGF0YWJhc2UoKTtcbiAgICBhd2FpdCBzdXBlci5vbkRlYWxzU3luY2hyb25pemVkKGluc3RhbmNlSW5kZXgsIHN5bmNocm9uaXphdGlvbklkKTtcbiAgfVxuXG4gIF9yZXNldCgpIHtcbiAgICB0aGlzLl9vcmRlclN5bmNocm9uaXphdGlvbkZpbmlzaGVkID0ge307XG4gICAgdGhpcy5fZGVhbFN5bmNocm9uaXphdGlvbkZpbmlzaGVkID0ge307XG4gICAgdGhpcy5fZGVhbHNCeVRpY2tldCA9IHt9O1xuICAgIHRoaXMuX2RlYWxzQnlQb3NpdGlvbiA9IHt9O1xuICAgIHRoaXMuX2hpc3RvcnlPcmRlcnNCeVRpY2tldCA9IHt9O1xuICAgIHRoaXMuX2hpc3RvcnlPcmRlcnNCeVBvc2l0aW9uID0ge307XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNvbXBsZXhpdHlcbiAgICB0aGlzLl9oaXN0b3J5T3JkZXJzQ29tcGFyYXRvciA9IChvMSwgbzIpID0+IHtcbiAgICAgIGxldCB0aW1lRGlmZiA9IChvMS5kb25lVGltZSB8fCBuZXcgRGF0ZSgwKSkuZ2V0VGltZSgpIC0gKG8yLmRvbmVUaW1lIHx8IG5ldyBEYXRlKDApKS5nZXRUaW1lKCk7XG4gICAgICBpZiAodGltZURpZmYgPT09IDApIHtcbiAgICAgICAgbGV0IGlkRGlmZiA9IG8xLmlkIC0gbzIuaWQ7XG4gICAgICAgIGlmIChpZERpZmYgPT09IDApIHtcbiAgICAgICAgICBpZiAobzEudHlwZSA+IG8yLnR5cGUpIHtcbiAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgIH0gZWxzZSBpZiAobzEudHlwZSA8IG8yLnR5cGUpIHtcbiAgICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKG8xLnN0YXRlID4gbzIuc3RhdGUpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG8xLnN0YXRlIDwgbzIuc3RhdGUpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBpZERpZmY7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0aW1lRGlmZjtcbiAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMuX2hpc3RvcnlPcmRlcnNCeVRpbWUgPSBuZXcgQVZMVHJlZSh7Y29tcGFyZUtleXM6IHRoaXMuX2hpc3RvcnlPcmRlcnNDb21wYXJhdG9yfSk7XG4gICAgdGhpcy5fZGVhbHNDb21wYXJhdG9yID0gKGQxLCBkMikgPT4ge1xuICAgICAgbGV0IHRpbWVEaWZmID0gKGQxLnRpbWUgfHwgbmV3IERhdGUoMCkpLmdldFRpbWUoKSAtIChkMi50aW1lIHx8IG5ldyBEYXRlKDApKS5nZXRUaW1lKCk7XG4gICAgICBpZiAodGltZURpZmYgPT09IDApIHtcbiAgICAgICAgbGV0IGlkRGlmZiA9IGQxLmlkIC0gZDIuaWQ7XG4gICAgICAgIGlmIChpZERpZmYgPT09IDApIHtcbiAgICAgICAgICBpZiAoZDEuZW50cnlUeXBlID4gZDIuZW50cnlUeXBlKSB7XG4gICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgICB9IGVsc2UgaWYgKGQxLmVudHJ5VHlwZSA8IGQyLmVudHJ5VHlwZSkge1xuICAgICAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIGlkRGlmZjtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHRpbWVEaWZmO1xuICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5fZGVhbHNCeVRpbWUgPSBuZXcgQVZMVHJlZSh7Y29tcGFyZUtleXM6IHRoaXMuX2RlYWxzQ29tcGFyYXRvcn0pO1xuICAgIHRoaXMuX21heEhpc3RvcnlPcmRlclRpbWUgPSBuZXcgRGF0ZSgwKTtcbiAgICB0aGlzLl9tYXhEZWFsVGltZSA9IG5ldyBEYXRlKDApO1xuICAgIHRoaXMuX25ld0hpc3RvcnlPcmRlcnMgPSBbXTtcbiAgICB0aGlzLl9uZXdEZWFscyA9IFtdO1xuICAgIGNsZWFyVGltZW91dCh0aGlzLl9mbHVzaFRpbWVvdXQpO1xuICAgIGRlbGV0ZSB0aGlzLl9mbHVzaFRpbWVvdXQ7XG4gIH1cblxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgY29tcGxleGl0eVxuICBhc3luYyBfYWRkRGVhbChkZWFsLCBleGlzdGluZykge1xuICAgIGxldCBrZXkgPSB0aGlzLl9nZXREZWFsS2V5KGRlYWwpO1xuICAgIHRoaXMuX2RlYWxzQnlUaWNrZXRbZGVhbC5pZF0gPSB0aGlzLl9kZWFsc0J5VGlja2V0W2RlYWwuaWRdIHx8IHt9O1xuICAgIGxldCBuZXdEZWFsID0gIWV4aXN0aW5nICYmICF0aGlzLl9kZWFsc0J5VGlja2V0W2RlYWwuaWRdW2tleV07XG4gICAgdGhpcy5fZGVhbHNCeVRpY2tldFtkZWFsLmlkXVtrZXldID0gZGVhbDtcbiAgICBpZiAoZGVhbC5wb3NpdGlvbklkKSB7XG4gICAgICB0aGlzLl9kZWFsc0J5UG9zaXRpb25bZGVhbC5wb3NpdGlvbklkXSA9IHRoaXMuX2RlYWxzQnlQb3NpdGlvbltkZWFsLnBvc2l0aW9uSWRdIHx8IHt9O1xuICAgICAgdGhpcy5fZGVhbHNCeVBvc2l0aW9uW2RlYWwucG9zaXRpb25JZF1ba2V5XSA9IGRlYWw7XG4gICAgfVxuICAgIHRoaXMuX2RlYWxzQnlUaW1lLmRlbGV0ZShkZWFsKTtcbiAgICB0aGlzLl9kZWFsc0J5VGltZS5pbnNlcnQoZGVhbCwgZGVhbCk7XG4gICAgaWYgKGRlYWwudGltZSAmJiAoIXRoaXMuX21heERlYWxUaW1lIHx8IHRoaXMuX21heERlYWxUaW1lLmdldFRpbWUoKSA8IGRlYWwudGltZS5nZXRUaW1lKCkpKSB7XG4gICAgICB0aGlzLl9tYXhEZWFsVGltZSA9IGRlYWwudGltZTtcbiAgICB9XG4gICAgaWYgKG5ld0RlYWwpIHtcbiAgICAgIHRoaXMuX25ld0RlYWxzLnB1c2goZGVhbCk7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5fZmx1c2hUaW1lb3V0KTtcbiAgICAgIHRoaXMuX2ZsdXNoVGltZW91dCA9IHNldFRpbWVvdXQodGhpcy5fZmx1c2hEYXRhYmFzZS5iaW5kKHRoaXMpLCA1MDAwKTtcbiAgICB9XG4gIH1cblxuICBfZ2V0RGVhbEtleShkZWFsKSB7XG4gICAgcmV0dXJuIChkZWFsLnRpbWUgfHwgbmV3IERhdGUoMCkpLnRvSVNPU3RyaW5nKCkgKyAnOicgKyBkZWFsLmlkICsgJzonICsgZGVhbC5lbnRyeVR5cGU7XG4gIH1cblxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgY29tcGxleGl0eVxuICBhc3luYyBfYWRkSGlzdG9yeU9yZGVyKGhpc3RvcnlPcmRlciwgZXhpc3RpbmcpIHtcbiAgICBsZXQga2V5ID0gdGhpcy5fZ2V0SGlzdG9yeU9yZGVyS2V5KGhpc3RvcnlPcmRlcik7XG4gICAgdGhpcy5faGlzdG9yeU9yZGVyc0J5VGlja2V0W2hpc3RvcnlPcmRlci5pZF0gPSB0aGlzLl9oaXN0b3J5T3JkZXJzQnlUaWNrZXRbaGlzdG9yeU9yZGVyLmlkXSB8fCB7fTtcbiAgICBsZXQgbmV3SGlzdG9yeU9yZGVyID0gIWV4aXN0aW5nICYmICF0aGlzLl9oaXN0b3J5T3JkZXJzQnlUaWNrZXRbaGlzdG9yeU9yZGVyLmlkXVtrZXldO1xuICAgIHRoaXMuX2hpc3RvcnlPcmRlcnNCeVRpY2tldFtoaXN0b3J5T3JkZXIuaWRdW2tleV0gPSBoaXN0b3J5T3JkZXI7XG4gICAgaWYgKGhpc3RvcnlPcmRlci5wb3NpdGlvbklkKSB7XG4gICAgICB0aGlzLl9oaXN0b3J5T3JkZXJzQnlQb3NpdGlvbltoaXN0b3J5T3JkZXIucG9zaXRpb25JZF0gPSB0aGlzLl9oaXN0b3J5T3JkZXJzQnlQb3NpdGlvbltoaXN0b3J5T3JkZXIucG9zaXRpb25JZF0gfHxcbiAgICAgICAge307XG4gICAgICB0aGlzLl9oaXN0b3J5T3JkZXJzQnlQb3NpdGlvbltoaXN0b3J5T3JkZXIucG9zaXRpb25JZF1ba2V5XSA9IGhpc3RvcnlPcmRlcjtcbiAgICB9XG4gICAgdGhpcy5faGlzdG9yeU9yZGVyc0J5VGltZS5kZWxldGUoaGlzdG9yeU9yZGVyKTtcbiAgICB0aGlzLl9oaXN0b3J5T3JkZXJzQnlUaW1lLmluc2VydChoaXN0b3J5T3JkZXIsIGhpc3RvcnlPcmRlcik7XG4gICAgaWYgKGhpc3RvcnlPcmRlci5kb25lVGltZSAmJiAoIXRoaXMuX21heEhpc3RvcnlPcmRlclRpbWUgfHxcbiAgICAgICAgdGhpcy5fbWF4SGlzdG9yeU9yZGVyVGltZS5nZXRUaW1lKCkgPCBoaXN0b3J5T3JkZXIuZG9uZVRpbWUuZ2V0VGltZSgpKSkge1xuICAgICAgdGhpcy5fbWF4SGlzdG9yeU9yZGVyVGltZSA9IGhpc3RvcnlPcmRlci5kb25lVGltZTtcbiAgICB9XG4gICAgaWYgKG5ld0hpc3RvcnlPcmRlcikge1xuICAgICAgdGhpcy5fbmV3SGlzdG9yeU9yZGVycy5wdXNoKGhpc3RvcnlPcmRlcik7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5fZmx1c2hUaW1lb3V0KTtcbiAgICAgIHRoaXMuX2ZsdXNoVGltZW91dCA9IHNldFRpbWVvdXQodGhpcy5fZmx1c2hEYXRhYmFzZS5iaW5kKHRoaXMpLCA1MDAwKTtcbiAgICB9XG4gIH1cblxuICBfZ2V0SGlzdG9yeU9yZGVyS2V5KGhpc3RvcnlPcmRlcikge1xuICAgIHJldHVybiAoaGlzdG9yeU9yZGVyLmRvbmVUaW1lIHx8IG5ldyBEYXRlKDApKS50b0lTT1N0cmluZygpICsgJzonICsgaGlzdG9yeU9yZGVyLmlkICsgJzonICtcbiAgICAgIGhpc3RvcnlPcmRlci50eXBlICsgJzonICsgaGlzdG9yeU9yZGVyLnN0YXR1cztcbiAgfVxuXG4gIGFzeW5jIF9mbHVzaERhdGFiYXNlKCkge1xuICAgIGlmICh0aGlzLl9mbHVzaFByb21pc2UpIHtcbiAgICAgIGF3YWl0IHRoaXMuX2ZsdXNoUHJvbWlzZTtcbiAgICB9XG4gICAgaWYgKHRoaXMuX2ZsdXNoUnVubmluZykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9mbHVzaFJ1bm5pbmcgPSB0cnVlO1xuICAgIGxldCByZXNvbHZlO1xuICAgIHRoaXMuX2ZsdXNoUHJvbWlzZSA9IG5ldyBQcm9taXNlKHJlcyA9PiByZXNvbHZlID0gcmVzKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5faGlzdG9yeURhdGFiYXNlLmZsdXNoKHRoaXMuX2FjY291bnRJZCwgdGhpcy5fYXBwbGljYXRpb24sIHRoaXMuX25ld0hpc3RvcnlPcmRlcnMsIHRoaXMuX25ld0RlYWxzKTtcbiAgICAgIHRoaXMuX25ld0hpc3RvcnlPcmRlcnMgPSBbXTtcbiAgICAgIHRoaXMuX25ld0RlYWxzID0gW107XG4gICAgICB0aGlzLl9sb2dnZXIuZGVidWcoYCR7dGhpcy5fYWNjb3VudElkfTogZmx1c2hlZCBoaXN0b3J5IGRiYCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aGlzLl9sb2dnZXIud2FybihgJHt0aGlzLl9hY2NvdW50SWR9OiBlcnJvciBmbHVzaGluZyBoaXN0b3J5IGRiYCwgZXJyKTtcbiAgICAgIHRoaXMuX2ZsdXNoVGltZW91dCA9IHNldFRpbWVvdXQodGhpcy5fZmx1c2hEYXRhYmFzZS5iaW5kKHRoaXMpLCAxNTAwMCk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHJlc29sdmUoKTtcbiAgICAgIHRoaXMuX2ZsdXNoUnVubmluZyA9IGZhbHNlO1xuICAgIH1cbiAgfVxuXG59XG4iXX0=